{"title": "PDF", "author": "PDF", "url": "https://openaccess.uoc.edu/bitstream/10609/45763/10/miglesiasjTFG0116memoria.pdf", "hostname": "PDF", "description": "PDF", "sitename": "PDF", "date": "PDF", "cleaned_text": "TRABAJO FINAL GRADO Dise\u00f1o e implementaci\u00f3n de un Dron Para la detecci\u00f3n de incendios forestales Alumno Miguel \u00c1ngel Iglesias Jim\u00e9nez Grado Ingenier\u00eda Telecomunicaciones, especialidad Sistemas de Telecomunicaci\u00f3n Profesor: Xavi Villajosana Guillen Consultor: Pere Tuset Peir\u00f3 10 enero 2016 rev(27/01/16) Esta obra est\u00e1 sujeta a una licencia de Reconocimiento- No comercial - Sin Obra Derivada 3.0 Espa\u00f1a de Creative C ommos Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 2 de 374 A MIS PADRES, HERMANOS Y FAMILIA, as\u00ed como a mi pareja POR EL APOYO DADO A LO LARGO DE ESTOS A\u00d1OS QUE HA HECHO POSIBLE LLEGAR HASTA AQUI. Agradecer este proyecto: A profesores de la UOC y en especial a Co nsultores por su ayuda, paciencia y respuestas siempre que l as he necesitado, serian muchos para poder citarlos debido a lo largo de estos a\u00f1os. A la especial figura de mi Tutor, Gracias Joaqu\u00edn por esos consejos importantes en cada momento y que siempre me has dado. A compa\u00f1eros que igualmente serian muchos , el m\u00e1s reciente Jordi gracias por ejercer en apoyo para facilitarme el tener un punto de vista cr\u00edtico siempre una inestimable ayuda para ver y localizar mejoras. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 3 de 374 FICHA DEL TRABAJO FINAL T\u00edtulo del trabajo: Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Nombre del Autor: Miguel \u00c1ngel Iglesias Jim\u00e9nez Nombre del consultor: Pere Tuset Peir\u00f3 Fecha del libramiento (mm/aaaa): Enero/2016 \u00c1rea del trabajo Final: Sistemas Arduino Titulaci\u00f3n: Grado Ingenier\u00eda Telecomunicaciones (Sistemas Telecomunicaci\u00f3n) Abstrac The serious damage caused by forest fires and the enormous size that reach them, make public administrations spend and increase economic resources in prevention on fire fighting as well as to remedy the negative consequences that these bring with them. Forest fires can cause irreparable damage to the environment as well as human losses and evictions of people who are reached by them. An important aspect in fire preventio n is its quick detection, since all the operating of extinction depends on the detection of the initial focus to act immediately and prevent it from becoming a large fire. It is therefore very necessary to detect the focus of a fire and determine the extension as soon as possible as well as to determine exactly the location of the same. Different technologies have been used for these purposes, which include the use of cameras, optical and infrared satellite images well as the use of the raphic (IGS) System. There are also other methods based on active laser (Salas, 2003), with very fast response times and ability to indicate the \"actual location of the fire together with its intensity or virulence\", whose main difference from the infrared is that this system is based on detecting smoke columns, getting faster in detention, while infrared basically methods of detecting fires one based on the detection of the fire and another based on the detection of smoke in the use of cameras. The fire detection is simple but with the disadvantage that when an optical camera detects a fire, this is already at an advanced stage. On the other hand, smoke detection allows you to detect forest fires in the early stages while the analysis of the images is much more complex since the algorithms responsible for the analysis should include: background subtraction, filtering of quick elements, and of related components. Thus from the images by analy sing pixel to pixel you can see the smoke from controlled fires that corresponds to possible fire. A system based on infrared and optical cameras, as it is the forest in Andaluc\u00eda (SPAIN), (which entered into operation with the forest 2000 plan), consists of a series of infrared and optical cameras placed strategically throughout the territory to control, a central monitoring with monitoring and image processing unit monitors. Each checkpoint situated in different towers has devices of cameras that provide a view of 360 degrees, which sent the recorded images to the image- processing unit responsible for detecting a Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 4 de 374 possible fire. When a possible fire is automatically detected the camera will stop at that position and the alarm is sent to the monitor's supervision. From the initial study a system of Imaging for Assembly is proposed in mobile unit (Dron) for surveillance of areas which fall outside the scope of systems as described previously (by scheduled flight). On the other hand the system provides some interesting new features since it integrates a number of sensors of temperature...) that are important subsequently against fire as specific software SIDAEX). Thus, with these objectives, and taking into account that we want the system to be mobile, various sensors are studied. We are looking for precision and low power consumption, which s hould be standard and if possible with minimum requirements of signal adaptation. They should have of communication systems the Coordinator systems radio control by RF (2.4 GHz) and the possibility of communication via GSM modem which makes it useful to use as a support unit for extinction once teams are located in the area. They can use it to display areas in the declared fire where people cannot access, while allowing contact control center to extinguishing equipment and lines of possibles it. This gives this project a special appeal since the unit may become a \"patrol\" fire service, while it can be used as a support unit by exti nction equipment s. Key Word Embedded systems, IGS (Systems Integration Geographic), forest fires, sensor network (WSN), systems wireless, Arduino and Dron. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 5 de 374 \u00cdndice de Contenidos 1. INTRODUCCION............................................................................................................................. 10 1.1. Justificaci\u00f3n y contexto ................................ ................................ ..................... 1.2. Descripci\u00f3n del 1.3. Objetivos de aplicaci\u00f3n ......................................................................... ................. 15 1.6. Breve descripci\u00f3n de los cap\u00edtulos de la memoria ................................ ............................ 17 2. ANTECEDENTES .......................................................................................................... 18 2.1. Estado del arte ................................ ................................ ................................ 2.2. 19 3. DESCRIPCION ................................ .......... 24 3.3.1. Detecci\u00f3n del C olor ................................ ................................ ... 24 3.3.2. Detecci\u00f3n del fuego por Humo ................................ ................................ ................. 25 3.4. Descripci\u00f3n Funcional UAV en la detecci\u00f3n de incendios forestales ................................ 25 3.4.1. Diagrama de Bloques de la aplicaci\u00f3n ................................ ................................ ...... 26 3.4.2. Posicionamiento y Comunicaci\u00f3n en la Red ................................ ............................. 27 3.4.3. Interacci\u00f3n entre los diferentes Sub-Sistema s 29 Aplicaci\u00f3n control y Diagrama de Bloques Aplicaci\u00f3n WEB ................................ ................................ .... 31 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 6 de 374 [Ir al \u00edndice] 4. DESCRIPCION DETALLADA HARDWARE.................................................................3 2 4.1. Requisitos m\u00ednimos S istema Central y Controlador de Vuelo ................................ ............ 33 4.2. Descripci\u00f3n de m\u00f3dulos seleccionados ................................ ................................ .............. 33 4.2.1. CPU Sistema Centra l y Captura -Procesado de video .............................................. 35 4.2.2. MCU controlador Humedad relativa y temperatura 40 4.2.15. Sistema Estabilizador C\u00e1mara Video (Gimbal) ................................ .................... 42 4.3. Sistema de Bater\u00eda ................................ 5. DESCRIPCION Sistema Operativo Central ................................ ................................ ................................ .. 46 5.2. Lenguaje programaci\u00f3n Python ................................ 5.3. Biblioteca de visi\u00f3n artificial OpenCV 49 5.4. Software Misi\u00f3n Planner 5.5. Casos ..................... 52 6. VIABILIDAD Viabilidad Proyecto ................................ ................................ ................................ 53 7. COSTES ....................................................................................................................... 55 7.1. Presupuesto ................................ ................................ ................................ ......... 55 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 7 de 374 [Ir al \u00edndice] 8. CONCLUSIONES .......................................................................................................... 56 8.1. Objetivos alcanzados ................................ ................................ ................................ ............ 56 8.2. Ampliaci\u00f3n y opciones de ......................... 56 8.3. 8.4. Autoevaluaci\u00f3n ..................................................................................................................... 57 9. .................................................................................................................. 58 10. BIBLIOGRAFIA ........................................................................................................... 59 11. ANEXOS ...................................................................................................................... 60 Anexo A Manual de Usuario ................................ ................................ ................................ ....... 61 Anexo B Procedimiento montaje ................................ 72 Anexo C Esquemas el\u00e9ctricos Sistema ................................ ................................ ..................... 84 Anexo D Hojas caracter\u00edsticas Componentes electr\u00f3nicos ................................ ....................... 92 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 8 de 374 \u00cdndice de Figuras Figura 1 Diagrama de Gantt ................................ ................................ ................................ .... Predator (Fuente ................................ ............ 18 Figura 4 Esquema ejes rotaci\u00f3 n y fuerzas rotores estructura Q uad-rotor ............................ 21 Figura 5 Esquema de control de lazo cerrado ................................ ................................ ....... 21 Figura 6 Esquema motor Brushless (Fuente:[7]) 22 Figura 7 Diagrama bloque aplicaci\u00f3n ................................ ................................ .................... 27 Figura 8 Servicio WEB Unidad Dron 28 Figura 9 Aplicativo WEB ................................ ................................ ................................ ........... 28 Figura 10 Diagrama Bloques interacci\u00f3n objetos del sistema ................................ ............... 29 Figura 11 Interfaz opci\u00f3n men\u00fa Localizaci\u00f3n Unidad. ................................ ............................. 30 Figura 12 Interfaz Opci\u00f3n Men\u00fa Servicios NAS. ................................ ................................ ...... 31 Figura 13 Interfaz Opci\u00f3n Men\u00fa Configuraci\u00f3n Red ................................ ................................ 31 Figura 14 Diagrama Estructura Aplicaci\u00f3n WEB ................................ ................................ ..... 32 Figura 15 Sistema embebido Raspberry PI 2 B ................................ ................................ ....... ................................ ................................ ............... Estructura TAROT IRON 650 Pro ................................ ................................ ..................... 38 Figura 23 M\u00f3dulos Transmisor y Receptor Fr Sky 8Ch ................................ ........................ 39 Figura 24 M\u00f3dulos Transmisor Audio- Video 5'8Gh ................................ ............................... 39 Figura 25 M\u00f3dulo Receptor Audio- Video 5'8Gh ................................ ................................ .... 39 Sensor Figura. 28 Sensor Iluminaci\u00f3n- Proximid ad Caracter\u00edsticas ................................ ................... 41 Figura 29 Sensor Temperatura Humedad Relativa DHT22 ................................ .................. 42 Figura 30 Sistema estabilizado DJI (Gimbal) ................................ ................................ ........ 42 Figura 31 PI Camera Rev ................................ 42 Figura 32 Consumo Sistemas ................................ ................................ ................................ 43 Figura 33 Relaci\u00f3n consumo- rpm y Lectura sensor Temperatura Presi\u00f3n MPL115A ................................ .................. 48 Figura 37 C onexi\u00f3n remota mediante Mission Planner ................................ ......................... 51 Figura 38 Conexiones a programaci\u00f3n plan de vuelo ................................ ........................... 51 Figura 39 Diagramas casos de us o ................................ ................................ ....................... 52 \u00cdndice de Figuras Tabla 1 Comparativas Placas base sistemas embebidos ................................ ....................... 33 Tabla 2 Proyector c ontroladores vuelo de c\u00f3digo abierto ................................ ........................ 34 Tabla 3 Caracter\u00edsticas sensor presi\u00f3n MPL115A ................................ ................................ ... 40 Tabla 4 Caracter\u00edsticas sensor iluminaci\u00f3n- VCNL4010 ................................ ....... 41 Tabla 5 Caracter\u00edsticas sensor temperatura- humedad relativa DHT22 ................................ .. 42 Tabla 6 Relaci\u00f3n RPM Motor y Consumo ................................ ................................ ................ 43 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 9 de 374 1. Introducci\u00f3n [Ir al \u00edndice] 1.1 Justificaci\u00f3n y contexto La necesidad de apoyo desde todos los \u00e1mbitos posibles a los medios existentes en la actualidad para evitar las cat\u00e1strofes en el \u00e1mbito de los incendios forestales se hace cada vez m\u00e1s evidente. Los graves da\u00f1os que producen en el medio ambiente as\u00ed como el gran impacto social que llegan a alcanzar han hecho que las administraciones p\u00fablicas dediquen importantes recursos econ\u00f3micos a la lucha y prevenci\u00f3n contra el fuego y a paliar en la medida de lo posible las consecuencias que producen es te tipo de incendios . Los incendios forestales no solo producen grandes da\u00f1os en el medio ambiente en muchas ocasiones irreparable, sino que llegan incluso a producir el desalojo de zonas habitadas por la propagaci\u00f3n del incendio y en ocasiones p\u00e9rdidas de vidas humanas. Para evitar estos da\u00f1os los equi pos de extinci\u00f3n de incendios cuentan con numerosos y modernos medios tanto terrestres como a\u00e9reos para la realizaci\u00f3n de las tares de lucha contra el fuego, por los que cada vez se hace m\u00e1s necesario el desarrollo de aplicaciones que utilizando l as nuevas tecnolog\u00edas optimicen el uso de dichos medios , ayuden en la toma de decisiones a los responsables de la lucha contra incendios, permitan evaluar las consecuencias del incendio sobre las \u00e1reas implicadas y su m\u00e1s adecuada restauraci\u00f3n. Para evitar que una alarma termine por ser un gran incendio forestal se pueden llevar a cabo tres acciones principales: Prevenci\u00f3n: Esta consiste en evitar que se provoque el incendio y minimizar las consecuencias en caso de que se produzca. Son acciones como por ejemplo l as quemas preventivas, o los cortafuegos . Detecci\u00f3n: Consiste en alertar con la mayor celeridad posible de la existencia de un incendio con la finalidad de comenzar su extinci\u00f3n. Como puede ser la funci\u00f3n realizada por los guardias forestales. Extinci\u00f3n : Es la acci\u00f3n directa contra el fuego que permite terminar con el incendio estas consisten en eliminar alguno de los tres elementos que lo constituyen el denominado tri\u00e1ngulos del fuego: combustible (vegetaci\u00f3n), comburente ( oxigeno) encargado de oxidar el c ombustible favoreciendo la combusti\u00f3n y energ\u00eda (calor) necesaria para que se produzca la reacci\u00f3n. De otro lado en el sentido de detecci\u00f3n de incendios la Consejer\u00eda de Medio Ambiente a trav\u00e9s del Plan INFOCA [1], han llevado a cabo instalaciones y disponen de medios que han permitido desarrollar numerosas aplicaciones basadas en las nuevas tecnolog\u00edas, a trav\u00e9s de convenios con universidades y centros de investigaci\u00f3n con la colaboraci\u00f3n de empresas especializadas as\u00ed como las aportaciones del Minis terio de Medio Ambiente. Entre dichas aplicaciones se pueden citar: La detecci\u00f3n autom\u00e1tica de incendios forestales mediante el uso de c\u00e1maras infrarrojas situadas estrat\u00e9gicamente en puntos fijos. En este sentido existe el denominado \"Sistema Bosque\"[1] instalado en Andaluc\u00eda y Galici a. Tambi\u00e9n existe el denominado \"Programa Fuego\" en fase de experimentaci\u00f3n el cual las c\u00e1maras son situadas en mini sat\u00e9lites. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 10 de 374 [Ir al \u00edndice] T\u00e9cnicas de medici\u00f3n durante el incendio, de \u00e1reas quemadas por el fuego, por medio del \"Sistema SALEIF\"[2], el cual est\u00e1 basado en el vuelo de un helic\u00f3ptero provisto de un ordenador con GPS que recorre el contorno del incendio. T\u00e9cnicas de simulaci\u00f3n de la evoluci\u00f3n de un incendio con el \"Programa CARDIN\"[2] basado en utilizaci\u00f3n de SIG (Sistemas de Informaci\u00f3n Geogr\u00e1fica) La aplicaci\u00f3n de procesado de im\u00e1genes para llevar a cabo tareas de vigilancia es un campo ampliamente estudiado, por lo que deben de aplicarse esos conocimiento y la utilizaci\u00f3n de estas t\u00e9cnicas de procesado de im\u00e1genes en el \u00e1mbito de la detecci\u00f3n de incendios . Es en este contexto que el presente proyecto pretende centrarse en la tarea de detecci\u00f3n de incendios forestales mediante t\u00e9cnicas de vigilancia y procesado de imagen. 1.2 Descripci\u00f3n del Proyecto Dadas las grandes extensiones de terreno que son propensas a incendios, bien sea por su vegetaci\u00f3n o bien por los factores clim\u00e1ticos de la zona, hacen que sea muy dif\u00edcil cuando no imposible que las acciones de detecci\u00f3n mediante las funciones de vigilancia puedan ser llevadas a cabo mediante persona s. De igual forma el despliegue de plataformas y redes de c\u00e1maras llegan a resultar proyectos altamente costos os y finalmente acaban por ser abandonad os o no dotad os de los recursos suficientes para llevar a cabo sus cometidos como ha ocurrido con el mencionado \"Sistema Bosque\" en Andaluc\u00eda. Esto lleva a proponer un UAV ( Unmanned Aerial Vehicle, veh\u00edculo de vuelo no tripulado ), tambi\u00e9n com\u00fanmente denominado Dron , el cual permitir\u00e1 realizar las funciones de vigilancia cubriendo mayores extensiones de terreno. Dicha unidad m\u00f3vil estar\u00e1 dotada con un sistema de Geo-posicionamiento por GPS (Global Positioning System ), capacidad de realizar grabaciones de video, captura y transmisi\u00f3n de im\u00e1genes , que pondr\u00e1 a disposici\u00f3n del centro de control a trav\u00e9s de sus diversos sistemas de comunicaciones. De igual forma podr\u00e1 ser comandada en varias modalidades como son: Modalidad de vuelo programado: El sistema es programado para realizar planes de vuelo peri\u00f3dicos con unos recorridos preestablecidos, durante dichos vuelos tendr\u00e1 la capacidad de realizar capturas de im\u00e1genes y/o video lo que permitir\u00e1 poder conocer mediante visi\u00f3n el estado de la zona. Modalidad de vuelo por control manual ( corto alcance ): Situado en una zona de incendio podr\u00e1 ser puesto a disposici\u00f3n de personal del equipo de extinci\u00f3n para ser pilotado manualmente y prestar funciones de apoyo que pudiera necesitar dicho equipo como puede ser : Visualizaci\u00f3n del incendio en zonas no accesibles por personas, toma de temperaturas, presi\u00f3n y humedad de esas zonas , extensi\u00f3n del incendio etc... De esta forma mediante t\u00e9cnicas de procesado de imagen la unidad podr\u00e1 detectar situaciones de posibles incendios de forma autom\u00e1tica alertando al centro de control al que enviara los muestreos de datos atmosf\u00e9ricos obtenidos que podr\u00e1n ser recabados y analizados para ayuda en la determinaci\u00f3n de un plan de actuaci\u00f3n contra incendio. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 11 de 374 [Ir al \u00edndice] 1.3 Objetivos principales El objetivo principal del presente proyecto es desarrollar una plataforma que permita dar un paso m\u00e1s en ayudas a la prevenci\u00f3n de incendios forestales. Plantea las bases para llevar a cabo un sistema de detecci\u00f3n de incendios mediante un UAV el cual realizara la captura de im\u00e1genes para posterior detecci\u00f3n autom\u00e1tica de incendios mediante t\u00e9cnicas de procesado de imagen. Dicha unidad incluir\u00e1 un sistema de sensores para medidas de fen\u00f3menos atmosf\u00e9ricos con indicador de localizaci\u00f3n v\u00eda GPS con la finalidad de ayudar a la determinaci\u00f3n de un plan contra incendio y/o labores de prevenci\u00f3n de incendios . Su desarrollo es llev ado a cabo mediante sistemas embebidos , en el que podemos concretar cuatro bloques principales bloques principales: El Sistema Central : Lleva a cabo las funciones de coordinaci\u00f3n de todos los subsistemas de la unidad Dron, permitiendo l a interacci\u00f3n con el usuario a trav\u00e9s de sus divers os interfaces y medios de comunicaci\u00f3n disponibles. Ya sea en largo alcance con los centros de control o bien dando paso al enlace de corto alcance (aprox. 1Km) como puede ser en el caso de uso de la unidad Dron por equipos de extinci\u00f3n de incendios para funciones de apoyo. Sistema Controlador de vuelo : Realiza las funciones de piloto de a bordo de la UAV ( Unmanned Aerial Vehicle ). Este p odr\u00e1 ser programado de forma remota a trav\u00e9s del sistema central para realizar vuelos peri\u00f3dicos de duraci\u00f3n de 15 minutos. Aunque pueda parecer un tiempo corto dada la velocidad que puede alcanzar permitir\u00e1 cubrir grandes extensiones de terreno. En modo de operaci\u00f3n manual el sistema de control de vuelo permitir\u00e1 ser controlado de h aciendo uso de un enlace de radio- control pudiendo ser pilotado el Dron de forma manual (p.e. por alg\u00fan miembro del equipo de extinci\u00f3n) . Sistema Captaci\u00f3n video y Sensores atmosf\u00e9rico s: El sistema ser\u00e1 capaz de capturar im\u00e1genes en tiempo real as\u00ed como informar de coordenadas de posicionamiento y fen\u00f3menos atmosf\u00e9ricos concretamente temperatura, presi\u00f3n atmosf\u00e9rica y luminosidad. Sobre dichas capturas se implementa ra una monitorizaci\u00f3n de la geo- localizaci\u00f3n por GPS conociendo as\u00ed con exactitud las coordenadas donde se producen el posible inicio del incendio. Estos muestreos ser\u00e1n efectuados de forma peri\u00f3dica y los resultados obtenidos ser\u00e1n puestos a disposici\u00f3n del centro de control donde podr\u00e1n ser analizados para la detecci\u00f3n autom\u00e1tica de i ncendios y disponiendo asi de los datos que le sean de utilidad y ayuda para determinar un plan de actuaci\u00f3n. Sistema de estaci\u00f3n base: Esta suministrara la energ\u00eda el\u00e9ctrica necesaria para la recarga de las bater\u00edas de la unidad Dron realiz\u00e1ndose mediante placas solares lo que hace que puedan instalarse diversas bases e incluso en lugares remotos, de dif\u00edcil acceso, donde la unidad pueda cargar bater\u00edas . Del alcance de este proyecto queda excluido el montaje de l as estaciones base donde la unidad Dron efectuara su aterrizaje para recarga de bater\u00eda s y quedando a la espera de \u00f3rdenes de vuelo. Si bien se aportara dise\u00f1o y requisitos de dichas bases (circuitos para carga y comunicaciones con centro de control). Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 12 de 374 [Ir al \u00edndice] 1.4. Enfoque y metodolog\u00eda El presente proyecto est\u00e1 desarrollado con un enfoque did\u00e1ctico y se lleva a cabo en diferentes ciclos los cuales , se realizan de forma secuencial si bien en todo momento se ha tenido una visi\u00f3n global lo que permite poder realizar trabajos de forma transversal cuyos resultados han sido utilizados en ciclos posteriores facilitando la soluci\u00f3n requerida. As\u00ed en una primera fase de b\u00fasqueda e investigaci\u00f3n, se realiza el estudio de la tecnolog\u00eda y herramient as requeridas tanto en el \u00e1mbito del hardware ( micro -controladores , sensores, componentes electr\u00f3nicos y herramientas) como en software (sistemas operativos, lenguajes y entornos de programaci\u00f3n). Por ultimo esta fase permite la identificaci\u00f3n de los datos a tratar y la determinaci\u00f3n de las metodolog\u00edas utilizadas para la obtenci\u00f3n del objetivo final. Las fases de montaje, de codificaci\u00f3n y de testeo y verificaci\u00f3n son llevadas a cabo de una forma transversal, mediante pruebas emp\u00edricas para ir obteniendo los resultados deseados en cada uno de los dispositivos y sistemas instalados. Por \u00faltimo la fase de documentaci\u00f3n es llevada a cabo durante toda la duraci\u00f3n del proyecto, desde su inicio recabando documentaci\u00f3n e informaci\u00f3n y efectuando documentos tales como diagramas de bloques, diagramas de flujos, esquemas el\u00e9ctricos, capturas de se\u00f1ales y pruebas efectuadas, que se aportan como anexos a esta memoria. Se ha tenido presente la utilizaci\u00f3n de c\u00f3digo abierto, as\u00ed el proyecto se presenta en Open Source y de igual forma se beneficia de librer\u00edas de c\u00f3digo de otros autores el cual ha sido convenientemente modificado conseguir los objetivos. 1.5. Planificaci\u00f3n 1.5.1 Planteamiento inicial y seguimiento El proyecto queda divido en tres fases bien definidas: Fase de estudio, fase de implementaci\u00f3n y desarrollo y fase de pruebas y conclusiones. Estas fases en su mayor\u00eda son secuenciales aunque manteniendo una visi\u00f3n global del proyecto en ocasi\u00f3n se llevan a cabo de forma transversal interactuando entre ellas. Fase de estudio. En esta fase se realiza el estudio de la tecnolog\u00eda necesaria que se utilizara as\u00ed como de las herramientas de las que haremos uso. Se identifican los dispositivos necesarios para la implementaci\u00f3n efectuando la selecci\u00f3n de estos para lo que se tiene en cuenta diversas consideraciones como calidad y precisi\u00f3n componentes sensores para que cumplan c on el m\u00ednimo requerido en las condiciones del proyecto, estandarizaci\u00f3n de los mismos, y cost e. De igual forma se determina el sistema operativo a utilizar, lenguajes de programaci\u00f3n y aplicaciones, quedando definida la metodolog\u00eda utilizada presentando todo el itinerario a seguir en una planificaci\u00f3n inicial para la obtenci\u00f3n del objetivo final. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 13 de 374 [Ir al \u00edndice] Fase de implementaci\u00f3n y desarrollo. Una vez determinada la tecnolog\u00eda a utilizar y seleccionados los componentes que se considerados como adecuados para el cumplimiento de requisitos se inicia la fase de montaje de un prototipo, que si bien se realiza el estudio y un primer esquem\u00e1tico de todo el sistema completo, el montaje no es efectuado en su totalidad en una \u00fanica vez, sino que aplicamos metodolog\u00eda modular compagin\u00e1ndola con la fase de codificaci\u00f3n del sistema y en su inicio con la parte final de la fase de estudio. As\u00ed se inicia el montaje con el dise\u00f1o y montaje de la estructura , motores y reguladores de potencia propulsi\u00f3n para proceder a su calibrado y ajuste. A continuaci\u00f3n se anexa el modulo sistema control de vuelo, as\u00ed como los m\u00f3dulos receptores de radiofrecuencia (RF 2.4GHz) para el control de la UAV mediante transmisor de radiofrecuencia. Para verificar su correcto funcionamiento se aprovecha la fase de estudio de la aplicaci\u00f3n de control de piloto autom\u00e1tico la cual nos permite verificar correctamente el funcionamiento de los m\u00f3dulos de comunicaci\u00f3n de control, m\u00f3dulo de posicionamiento GPS, Modulo GSM -GPRS ( Global Sistem for Mobile communications - General Packet Radio Service) y el bus de comunicaciones I2C a utilizar para sensores perif\u00e9ricos. El siguiente paso ser\u00e1 efectuar la correspondiente programaci\u00f3n del m\u00f3dulo de comunicaciones de video y su depuraci\u00f3n de forma independiente por considerar que este es el punto que puede resultar m\u00e1s vulnerable e importante en el proyecto. Una vez obtenidos los resultados \u00f3ptim os y realizadas todas las pruebas de comunicaciones que permitan disponer de un c\u00f3digo de comunicaciones estable con un \u00f3ptimo control de errores, se realiza ra el ensamblaje de los distintos sensores y m\u00f3dulo s de transmisi\u00f3n de video con el sistema central quedando finalmente todos los sistemas programados e instalados sobre la estructura. Fase de pruebas y conclusiones . En esta fase se llevan a cabo los test de pruebas para verificaci\u00f3n de todas las funciones descritas para este proyecto, se incluye en ella una parte de subsanaci\u00f3n de posibles errores o desviaciones de los objetivos que puedan darse, asegurando as\u00ed que las pruebas finales sean correctas. Se termina con la verificaci\u00f3n de que se cumplen todos los requisitos marcados y llevando a cabo una toma de datos para dejar constancia de ello y posterior aportaci\u00f3n a la Memoria del proyecto. La planificaci\u00f3n detallada puede verse en el siguiente diagrama de Gantt Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 14 de 374 [Ir al \u00edndice] 1.5.2. Diagrama de Gantt Fig. 1 Diagrama de Gantt Esta planificaci\u00f3n puede decirse que dada la envergadura del proyecto ha sufrido algunos retrasos en hitos de entrega y mantener documentaci\u00f3n al d\u00eda si bien en su entrega final el retraso ha sido de 1 d\u00edas . Estos retrasos han sido mayormente por la carga de trabajo que supone el montaje de la unidad en su totalidad, pruebas modulares para verificaci\u00f3n del correcto funcionamiento. Las dificultades surgidas con proveedores los cuales indicaban plazos que finalmente no se han cumplido e incluso ha llevado a tener que realizar modificaciones en aspectos importantes del proyecto como ha sido en el sistema estabilizador de c\u00e1mara de video. 1.5.3. Metodolog\u00eda de la memoria La realizaci\u00f3n de la memoria del proyecto se realiza mediante la fase de documentaci\u00f3n la cual es llevada a cabo a lo largo de todo el proyecto. As\u00ed en la fase de estudio se recopila documentaci\u00f3n, datasheet de componentes, referencias de bibliograf\u00eda. De igual forma en la fase de desarrollo se capturan tomas de se\u00f1ales, im\u00e1genes correspondientes al montaje de prototipo y capturas de pantalla de las pruebas de verificaci\u00f3n efectuadas as\u00ed como videos explicativos de cada uno de los subsistemas y montajes llevados a cabo. En la fase de codificaci\u00f3n se impl ementa la documentaci\u00f3n correspondiente a la programaci\u00f3n efectuada sobre el sistema que se aporta como anexo a la presente memoria. 1.5.3. Metodolog\u00eda de aplicaci\u00f3n La implementaci\u00f3n de la aplicaci\u00f3n es realizada en cuatro fases que definimos como fase de an\u00e1lisis, fase de programaci\u00f3n, fase de codificaci\u00f3n, fase de depuraci\u00f3n y control de errores, las cuales se describen detalladamente a lo largo de la presente memoria, el cap\u00edtulo de Software. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 15 de 374 [Ir al \u00edn dice] a) Fase de an\u00e1lisis En esta fase se efect\u00faa el planteamiento del problema de una forma t\u00e9cnica, se determinan los sistemas y software a utilizar obteniendo tras el an\u00e1lisis un primer diagrama que aporta la informaci\u00f3n general del sistema y los dispositivos hardware del sistem a que se utilizaran y un diagrama de flujo general de la aplicaci\u00f3n. Se pueden diferenciar dos aplicativos uno para la unidad Dron , en adelante Sistema Central , y otro WEB para usuario. . Aplicaci\u00f3n del Sistema Central En el sistema se requiere que el mi smo en su inicializaci\u00f3n efect\u00fae un auto chequeo y detecci\u00f3n de los recursos disponibles (interfaces con usuario, interfaces de comunicaci\u00f3n, sensores del sistema), enviando un comunicado al usuario si existe incidencia. Verifica ra y establecer\u00e1 ser servidor proxy para la conexi\u00f3n con la unidad de Control de vuelo de abordo activando la comunicaci\u00f3n con la misma para ponerla a disposici\u00f3n del usuario. S i la inicializaci\u00f3n es correcta quedara en estado de reposo en espera de planes de vuelo o ser controlado mediante radio -control. Si el usuario quiere podr\u00e1 activar muestreos peri\u00f3dicos de datos de los distintos sensores para control de la zona donde est\u00e9 ubicado. A dquiridos estos efect\u00faa el env\u00edo a la base de datos para su archivo y posterior tratamiento por parte del usuario si lo requiere. Cuando el sistema no tenga trabajo pasara a estado de bajo consumo dado que se encuentra alimentada por bater\u00edas o paneles solares en la base. El sistema central ser\u00e1 accesible en todo momento mediante conexi\u00f3n SSH, al ig ual que mediante software espec\u00edfico de aplicaci\u00f3n de realizaci\u00f3n de planes de vuelo. Igualmente ser\u00e1 accesible en todo momento v\u00eda GSM disponiendo de servicio de voz (N\u00ba telef\u00f3nico Movil) . Aplicaci\u00f3n WEB Esta aplicaci\u00f3n Web monitoriza los datos obtenidos por el sistema central y los presenta al usuario en un formato comprensible. De otro lado realiza las funciones de interfaz de comunicaci\u00f3n usuario -sistema cuando se requiera configurar par\u00e1metros del sist ema como puede ser activaci\u00f3n de servicios NAS como puede ser servidores media, o servidores Cloud que la unidad pudiera utilizar, o tambi\u00e9n la configuraci\u00f3n de puntos de acceso de red inal\u00e1mbricos (esta es opcional implementada en parte para mejoras ). b) Fase de programaci\u00f3n En esta fase se instalan los sistemas y entornos de programaci\u00f3n a utilizar, se determinan finalmente las estructuras y se realiza un diagrama de flujo detallado de las aplicaciones que ser\u00e1 la base para la fase de codificaci\u00f3n de las mismas. En este proyecto se utilizara: -Sistema operativo Raspbian para Raspberry Pi -Protocolo MAVLink para control y programaci\u00f3n de planes de vuelo. -Lenguaje Python para programaci\u00f3n -Openc Cv para tratamiento de im\u00e1genes. -Lenguaje html y php para programaci\u00f3n de aplicaci\u00f3n WEB -Lenguaje MySql para tratamiento de base de datos Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 16 de 374 [Ir al \u00edndice] 1.6 Breve descripci\u00f3n de los cap\u00edtulos de la memoria La presente memoria se estructura de la siguiente forma. En primer lugar, el Cap\u00edtulo 2 sirve al lector para dar a conocer la trayectoria que ha tenido la tecnolog\u00eda que se pretende implementar en la soluci\u00f3n a lo largo de los \u00faltimos a\u00f1os y contextualizar la en la problem\u00e1tica que se aborda, exponiendo tambi\u00e9n la situaci\u00f3n actual y posibles ventajas e inconvenientes que esta tecnolog\u00eda puede presentar. El cap\u00edtulo tres sirve al lector para familiarizarse con los conceptos te\u00f3ricos que se mencionan en este trabajo, al igual que para mostrar un estudio de la plataforma a utilizar y del problema que se pretende abordar poniendo un especial \u00e9nfasis en la problem\u00e1tica existente. As\u00ed en un primer apartado se hace una introducci\u00f3n al modelo de la din\u00e1mica del cuatri -motor desde el punto de vista del control de sistema, para pasar a det allar todos los componentes en su configuraci\u00f3n b\u00e1sica. Pasando a describir la funcionalidad de los distintos sistemas que puede finalmente ser de utilidad en el \u00e1mbito del problema al que se pretende dar soluci\u00f3n, describiendo detalladamente la interacci\u00f3n entre los distintos sub -sistemas que componen la posible soluci\u00f3n as\u00ed como las opciones que puede ofrecer la aplicaci\u00f3n de control y monitorizaci\u00f3n para la interacci\u00f3n con el usuario y llevar a cabo el control de la UAV. El Cuarto cap\u00edtulo entra a describir los requisitos necesarios que deber\u00e1 reunir el hardware para la soluci\u00f3n pasando al an\u00e1lisis de las distintas opciones y la selecci\u00f3n de cada uno de los m\u00f3dulos o c omponentes que conformaran finalmente la unidad Dron justificando y verificando en los casos que se requiere que las selecci\u00f3n cumpla los requisitos necesarios para su selecci\u00f3n. El Quinto cap\u00edtulo entra en la selecci\u00f3n y descripci\u00f3n del software, sistema operativo que se utilizara, dado que muchas de las necesidades quedan cubiertas por el propio sistema operativo instalado y son simplemente instalaciones y uso de los m\u00f3dulos correspondientes del sistema o aplicaciones que solo requieren instalaci\u00f3n y apr endizaje de manejo, estos se han llevado a un anexo como Manual de Instalaci\u00f3n y Uso de aplicaciones Por lo que se entra directamente a ver algunos de los ejemplos de programaci\u00f3n del uso de las interfaces como puede ser en lenguaje Phyton o la exposici\u00f3n de la conexi\u00f3n con protocolos de control de vuelo , para pasar finalmente a exponer las t\u00e9cnicas de procesado de video con Open CV que pueden ser de utilidad para la detecci\u00f3n de incendios. El cap\u00edtulo 6 realiza un estudio de la viabilidad t\u00e9cnica exponi endo los principales inconvenientes observados as\u00ed como sus puntos fuertes. El cap\u00edtulo 7 presenta el presupuesto para finalmente en el cap\u00edtulo 8 presentar las conclusiones y futuros trabajos. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 17 de 374 2. Antecedentes [Ir al \u00edndice] 2.1 Estado del Arte Los UAV ( Unmanned Aerial Vehicle) o veh\u00edculo s a\u00e9reos no tripulados tienen su origen en fines militares dado que con ellos se puede tanto vigilar una zona de conflicto como atacar sin necesidad de poner en peligro vidas humanas. El UAV puede estar controlado remotamente por los operadores en tierra o pueden ser aut\u00f3nomos siguiendo una trayectoria previamente definida en su sistema de vuelo. Se pueden definir por tanto dos estaciones que pueden manejar la informaci\u00f3n del Dron , la estaci\u00f3n de tierra y la estaci\u00f3n de a bordo de la aeronave. Existen diversos tipos de UAV los hay de tipo avi\u00f3n, tipo helic\u00f3ptero, tipo dirigible etc... en las siguientes figuras podemos ver algunos de los utilizados para fines militares: Figura 2 UAV de combate Barracuda (Fuente:Wikipedia Enlace ) Figura 3 UAV Predator (Fuente Wikipedia Enlace ) Sin embargo estas aeronaves tambi\u00e9n tienen uso en el \u00e1mbito civil, actualmente se trabaja en este sentido para desarrollar veh\u00edculos c ada vez m\u00e1s peque\u00f1os y ligeros, con menor nivel tecnol\u00f3gico que empiezan a utilizarse en aplicaciones civiles las cuales pueden resultar peligrosas para que sean lle vadas a cabo por tripulaciones, como es el caso de los incendios forestales. En este \u00e1mbito en Espa\u00f1a existen diferentes proyectos de veh\u00edculos no tripulados orientados a la lucha contra incendios. As\u00ed la empresa FlightechSystem[3] ha llevado a cabo el desarrollo de diversas UAV para ayuda en problemas de deforestaci\u00f3n causada por los incendios y para labores de vigilancia e incluso en detecci\u00f3n de personas pir\u00f3manas , siendo capaz la aeronave de identificar actividad humana tanto de d\u00eda como de noche a cas i 2.000 metros de distancia. El avance y desarrollo de la investigaci\u00f3n en el \u00e1rea de los UAV, desde los a\u00f1os 90, en una gran medida es debido a la miniaturizaci\u00f3n de la tecnolog\u00eda, que ha permitido llevar a cabo diversos modelos y estudios de los distintos tipos de naves y su correcto control . As\u00ed desde los a\u00f1os 2000 se vienen aplicando nuevas estrategias de control que junto con la posibilidad de construcci\u00f3n e implementaci\u00f3n de hardware y software m\u00e1s potente, con micro controladores capaces ejecutar millones de instrucciones por segundo, y la reducci\u00f3n del tama\u00f1o y por tanto peso de las bater\u00edas, principalmente ion- litio y Litio -Pol\u00edmero han permitido una escalada en el \u00e1mbito de los Drones . Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 18 de 374 [Ir al \u00edndice] Las publicaciones recientes centran estas investigaciones mayormente en: Creaci\u00f3n y validaci\u00f3n de modelos en distintos tipos de software como puede ser MATLAB, simulink u otros de tipo CAD ( Computer Aided Desing, Dise\u00f1o Asistido por Computadora). Implementaci\u00f3n de diferentes estrategias de creaci\u00f3n y seguimiento de trayectorias incluyendo detecci\u00f3n y evasi\u00f3n de obtaculos. Control basado en sensores de visi\u00f3n (Camaras). Todo ello ha llevado los \u00faltimos a\u00f1os a conseguir desarrollar veh\u00edculos cada vez m\u00e1s peque\u00f1os y ligeros para su uso en el \u00e1mbito civil (denominados de baja escala) , los cuales son utilizados para control de fronteras, operaciones contra narcotr\u00e1fico, control de tr\u00e1fico de carreteras, o en operaciones de emergencia de la cruz roja como es el caso del proyecto que la cruz roja lleva a cabo en cooperaci\u00f3n con la empresa Zerintia[4] la cual dispone de una flota de Drones que pone a disposici\u00f3n de la Cruz Roja siempre que l os necesite, como puede ser en casos de b\u00fasqueda de s upervivientes o localizaci\u00f3n de equipos de rescate en grandes cat\u00e1strofes. 2.2 Estudio de Mercado Se ha podido ver los veh\u00edculos a\u00e9reos no tripulado s UAV se encuentran en expansi\u00f3n, pero igualmente existe un estricto control y muchas limitaciones para su utilizaci\u00f3n con las actuales normativas , por tanto no es f\u00e1cil su expansi\u00f3n y comercializaci\u00f3n . Aun as\u00ed la agencia WinterGreen Research [5], famosa por sus estudios de mercado sobre sectores como puede ser el de la energ\u00eda, software o telecomunicaciones, ha hecho p\u00fablico un estudio sobre la previsi\u00f3n de mercado de los D rones comerciales para los a\u00f1os 2015 a 2021. En este indica que la siguiente generaci\u00f3n de UAV conseguir\u00e1 un reemplazo total de los sistemas a\u00e9reos existentes en la actualidad en diversos sectores como pueden ser: Vigilancia de instalaciones , patrulla s fronterizas , envi\u00f3 de paqueter\u00eda, fotograf\u00eda y agricultura, apoyo en situaciones de cat\u00e1strofes . Estas unidades presenta claras ventajas como son: Mayor eficiencia energ\u00e9tica, mayor vida \u00fatil as\u00ed como un menor coste de operaci\u00f3n que los actuales sistemas tripulados . El mercado de las UAV (Unmanned Aerial Vehicle ) presenta una fuerte tendencia a crecer principalmente por razones como son el abaratamiento de los sistemas de navegaci\u00f3n y visualizaci\u00f3n, la experiencia de m\u00e1s de 3 millones de horas de vuelo que sistemas militares han llevado a cabo dotan a esta tecnol og\u00eda de la suficiente credibilidad y confianza para sentar las bases en su uso comercial. En este sentido la citada agencia presenta unos datos de previsi\u00f3n de mercado para l as UAV el cual alcanzo los 609 millones de d\u00f3lares en el a\u00f1o 2014 y se espera alcance la cifra de 4.800 millones para el a\u00f1o 2021, debi\u00e9ndose este crecimiento principalmente a la venta en sectores como son: M apeo para petr\u00f3leo y gas, inspecci\u00f3n de infraestructuras energ\u00e9ticas, envi\u00f3 de paqueter\u00eda, aplicaciones agr\u00edcolas y servicios de apoyo a cat\u00e1strofes. Puede solicitarse una copia del citado informe en el siguiente enlace Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 19 de 374 [Ir al \u00edndice] Hay que indicar que al mencionado avance de las tecnolog\u00edas y reducci\u00f3n del tama\u00f1o unido a un menor coste ha llevado a que estos dispositivos est\u00e9n al alcance de un mayor p\u00fablico objetivo con menor poder adquisitivo . As\u00ed actualmente se est\u00e1n comercializando un tipo muy particular de UAV multi- rotor en el que los motores est\u00e1n en el mismo plano, y pueden encontrarse disponibles en distintos modelos seg\u00fan su n\u00famero de motores sea de cuatro, seis y ocho motores . Estos Drones de bajo coste se establecen para usos recreativos como pueden ser los modelos Parrot AR Dron e 2.0 o DJI Phanton Profesional los cuales est\u00e1n orientados al ocio y a la grabaci\u00f3n de video mediante el uso de c\u00e1maras. Hay que indicar que en Espa\u00f1a est\u00e1 totalmente prohibido el uso de Drones para actividades civiles as\u00ed lo ha puesto de manifiesto AESA (Agencia Estatal de Seguridad A\u00e9rea) en diversas ocasiones mediante comunicados, donde indica \" ...en Espa\u00f1a no est\u00e1 permitido, y nunca lo ha estado, el uso de aeronaves pilotadas por control remoto con fines comerciales o profesionales , para realizar actividades consideradas trabajos a\u00e9reos, como la fotogr ametr\u00eda, agricultura inteligente (detectar en una finca aquellas plantas espec\u00edficas que necesitar\u00edan de una intervenci\u00f3n, como riego, fumigaci\u00f3n, para optimizar el cultivo), reportajes gr\u00e1ficos de todo tipo, inspecci\u00f3n de l\u00edneas de alta tensi\u00f3n, ferroviar ias, vigilancia de fronteras, detecci\u00f3n de incendios forestales, reconocimiento de los lugares afectados por cat\u00e1strofes naturales para dirigir las ayudas adecuadamente, etc. La realizaci\u00f3n de trabajos especializados (tambi\u00e9n llamados trabajos a\u00e9reos), com o son las filmaciones a\u00e9reas, los de vigilancia, de detecci\u00f3n y / o extinci\u00f3n de incendios, de cartograf\u00eda, de inspecci\u00f3n, etc., tal como indican los art\u00edculos 150 y 151 de la Ley 48/1960 sobre Navegaci\u00f3n A\u00e9rea, requiere autorizaci\u00f3n por parte de AESA, y hasta que no est\u00e9 aprobada la nueva normativa espec\u00edfica que regule el uso de este tipo de aparatos, AESA no puede emitir dichas autorizaciones porque carece de base legal para ello \"[6] Puede consultarse al respecto la citada legislaci\u00f3n sobre Navegaci\u00f3n A\u00e9rea en vigente en documento indicado en referencias [7]. Por tanto la posibilidades introducir un dise\u00f1o de una UAV, como puede ser e l presente proyecto para fines comerciales y/o profesionales no es posible en Espa\u00f1a est\u00e1 prohibido, la \u00fanica comercializaci\u00f3n posible de UAV en Espa\u00f1a se encontrar\u00eda en el \u00e1mbito de uso recreativo y actividades deportivas y realmente est\u00e1 muy limitado por la mencionada legislaci\u00f3n. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 20 de 374 3. Descripci\u00f3n te\u00f3rica y funcional [Ir al \u00edndice] 3.1 Modelo UAV Quad- rotor El presente capitulo se centrara en describir las partes que conforma un modelo de AUV, el quad -rotor, ya que es el modelo que se ha seleccionado para el presente proyecto por presentar una gran versatilidad y maniobrabilidad y ser actualmente la configuraci\u00f3n m\u00e1s utilizada debido a que posee la misma naturaleza no lineal del helic\u00f3ptero cl\u00e1sico y los mismos efectos aerodin\u00e1mi cos, pero con una mayor facilidad de control por tener los torques aerodin\u00e1micos bien definidos. La estructura quad -rotor se corresponde con la de un multi- c\u00f3ptero de 4 motores y 4 h\u00e9lices dispuestos en los extremos de unos brazos con la misma longitud. Las h\u00e9lices delantera y trasera giran en un sentido mientras que las h\u00e9lices derechas e izquierdas giran en el sentido opuesto. Esto lleva a una cancelaci\u00f3n de los efectos gir\u00f3scopos y torques aerodin\u00e1micos en estado de vuelo compensado. Figura 4 Esquema ejes rotaci\u00f3n y fuerzas rotores estructura quad -rotor A groso modo l a estrategia de control del quad -rotor responder\u00e1 ante serie de entradas (acciones de control) con una serie de salidas que corresponden a las coordenadas (x,y,z) y \u00e1ngulos de or ientaci\u00f3n ( ,,) , dicho sistema est\u00e1 sometido a perturbaciones externas v(t), por lo que un controlador deber\u00e1 calcular las acciones a tomar para contrarrestar dichas perturbaciones puede representarse dicha estrategia de control mediante un es quema de co ntrol de lazo cerrado como se muestra en la siguiente figura Figura 5 Esquema de control de lazo cerrado Por tanto el c\u00e1lculo de la acci\u00f3n de control depender\u00e1 de las medidas tomadas por los sensores, por lo que los rangos de tolerancias de dichos sensores har\u00e1n que un sistema de control sea o no aceptable para una determinada aplicaci\u00f3n. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 21 de 374 [Ir al \u00edndice] 3.2 Componentes UAV modelo Quad- Rotor La configuraci\u00f3n est\u00e1ndar para llevar a cabo la construcci\u00f3n y ensamblado de un Dron de cuatro motores implica los siguientes componentes. 3.2.1 Estructura Conforma el cuerpo de la UAV, sirviendo de esqueleto para la instalaci\u00f3n de componentes mec\u00e1nicos, el\u00e9ctricos y electr\u00f3nicos de la aeronave. Esta debe de minimizar su peso y maximizar en lo posible su rigidez y resistencia con la finalidad de soportar y transmitir las fuerzas que act\u00faan sobre la UAV. Es com\u00fan que se usen materiales como fibra de vidrio, aluminio, o pol\u00edmeros por su alta resistencia y bajo peso 3.2.2 Motores y H\u00e9lices El motor m\u00e1s utilizado en las UAV de baja escala es de tipo el\u00e9ctricos brushless DC, ya que estos no contemplan anillos de rozamiento para el cambio de polaridad en el rotor, realizando dicho cambio mediante la conmutaci\u00f3n de la polaridad en los electroimanes incorporados en el motor. Son motores que presentan una reacci\u00f3n r\u00e1pida y son alimentados mediante corriente continua (DC) la cual es convertida en una se\u00f1al AC de tres fases que se aplica a los electroimanes y resultan ser tener una larga duraci\u00f3n de uso[6]. Respecto de las h\u00e9lices se fabrican de materiales compuestos como pol\u00edmeros debido a las propiedades que le permiten resistir a fuerzas muy altas en ciertas direcciones. En el modelo Quad- rotor resulta muy \u00fatil ya que se conocen de antemano las fuerzas a las que estar\u00e1n sometidas. 3.2.3 Controlador electr\u00f3nico de velocidad E SC (Electronic Speed Control ) Estos dispositivos son los encargados de transformar las se\u00f1ales PWM ( Pulse Width Modulation) en una se\u00f1al de corriente alterna (AC) trif\u00e1sica que es la que alimenta los motores. Cumplen tambi\u00e9n la funci\u00f3n de ampli ficadores de voltaje salida a los valores nominales requeridos por el motor [7]. Para llevar a cabo la correcta regulaci\u00f3n de velocidad estos monitorean la posici\u00f3n del im\u00e1n permanente ubicado en el motor, efectuando los cambios de polaridad en los electroimanes del estator. En la siguiente imagen se puede observar el esquema de un motor Bushless , donde el im\u00e1n permanente se ubica en el rotor mientras que los electroimanes est\u00e1n fijados en el estator, Figura 6 Esquema motor Brushless (Fuente:[7]) Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 22 de 374 [Ir al \u00edndice] 3.2.4 Controlador UAV Realiza las funciones de control de la posici\u00f3n, velocidad y aceleraci\u00f3n de la UAV, para ello cuentan con un microprocesador y unidades de medici\u00f3n inercial (IMU) y de forma general est\u00e1n dotados de puertos de comunicaciones con los diferentes protocolos c omo pueden ser I2C, UART, SPI, USB. Para el manejo de los motores hacen uso de las salidas PWM ( pulse width modulation) de las que disponen. Actualmente existen una gran diversidad de controladores y diferentes comunidades que han colaborado para dise\u00f1os de m\u00f3dulos open- source , si bien por lo general las empresas comerciales de Drones realizan sus propios dise\u00f1os de estos m\u00f3dulos de control. 3.2.5 Sensores IMU (Unidades Medici\u00f3n Inercial) Como se ha indicado en el apartado 3.1 el control de lazo cerrado requiere de un muestreo de lecturas actualizado de las coordenadas (sensores) para poder efectuar los c\u00e1lculos de correcci\u00f3n. Los sensores m\u00e1s b\u00e1sicos que se utilizan en sistemas quad- rotor son los reunidos en las Unidades de Medici\u00f3n Inercial (IMU) que incluyen giroscopios y aceler\u00f3metro de tres ejes, lo que le permite obtener de una manera r\u00e1pida mediante integraci\u00f3n, la orientaci\u00f3n de la aeronave. Estas unidades IMU suelen cumplimentarse con alt\u00edmetros, sensores barom\u00e9tricos los cuales calculan la alti tud en base a las medidas de presi\u00f3n, estos son costosos pero suelen presentar importantes desviaciones de precisi\u00f3n. Para aplicaciones que se requiera una mayor precisi\u00f3n se utilizan tecnolog\u00edas sonar o laser entre otros. Para obtener la posici\u00f3n suelen hacer uso del magnet\u00f3metro (comp\u00e1s) el cual facilita la orientaci\u00f3n respecto al sistema de referencia acoplado a la tierra, esto en conjunci\u00f3n con el uso de GPS permite obtener, en tiempo real, la posici\u00f3n hasta en 3 ejes seg\u00fan el n\u00famero de sat\u00e9lites disponibles en cada momento. 3.2.6 Radiocontrol Con la finalidad de comunicar y controlar la aeronave se requiere un sistema de comunicaci\u00f3n por radio frecuencia (Transmisor -Receptor) el cual deber\u00e1 disponer de un m\u00ednimo de canales igual al n\u00famero de motores de la aeronave. Existen una gran variedad de m\u00f3dulos de comunicaciones y con distintos tipos de modulaci\u00f3n. En el transmisor se deber\u00e1 disponer de una serie de mandos usualmente palancas o Sticks de dos ejes que permitan el control de la aceleraci\u00f3n ( throttle ) y la rotaci\u00f3n del angulo (yaw) por un lado y el de los \u00e1ngulos (roll) y (pitch). Actualmente existen dispositivos con mayor n\u00famero de canales para control de otras opciones como modos de vuelo, tren de aterrizaje plegable, etc.. Siendo comunes los sist emas de 8, 16 y 32 canales. 3.2.7 Telemetr\u00eda Los sistemas de telemetr\u00eda a bordo de la UAV como indica su propia definici\u00f3n permiten obtener datos f\u00edsicos a bordo d e la aeronave en tiempo real y enviarlos a la estaci\u00f3n de control en tierra. Estos operan seg\u00fan la regulaci\u00f3n local en el las frecuencias de 433Mhz y 915 M Hz, realizando la comunicaci\u00f3n con el controlador de vuelo de abordo a trav\u00e9s de puerto de comunicaci\u00f3n serial UART ( Universal Asynchronous Receiver - Transmiter ). 3.2.8 Bater\u00eda Estas unidades suelen utilizar para su autonom\u00eda de funcionamiento bater\u00edas de Pol\u00edmero de litio, (Li -Po) ya que ofrecen una mayor densidad de carga a las tradicionales de ion- litio, un tama\u00f1o m\u00e1s reducido y menor peso. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 23 de 374 [Ir al \u00edndice] 3.3 Detecci\u00f3n del fuego Como se ha indicado en los primeros cap\u00edtulos existen sistemas para la detecci\u00f3n de incendios mediante c\u00e1maras situadas en el terreno y que hace uso de t\u00e9cnicas de procesado llevarla a cabo. Di cha detecci\u00f3n se puede realizar mediante la detecci\u00f3n del fuego o bien mediante la detecci\u00f3n del humo ya que ambos son indicadores de los incendios forestales. Sin embargo son caracter\u00edsticas distintas ya que fuego se mantiene siempre en un mismo sitio pero este es muy variante por el avance del fuego y sus colores tienen la caracter\u00edstica de ser muy vivos, mientras que el humo tiende a moverse y expandirse hacia la atmosfera y sus colores son muy apagados, esto hace que la detecci\u00f3n de uno u otro sean pr ocesos diferentes. La detecci\u00f3n del fuego se puede realizar de diversas formes en funci\u00f3n de la c\u00e1mara utilizada as\u00ed: Mediante C\u00e1mara IR (Infrarroja): Los infrarrojos son una banda del espectro radioel\u00e9ctrico por debajo de la luz visible sobre la que radi an los objetos al producir calor. Mediante c\u00e1mara de espectro visible: En estas el fuego presenta un color caracter\u00edstico y diferenciado de otros elementos que puede facilitar su detecci\u00f3n. En este sentido la c\u00e1mara infrarrojo presenta un nivel m\u00e1s altos de falsos positivos ya que la vegetaci\u00f3n tiende a alcanzar mayores temperaturas los efectos solares acumulando calor y radiando un fuerte espectro infrarrojo, igualmente se producen falsos negativos por que la atmosfera aten\u00faa la banda infrarroja en grabac iones a distancia. 3.3.1 Detecci\u00f3n del fuego mediante su color El modelo m\u00e1s usual para el almacenamiento de im\u00e1genes es el modelo RGB (Red, Green, Blue) el cual se basa en que cualquier color puede ser representado con una combinaci\u00f3n de los tres colores denominados primarios, rojo, verde y azul. Dada la caracter\u00edstica del color del fuego que var\u00eda entre naranja y amarillo hace que en el modelo RGB presente grandes cantidades de muy grandes de rojo, grandes de verde y muy escasos de azul, esta caracteriza ci\u00f3n es la que permitir\u00e1 llevar a cabo su detecci\u00f3n entre los otros elementos de una imagen. Sin embargo el modelo RGB presenta el problema est\u00e1 en que la uni\u00f3n entre el fuego y otros elementos si bien es posible el establecer la frontera resulta altamente complejo. Para solucionar este problema se hace uso del modelo de color HSV el cual se compone de tres variables: tono ( Hue), saturaci\u00f3n y brillo (value ). Asi la saturaci\u00f3n indica lo alejado que esta el valor del eje blanco y neg\u00f3 mientras que el brillo representa la altura del valor dentro del eje blanco y negro. Este modelo de color permite establecer las del imitaciones de una forma m\u00e1s sencill a y con un alto porcentaje de acierto permitiendo de una forma r\u00e1pida determinar qu\u00e9 elementos son fuego en una imagen. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 24 de 374 [Ir al \u00edndice] 3.3.2 Detecci\u00f3n del fuego por humo Debido a las problem\u00e1ticas expuestas puede ser m\u00e1s factible buscar humo que buscar fuego ya que este puede observarse desde una fase m uy precoz del incendio y a mayores distancias mientras que el fuego La detecci\u00f3n del humo se hace en base a cuatro caracter\u00edsticas: Novedad: El humo ser\u00e1 un elemento nuevo que aparece en una secuencia de video Velocidad: El Humo se mueve a baja velocidad frente a otros nuevos elementos Tonalidad: Su color tiende a ser blanco- gris Volumen: El humo ser\u00e1 un elemento grande. De acuerdo a estas cuatro carac ter\u00edsticas el algoritmo para la detecci\u00f3n del humo se realiza mediante cuatro etapas o procesos en la imagen que son: Sustracci\u00f3n de fondo: En una secuencia de video detectara aquellos elementos que sean nuevos. Eliminaci\u00f3n de elementos r\u00e1pidos : Se queda c on los elementos r\u00e1pidos Detecci\u00f3n de color: Descarta aquellos colores que sean distintos del humo An\u00e1lisis de componentes conexas: Los elementos deber\u00e1n ser suficientemente grandes Adem\u00e1s existe una quinta etapa que es el no aprendizaje, lo que asegura que los elementos clasificados como humo no sean aprendidos por el algoritmo y dejen de ser detectado en la sustracci\u00f3n de fondo que detecta los elementos nuevos. La detecci\u00f3n de humo es m\u00e1s factible en sistemas fijo ya los movimientos capara pueden hacer que la etapa de sustracci\u00f3n de fondo no sea validad al entender el movimiento como un elemento nuevo y los descarte. Para contrarrestar los movimientos r\u00e1pidos se pueden aplicar varias t\u00e9cnicas, existe una t\u00e9cnica que cosiste en eliminar las detecciones que no se producen de forma continuada. 3.4 Descripci\u00f3n Funcional de la UAV en la detecci\u00f3n de incendios forestales Se han visto en apartados anteriores los componentes b\u00e1sicos de la unidad Dron, para explicar la funcionalidad de la unidad se describen a continuaci\u00f3n las funciones b\u00e1sicas de cada uno de los subsistemas que se incorporaran a la aeronave para cumplir los objetivos de detecci\u00f3n de incendios forestales: Estructura y sist ema de propulsi\u00f3n: Su estructura , en fibra de carbono, permitir\u00e1 el acople del sistema de propulsi\u00f3n el cual se basa en el modelo de cuatro motores el\u00e9ctricos descrito en apartados anteriores y debidamente regulados mediante dispositivos ESC. A esta estruc tura se incorporara un sistema de anclaje y estabilizaci\u00f3n ( Gimbal ) donde ser\u00e1 instalada la unidad del sistema central la cual incorpora el dispositivo de captura de video (C\u00e1mara ). Dicho sistema de anclaje permite la rotaci\u00f3n sobre 2 ejes (opcional 3 ejes) proporcionando as\u00ed al sistema de captura de video la estabilidad necesaria, independientemente de las variaciones que pueda sufrir la aeronave como consecuencia de su navegaci\u00f3n, para efectuar la grabaci\u00f3n y/o la visi\u00f3n imagen de video. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 25 de 374 [Ir al \u00edndice] Sistema Central : Esta es la encargada del control y coordinaci\u00f3n de todos los subsistemas de la UAV. Para ello: o Realiza la gesti\u00f3n y control de los dispositivos de comunicaciones que permit en a la unidad su acceso a la red internet de forma inal\u00e1mbrica, as\u00ed como la interacci\u00f3n del sistema con el usuario final. o Estar\u00e1 dotada de diversos modos de comunicaci\u00f3n como son: Adaptador r ed inal\u00e1mbrica (Wi- Fi), sistema de radiocontrol de corto alcance (2.4Ghz) modem GSM -GPRS . (Global System Mobile -General Packet Radio Service) y sistema de transmisi\u00f3n de video (5.8GHz). o Realizara las funciones de captura de video y grabaci\u00f3n de im\u00e1genes , presentando dicha captura de video a trav\u00e9s de su salida AV compuesto (Audio- Video Compuesto), a la cual le ser\u00e1 superpuesta en un paso previo mediante el sistema OSD ( On Screen Display ) todos los datos de telemetr\u00eda. En su conjunto la se\u00f1al de video obtenida ser\u00e1 aplicada al transmisor de video con lo que se obtendr\u00e1 sobre dichas capturas el posicionamiento exacto de las mismas present\u00e1ndolas en la propia transmisi\u00f3n de video realizada por la unidad. Sistema Controlador de Vuelo: Es ta realiza las funciones de piloto de abordo de la unidad, al igual que las funciones de obtenci\u00f3n de datos de geo-.posicionamiento y de telemetr\u00eda poni\u00e9ndolos a disposici\u00f3n de la unidad central mediante su interface UART . Igualmente llevara a cabo los planes de vuelo programado que el usuario le asigne a trav\u00e9s de la unidad de sistema central y permitir\u00e1 el control manual de vuelo mediante radio enlace de corto alcance (aprox. 1Km). Sistema de sensores (US) estos ser\u00e1n los encargados de la medici\u00f3n de los factores atmosf\u00e9ricos de la zona poni\u00e9ndolos a disposici\u00f3n de la unidad central mediante su interface de comunicaciones I2C (Inter-Integrated Circuit ) \u00f3 SPI ( Serial Peripheral Interface) por los cuales disponen de comunicaci\u00f3n con el sistema central. Aplicaci\u00f3n de Monitorizaci\u00f3n y Control por el usuario, dicha aplicaci\u00f3n est\u00e1 ubicada en servidor WEB remoto proporcionando al usuario una interfaz para interacci\u00f3n con la unidad y visualizaci\u00f3n de la informaci\u00f3n en todo momento. Unidad de alimentaci\u00f3n (bater\u00eda) : Esta ser\u00e1 la encargada de dotar a la unidad de la energ\u00eda el\u00e9ctrica necesaria para su correcto funcionamiento, proporcionando una autonom\u00eda de vuelo m\u00ednima de 15 minutos . Su funcionamiento es el siguiente: Posicionada la unidad Dron en una estaci\u00f3n base esta quedara en modo de espera para ser comandada en alguno de sus posibles modos los cuales son: Modo manual mediante emisora de radio c ontrol (2.4GHz) de corto alcance. Modo remoto mediante conexi\u00f3n remota para realizaci\u00f3n de vuelo programado. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 26 de 374 [Ir al \u00edndice] El sistema en el estado de reposo en su base aceptara conexiones remotas desde el centro de control, permitiendo al usuario realizar la programaci\u00f3n de planes de vuelo. Durante dicho plan de vuelo la unidad recabara los datos necesarios de los correspondientes subsistemas incorporado s a la unidad. Efectuado el tratamiento de datos correspondiente ser\u00e1n enviados a la aplicaci\u00f3n WEB para su monitorizaci\u00f3n a la vez que efect\u00faa el registro de los datos correspondientes factores clim\u00e1ticos y de posicionamiento GPS en la base de datos para s u posterior tratamiento, si se requiere, por parte del usuario. Si el sistema en estado de reposo es controlado en modo manual, el transmisor de corto alcance estar\u00e1 dotado de un receptor de video a trav\u00e9s del cual la persona que efect\u00faa el control podr\u00e1 disponer en pantalla de la captura de video realizada por el sistema a la vez que podr\u00e1 pilotar el Dron mediante vuelo guiado por video FPV ( Firs Person View ). 3.4.1 Diagrama de Bloques de la aplicaci\u00f3n En la siguiente figura se represente el diagrama de bloque de la aplicaci\u00f3n. Figura 7 Diagrama bloque Aplicaci\u00f3n Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 27 de 374 [Ir al \u00edndice] 3.4.2 Posicionamiento y Comunicaci\u00f3n en la Red El sistema queda posicionado en la Red de las siguientes formas : Mediante la implementaci\u00f3n de un servidor WEB (Local) propio, el cual puede ser configurado en sus valores de IP, y puerto de uso HTTP. Dicho servidor podr\u00e1 ser debidamente programado para que a la unidad pueda presentar para su monitorizaci\u00f3n los datos atmosf\u00e9ricos obtenidos en el muestreo que realiza, el posicionamiento GPS de la estaci\u00f3n, el estado de las redes de que dispone ( Wifly , GSM -GPRS), e incluso si est\u00e1 en estado de reposo podr\u00e1 activar servidor CAM permitiendo visionar su entorno. (En la figura 8 se puede ver captura la p\u00e1gina de instalaci\u00f3n del servidor Local de la unidad Dron ). Mediante el uso de red GSM -GPRS, la unidad podr\u00e1 efectuar env\u00edos de mensajes SMS, y de tramas de datos via GPRS. Pudiendo ser tambi\u00e9n localizada mediante apl icaciones existentes para la localizaci\u00f3n y posici\u00f3n de dispositivos de telefon\u00eda m\u00f3vil. En anexo B Manual de montaje pueden verse pruebas efectuadas del env\u00edo de SMS a mediante la unidad. Otra mediante el uso de un servidor WEB de aplicaci\u00f3n (requiere bien un Equipo servidor WEB o bien un hosting en la r ed). Este debe ser instalado en la red, a trav\u00e9s de este el sistema adem\u00e1s de monitorizar los datos anteriormente indicados, permite la interacci\u00f3n del usuario con el sistema. (En la figura 9 puede observarse una captura de la p\u00e1gina principal de la aplicaci\u00f3n WEB ). Figura 8 Servicio WEB Unidad Dron Figura 9 Aplicativo WEB Estas Web se han posicionado y configurado en las siguientes direcciones: La aplicaci\u00f3n WEB estar\u00e1 alojada en servidor instalado expresamente para el desarrollo de este proyecto en la URL: https://infoteli.org/proto . El servidor WEB local alojado en la unidad Dron ser\u00e1 accesible mediante la U RL: http://www.infoteli.org:8090 o bien desde el aplicativo WEB en la opci\u00f3n de men\u00fa WEB Dron. Dado que ha sido implementado como mejora con la finalidad de ver la posibilidad de of recer video las capturas de video mediante esta otra opci\u00f3n actualmente no se ha programado ninguna aplicaci\u00f3n web para el presentando \u00fanicamente como puede verse en la figura 8 la p\u00e1gina de instalaci\u00f3n. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 28 de 374 [Ir al \u00edndice] 3.4.3 Interacci\u00f3n entre los diferentes Sub- Sistemas Como puede verse en el diagrama de bloques aplicaci\u00f3n (Figura 7 ), existe interconexi\u00f3n con diferentes dispositivos y aplicaciones, realiz\u00e1ndose estos mediante los diversos medios de comunicaci\u00f3n as\u00ed los m\u00e1s destacados son: Entre dispositivo GPS y unidad de controlador de vuelo se lleva a cabo mediante un puerto UART Entre dispositivo Compas y Aceler\u00f3metro se realiza mediante bus I2C del controlador de vuelo los cuales son accesibles mediante el sistema central por UART, haciendo uso del protocolo MAVlink (Micro Air Vehicule Comunication Protocol ). Entre dispositivo regulador potencia motores y controlador de vuelo a trav\u00e9s de sus puertos PWM. Sistemas de comunicaci\u00f3n con Usuario puede efectuarse mediante los siguientes medios: o Enlace Radio Control TX -RX (2.4GHz) o Enlace v\u00eda LAN-WAN (Protocolo MAVLink) haciendo uso del Software espec\u00edfico Mission Planner para planificaci\u00f3n de planes de vuelo o Enlace v\u00eda LAN -WAN mediante conexi\u00f3n SSH se ten dr\u00e1 acceso al sistema central. o Enlace v\u00eda GSM -GPRS Sistema de Monitorizaci\u00f3n WEB LOCAL haciendo uso de dispositivo Wi -Fi. Sistema comunicaci\u00f3n con usuario mediante PC hace uso de dispositivo USB Los dispositivos sensores instalados en el sistema efect\u00faan comunicaci\u00f3n a su vez por distintos buses esto son: - Sensor Temperatura- Humedad DTH22 utiliza BUS SPI (de un \u00fanico hilo) - Sensores de Temperatura Presi\u00f3n, y Luminosidad mediante Bus I2C En la siguiente figura pueden verse detallados la los distintos interf aces de comunicaci\u00f3n de los que hace uso cada dispositivo y aplicativos. Figura 10 Diagrama Bloques interacci\u00f3n objetos del sistema Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 29 de 374 [Ir al \u00edndice] 3.4 Aplicaci\u00f3n control y monitorizaci\u00f3n El sistema interact\u00faa con el usuario de tres formas diferentes: Conexi\u00f3n directa mediante teclado y monitor con al sistema central, o bien mediante un PC de forma remota por conexi\u00f3n SSH, o haciendo uso igualmente de forma remota mediante software espec\u00edf ico de aplicaci\u00f3n ( Mission Planner ) Mediante el uso de emisora de control de RF(2.4GHz), para Radio- Control de la UAV.. Mediante Aplicativo WEB, a trav\u00e9s de internet. 3.4.1 Dise\u00f1os interfaces usuarios Figura 11 Interfaz opci\u00f3n Men\u00fa Localizaci\u00f3n Unidad. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 30 de 374 [Ir al \u00edndice] Figura 12 Interfaz Opci\u00f3n Men\u00fa Servicios NAS. Figura 13 Interfaz Opci\u00f3n Men\u00fa Configuraci\u00f3n Red Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 31 de 374 [Ir al \u00edndice] 3.3 Diagrama Estructura aplicativo WEB Figura 14 Diagrama Estructura Aplicaci\u00f3n WEB Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 32 de 374 4. Descripci\u00f3n detallada del Hardware [Ir al \u00edndice] 4.1 Requisitos m\u00ednimos Sistema Central y Controlador de Vuelo El Sistema Central deber\u00e1 de cubrir unas m\u00ednimas prestaciones y cumplir con unos requisitos como son: Disponer de buses con los distintos protocolos como son UART, I2C, SPI, Disponer de la posibilidad video en alta definici\u00f3n Una velocidad de procesado que permita \u00e9l envi\u00f3 mostrar en su salida de video las capturas realizadas en tiempo real y en una definici\u00f3n aceptable para posterior procesado del mismo. Reducido tama\u00f1o para poder ser ubicada en la unidad Dron y a ser posible con la posibilidad de incorporar se a esta como un m\u00f3dulo ensambl\u00e1ndose de forma f\u00e1cil Posibilidad de almacenamiento externo que pudiera requerir para grabaci\u00f3n de video e im\u00e1genes. Bajo consumo y reducido tama\u00f1o. A estas m\u00ednimas prestaciones es deseable un mayor coste y que sea de f\u00e1cil adquisici\u00f3n sin problemas en proveedores por las li mitaciones de tiempo existentes al igual que disponga de comunidades que apoyen dichos proyectos y puedan aportar un soporte m\u00ednimo en sistemas operativos y librer\u00edas para su uso. Se ha podido observar a t rav\u00e9s de b\u00fasquedas de informaci\u00f3n en internet ver que existen en el mercado amplia variedad de dispositivos con prestaciones muy similares a las de un PC, pero con unas dimensiones muy reducidas (mini -PC). A continuaci\u00f3n se presentan tres dispositivos mini -PC que posibles candidatos a ser seleccionados para su uso como sistema central. Raspberry PI 2 A20 OLinuXino Lime2 Radxa Rock Pro CPU Quad ARM Cortex - 1,6MHz GPU Video Core IV Mali 400 GPU Mali 400 RAM 1GB 1GB 2GB 8GB NAND Flash USB 4 2 2 Video Compuesto y HDMI HDMI RGA, HDMI Audio Jack HDMI HDMI RGA Boot Micro SD Micro SD Digital S/PDIF, Jack, micro integrado en placa. Red Ethernet 10/100 1000 Ethernet 10/100M Wifi Buses UART(1),I2C(1), SPI(1) UART(1),I2C(1), SPI(1) UART(1),I2C(1), SPI(1) SI NO Interfaces Adic. CSI ( C\u00e1mara ) y LCD NO IR, a 800mA 500mA a 1200mA 800mA a 2000m A Alimentaci\u00f3n Micro USB/GPIO USB Tama\u00f1o x 56 mm 84X60mm 100x80 Precio 50\u20ac 45\u20ac 95\u20ac Tabla 1 Comparativa mini -PC Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 33 de 374 [Ir al \u00edndice] Actualmente existen diversas comunidades que trabajan en proyectos para el desarrollo de firmware y software para el control de vuelo de Drones de diverso t ipo como son: M ulti-rotores, aviones, helic\u00f3pteros, etc... A se presenta una lista de los proyectos existentes actualmente en open -source . PROYECTOS Controladores Soporte Sensores Configuraciones Mag, Alt. Tri, Quad, Hexa Octo. Tabla 2 Proyectos Controladores vuelo de c\u00f3digo abierto De estos hemos podido comprobar que APM Copter, anteriormente ArduPilotMega de donde ha tomado sus actuales APM, es la m\u00e1s consolidada trabajando activamente en desarrollo de veh\u00edculos a\u00e9reos y terrestres dispone de diferentes categor\u00edas[x] siendo su controlador cl\u00e1sico el ATMega2560 inspirado en Arduino. Esta comunidad desarrolla firmware diferenciado para cada tipo de configuraci\u00f3n, siendo su software caracter\u00edstico el APM:Mission Planner. Actualmente esta comunidad est\u00e1 desarrollando un controlador basado en microprocesador STM32 el cual presenta mejoras importantes en cuanto a capacidad de c\u00f3mputo y con opciones para agregar segundos dispositivos de telemetr\u00eda y GPS entre otros. Para el desarrollo del proyecto se requerir\u00e1n otros componentes electr\u00f3nicos as\u00ed como herramientas espec\u00edficas tanto de electr\u00f3nica como de inform\u00e1tica. Por lo que a continuaci\u00f3n se pasa a describir cada uno de los componentes seleccionados Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 34 de 374 [Ir al \u00edndice] 4.2 Descripci\u00f3n de los m\u00f3dulos seleccionados 4.2.1 CPU Sistema Central y Captura -Procesado de video Para el control del sistema central y el procesado de las captura de video se ha seleccionado la mini -PC Rasperry Pi 2 B. El motivo de su selecci\u00f3n respecto a las otras presentadas es el disponer de su propia interfaz para c\u00e1mara de video existiendo actualmente c\u00e1maras IR (Infrarroja) y NoIR (No Infrarroja) espec\u00edficas de Raspberry Pi de un relativo bajo coste. Otro motivo ha sido el disponer de hasta 4 puertos USB de los que se tiene previsto utilizar tres. Figura 15 Sistema embebido Raspberry pi 2+ B De igual manera se ha podido ver que existe un buen soporte de apoyo por parte de la comunidad Raspberry Pi con c\u00f3digo open -source en la Red, diversos sistemas operativos a utilizar incluyendo el sistema operativo de tiempo real RT Linux, lo que permitir\u00e1 en futuros trabajos poder llevar a cabo mejoras en el proyecto. 4.2.2 MCU Controlador de vuelo Como sistema controlador de vuelo se ha seleccionado al APM Copter 2.6 con procesador A Tmega 2560. El sistema ArduCopter cuenta con capacidad de vuelo aut\u00f3nomo basado en way -point , planificaci\u00f3n de la misi\u00f3n y telemetr\u00eda en tiempo real a trav\u00e9s de una estaci\u00f3n en tierra. Motivo por el que se ha seleccionado ya que la mayor\u00eda de las soluciones para multi -rotores s olo cuentan con soporte por radiocontrol. Si bien existe una MCU superior actualmente como es la Pixhawk esta tiene un coste m\u00e1s elevado y aunque incluye mejoras sustanciales como son: L a posibilidad de conexi\u00f3n de Figura. 16 Arduino APM Copter 2.6 (ArduCopter) un segundo dispositivo GPS, un procesador con una mayor potencia de c\u00e1lculo as\u00ed como un n\u00famero mayor de puest os dicho no son necesarios para este proyecto. Por otro lado, el APM 2.6 ArduCopter presenta ventajas como ser multiplataforma por lo que es compatible con Windo ws, Mac y Linux. La utilidad de configuraci\u00f3n y planificaci\u00f3n puede ser utilizada en entorno gr\u00e1fico o bien mediante l\u00ednea de comandos utilizando el protocolo MAVLink lo que permite que pueda ser planificado a trav\u00e9s de redes donde el ancho de banda este limitado e incluso con programaci\u00f3n adecuada mediante GSM . Por ultimo indicar que es totalmente compatible con est\u00e1ndares de la industria de rob\u00f3tica l\u00edderes como son el sistema ROS, o el protocolo MAVLink el cual permite a trav\u00e9s de una librer\u00eda poco pesada recibir los datos del dispositivo controlador de vuelo y enviarle comandos, pudi\u00e9ndose empaquetas estructura C a trav\u00e9s de canales seria con eficacia y enviar dichos paquetes a la estaci\u00f3n de control en tierra. Razones estas que unidas a su bajo co ste lo convierten en ideal para este proyecto. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 35 de 374 [Ir al \u00edndice] 4.2.3 Estructura Quap -rotor (TAROT IRON 650) La estructura se selecciona en fibra de carbono por sus caracter\u00edsticas de peso -resistencia y dada la cantidad de dispositivos que se han de acoplar y teniendo presente que la unidad no debe superar 2,5 kg de peso para que pueda quedar incluida en normativa vigente [7]. Se espera un peso total de 2Kg. De las diversas estructuras vistas en este material se selecciona la referenciada como TAROT IRON 65 0 por su coste y posibilidades Figura. 17 Estructura TAROT IRON 650 de adaptaci\u00f3n ya que esta s er\u00e1 sometida a modificaciones para el correcto acople de los dispositivos de captura y diversos m\u00f3dulos de comunicaciones. Esta estructura tiene como especificaciones: Distancia entre sus ejes 650mm Peso total bruto: 450g/480g Configuraci\u00f3n recomendada por fabricante H\u00e9lices de 14- 17 pulgadas. 5.2.4 Motores propulsores El motor seleccionado es un motor Brushless (sin escobillas ) estos proporcionan movimientos suaves y r\u00e1pidos , presentando ventajas frente a los motores comunes de DC (Corriente continua) como son: Mayor eficiencia (menos perdidas por calor) Mayor rendimiento (por tanto mayor duraci\u00f3n bater\u00edas) Menor peso a la misma potencia Requieren un menor mantenimiento Figura 18 Motor brushless A2212/13T (1000Kv) Relaci\u00f3n velocidad/par motor casi constante Mayor pot encia en el mismo tama\u00f1o Mejor disipaci\u00f3n de calor Rango de velocidad elevado a l no tener limitaci\u00f3n mec\u00e1nica Menor ruido electr\u00f3nico Como desventajas presentan un mayor costo de construcci\u00f3n, requieren de un circuito de control m\u00e1s complejo y siempre necesario para su funcionamiento. Por otro lado los motores normales con escobillas son m\u00e1s propensos , debido a los roces , a producir chispas y aver\u00edas. De la de nominaci\u00f3n de dada en un motor (p.e A2212/13T -1000KV) se puede conocer que: Los dos primeros d\u00edgitos (22): Es el d i\u00e1metro de la parte interna del motor (estator) en mil\u00edmetros . Indican el torque que puede ejercer a mayor n\u00famero podr\u00e1 mover h\u00e9lices m\u00e1s grandes y con mayor pitch por tanto podr\u00e1 levantar mayor peso con menor velocidad. Los dos siguientes d\u00edgitos (12): Di\u00e1metro de la parte internet del motor medio en mil\u00edmetros. 1000KV: Indica las RPM (Revoluciones por minuto) por voltio. As\u00ed si se aplica una tensi\u00f3n de 11. 1 voltios (bater\u00eda de 3S) puede llegar a 11 100 RPM. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 36 de 374 [Ir al \u00edndice] Hay que tener en cuenta que a mayor RPM las h\u00e9lices deben ser m\u00e1s peque\u00f1as lo que permite grandes velocidades pero reducen en gran medida la eficiencia y por tanto el tiempo de vuelo. As\u00ed valores del orden de 2300 KV con h\u00e9lices de 5 a 7 pulgadas suelen ser utilizados para carreras. Mientras que motores del orden de 400KV a 900Kv, son utilizadas para Drones grandes con cargas pesadas, no son agiles ni r\u00e1pidos pero si muy estables aunque necesitan de h\u00e9lices m\u00e1s gran des por encima de 10 pulgadas. As\u00ed para la selecci\u00f3n del motor acorde a las RPM y fuerza de empuje que se requiere por motor puede efectuarse el c\u00e1lculo mediante la aplicaci\u00f3n de la f\u00f3rmula: =1.225(0.0254)2 40.0254 1 602 0.0254 =4.392399108()3.5 4.2333104 0 pitch=Prop. Pich (pulgadas). RPM= Rotaciones por minuto h\u00e9lice. D=prop. Di\u00e1metro (pulgadas). V0=Velocidad avance en m/s Para convertir Newtons en gramos basta con multiplicar por 1000 9.81 De una forma mucho m\u00e1s simplificada los fabricantes recomiendan para una primera aproximaci\u00f3n la formula general en base a la caracter\u00edstica del motor que proporcionan (KV) ()= ()2 \u00ba =2000 2 4=1000 En este caso se ha seleccionado el motor Brushless A2212/13T 1000Kv, seg\u00fan caracter\u00edsticas del fabricante con un empuje de 900gr, y un consumo m\u00e1ximo de 20A. En anexo correspondiente a manual de montaje se pueden observar los datos obtenidos de pruebas emp\u00edricas realizadas al motor seleccionado. 4.2.5 H\u00e9lices Las h\u00e9lices es un dispositivo el cual est\u00e1 constituido por un numero variable de aspas o palas (2, 3, 4,..) y que al girar alrededor de un eje producen una fuerza propulsora. Cada pala est\u00e1 formada por un conjunto de perfiles aerodin\u00e1micos los cuales cambian su Angulo de incidencia desde la ra\u00edz hasta extremo. En este caso las h\u00e9lices han sido proporcionadas en conjunci\u00f3n con los motores seleccionados por el propio fabricando las cuales son 12*4.5 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 37 de 374 [Ir al \u00edndice] 4.2.6 Regulador es Velocidad Motor es El regulador de velocidad del motor (ESC) se ha seleccionado el m\u00f3dulo EMAX ESC 30A x4, principalmente por guardar un amplio margen en su capacidad de suministrar intensidad (30A) frente al consumo m\u00e1ximo del motor seleccionado (25A) y permite bater\u00edas de 2s a 4s lo que posibilita en un futuro incluir si fuese necesario unos motores de may or potencia haciendo uso de bater\u00edas de voltaje (14.8). Por ultimo su dise\u00f1o presentando los cuatro reguladores necesarios en un \u00fanico bloque los cuatro reguladores permitir\u00e1 su acople en el centro de Figura.19 ESC EMAX 4In1 30A la estructura utilizada y no en los brazos lo que mejora el dise\u00f1o 4.2.7 Modulo GPS y Brujula HMC5883L Incluye GPS NEO -6M Compatible con el protocolo NMEA, ( National Marine Electronics Association ). Dispone de interface serie a trav\u00e9s de la cual el sistema de control recibir\u00e1 de la red satelital datos de posicionamiento, altitud etc... Se ha seleccionado este m\u00f3dulo ya que Incluye una br\u00fajula digital con conexi\u00f3n por bus I2C mediante la cual se dota al sistema de la capac idad de indicaci\u00f3n de direcci\u00f3n a donde se dirige y la orientaci\u00f3n del dispositivo en todo momento. Igualmente el modulo es compatible con el APM Copter seleccionado Modulo modem GSM dual banda, el cual permitir\u00e1 la comunicaci\u00f3n de voz con el dispositivo a la vez que posibilita el env\u00edo de mensajes y transferencia de datos mediante GPRS . Siendo as\u00ed posible comunicar con la unidad desde cualquier localizaci\u00f3n. Figura.21 Modulo GPS NEO -6M 4.2.9 Sistema Radio -Control RF (2.4GHz) Mediante este sistema de control se quiere obtener el control de la unidad en distancias cortas (para uso por el equipo de extinci\u00f3n como unidad de apoyo). Este se encuentra constituido por: Un emisor de radiofrecuencia Turningy 9XR PRO. Seleccionado principalmente por ser un dispositivo profesional el cual permite de forma f\u00e1cil (mediante cambio de m\u00f3dulo), hacer uso de diversos tipos de m\u00f3dulos transmisores pudiendo ser utilizado para diversas frecuencia s, igualmente permite conexionado de pantalla para FPV (Vuelo guiado por Video) teniendo en cuenta calidad precio no permite disponer de un control fiable. Figura 22 Emisor RF Turnigy 9x Pro Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 38 de 374 [Ir al \u00edndice] M\u00f3dulos TX RX (2,4Ghz). En la emisora se utilizara un Transmisor TX Fr Sky 2.4GHz, y en la unidad Dron m\u00f3dulo RX FrySky X8R en frecuencia de 2.4GHz el cual est\u00e1 dotado de 8 canales se ha seleccionado este modelo pues tiene la posibilidad de ampl iar hasta 16 canales y dispone de telemetr\u00eda. Igualmente su relaci\u00f3n calidad precio lo hace asequible a las posibilidades del proyecto. Figura 23 M\u00f3dulos Transmisor y Receptor Fr Sky 8Ch 5.2.10 Sistema Transmisi\u00f3n - Recepci\u00f3n Audio- Video (5,8Ghz) Transmisor Audio- Video Boscam 5832 Se ha seleccionado por se r ideal por su potencia, que en principio no supera los 600mW lo que posibilita si es necesario hacer uso de amplificador existente en mercado pudiendo ampliar potencia hasta 2,5W, (hay que tener en cuenta la legalidad vigente en este sentido)[2]. Por otro lado haciendo uso de antena circular la cual seg\u00fan caracter\u00edsticas indicadas por fabricante garantiza una alcance de 1Km a 1'5Km con una potencia de 600mW. Figura 24 M\u00f3dulos Transmisor Audio- Video 5'8Ghz Receptor A udio-Video Boscam RC805 Se ha seleccionado el receptor RC805 el cual es acorde con los canales de transmisi\u00f3n del transmisor seleccionado, ambos han sido seleccionado principalmente por su relaci\u00f3n calidad- precio, y teniendo en cuenta el alcance indicado en caracter\u00edsticas por el fabri cante. Figura 25 M\u00f3dulo Receptor Audio- Video 5'8Ghz 5.2.11 Visualiz ador de datos en pantalla OSD (On Screen Display ) Es un sistema que puede ser programado para disponer los datos de telemetr\u00eda as\u00ed como el sistema de pilotaje de la UAV en pantalla. Lo que permitir\u00e1 sin necesidad de consumo de recursos del sistema poder activarlo y sobre impresionar dichos los datos sobre la salida de video en paso previo a ser transmitidos. Figura 26 OSD (On Screen Display) Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 39 de 374 [Ir al \u00edndice] 4.2.12 Sensor presi\u00f3n atmosf\u00e9rica La presi\u00f3n se define como la fuerza que se ejerce sobre un \u00e1rea o superficie. Existen cinco tipos de presi\u00f3n: Presi\u00f3n absoluta, presi\u00f3n atmosf\u00e9rica o barom\u00e9trica, presi\u00f3n diferencia, presi\u00f3n positiva relativa y presi\u00f3n negativa relativa, este proyecto se centra en la presi\u00f3n atmosf\u00e9rica o barom\u00e9trica. La presi\u00f3n barom\u00e9trica es la que ejerce el aire en cualquier punto de la atm\u00f3sfera, de ah\u00ed que se hable de forma general de presi\u00f3n atmosf\u00e9rica terrestre. Esta presi\u00f3n var\u00eda ligeramente con las condiciones meteorol\u00f3gicas y disminuye con la altitud. Existen diversos m\u00e9todos para su medici\u00f3n como son mec\u00e1nicos, neum\u00e1ticos, electromagn\u00e9ticos y elementos electr\u00f3nicos. Dentro de est os se conocen cuatro tipos de sensores: Capacitivos, Sensor de Hall, sensor piezo -resistivo y sensor monol\u00edtico. Sensor seleccionado: Efectuando algunas comparativas de los sensores vistos en el mercado se ha seleccionado el sensor MPL115A, principalmente por su bus de comunicaci\u00f3n I2C, por su bajo consumo, alta precisi\u00f3n y reducido tama\u00f1o. El dispositivo esta calibrado en fabrica y se corresponde con el tipo de sensor monol\u00edtico. Fig 27 Sensor Presi\u00f3n MPL115A PRESION Unidades min. T\u00edpica Max Resoluci\u00f3n kPa - 0.15 - Bit 16 16 16 Rango KPa 50 - 115 Conversi\u00f3n Time ms 1.6 3 VDD Voltios 2.3 3.3 5.5 Tabla 3 Caracter\u00edsticas Sensor presi\u00f3n MPL115A 4.2.13 Sensor Iluminaci\u00f3n y proximidad La radiaci\u00f3n solar se define como el conjunto de radiaciones electromagn\u00e9ticas emitidas por el Sol, las cuales para alcanzar la superficie terrestre han de pasar la capa de ozono la cual absorbe la mayor parte de radiaci\u00f3n. Su magnitud de medida es la irradiancia, la cual nos indica la energ\u00eda por unidad de tiempo y \u00e1rea cuando alcanza la tierra. Su unidad son los W/m2 aunque existe otra conocida como Lux. Esta es la luminosidad (lumen) por metro cuadrado. Esta ser\u00e1 la que se utilizara a lo largo de este proyecto. Aunque no existe conversi\u00f3n directa entre Lux y W/m2 si existe una equivalencia en funci\u00f3n de la longitud de Onda. Aqu\u00ed hemos de indicar que en principio seleccionamos dos sensores independientes el S1087, pero que debido a plazos de entrega de proveedores se ha tenido que sustituir por uno m\u00e1s est\u00e1ndar el cual si fue recibido dentro de los plazos. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 40 de 374 [Ir al \u00edndice] Sensor seleccionado: El sensor seleccionado para medici\u00f3n de Iluminaci\u00f3n es el VCNL4010, debido a sus reducidas dimensiones, bajo consumo y una buena precisi\u00f3n. Fig. 28 Sensor Iluminaci\u00f3n- Proximidad ILUMINACION Unidades min. T\u00edpica Max Resoluci\u00f3n Luxes - 0.25 - Bit 16 16 16 Rango %HR 0.25 - 16383 PROXIMIDAD Resoluci\u00f3n mm Up 200mm Bit 16 16 16 Tabla 4 Caracter\u00edsticas Sensor Iluminacion -Proximidad 4.2.14 Sensor Medidor Temperatura y Humedad relativa La temperatura es una magnitud que hace referencia a la noci\u00f3n de calor o fr\u00edo. Esta puede expresarse en el S.I de Unidades por grados Kelvin, aunque tambi\u00e9n fuera del \u00e1mbito cient\u00edfico se hace uso de otras escalas como la escala cent\u00edgrado o Celsius, y la escala Fahrenheit, En este proyecto se hara uso de la escala Cent\u00edgrada o Celsius. Para llevar a cabo la conversi\u00f3n la ecuaci\u00f3n siguiente muestra c\u00f3mo realizarla: 16.273)(\u00ba )(\u00ba = KT CT La Humedad Relativa est\u00e1 definida como el porcentaje de vapor de agua que contiene el aire, este se mide en porcentajes, as\u00ed a nivel del mar si nos encontramos con un porcentaje del 90% indica que el aire contiene ese porcentaje del vapor de agua que puede admitir. En zonas seca s puede llegar a ser del 20%. Este factor est\u00e1 directamente relacionado con la temperatura y nivel de saturaci\u00f3n del aire. Sensor seleccionado: El sensor seleccionado para este proyecto ha sido el SHT 11, sin embargo debido a problemas con proveedores en plazos de entrega, los cuales superaban los plazos para poder cumplir la planificaci\u00f3n se ha utilizado uno similar concretamente el DHT22. Ambos son capaces de efectuar medidas de los dos par\u00e1metros indicados, temperatura y Humedad relativa, estando cali brados, se trata de un sensor de la familia CMOS el cual posee un converso r A/D (anal\u00f3gico/digital) de 14 bit, bajo consumo de energ\u00eda y peque\u00f1as dimensiones . En la siguiente tabla se pueden ver sus caracter\u00edsticas principales, tanto para la medici\u00f3n de Humedad Relativa como para la de Temperatura. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 41 de 374 [Ir al \u00edndice] Fig 29 Sensor Temperatura Humedad Relativa DHT22 HUMEDAD Unidades min. Tip. Max Resoluci\u00f3n %HR 0.5 0.03 0.03 Bit 8 12 12 Repetitividad %HR - 1.0\u00b1 - Rango %HR 0 - 100 TEMPERATURA Resoluci\u00f3n \u00baC 0.04 0.01 0.01 \u00baF 0.07 0.02 0.02 Bit 14 Repetitividad \u00baC 1.0\u00b1 - \u00baF - \u00baF -40 254.9 T abla 5 Caracter\u00edsticas Sensor Temperatura- Humedad Relativa 4.2.15 Sistema Estabilizador C\u00e1mara Video (Gimbal) El sistema estabilizador adquirido ha sido el DJI, ya que el que se hab\u00eda previsto marca Tarot no se ha podido adquirir por problemas de con el proveedor el cual no lo surtir\u00e1 hasta mes de febrero, este se utilizara de forma provisional ya que su tama\u00f1o no el apropiado (es peque\u00f1o para situar la Raspberry como se quiere hacer) en el soporte si bien se estudiara la forma en que puede modificarse sin que afecte al sistema estabilizador. Figura 30 Sistema estabilizador (Gimbal) 4.2.15 C\u00e1mara Pi La c\u00e1mara capturadora de video se opta por adquirirla correspondiente al sistema Raspberry Pi, para asi poder hacer uso de las ventajas que presenta la CPU de disponer de un bus exclusivo DSI el cual esta conectado directamente al procesador de video obteniendo un mayor rendimiento. Sus caracter\u00edsticas son: 5 megap\u00edxeles del sensor, Soporta 1080p / 720p / 640x480p Video, Capaz de 2592 x 1944 p\u00edxeles Im\u00e1genes est\u00e1ticas 25mm x 20mm x 9mm Huella Peso 3g Totalmente compatible con los casos ModMyPi Figura 31 Pi Camera Rev 1.3 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 42 de 374 [Ir al \u00edndice] 4.3 Sistema de Alimentaci\u00f3n 5.3.1 Selecci\u00f3n de Bater\u00edas La bater\u00eda a utilizar ser\u00e1 de Pol\u00edmero de litio (Li -Po) ya que estas ofrecen una mayor densidad de carga y tienen un tama\u00f1o m\u00e1s reducido as\u00ed como menor peso que las de tradiciones de ion- litio. Para la selecci\u00f3n de la bater\u00eda adecuada que proporciones los tiempos de vuelo que se necesitan (20min) se deber\u00e1 tener \u00e9l cuenta el consumo total de la unidad. Para ello en primer lugar se toma medida del consumo en estado de reposo efectuando transmisi\u00f3n de video para una vez conocido este poder determinar cu\u00e1l ser\u00e1 el consumo que la unidad tendr\u00e1 en vuelo incluyendo el que necesitan los distintos sistemas. Tomando medida emp\u00edricamente pude observarse en la figura de la izquierda que el consumo efectuando transmisi\u00f3n de video es de pr\u00e1cticamente de 1 Amperio. Esta Intensidad sera el c onsumo de los sistemas de la unidad dron (I Csistemas ) Consumo sistemas y transmisi\u00f3n video= ICsistemas =965mA Figura 32 Consumo Sistemas En la siguiente figura se puede ver las caracter\u00edsticas de trabajo del motor, relaci\u00f3n consumo -rpm y fuerza de elevaci\u00f3n en gramos correspondientes al motor utilizado A2212/T13 (1000Kv) Figura 33 Relaci\u00f3n consumo -rpm y fuerza elevaci\u00f3n motores Tabla 6x Relaci\u00f3n RPM Motor y consumo. Se puede extraer de l as caracter\u00edsticas mostradas (tabla xx) que l os consumos de un \u00fanico motor a m\u00e1xima potencia es de 13,81 A, por lo que el consumo total de los motores a m\u00e1xima potencia estar\u00e1 determinado por el n\u00ba de motores y dicho consumo m\u00e1s el consumo de los sistemas medido anteriorment e. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 43 de 374 [Ir al \u00edndice] =\u00ba + As\u00ed se tendr\u00e1 que en el momento de despegue (m\u00e1xima potencia) el consumo llegara a ser de: =\u00ba + =,+= Sin embargo los motores no se mantienen durante todo el vuelo a m\u00e1xima potencia sino que una vez realizado el despegue se establecer\u00e1 una velocidad de crucero que se estima en 60% (algo superior a la media velocidad). Por lo que el consumo de cada motor seria de aproximadamente 4.5 A , por tanto a dicha velocidad de crucero el consumo seria de: =,+=+= La vida \u00fatil de una bater\u00eda se calcula en base a su corriente nominal en miliamperios por hora (mAh) inversamente proporcional a la corriente de carga soportada y aplic\u00e1ndole un factor de tolerancia de un 0.7 por lo que para tener una vida \u00fatil de 20minutos se requerir\u00e1 una bater\u00eda con un capacidad de: = () . ()= . Por lo que para una autonom\u00eda de vuelo de 15 minutos=0.333 horas ()= . .=. Determinada la capacidad de la bater\u00eda se consulta modelos de bater\u00edas seleccionando dos posibles opciones, estas son: Zyppy modelo Compact N\u00famero de elementos: 3 Voltaje: mAh 360 g 145*51*24mm Conector de Conector bater\u00eda : 4mm Bullet Zyppy modelo Flightmax N\u00famero de elementos: 3 Voltaje 8000 mAh Descarga: 164*67*24mm Conector de equilibrado: si Conector bater\u00eda : 5mm conectores oro. Ambas puede observarse que la intensidad m\u00e1xima en pico cubre con amplio margen el amperaje del requerido en la acci\u00f3n de despegue y que en modo de descarga continua igualmente pueden suministrar la intensidad necesaria igualmente con un amplio margen. Por lo que se puede optar por instalar 2 bater\u00edas de 5000mAh en paralelo o bien una bater\u00eda de una capacidad de 8000mAh. Finalmente se selecciona la bater\u00eda Li.Po Zyppy modelo Flightmax ya que es suficiente para el tiempo de vuelo indicado y el coste es bastante inferior al que supone la compra de dos bater\u00edas del modelo Compact. Por ot ro lado dado se deja opci\u00f3n a una futura mejora la posibilidad de incorporar una segunda bater\u00eda en paralelo que pueda proporcionar un tiempo de vuelo, siempre y cuando el peso final de la UAV no exceda de 2,5Kg. Figura 34 Bater\u00eda LI- PO Zippy 3S 8000mAh Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 44 de 374 [Ir al \u00edndice] 4.3.2 Adapta ci\u00f3n niveles tensi\u00f3n alimentaci\u00f3n. La unidad Dron como se ha visto ser\u00e1 alimentada mediante bater\u00eda LiPo de tres celdas, obteniendo as\u00ed un voltaje de 11. 1V. Para la reducci\u00f3n de tensi\u00f3n se har\u00e1 uso de dos m\u00f3dulos de potencia con medici\u00f3n de intensidad y voltaje preparados para 5V y 3.3V . Concretamente se har\u00e1 uso de los m\u00f3dulos espec\u00edficos para Arduino Arduflyer Power Module V1.0 Este m\u00f3dulo de potencia ofrecer\u00e1 una alimentaci\u00f3n de 5V a partir de una bater\u00eda LiPo (11.1V) y reportara la medici\u00f3n de consumo de corriente y voltaje de la bater\u00eda a trav\u00e9s del su conector de salida de 6 pines. Sus caracter\u00edsticas son: Figura 35 Modulo de potencia V1.0 - Max Voltaje entrada 25V - Max medici\u00f3n Amp. 90A - Salida 5.3V y 3.3V. - Intensidad Max salida 2.25A Estas caracter\u00edsticas son suficientes para el consumo m\u00e1ximo que puede requerir tanto en el sistema de control de vuelo (Arduino) como en el sistema central y Transmisi\u00f3n de Video cuyo consumo m\u00e1ximo recomendado es de 2A m\u00e1ximo y verificado en uso emp\u00edricamente se ha visto es de 1 Amperio. 4.3.3 Estaci\u00f3n base La estaci\u00f3n base deber\u00e1 estar dotada de un sistema de carga de bater\u00edas el cual ser\u00e1 alimentado mediante placas solares. El sistema de placas solares y sistema de carga deber\u00e1 de ser capaz de suministras una intensidad m\u00e1xima de 8000mA intensidad igual a l a capacidad de la bater\u00eda. Se determina asi ya que en la bater\u00eda adquirida indica y recomienda sea cargado a un m\u00e1xima de 1C, por tanto 8000mA. Los bornes de alimentaci\u00f3n para carga ser\u00e1n situados en placas en la zona de aterrizaje donde el Dron se posara sobre ellas y estando dotado de contactos en sus en su tren de aterrizaje servir\u00e1n de contacto para efectuar la carga una vez haya aterrizado sobre la plataforma. En la estaci\u00f3n de base es deseable que exista un punto de acceso a red si existe la posibilidad. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 45 de 374 5. Descripci\u00f3n Detallada del Software [Ir al \u00edndice] 5.1 Sistema Operativo Central En este \u00faltimo a\u00f1o se han presentado nuevas distribuciones para R aspberry PI, especialmente para la versi\u00f3n Rapberry Pi 2 B . La mayor\u00eda de los sistemas para este dispositivo est\u00e1n basados en Linux, siendo en gran medida distribuciones de Linux portadas a la arquitectura ARM, pero tambi\u00e9n soporta otras distribuciones incluso Windows ha sacado un versi\u00f3n para Raspberry Pi 2 Windows 10 IoT (Internet of Things) para Raspberry pi . Algunos de los sistemas son: FreeBSD el cual es un sistema de Unix -like open- source cuyas caracter\u00edsticas en su versi\u00f3n para Raspberry Pi es haber sido compilado utilizando FreeBSD GCC 4.2.1, ( Berkeley Software Distribution ) incluyendo partici\u00f3n de intercambio de 512MB. Sin embargo actualmente no est\u00e1 considerado estable para Raspberry PI , presentando problemas con dispositivos de Red. Open Elec (Open Embedded Linux Entertainment Center) es una distribuci\u00f3n de Linux la cual est\u00e1 dise\u00f1ada para HTPC (Home Theater Personal Computer, computadora personal de cine en casa) y est\u00e1 basada en el reproductor de medios XBMC, aplicando el principio de JeOS (Just Enough Operating System) est\u00e1 dise\u00f1ado para consumir pocos recursos, este proporciona un completo centro de recursos multimedia. Ubuntu Mate , con entorno de escritorio, esta versi\u00f3n de Ubuntu se encuentra en fase de desarrollo sin embargo se ha pr esentado una distribuci\u00f3n compilada para ARM. Unbuntu Mate 15.04. Sin embargo el primer sistema operativo fue Raspbian siendo el m\u00e1s extendido para uso gen\u00e9rico, es una sistema estable para la Rasberry Pi y que ha incorporado importantes mejoras para la versi\u00f3n Rasberry Pi 2. Por tanto es este proyecto se har\u00e1 uso de este sistema operativo sobre el que se instalaran el resto de aplicaciones . Raspbian es una distribuci\u00f3n del sistema operativo GNU/Linux lanzado en junio del a\u00f1o 2012, es por tanto un software libre y basado en el sistema operativo Debian 7.0. Los motivos para su selecci\u00f3n han sido que Raspbian@ dispone de soporte optimizado para c\u00e1lculo s en coma flotante por hardware lo que posibilita un may or rendimiento en este proyecto. Por otro lado cuenta con herramientas de desarrollo ya incorporadas como los lenguajes d e programaci\u00f3n Phyton o Scratch, de igual forma dispone de utilidades iniciales simples y mediante men\u00fas interactivos con el usuario que permiten la configuraci\u00f3n del sistema a usuarios sin necesidad de altos conocimientos en Linux . As\u00ed su men\u00fa de configuraci\u00f3n raspi -config tiene opciones como son configuraci\u00f3n de teclados, interface s (I2C, Serial, C\u00e1mara, etc..), permite la expansi\u00f3n de la partici\u00f3n root, aplicar overclock , entre otras muchas . Puede adquirirse mediante enlaces de descarga, directamente de internet en su web de desarrollo [9] donde tambi\u00e9n ofrece manuales en l\u00ednea para su instalaci\u00f3n y consulta. De igual forma puede descargarse de la web de Raspberrypi[2], donde se encuentra entre otros sistemas operativos disponibles para esta MCU. (http://www.raspberrypi.org/downloads ) Su instalaci\u00f3n se realiza de forma sencilla sobre tarjeta micro SD, haciendo uso de las aplicaciones SDFormatter (Enlace descarga ) y Windisk32Imagen (Enlace descarga ). Ambas aplicaciones de software libre para formateo y escritura de im\u00e1gen es en Tarjetas SD respectivamente. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 46 de 374 [Ir al \u00edndice] Los procesos de instalaci\u00f3n tanto del sistema operativo como del resto de apli caciones de las que se har\u00e1 uso se pueden consultar su instalaci\u00f3n en ANEXO A adjunta a esta memoria, as\u00ed una vez instaladas las aplicaciones y el Sistema Central configurado como se expone en el mencionado anexo el propio sistema pone disposici\u00f3n lenguajes de programaci\u00f3n para la creaci\u00f3n de los distintos scripts, y ejecutables en su conjunto bien mediante su uso por usuario o configurados para arranque autom\u00e1tico no permitir\u00e1 realizar todos las funciones de control y seguimiento de la aeronave. 5.2 Lenguaje de programa ci\u00f3n Python. El sistema Rabian como se ha indicado incorpora el lenguaje de programaci\u00f3n Python el cual es un lenguaje interpretado orientado a objetos, y que mediante sentencias permiten realizar tareas que implicar\u00edan una mayor complejidad as\u00ed, en el caso en el caso de querer acceder a dispositivos conectados a la unidad Dron como por ejemplo puede obtener los datos de temperatura o presi\u00f3n de la zona en la que est\u00e1 vigilando se puede f\u00e1cilmente realizar mediante un breve programaci\u00f3n. As\u00ed para acceder al sensor de Presi\u00f3n y temperatura MPL115A se realiza la siguiente codificaci\u00f3n la cual guardar\u00ed amos como fichero ejecutable directamente con extensi\u00f3n *.py #Lectura y presentaci\u00f3n en pantalla de la presi\u00f3n y temperatura del sensor MPL115A .py #!/usr/bin/phthon import smbus from time import sleep bus = smbus.SMBus(1) while(0==0): tempC=0 pressure=0 # solicita 1fkPa' %(tempC, pr$ Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 47 de 374 [Ir al \u00edndice] Entrando en el sistema ejecutar\u00edamos la sentencia (p.e por conexi\u00f3n SSH) ejecutando directamente el programa mediante Python con ejecutando el script mediante. sudo phyton MPL115A.py El sistema nos presentara la temperatura y presi\u00f3n de la zona donde se encuentre ubicado el Dron. Figura 36 presentaci\u00f3n lectura Temperatura y presi\u00f3n Este cuenta con una amplia librer\u00eda as\u00ed puede realizarse el servicio de env\u00edo de SMS, instala la librer\u00eda SMS API, lo que permitir\u00e1 que dichos datos si el sistema no dispone de otra red puedan ser enviados mediante un SMS. Por otro lado Python permite la ejecuci\u00f3n de sus programas en pr\u00e1cticamente toda la plataforma ofreciendo m\u00faltiples opciones para desarrollar interfaces graficas de usuario portables, como Tkinter, wxPython, PyGTK, PyQT. Los scripts de Python puede de una forma f\u00e1cil comunicarse con otras parte de la aplicaci\u00f3n del sistema ya que tiene mecanismos de integraci\u00f3n para invocar librer\u00edas de leguaje C y C++ por lo que puede ser llamado desde C, CORBA ( Common Objetct Request Broker Architecture) y NET pudiendo interactuar en la red con interfaces como SOAP, o comunicarse por medio de mecanismo de intercambio de datos en XML, lo que lo hace \u00fatil en esta aplicaci\u00f3n para comunicaci\u00f3n con la unidad Dron. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 48 de 374 [Ir al \u00edndice] 5.2 Biblioteca de visi\u00f3n artificial OpenCV . Open CV (Open Source Computer Visi\u00f3n ) es una biblioteca de visi\u00f3n artificial desarrollada por el centro de investigaci\u00f3n Intel, es utilizada en aplicaciones de sistemas de seguridad para detecci\u00f3n de movimientos, y reconocimiento de objeto. Esta tiene muchas formas de poder detectar el color por contornos, por momentos, calculando \u00e1reas, etc... Como se ha visto en el apartado 3.3 la detecci\u00f3n de fuego por color es m\u00e1s complicada y que la detecci\u00f3n por humo si bien En este sentido no se ha podido profundizar por falta de tiempo material, \u00fanicamente se han podido realizar algunas pruebas en cuanto a reconocimiento de objetos por la forma, o reconocimiento facial, pero no ha sido posible disponer de m\u00e1s tiempo para llevar a cabo pruebas de detecci\u00f3n del color y comprobar hasta qu\u00e9 punto en vuelo puede ser capaz de detecta color. Se indica por detecci\u00f3n de color pues la detecci\u00f3n por humo cuando el sistema de visi\u00f3n, como es la UVA esta en vuelo es dif\u00edcil implica turbulencias y movimientos aunque exista un estabilizador y como se explicado en el apartado 3 es m\u00e1s complicado y hay que aplicar otras t\u00e9cnicas. Por tanto todo lo que se ha podido realizar a cabo a trav\u00e9s de OpenCV y creando entornos virtuales es conseguir una captura de video alta definici\u00f3n durante el vuelo, a la vez que pone a disposici\u00f3n del servidor WEB local del dispositivo la grabaci\u00f3n en almacenamiento USB . La idea de instalar un servidor en la propia aeronave ha resultado factible en el sentido que si se ha verificado su funcionamiento realiz\u00e1ndolo cor rectamente incluso mediante una captura con Raspistall, como se ha mostrado en videos de verificaci\u00f3n de funcionamiento que se encuentra en repertorio del la web del presente trabajo de fin de grado. https://www.inf oteli.org . Rasp\u00ecstill -o /media/archivo/www/video/fotograma.jpg -tl 1000 t 0, El sistema captura y transmite video por RF (5,8MHz) por tiempo indefinido y env\u00eda cada segundo graba un fotograma en el servidor WEB. Igualmente mediante la grabaci\u00f3n de video (Raspivid) se puede efectuar esta grabaci\u00f3n de diversos formatos, como se ha efectuado en formato h.264, y realizar video streaming. Por tanto como el sistema se ha programado mediante las aplicaciones y librer\u00edas con el sistema operativo para que pueda efectuar transmisi\u00f3n de video por RF a la vez que proporciona dichos video o bien fotogramas cada segundo para su an\u00e1lisis. Pruebas que se esperan puedan presentarse en la presentaci\u00f3n de este trabajo. Indicar que todo ello se realiza controlado remotamente como se indica en el siguiente apartado. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 49 de 374 [Ir al \u00edndice] 5.3 Software Mission Planner 5.3.1 Conectando a Unidad Controladora de vuelo a trav\u00e9s de Raspberry pi Para ello se har\u00e1 uso de MAVLink (Micro Air Vehicule link). Este es un protocolo de comunicaci\u00f3n para veh\u00edculos no tripulados, realizado por Lorenz Meier bajo licencia GPL 2009. Este es instalado como biblioteca en el sistema y permitir\u00e1 disponer de una co nexi\u00f3n y un control total del sistema control de vuelo (Arduino Pilot). Correctamente configurado, mediante MavProxy proporciona una conexi\u00f3n mediante protocolo UDP para aplicaciones como Misi\u00f3n Planner o bien simplemente mediante conexi\u00f3n SSH (p.e. WiFi) permitir\u00e1 la comunicaci\u00f3n con el controlador de vuelo en l\u00ednea de comandos a trav\u00e9s de MAVLink. As\u00ed en modo supervisor (programador) este permitir\u00e1 conectar y comandar los sistemas ajustando par\u00e1metros de vuelo y configurando la unidad Dron para vuelo programado. De igual forma en todo momento haciendo uso de MAVLink se pueden obtener todos los datos de telemetr\u00eda que puedan requerirse para el control de vuelo, a trav\u00e9s de los diferentes dispositivos perif\u00e9ricos de que dispone el sistema controlador de vuelo. (p.e GPS, Altitud, velocidad, posicionamiento, as\u00ed como sensores tensi\u00f3n y consumo, del sistema en tiempo real.). Para disponer de conexi\u00f3n remota se debera ejecutar mavproxy debidamente configurado en el inicio del sistema para lo cual agregarem os las siguientes l\u00edneas al fichero de inicio etc/rc.local ( date echo $PATH PATH=$PATH:/bin:/sbin:/usr/bin:/usr/local/bin ello se dispondr\u00e1 de conexi\u00f3n mediante protocolo UDP en el puerto 14550 de forma remota para configuraci\u00f3n como puede verse la conexi\u00f3n se establece correctamente pudiendo a partir de ella efectuar toda la programaci\u00f3n y control de la UVA a trav\u00e9s del sistema central Raspberry pi. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 50 de 374 [Ir al \u00edndice] Figura 37 efectuando conexi\u00f3n remota mediante Mission Planner . En la siguiente figura se puede observar como la situaci\u00f3n del GPS la marca correcta y se puede a directamente comenzar indicar los Way -points que definan un plan de vuelo Figura 38 conexi\u00f3n a programaci\u00f3n plan de vuelo. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 51 de 374 [Ir al \u00edndice] 5.5 Diagrama casos de Uso En la aplicaci\u00f3n del sistema pueden diferenciarse tres tipos de usuarios: Usuario Local: Interact\u00faa directamente con el sistema de navegaci\u00f3n como piloto in- situ. Usuario PC: Interact\u00faa mediante SSH o Entorno Grafico (Escritorio remoto) con el sistema, pudiendo llevar a cabo toda la programaci\u00f3n de sistema que se requiera. De igual forma podr\u00e1 en modo SSH enviar comandos y planes de vuelo mediante MAVLin ks por consola a la UAV. Usuario WE B: Interact\u00faa con el sistema mediante aplicaci\u00f3n WEB a trav\u00e9s de red internet. Para cada usuario podemos distinguir los siguientes casos de uso que se representan el siguiente diagrama de casos de uso Diagrama casos de Uso Figura 39 Diagrama casos de uso Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 52 de 374 6. VIABILIDAD TECNICA [Ir al \u00edndice] 6.1 Estudio Viabilidad T\u00e9cnica El proyecto como puede comprobarse est\u00e1 falto de madurez , dado que no se han implementado los dise\u00f1os de placa de sensores , ni los dise\u00f1os de caja apropiada para un ensamblado m\u00e1s profesional, de igual forma la programaci\u00f3n de interfaces de usuario se han realizado de una forma muy simple a modo de demostraci\u00f3n, debido al corto tiempo disponible para su realizaci\u00f3n. Sin embargo, desde el punto de vi sta t\u00e9cnico, si puede considerarse un proyecto viable, ya que en la selecci\u00f3n de sus componentes se ha tenido presente siempre la consecuci\u00f3n de unos fines profesionales, teniendo en cuenta la calidad y precisi\u00f3n de los mismos . Por otro lado resuelve ampli amente el problema planteado, obteniendo un producto con capacidad para la capt ura de video y medida de fen\u00f3menos atmosf\u00e9ricos as\u00ed, como posibilidad de registro de estos en base de datos para su tratamiento posterior y con posibilidades de mejoras sin pr\u00e1cticamente coste (solo se requiere tiempo) como puede ser la capacidad de tomar decisiones como causa -efecto de los datos recabados o la capacidad de mostrar presentar en su propio servidor web accedo a video a la vez que efect\u00faa el vuelo pudiendo as\u00ed poner a disposici\u00f3n la visi\u00f3n de la zona y esos datos recabados entiendo que da por tanto soluci\u00f3n al problema que se planteaba en este proyecto. Como puntos d\u00e9biles , remarcar que el principal punto d\u00e9bil es su falta de madurez, a partir aqu\u00ed se pueden observa r otros como son: La autonom\u00eda de vuelo, el dise\u00f1o deber\u00eda ser repasado y m\u00e1s ajustado en peso para as\u00ed poder reducir esos 200g que le sobran para poder incorporar una segunda bater\u00eda lo que le dar\u00eda una autonom\u00eda una mayor autonom\u00eda manteni\u00e9ndose dentro de la legalidad vigente. El alto nivel de competencia en ambos sectores que pretende cubrir, ya que existen una amplia gama de productos tanto en el sector de medici\u00f3n de factores meteorol\u00f3gicos como en el sector de UAV unido a la actual legislaci\u00f3n vigent e hacen que desde el punto de vista comercial no tenga otras expectativas m\u00e1s que en actividades de recreo o deportivas . Como puntos fuertes se puede considerar los siguientes puntos: Uso de una placa base con un procesador central el cual tiene una potencia considerable (cuatro n\u00facleos ), una amplia escalabilidad y con una tecnolog\u00eda que puede considerarse de las punteras en sistemas embebidos. La implementaci\u00f3n de los distintos tipos de intercomunicaci\u00f3n con otros dispositivos, no dejando al sistema limitado por el uso exclusivo de ninguno de ellos, esto lo hace f\u00e1cilmente escalable y aplicable en diversos \u00e1mbitos tanto en apoyo a equipos de extinci\u00f3n de incendios como de apoyo a sistemas de toma de datos meteorol\u00f3gicos u otros sectores como puede ser el sector agrario. La implementaci\u00f3n de distintos interfaces con el usuario, permitiendo el control total del sistema tanto de forma local como remota, y por otro que el sistema pueda informar en todo momento de su estado. La alta precisi\u00f3n de los sensore s empleados estando todos ellos en un margen de error por debajo del 0.2% lo hacen un dispositivo de alta precisi\u00f3n. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 53 de 374 [Ir al \u00edndice] La realizaci\u00f3n de toda la programaci\u00f3n de sistemas y aplicaciones en su totalidad de c\u00f3digo libre reducen su coste en comparaci\u00f3n con otros que pudieran dar las mismas prestaciones indicadas en el mercado. Por lo que se puede concluir que: Implementando en profundidad su aplicaci\u00f3n WEB y de control Local para que permita una correcta actuaci\u00f3n sobre el sistema, cosa que no se ha podido llevar a cabo por falta de tiempo, se puede considerar que el proyecto es t\u00e9cnicamente viable. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 54 de 374 7. COSTES [Ir al \u00edndice] 8.1 Presupuesto Prototipo PRESUPUESTO INVESTIGACION DESARROLLO Y MONTAJE PROTOTIPO Descripci\u00f3n Componentes Cantidad Precio Unidad(\u20ac) Precio Total (\u20ac) Estructura Quap -Copter TAROT IRON 650 1 160.00 160.00 2 B 1 Copter 1 62.00 62.00 Caja montaje Placa Base PI 1 4.00 4.00 Emisora Radio Control Turning 9XR PRO (TX M\u00f3dulo 16Canales TX + 9.00 9.00 Camara PI NoIR 1 18.00 18.00 Camara PI IR 1 14.00 14.00 Soporte Gimbal 1 10.50 10.50 Soporte plegable base alzadora GPS (1000KV) + 4Helices 25.00 25.00 Gimbal Taror RAIL 4 3.00 12.00 Soporte CNC FPV aluminio 1 6.90 6.90 CP2102 CEB31 1 13.00 Rollo Esta\u00f1o sin 1 8.68 8.68 3.04 Iluminaci\u00f3n - Proximidad - Infrarojo VCNL4010 1 2.30 2.30 Sensor Temperatura -Humedad DTH -22 1 6.20 6.20 Total Coste Materiales 932.64 \u20ac Horas Investigaci\u00f3n, desarrollo, montaje y programaci\u00f3n 480h. 15.00 7.200 \u20ac COSTE BASE 8132,64 \u20ac IVA 21% \u20ac COSTE TOTAL 9840.34 \u20ac Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 55 de 374 8. Conclusiones [Ir al \u00edndice] 8.1 Objetivos alcanzados El desarrollo del proyecto ha resultado una tarea bastante complicada debido al gran n\u00famero de horas que supone desarrollarlo con detalle y como contrapartida el poco tiempo disponible para la realizaci\u00f3n. Hay que indicar que ha resultado un reto muy interesante y me ha permitido aprender bastante sobre el tema . La dificultad del tema escogido, y la falta de tiempo debida principalmente a compaginar el proyecto con otras tareas y estudios , no me han permitido llevar el proyecto a puntos de realizaci\u00f3n que me hubiera gustado vistas las grandes posibilidades que ofrece los dispositivos de que se han podido disponer. Indicar que b\u00e1sicamente estoy satisfecho con el producto final obtenido el cual ha presentado un funcionamiento correcto consiguiendo alcanzar los objetivos marcados, si bien hay que reconocer que falta puntos importantes para alcanzar cierto nivel de madurez como dise\u00f1o de placa, dise\u00f1o de caja exterior, una programaci\u00f3n de interfaces m\u00e1s exhaustiva que ponga al alcance del usuari o a todas las posibilidades del sistema etc... y realizar algunas mej oras de las cuales se proponen a continuaci\u00f3n. 8.2 Propuesta de mejoras A lo largo del desarrollo del proyecto y en la presente memoria se han indicado varios puntos como mejoras del si stema tanto en software como en hardware, as\u00ed se propondr\u00edan las siguientes mejoras: Software : - Programaci\u00f3n adecuada y eficaz del modo bajo consumo (no efectuado por falta de tiempo) - Programaci\u00f3n de una Interfaz Usuario -sistema WEB mucho m\u00e1s detallada y avanzada. Hardware : - Inclusi\u00f3n de un 2\u00ba m\u00f3dulo GPS al sistema pudiendo dejar as\u00ed el dispositivo Bluetooth para comunicaciones con dispositivos dom\u00f3tica cercanos, y no dependiendo el sistema de GPS externo. - Inclusi\u00f3n de z\u00f3calo tarjeta microSD a Sistema RED SENSORES, lo que podr\u00eda dotar al sistema de una total autonom\u00eda para registro de datos y poder realizar un servidor WEB Local m\u00e1s avanzado. - Dotar al sistema de conexi\u00f3n 3G dando una total independencia al mismo. -Eliminaci\u00f3n Modulo CP2102, ya que el sistema dispone de USB propio. Estas son mejoras que b\u00e1sicamente en Hardware no incrementan el costo de un forma excesiva, ya que el dispositivo GPS interno es m\u00e1s econ\u00f3mico que un GPS externo por Bluetooth (se ha efectuado as\u00ed porque se dispon\u00eda del externo), se ha consultado un m\u00f3dulo que incluye GPS y 3G para Arduino el cual su costo es de 105\u20ac. Por otro lado se ahorrar\u00eda costo al eliminar el dispositivo CP2102 utilizando el USB incorporado en la MCU, y los costo s de z\u00f3calo tarjeta microSD son m\u00ednimos (aprox. 10\u20ac). Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 56 de 374 [Ir al \u00edndice] 8.3 Impacto ambiental En el presente proyecto se ha tenido en cuenta a la hora de desarrollarlo el consumo energ\u00e9tico. Las aeronaves son m\u00e1s eficientes y su nivel de contaminaci\u00f3n es pr\u00e1cticamente nulo. Las bases all\u00ed donde se establezcan se alimentaran con placas solares por lo que el impacto en el medio ambiente es m\u00ednimo. En cuanto al proyecto las plataform as de hardware utilizadas se ha cuidado que cumplan con la normativa RoHS la cual restringe el uso de materiales peligrosos como son mercurio, plomo, cadmio, cromo VI, etc.. Si hay que guardar las precauciones oportunas con las bater\u00edas as\u00ed las bater\u00edas Li -Po cuando se acaba su ciclo de vida deben ser sumergidas en agua con sal y trasladas a los puntos de recogida de las bater\u00edas. 8.4 Autoevaluaci\u00f3n. Considerando que los requisitos m\u00ednimos b\u00e1sicamente consist\u00edan en: En el desarrollo mediante sis temas de Arduino, adquisici\u00f3n de datos mediante sensores Dise\u00f1o e implementaci\u00f3n de una UVA Programaci\u00f3n de interfaces de comunicaci\u00f3n Muestreo peri\u00f3dico de datos y env\u00edo a la aplicaci\u00f3n local Conexi\u00f3n a Internet mediante Wifi Creo que se han cumplido los objetivos y se han incorporado bastantes de las mejoras que se dieron como optativas en la planificaci\u00f3n inicial. Intentando suplir las carencias que por falta de tiempo material no se ha podido llevar a cabo, asi se ha incorpo rado a la unidad un servidor WEB Local, sobre pendrive USB para no acortar la vida de la tarjeta micro SD, con capacidad de debidamente configurado presentar el video de vuelo en el momento que lo est\u00e1 realizando independientemente de que efectu\u00e9 la grabac i\u00f3n para el posterior an\u00e1lisis por visi\u00f3n de im\u00e1genes. As\u00ed este TFG me ha brindado la oportunidad de hacer una breve introducci\u00f3n en el mundo de los sistemas embebidos y as\u00ed como de as\u00ed como de los diversos sistemas de transmisi\u00f3n y control que pueden ser empleados, se han utilizado diversos sistemas de transmisiones en conjunci\u00f3n as\u00ed como las diversas redes de datos GPRS, WAN, LAN, incluyendo en la unidad las red GSM, con la finalidad de conocer dentro de lo posible el funcionamiento de dichos dispositiv os de comunicaciones. De igual forma me ha permitido conocer y utilizar un sistema operativo como es Raspbian y de igual forma hacer una introducci\u00f3n en el lenguaje de programaci\u00f3n Python. Si bein es cierto que por problemas ocurridos y falta de tiempo no se ha podido profundizar en la aplicaci\u00f3n de Open CV, cosa que me hubiera gustado y que realizare para continuar con esas esas mejoras en este proyecto. Por ultimo tambi\u00e9n me ha dado la oportunidad para conocer por encima las comunicaciones con disposi tivos GPS, conociendo los distintos tipos de datos que pueden recabarse de la red de sat\u00e9lites mediante los distintos protocolos m\u00e1s en profundidad el protocolo utilizado NMEA0183 v2.20 (National Marine Electronics Association). Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 57 de 374 9. Glosario [Ir al \u00edndice] A ADC : Conversi\u00f3n anal\u00f3gica digital. B Bluetooth: Es una especificaci\u00f3n industrial para Redes Inal\u00e1mbricas de \u00c1rea Personal (WPAN) que posibilita la transmisi\u00f3n de voz y datos entre diferentes dispositivos. Baudrate: N\u00famero de unidades de se\u00f1al por segundo. C Cortex -A7: procesador de 32 bits de ARM. CPU : Unidad central de procesamiento. D DHCP: protocolo de configuraci\u00f3n din\u00e1mica de host. Diagramas de Gantt : Herramienta grafica para representaci\u00f3n de planificaci\u00f3n de trabajos y tareas. E E/S: Entrada/Salida. G GUI: Interface gr\u00e1fica de usuario. GPIO : Puerta programable de entrada y salida de datos. H HTML : Siglas de HyperText Markup Language. I IDE: Entorno de desarrollo integrado. IP: Identificaci\u00f3n l\u00f3gica y jer\u00e1rquica, de interfaz de dispositivo dentro de una red que utilice el protocolo IP. I2C: Bus de comunicaciones en serie. L Lan: Red de \u00e1rea local. M MCU: Microcontrolador circuito integrado programable, c on capacidad de ejecuci\u00f3n y memoria. Mysql: Sistema de gesti\u00f3n de bases de datos relacional, y multiusuario O Open Source : Es el t\u00e9rmino con el que se conoce al software distribuido y desarrollado libremente. P PHP: Lenguaje de programaci\u00f3n de uso general de script del lado del servidor origi nalmente dise\u00f1ado para el desarrollo web de contenido din\u00e1mico. R RSSI : Indicador de fuerza de se\u00f1al de recepci\u00f3n. RTLinux : Sistema operativo en tiempo real el cual ejecuta Linux como un hilo. S SSID: Nombre identificaci\u00f3n de una Red Inalambrica (Wi -Fi) SPI :Serial Peripheral Interface. Est\u00e1ndar de comunicaci\u00f3n utilizado para entre transferencia de informaci\u00f3n entre dispositivos T TCP/IP : conjunto de protocolos de red en los que se basa Internet y que permiten la transmisi\u00f3n de datos entre computadoras. U UART : Transmisor -Receptor As\u00edncrono Universal W Wifi: Mecanismo de conexi\u00f3n de dispositivos electr\u00f3nicos de forma inal\u00e1mbrica. Wireless: Comunicaci\u00f3n inal\u00e1mbrica o sin cables Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 58 de 374 10. Bibliografia [Ir al \u00edndice] Se indican a continuaci\u00f3n otras referencias utilizadas para el estudio inicial del proyecto y la realizaci\u00f3n que se han efectuado hasta la entrega de esta PAC3 (Material Docente UOC) Universidad Oberta d Catalunya. Sistemas Empotrados , 2011. Jos\u00e9 Mar\u00eda Gomez Cama, Francisco Hern\u00e1ndez Ram\u00edrez, Jos\u00e9 L\u00f3pez Vicario, Antoni Morell P\u00e9rez, Juan Daniel Prades Garc\u00eda, Ignasi Vilajosana Guillen, Xavier Filajosana Guillen. (Material Docente UOC) Universidad Oberta de Catalunya. Presentaci\u00f3n de documentos y elaboraci\u00f3n de presentaciones. 2013 Roser Beneito Montagut P\u00e9rez Garc\u00eda, Miguel \u00c1ngel . 2011 . Instrumentaci\u00f3n Electr\u00f3nica. Editorial Thomson- Paraninfo LOS SANTOS, 2004. Alberto Los Santos Aransay, Aplicaci\u00f3n de las redes de sensores en el entorno vehicular. Mayo 2009. Lorenzati, Desarrollo aplicaciones para FreeRTOS. Marzo 2010. http://laboratorios.fi.uba.ar/lse/sase/2010/slides/SASE -2010_- FreeRTOS_Drivers_- Lorenzati.pdf Real Decreto sobre Drones . Boletin Oficial del Estado Enlace: www.seguridadaerea.gob.es/media/4243006/rdl_8_2014_4julio.pdf Aplicaci\u00f3n WEB proyecto (2016) . Miguel Angel Iglesias Jimenez. Enlace: https://www.infoteli.org/proto Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 59 de 374 11. Referencias [Ir al \u00edndice] [1] Plan INFOCA . Sistemas de Vigilancia y detecci\u00f3n Red de comunicaciones. Junta Andaluc\u00eda [en l\u00ednea] Enlace documento . \u00daltima consulta: 08/10/2015 [2] Plan INFO CA. Aplicaci\u00f3n de nuevas tecnolog\u00edas. Junta de Andaluc\u00eda . Drones: Market de seguridad Aerea (2014) . El uso de Drones en Espa\u00f1a. [En l\u00ednea] Enlace Decreto -ley sobre H Romero, \"Attitude control of a quad -rotor using speed sensing in brushless DC motors,\" in 2011 8th International Conference on Electrical Engineering Computing Science and Automatic Control (CCE) , Merida City, 2011, pp. 1-6. Faraday. [En l\u00ednea] Enlace: http://www.gigahertz.es/la_jaula_de_faraday.html \u00faltima \u00daltima consulta: 30/12/2025 [14] Referencias a Dise\u00f1os Sistemas Embebidos y Redes de sensores. Estaci\u00f3n meteorol\u00f3gica m\u00f3vil con posicionamiento GPS. REPOSITORIO 02 UOC. URL: http://hdl.handle.net/10609/29781 \u00daltima consulta: 10/01/2016 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 60 de 374 Anexo A [Ir al \u00edndice] MANUAL USUARIO Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 61 de 374 \u00cdndice [Ir al \u00edndice] 1. Instalaci\u00f3n ................................ ................................ ................................ ........................ Creaci\u00f3n tarjeta Micro SD Sistema Central ................................ ............................. 63 1.2 Primeras configuraciones del sistema ................................ ................................ ... 63 1.3 Configuraci\u00f3n salida video AV ................................ ................................ ............... 64 1.4 Configuraci\u00f3n adaptadores Red LAN ................................ ................................ .... 64 1.5 Configuraci\u00f3n unidades almacenamiento externas mediante USB ...................... 65 1.6 Instalaci\u00f3n OpenCV 3.0 y Phyton 2.7 ................................ ................................ .... 67 Vehicule Communic ation Protocol) ....................... Configuraci\u00f3n e instalaci\u00f3n herramientas bus I2c ................................ ................. 70 1.9 Primeros contactos con Software Mission Planner ................................ ................. 71 Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 62 de 374 Manual Usuario [Ir al \u00edndice] 1 Instalaci\u00f3n 1.1 Creaci\u00f3n de la tarjeta Micro SD Sistema Central Para ello se deber\u00e1 de disponer de una tarjeta micro SD con una capacidad m\u00ednima de 8GB. (Recomendada 32GB) y un PC. Mediante el PC se efect\u00faa la grabaci\u00f3n de la imagen del sistema Raspbian@, haciendo uso de las cualquiera de las aplicaciones existentes d e formateado y grabaci\u00f3n de im\u00e1genes en tarjetas USB. En este caso hemos utilizado SDFormatter para formateo de la micro tarjeta y Win32DiskImager para su grabaci\u00f3n. Efectuada la grabaci\u00f3n de la Micro SD, se insertara en la placa Raspberry pi 2 B, a la que en su primer inicio se deber\u00e1 conectar para realizar su configuraci\u00f3n b\u00e1sica los siguientes dispositivos: Un monitor (HDMI), Un teclado y rat\u00f3n (inal\u00e1mbrico por puerto USB) Tarjeta USB WIFI (Edimax) o bien conectar a router mediante cable Ethernet 1.2 Pri meras configuraciones del sistema En el primer arranque el sistema se presenta mediante men\u00fa grafico como puede verse en la siguiente captura: Fig xx Primer i nicio Sistema Raspbian modo grafico A continuaci\u00f3n se inicia un terminal de consola en el cual se ejecuta el comando sudo raspi -config para la configuraci\u00f3n b\u00e1sica del sistema el cual mediante su men\u00fa interactivo permitir\u00e1 llevar a cabo la configuraci\u00f3n b\u00e1sica del sistema como puede verse en la siguiente imagen Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 63 de 374 [Ir al \u00edndice] En este punto se realiza la siguiente configuraci\u00f3n m\u00ednima: Internacionalizaci\u00f3n de la unidad: Asignar idioma , timezone y tipo de teclado del sistema . Activaci\u00f3n del m\u00f3dulo de c\u00e1mara En opciones avanzadas: Se activa el bus I2c, el acceso mediante SSH, el modo de audio (seleccionado 3.5mm headphone Jack) y se desactiva el acceso al puerto serial mediante Shell Esta aplicaci\u00f3n de configuraci\u00f3n como puede observarse en la figura anterior permite muchas otras opciones como cambio de contrase\u00f1a, definir el nombre del host \u00f3 expandir el sistema de archivos para que pueda utilizar la totalidad de la tarjeta micro SD entre otras. 1.3 Configuraci\u00f3n salida Video Efectuadas estas configuraciones m\u00ednimas, debido a que la se\u00f1al de video ser\u00e1 transmitida por RF (5.8Ghz) utilizaremos por tanto la salida de video compuesto, para ello se debe editar el fichero de configuraci\u00f3n inicial /boot/config.txt. e indicar la opci\u00f3n de salida de video compuesto deseada. Esto se puede llevar a cabo mediante el editor de texto del sistema (aplicaci\u00f3n nano ). As\u00ed ejecutando la aplicaci\u00f3n con privilegios root (sudo): sudo nano /boot/config.txt Se edita el fichero config.txt y se modifica el par\u00e1metro stdv_mode (el cual se encuentra en una l\u00ednea comentada), eliminando el signo de l\u00ednea comentada (#) se dejara asignado el modo de video AV en este caso modo PAL, asign\u00e1ndole el valor: stdv_mode=2 Este tiene las opciones (0=NTSC normal, 1=NTSC Japon, 2=PAL Normal, 3 PAL Brasil 525/60) Con estos pasos iniciales queda instalado el sistema Raspbian@ quedando configurado para su monitorizaci\u00f3n a trav\u00e9s de su salida de video compuesto (para conexi\u00f3n al transmisor video RF 5.8Ghz) y podr\u00e1 ser controlado mediante SSH. 1.4 Configuraci\u00f3n redes LAN Para llevar a cabo la configuraci\u00f3n de los dispositivos de red (LAN), tanto la red lan cableada como la inal\u00e1mbrica que se instala mediante adaptador USB Edimax, debe efectuarse la configuraci\u00f3n mediante la edici\u00f3n del fichero /etc/network/interfaces , asig nando en este IP fijas y los distintos datos de conexi\u00f3n a la red inal\u00e1mbrica como son SSID y contrase\u00f1a. A continuaci\u00f3n se muestra la configuraci\u00f3n utilizada en dicho fichero y que debe modificarse acorde a los datos de la red a la que efectu\u00e9 conexi\u00f3n. ( Se requerir\u00e1 de un teclado y monitor pudiendo utilizar directamente la salida HDMI la cual si esta es conectada en el encendido del sistema esta ser\u00e1 activada por defecto). Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 64 de 374 [Ir al \u00edndice] El fichero interfaces utilizado es configurado como se muestra a continuaci\u00f3n: --------------------------------------------- Fichero /etc/network/interfaces ----------------------------------------------------- # Please note that this file is written to be used with dhcpcd. # For se apagara puede configurarse el modo suspensi\u00f3n, modificando o creando el fichero /etc/modprobe.d/8192cu.conf ajustando los valores: rtw_power_mgnt : Activa y desactiva el control de energ\u00eda del adaptador wifi. Los posibles valores son 0, (desactivado), 1 (activado ahorro de energ\u00eda) y 2 (m\u00e1ximo ahorro de energ\u00eda). rtw_enusbss: Controla la auto suspensi\u00f3n del adaptador en caso de no ser usado. Los posibles valores son 0 (desactivado) y 1(activado). rtw_ips_mode: controla el consumo energ\u00e9tico del adaptador cuando no se encuentra en uso. Los posibles valores son 0 (normal, por defecto) y 1 (m\u00e1ximo ahorro de energ\u00eda). 1.5 Configuraci\u00f3n auto montaje unidades almacenamiento externas mediante USB Dada la capacidad limitada de la tarjeta SD y que este proyecto requerir\u00e1 de espacio de almacenamiento para videos y otra informaci\u00f3n, instalamos una unidad de almacenamiento USB, para lo que con la finalidad de no tener que efectuar montaje manual de la misma se instala la herramienta usbmount para lo cual ejecutamos el comando sudo apt -get install usbmount A partir de su instalaci\u00f3n al conectar un dispositivo de almacenamiento en el USB este ser\u00e1 montado por el sistema de forma autom\u00e1tica, asignando el nombre USBx (x =0,1,.2...x) ** Si no se desea instalar la aplicaci\u00f3n puede montarse una unidad USB de forma fija editando el fichero /etc/ftsab al que se a\u00f1adir\u00e1 la siguiente l\u00ednea: /dev/sda1 /media/ archivo vfat defaults 0 0 Queda as\u00ed montado en el arranque el dispositivo de almacenamiento USB al directorio /media/archivo. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 65 de 374 [Ir al \u00edndice] Con estos pasos iniciales queda instalado y configurado el sistema Raspbian para su monitorizaci\u00f3n a trav\u00e9s de su salida de video compuesto y podr\u00e1 ser controlado medi ante SSH como se muestra en las siguientes capturas del sistema. Como puede verse en la siguiente figura (izquierda), se puede efectuar conexi\u00f3n directamente mediante aplicaciones de conexi\u00f3n remota SSL (p.e PuTTy) indicando la direcci\u00f3n IP asignada al si stema. Fig 25. Conexi\u00f3n SSL sistema central. Haciendo clic en Open se obtendr\u00e1 una conexi\u00f3n segura con el sistema central. Este solicitara usuario y contrase\u00f1a permitiendo as\u00ed el acceso al sistema con todos los privilegios del usuario utilizado, como puede observarse en la figura anterior (derecha). Igualmente puede interactuar mediante entorno activando las X, como puede verse en la siguiente figura mediante simple conexi\u00f3n de escritorio remota SSH. (Utilizando Xarchive del propio sist ema Raspbian ). Fig 26. Conexi\u00f3n SSL entorno grafico (escritorio remoto). Quedando as\u00ed el sistema totalmente configurado para continuar con su programaci\u00f3n y control de forma remota sin que se requiera de teclados ni monitores. Una vez instalado el sis tema Raspbian es conveniente actualizar el sistema y firmware de la Raspberry Pi para lo que se ejecutaran los siguientes comandos: Dise\u00f1o implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 66 de 374 [Ir al \u00edndice] 1.6 Instalaci\u00f3n OpenCV y Phyton Una vez instalado el sistema Raspbian se realiza la instalaci\u00f3n del Software OpenCV y Python para lo cual se ejecutan las siguientes l\u00edneas de comando, siguiendo los siguientes pasos: 1- Se instalan paquetes de herramientas sudo apt-get install build- essential cmake pkg-config 2- Se instalan paquetes necesarios para los diversos formatos de imagen (jpg, png, tiff, etc..) sudo posibilitando que OpenCV sudo apt-get install libgtk2 .0-dev 4- Instalaci\u00f3n de los paquetes necesarios para para optimizaci\u00f3n ~/.cache/pip 7- Actualizar el perfil para lo que se incluyen las siguientes l\u00edneas en el fichero ~/.profile Sudo nano ~/.profile export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python2.7 export WORKON_HOME=$HOME/.virtualenvs y creaci\u00f3n entorno vircutal (cv) source ~/.profile mkvirtualenv cv 8- Instalaci\u00f3n de Python 2.7 development too ls sudo apt-get install python2. 7-dev 9- Instalar NumPy desde enlaces OpenCV Phyton Pip install numpy Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 67 de 374 [Ir al \u00edndice] 10- Descarga de Open CV e instalaci\u00f3n cd ~ git clone https://github.com/Itseez/opencv.git cd opencv git checkout instalaci\u00f3n sudo make install sudo ldconfig Por ultimo Open CV queda instalado en el directorio /usr/local/lib/python2. 7/site-packages . Se efect\u00faa copia de la compilaci\u00f3n al directorio cv del entorno virtual para su uso cd ~/.virtualenvs/cv/lib/python2.7/site- packages/ ln -s /usr/local/lib/python2.7/site -packages/cv2.so cv2.so cv.py Reiniciando el sistema se efectua conexi\u00f3n mediante SSH se verifica OpenCV 3.0 y Phyton 2.7 est\u00e1 correctamente instalado como puede verse en la figura 27. En ambos entornos puede llevarse a cabo las mismas tareas, el entorno X enfocado a programaci\u00f3n usuar ios, y entorno SSH (TTY) para usuarios avanzados. Figura 27. Verificaci\u00f3n instalaci\u00f3n OpenCV 3.0 entorno SSH. (TTY) Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 68 de 374 [Ir al \u00edndice] 1.7 Instalaci\u00f3n MAVlink (Micro Air Vehicule Communiction Protocol) Se efect\u00faa la instalaci\u00f3n del protocolo MAVlink , as\u00ed como de la aplicaci\u00f3n MAVproxy , lo cual permitir\u00e1 el acceso a la unidad de control de vuelo (APM 2.6) a trav\u00e9s de la unidad central ( Raspberry pi 2B) pudiendo as\u00ed efectuar programaci\u00f3n de planes de vuelo y operaciones de mantenimiento y ajustes del controlador de vuelo mediante software libre Mission Planner de forma remota . Para ello ejecutamos los siguientes comandos: Importante desactivar el acceso a la interfaz serial mediante el Shell, se realiza mediante el comando raspi -config en opciones avanzadas (como se ha indicado en punto 1 de este manual). De no realizarse el sistema enviara error por uso de la UART0 por diversos dispositivos. Para que MAVproxy se active en el inicio del sistema deber\u00e1n agregarse las siguientes l\u00edneas al fichero del sistema /etc/rc.local, lo cual se puede realizar mediante el propio editor del sistema nano ----------------------------------------------------------------------------------------------------------------------------- ----------- ( Date echo $PATH par\u00e1metros a indicar a mavproxy son: -master=/dev/ttyAMA0 el cual determina el puerto serie para la comunicaci\u00f3n. En el caso de la Raspberry Pi, el puerto serie es 0 -baudrate 57600 velocidad del bus que debe coincidir con el predeterminado del controlado de vuelo -out IP:Puerto (p.e. 192.168.1.5:14550 ): IP del equipo donde se ejecutara la aplicaci\u00f3n Mission Planner . Y puerto UDP que utilizara para la comunicaci\u00f3n. (14550 es el utilizado por defecto por la aplicaci\u00f3n Mission Planner ). -aircraft Planes_vuelo nombre del modelo que pretendemos usar en la sesi\u00f3n y con el que se guardar\u00e1n los nombres de los logs y configuraciones. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 69 de 374 [Ir al \u00edndice] 1.8 Configuraci\u00f3n e instalaci\u00f3n herramientas bus I2c Para el uso de los dispositivos sensores conectados al bus I2c, se deber\u00e1n instalar las correspondientes herramientas en el sistema para lo cual ejecutaremos los siguientes comandos: sudo apt-get install i2c -tools sudo apt -get update Para asegurar que el usuario pi es miembro del grupo i2c, ejecutaremos el comando: sudo adduser pi i2c Una vez instaladas las herramientas se reiniciara el sistema para verificar si se obtiene un funcionami ento correcto y los dispositivos sensores son detectados por el sistema central. Para ello se puede verificar si se han cargado correctamente las librer\u00edas y comprobar que los dispositivos sensores son detectados por el sistema mediante los comandos: lsmod |grep i2c sudo i2cdetect - y 1 Se puede observar en la siguiente figura el resultado que ha de obtenerse si la controladora bcm2708 y el modulo i2c_dev se han instalado correctamente y que los dispositivos han sido detectados y se encuentra conectados al bus I2C. Figura 27. Verificaci\u00f3n reconocimiento dispositivos sensores Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 70 de 374 [Ir al \u00edndice] 1.9. Primeros contactos con Software Mission Planner . Se comienza la programaci\u00f3n inicial del controlador autom\u00e1tico de vuelo sobre la unidad Arduino (APM Ardu Copter 2.6) para lo cual en primer lugar se realiza una actualizaci\u00f3n del software de la controladora adquirida, para ello se hace uso del Software Mision Planner , realizando los siguiente pasos: Se instala en el PC el Software Mision Planner ( Enlace descarga ). Una vez instalado conectar la unidad mediante USB, esta deber\u00e1 ser reconocida por el PC, (de no ser as\u00ed deber\u00e1n instalarse sus correspondientes drivers). Se ejecuta el programa Mission Planner , y seleccionar el puerto en la que est\u00e1 instalada la unidad o bien la conexi\u00f3n UDP si se conecta a trav\u00e9s de mavlink. NO debe hacer click en conectar (CONNECT). En el men\u00fa INITIAL SETUP, seleccionar la opci\u00f3n Install Firmware esta presentara los distintos modelos de Unidades m\u00f3viles para el cual se puede configurar la unidad de control, en este caso se selecciona APM Copter v3.0.1 Figura 26 Actualizaci\u00f3n Firmware controlador Vuelo. Confirmando en el mensaje que presenta para actualizar realizara la actualizaci\u00f3n del firmware, una vez terminado presentara los correspondientes mensajes de los ajustes que deben realizarse para el correcto funcionamiento, siendo estos: Selecci\u00f3n de la estructura modo de vuelo (Quapcopter, en X, en +). Ajustes del compas Ajuste del aceler\u00f3metro Ajuste de emisora (Seguir indicaciones en manual Transmisor RF 2.4Ghz. que se utilice) A partir de estos momentos si no ha habido errores la unidad estar\u00e1 dispuesta para poder ser armada. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 71 de 374 Anexo B [Ir al \u00edndice] MANUAL ENSAMBLAJE DRON Y VERIFICACION MODULAR DE FUNCIONAMIENTO Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 72 de 374 [Ir al \u00edndice] 1. Equipos de desarrollo Para el desarrollo del proyecto se requieren de equipos diversos y herramientas tanto de electr\u00f3nica como de inform\u00e1tica. A continuaci\u00f3n se pasa a describir brevemente cada uno de los bloques que componen el sistema. El trabajo se desarrolla mediante un ordenador de sobremesa concretamente equipo Intel(R) Core(TM) i7 CPU 939 @ 2.80 GHz con 12Gb de memoria. Los programas de soporte general utilizados han sido obtenidos bien mediante c\u00f3digo abierto o bien a trav\u00e9s de las versiones para estudio que nos facilita la propia UOC en su programa Microsoft DreamSpark para uso acad\u00e9mico, as\u00ed se utilizara: Sistema Operativo Windows 7 64bits Microsoft Office (incluyendo FrontPage) Microsoft Project Visual Studio 12 Microsoft Studio Mx (para creaci\u00f3n WEB) MySql (base de datos) Apache (para montaje Servidor WEB) Programas espec\u00edficos para implementaci\u00f3n del sistema central del proyecto: Sistema Operativo Raspbian para Raspberry Pi 2 Open CV y Phyton para tratamientos de im\u00e1genes y Arduino: Entorno de Desarrollo Integral para la programaci\u00f3n y grabaci\u00f3n de Arduino Tera Term : Como terminal de comunicaci\u00f3n serie (USB). Programas espec\u00edficos para Dise\u00f1o Electr\u00f3nico: OrCad Capture : Para creaci\u00f3n de Osciloscopio PROMAX OD -571 Corta hilos, destornilladores, pela hilos, pinzas sujeci\u00f3n placas, entre otros Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 73 de 374 [Ir al \u00edndice] 2 Ensamblaje estructura y sistema s de propulsi\u00f3n TAROT IRON 650 El montaje de la unidad Dron se efect\u00faa sobre la estructura de cuatro motores TAROT IRON 650 (Quapcopter ), efectuando modificaciones para el correcto acoplamiento de los m\u00f3dulos descritos anteriormente. Entre dichas modificaciones se efect\u00faa una bajada en altura de los soportes de fijaci\u00f3n tipo RAIL con la finalidad de disponer de un espacio intermedio donde se situara el correspondiente sistema de control de velocidad de motores (ESC), quedando este entre la estructura central y el sistema de fijaci\u00f3n los soportes tipo RAIL convenientemente aislado y protegido por placas de fibra de carbono. En las siguientes im\u00e1genes puede verse la es tructura y ensamblaje de motores llevada a cabo. Figura s 1 montajes Estructura y motores A2212/13T En la imagen de la parte superior izquierda se puede apreciar la fijaci\u00f3n del servo correspondiente al tren de aterrizaje plegable, con la finalidad de que el sistema de video situado en la parte inferior pueda disponer sin necesidad de cambiar el sentido de vuelo de una visi\u00f3n de 360\u00ba, cabe indicar que esto es en el caso de utilizar un sistema estabilizador del sistema de captura de video de tres ejes. (Este es opcional ya que en este caso se utilizara un sistema de dos ejes). En la imagen superior derecha podemos observar la fijaci\u00f3n de los motores utilizados y finalmente en las im\u00e1genes inferiores de la figura 12 la estructura montada con el tren de aterrizaje plegado e igualmente con el tren de aterrizaje desplegado. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 74 de 374 [Ir al \u00edndice] Una vez llevado a cabo el ensamblaje de la estructura y motores s e realiza el acople de los sistemas reguladores de motores (ESC) de la unidad Dron. Efectuando previamente las modificaciones mencionadas anteriormente que consisten en instalar un separador met\u00e1lico entre de los soportes RAIL (silentblock) y su fijaci\u00f3n a la estructura. Igualmente se procede a cablear los motores realizando el cableado por el interior del brazo, previamente los cables han sido enfundados con maya protectora para evitar posibles problemas por deterioro de los mismos. Quedando finalmente como se muestra en la figura 13. Para la fijaci\u00f3n de los reguladores ESC se intercala una plac a de carbono (para evitar posibles interferencias de los sistemas de trasmisi\u00f3n en los reguladores del sistema motor. Quedar\u00e1 as\u00ed , debido a la conductividad del material (fibra de carbono) , creada una Jaula de Faraday en cuyo interior se aloja ran los mencionados reguladores. Igualmente se instalara otra base inferior donde ser\u00e1 acoplado el modulo transmisi\u00f3 n de video. Quedan as\u00ed dos alojamientos para cada uno de los sistemas indicados como puede verse en las siguientes im\u00e1genes una vez efectuado el montaje. Figuras 3. Encaje sistemas ESC y Sistema Transmisi\u00f3n Video El montaje efectuado as\u00ed como su funcionamiento puede verse detalladamente en video Ensamblado estructura y propulsi\u00f3n existente en repertorio de videos aportado para uso en el alojamiento Web del presente proyecto. Enlace a video Figura 2 conexionado motores (Elaboraci\u00f3n propia) Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 75 de 374 [Ir al \u00edndice] 2 Verificaci\u00f3n, ajuste y medida de consumos de los diferentes m\u00f3dulos. Verificaci\u00f3n sistema propulsor La siguiente figura muestra el conexionado de los cables de control de motores, cuyo funcionamiento se verifica a continuaci\u00f3n. Para ello se requiere de las herramientas electr\u00f3nicas siguientes: 1 Switch para servos 1 Testeador Servos (Gen. y reg. de pulsos PWM) 1 Fuente alimentaci\u00f3n corriente continua regulable ajustada a 11. 7 y otra de 5V 1A. Figura 4 conexionado prueba motores propulsores Situando el control de motores en el CH3 del (Switch) y efectuando las conexiones de alimentaci\u00f3n (11.7V a ESC motores y 5V a Testeador Servos), se y ajusta ESC Emax 30A . Proceso de calibrado de motores Para ello colocamos el regulador al m\u00e1ximo y conectamos alimentaci\u00f3n, esperamos unos segundos y se oir\u00e1n los pitidos de aviso de calibraci\u00f3n terminada procedentes del ESC IMAX 30A. A continuaci\u00f3n se sit\u00faa el regulador al m\u00ednimo y deber\u00e1n de o\u00edrse los sonidos de ajuste de calibraci\u00f3n de m\u00ednimos. Figura 5 F.A. auxiliar para verificaci\u00f3n Una vez terminado el proceso, lo cual se sabr\u00e1 por qu\u00e9 el sistema ESC deja de emitir sonidos, se retira la alimentaci\u00f3n (bater\u00eda de la unidad Dron o como en este caso F.A.) posteriormente asegur\u00e1ndose de situar regulador en posici\u00f3n m\u00ednimo se vuelve a alimentar la unidad. Esta mediante una serie de sonidos nos indicara que est\u00e1 dispuesta para uso confirmando la activaci\u00f3n del sistema controlador de potencia de los motores. Si se act\u00faa sobre el regulador se debe observar que a m\u00ednimo los motores quedan parados y a m\u00e1ximo valor del regulador los motores alcanzan s u m\u00e1xima velocidad. Realizados estos ajustes se obtiene un funcionamiento correcto concluyendo as\u00ed el montaje y la verificaci\u00f3n del sistema de control de los motores propulsores. Efectuando medida de consumo emp\u00edricamente se obtienen los siguientes resultados: Consumo Sistema en estado de reposo: 2 50mA Consumo Sistema propulsi\u00f3n (motores m\u00e1xima potencia) 2.5A (**sin carga) Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 76 de 374 [Ir al \u00edndice] Respecto del comportamiento de los motores seleccionados, A221213T hacer referencia a las pruebas visualizadas (video existentes en internet y que se indican en referencias) \"las pruebas emp\u00edricas marcan un rendimiento en medida de peso de elevaci\u00f3n de 212g. a 770gr. es menor al indicado en caracter\u00edsticas t\u00e9cnic as indicadas del motor 900gr . Si bien hay que poner de manifiesto que seg\u00fan torque del motor por su referencia las h\u00e9lices utilizadas en la prueba por lo que puede apreciarse no son las correctas, estas deber\u00edan de ser de 12\" y como puede apreciarse en la figura 16 se han utilizado de 10\" lo que produce una menor fuerza de elevaci\u00f3n. En la siguiente figura se puede ver las caracter\u00edsticas de trabajo del motor, relaci\u00f3n consumo -rpm y fuerza de elevaci\u00f3n en gramos. Figura 6 Relaci\u00f3n consumo -rpm y fuerza elevaci\u00f3n motores Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 77 de 374 [Ir al \u00edndice] 3 Sistema Controlador de Vuelo (APM 2.6 ArduCopter) El sistema embebido de control de vuelo y piloto autom\u00e1tico, es instalado en la parte superior de la estructura . Con ello se pretende que la propia estructura dificulte que puedan interferir las se\u00f1ales correspondientes del sistema de transmisor de video (5.8GHz) sobre el sistema con control de vuelo (APM Ardu Copter 2.6 ) o sobre el receptor de radio -control igualmente ubicado en esta zona de la estructura. El correspondiente cableado queda salvaguardado pr\u00e1cticamente en su totalidad en la parte central de la estructura bajo el sistema anti vibraci\u00f3n ins talada sobre el que se montara la unidad de control de vuelo, dejando \u00fanicamente la longitud suficiente para la interconexi\u00f3n ente los dispositivos que se utilizaran para el control los cuales son: Del receptor RX de Radio- control RF 2.4Ghz a unidad APM De la unidad APM, hasta el dispositivo de sistema central Raspberri, para control por MAVLink. Igualmente a la controladora de vuelo se conectan los distintos dispositivos perif\u00e9ricos como es la unidad GPS para localizaci\u00f3n ( RS232) , y la br\u00fajula compas (mediante comunicaci\u00f3n bus I2C). El controlador de vuelo ser\u00e1 conectado al sistema central y al OSD (On Screen Display) mediante su puerto de telemetr\u00eda UART 0/1. Quedando de esta forma el el sistema de control de vuelo disponible para poder ser comandado seg\u00fan necesidades, de alcance, maniobra, servicio, etc... mediante el uso de los correspondientes sistemas programados. En las siguientes figura se puede observar la distribuci\u00f3n que se ha dado en la parte superior de la estructura para anclaje del GPS, la fijaci\u00f3n del soporte anti vibraciones para la APM, y los anclajes para la fijaci\u00f3n del receptor de radio- control. Figura 7 disposicion APM sobre estructura. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 78 de 374 [Ir al \u00edndice] 4 Instalaci\u00f3n Sistema Estabilizador de c\u00e1mara ( Gimbal 2 Ejes ) Problemas de proveedores ha obligado a efectuar modificaciones no previstas , ya que no se ha podido obtener en tiempos el dispositivo estabilizador del sistema de video Tarot el cual estaba previsto en el dise\u00f1o original . Se ha utilizado un sistema estabilizador (Gimbal de 2 Ejes) DJI para Go pro. Este es m\u00e1s peque\u00f1o lo que ha supuesto algunos problemas que de adaptaci\u00f3n para poder calibrar y obtener un correcto funcionamiento del sistema est abilizado el cual se ha tenido que limitar los l\u00edmites de \u00e1ngulos Roll y Pitch para poder obtener un \u00f3ptimo resultado y que la unidad estabilizadora quede calibrado. Estos \u00e1ngulos han quedado por tanto limitados a 30\u00ba, que si bien creemos son suficientes pues no se espera que la en vuelo llegue a esas inclinaciones, si ha llevado una serie de problemas que ha dejado la unidad limitada en una parte importante como es la estabilidad de la captura de imagen. En las siguientes im\u00e1genes se muestra lo indicado se puede ver como el sistema de anclaje es peque\u00f1o por lo que se ha tenido que invertir el soporte de c\u00e1mara y en vez que de la c\u00e1mara (en este caso el sistema Raspberry ) repose sobre el soporte se ha tenido que instalar quedando suspendido el de dicho soporte como puede apreciarse en la imagen de la derecha. Ello limita los \u00e1ngulos de giro tanto el Roll como puede verse en la imagen de la izquierda como el Pitch por llegar a un punto donde el sistema choca con el motor del sistema estabilizado. Figura 8 modificaciones en sistema estabilizado. Finalmente adaptando la estructura del Gimbal, y efectuando fijaci\u00f3n mediante tornillos de la caja del sistema Raspberry Pi se ha conseguido aunque con las limitaciones en los \u00e1ngulos como se ha indicado cosa que no puede remediarse sin efectuar el cambio de la estructura Gimbal por la que inicialmente se hab\u00eda planteado y que no presentaba estos problemas pues es mayor. Esto supon\u00eda un problema ser\u00eda pues como puede verse en la siguiente figura con la c\u00e1mara sin estabilizar es imposible pues visionarse y mucho menos usar t\u00e9cnicas detecci\u00f3n de color como se pretende llevar a cabo para la detecci\u00f3n de incendios. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 79 de 374 [Ir al \u00edndice] Figuran 8 Problemas de vibraci\u00f3n en Sistema estabilizador de camara La soluci\u00f3n ha pasado por la limitaci\u00f3n de los \u00e1ngulos , invertir el aceler\u00f3metro instalado en el dispositivo estabilizado, y realizar la calibraci\u00f3n correspondiente de la controladora de Gimbal mediante su programaci\u00f3n, ya que invertir el soporte el sistema lo entiende como girado sobre el Pitch no consiguiendo estabilizar el sistema ni tan siquiera estando el Dron posado con las consecuencias que pueden verse en la figura 8. Una vez corregido puede verse en la siguiente figura como ya la imagen queda estabilizada y fijada incluso aunque varie el Angulo de inclinaci\u00f3n (dentro de los m\u00e1rgenes indicados). Figura 9 Problemas de vibraci\u00f3n en Sistema estabilizador de c\u00e1mara En la Web del proyecto puede verse mediante video el montaje y su correcto funcionamiento, quedando as\u00ed por tanto calibrado el sistema estabilizador. Este se ha verificado dejando el sistema en funcionamiento largo tiempo (entre 4-5 horas ) con sonda de temperatura colocada en motores para verificar que la temperatura de estos no sea elevada como indica el fabricante ya que al una alta temperatura puede da\u00f1ar alguno de sus imanes internos y por tanto inutilizar el sistema estabilizador definitivamente. La temperatura obtenida no ha llegado nunca a los 39\u00ba, teniendo en cuenta que en la ubicaci\u00f3n la temperatura ambiente es de unos 23\u00ba se considera que el funcionamiento es correcto. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 80 de 374 [Ir al \u00edndice] 5 Verificaci\u00f3n M\u00f3dulo GSM -900A El modulo adquirido por cuestiones de precio ha sido el m\u00f3dulo GSM900A de doble banda 900- 1800Mhz (importado de Jap\u00f3n) ya que los aqu\u00ed existentes Quadband, dichas bandas no son \u00fatiles en Europa y el costo es mucho m\u00e1s elevado. Cabe i ndicar que se debe de actualizar su firmware al de Europa para su correcto funcionamiento en Europa. Proceso que llevamos a cabo. Una vez actualizado el mismo, efectuamos la conexi\u00f3n del m\u00f3dulo GSM900A mediante herramienta electr\u00f3nica conversor (RS232- USB) CP21 01 al PC con la finalidad de verificar su correcto funcionamiento. En la siguiente figura puede verse el cableado para su conexi\u00f3n directamente al PC (a trav\u00e9s de USB). Haciendo uso del Software TeraTem , (como se observa en la figura de la derecha), se efect\u00faa la conexi\u00f3n con el dispositivo, se le indica el PIN efectuando una llamada de prueba a tel\u00e9fono fijo y se realiza envi\u00f3 de un mensaje SMS a tel\u00e9fono m\u00f3vil, obteniendo resultado positivos. Figura 10 Cableado GSM -CP2102 y Captura comunicaci\u00f3n con PC via GSM En dichas pruebas se efect\u00faa toma emp\u00edrica de medidas, mediante interconexi\u00f3n de Mult\u00edmetro. Obteniendo los siguientes resultados de consumo en reposo y efectuando transmisi\u00f3n (llamada telef\u00f3nica) y envi\u00f3 de SMS: Consum o GSM en estado de reposo: 18- 20mA Consumo GSM en estado de transmisi\u00f3n: 60mA Datos que a posteriori ser\u00e1n necesarios para los correspondientes de consumo y as\u00ed poder determinar la potencia necesaria de las bater\u00edas a utilizar para determinar el tiempo fi nal de vuelo y uso a pleno rendimiento de la unidad. Queda por tanto verificado el m\u00f3dulo de comunicaci\u00f3n GSM -GPRS que ser\u00e1 utilizado el cual se instara sobre una placa de baquelita junto con la placa de sensores atmosf\u00e9ricos, la cual se ubicara sobre los soportes preparados como puede observarse en la figura 7 anterior, quedando as\u00ed todos los dispositivos acoplados a la estructura Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 81 de 374 [Ir al \u00edndice] 6 Ensamblaje sensores datos atmosf\u00e9ricos Por \u00faltimo se lleva a cabo el montaje de los sensores para lo cual se ha efectuado un peque\u00f1o montaje sobre baquelita del sensor de temperatura, medidos de luminosidad y proximidad, y medido de presi\u00f3n barom\u00e9trica, como puede verse en la siguiente figura el sensor de humedad se fija sobre el propio chasis. Estos sensores comunican con el sistema central (Raspberry Pi) mediante bus I2C.. Figura 11 P laca de sensores Figura . 12 placas de sensores Dado que conviven en la unidad diversos sistemas de RF y se hace uso del osciloscopio, el cual se conecta al bus I2C y activando un bucle de petici\u00f3n de muestreo se pasa a medir la se\u00f1al para observar si le est\u00e1n llegando las se\u00f1ales correctamente sin interferencias. Figura . 13 Se\u00f1al Bus I2C Puede verse que efectivamente la se\u00f1al llega correctamente a la frecuencia de 100Khz velocidad del bus y que no presenta interferencias, incluso armando motores por si estos le afectara. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 82 de 374 Verificando el peso de la UAV, vemos que ha pasado de los 2Kg que se esperaba como m\u00e1ximo, Figura . 14 Peso final de la unidad. Estando como puede apreciarse su peso en 2,3Kg, con bater\u00eda ser\u00eda conveniente en un futuro revisar partes del montaje y ver en qu\u00e9 medida puede rebajarse dicho peso. Quedan por tanto verificados todos los m\u00f3dulos y componente que dando finalmente el ensamblaje como puede verse en la siguiente figura: Figura . 15 montaje final de la UAV. Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 83 de 374 Anexo B [Ir al \u00edndice] ESQUEMAS ELECTRICOS Y DATASHEET Dise\u00f1o e implementaci\u00f3n Dron para la detecci\u00f3n de incendios forestales Autor: Miguel \u00e1ngel Iglesias Jim\u00e9nez 84 de 374 USB Power Input 5V 4 D3 XIO1 23 45 67 89 1011 1213 1415 2223 2425 2627 2829 3031 3233 3435 36JP6 1 2 3 4 5 6 7 8 9 10 1 2 3 4 5 6 7 47 45 43 41 46 44 42 40 38 pwm make changes to specifications and product descriptions at any time, without notice. The Customer must notREGARDING PRODUCTS, INCLUDING BUT NOT LIMITED TO, ANY MERCHANTABILITY OR FITNESS FOR A PARTICULAR whatsoever for conflicts or incompatibilities arising from future changes to them. The product information on the Web Site or Materials is subject to change without notice. Do not finalize a design with this connection diagram CAM STAB ROLL CAM STAB PITCH CAM CONTROL ROLL CONTROL PITCH3rd axis expansion board GND SDABATYAW Broadcom Corporation. All rights reserved Broadcom Europe Ltd. 406 Science Park Milton Road 0WW BCM2835 ARM Peripherals 06 February 2012 Broadcom 406 Science Park Milton Road Cambridge CB4 0WW Page ii \u00a9 2012 Broadcom Corporation. All Table of Contents 1 Introduction 1.2.1 Diagrammatic overview 4 1.2.2 ARM virtual addresses (standard Linux kernel only) 6 1.2.3 ARM physical addresses 6 1.2.4 Bus addresses 6 1.3 Peripheral access 8 Overview SPI implementation details 20 2.3.2 SPI register details. 22 3 BSC 28 3.1 Introduction 28 3.2 Register View 28 3.3 10 Bit Addressing 36 4 DMA Controller 38 4.1 Overview 38 4.2 DMA Controller Registers 39 4.2.1 DMA Channel Register Address Map 40 4.3 AXI Bursts 63 4.4 Error Handling 63 4.5 DMA LITE Engines 63 5 External Mass Media Controller 65 o Introduction 65 o Registers 66 6 General Purpose I/O (GPIO) 89 6.1 Register View 90 6.2 Alternative Function Assignments 102 6.3 General Purpose GPIO Clocks 109 7.1 110 7.3 Interrupt (FIQ). 110 7.4 Interrupt priority. 110 7.5 Registers 112 8 PCM / I2S Audio 119 8.1 Block Diagram 120 8.2 Typical Timing 120 8.3 Operation 121 8.4 Software Operation 122 8.4.1 Operating in Polled mode 122 123 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page iii \u00a9 2012 Broadcom Corporation. All rights reserved 8.4.3 DMA 123 8.5 Error Handling. 123 8.6 PDM Input Mode Operation 124 8.7 GRAY Code Input Mode Operation 124 8.8 PCM Register Map 125 9 Pulse Width Modulator 138 9.1 Overview 138 9.2 Block Diagram 138 9.3 PWM Implementation 139 9.4 Modes of Operation 139 9.5 Quick Reference 140 9.6 Control and Status Registers 141 10 SPI 148 10.1 Introduction 148 10.2 SPI Master Mode 148 10.2.1 Standard mode 148 10.2.2 Bidirectional mode 149 10.3 LoSSI mode 150 10.3.1 Command write 150 10.3.2 Parameter write 150 10.3.3 Byte read commands 151 10.3.4 24bit read command 151 10.3.5 32bit read command 151 10.4 Block Diagram 152 10.5 SPI Register Map 152 10.6 Software Operation 158 10.6.1 Polled 158 10.6.2 Interrupt 158 10.6.3 DMA 11 SPI/BSC SLAVE 160 11.1 Introduction 160 11.2 Registers 160 12 System Timer 172 12.1 System Timer Registers 172 13 UART Interrupts 176 13.4 Register View 177 196 14.1 Introduction 14.2 Adapted registers. 202 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 4 \u00a9 2012 Broadcom f or these peripherals in sufficient detail to allow a developer to port an operating system to BCM2835. There are a number of peripherals which are intended to be controlled by the GPU. These are omitted from this datasheet. Accessing these peripherals f rom the is 1.2 Address map 1.2.1 Diagrammatic overview In BCM2835 includes a second coar se-grained MMU for mapping ARM physical addresses onto system bus addresses. T his spaces of interest: 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 5 \u00a9 2012 Broadcom Corporation. All rights reserved 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 6 \u00a9 2012 Broadcom Corporation. All rights Addresses in ARM Linux are: issued as virtual addresses by the ARM core, then mapped into a physical address by the ARM MMU, then mapped into a bus address by the ARM mapping MMU, and finally used to select the appropriate peripheral or location in RAM. 1.2.2 ARM virtual addresses (standard Linux kernel only) As is standard practice, the standard BCM2835 Linux kernel pro vides a contiguous mapping over the whole of available RAM at the top of memory. The kernel is configured for a 1GB/3GB split between kernel and user-space memory. The split between ARM and GPU memory is selected by ins talling one of the supplied start*.elf files as start.elf in the FAT32 boot partition of the SD card. The minimum amount of memory which can be given to the GPU is 32MB, but th at will restrict the multimedia 32MB does not provide enough buff ering the GPU to do 1080p30 video decoding. Virtual addresses in kernel mode will range between 0xC0000000 an d 0xEFFFFFFF. Virtual addresses in user mode (i.e. seen by processes running in ARM Linux) will range between 0x00000000 and 0xBFFFFFFF. Peripherals (at physical address 0x20000000 on) are mapped into t he kernel virtual space starting at address 0xF2000000. Thus a here the ARM kenel 1.2.3 ARM physical addresses Physical addresses start at 0x00000000 for RAM. The ARM section of the RAM starts at 0x00000000. The VideoCore section of the RAM is mapped in only if t he system is configured to support a memory mapped display (this is the common case) . The VideoCore MMU maps the ARM physical address space to the bus address space seen by VideoCore (and VideoCore peripherals). The bus addresse s for RAM are set up to map onto the uncached 1 bus address range on The addresses for peripherals are set up to map onto the periphe ral address range starting The directly accessing peripherals must translate Software accessing peripherals using bus addresses. 1 BCM2835 provides a 128KB system L2 cache, which is used primari ly by the GPU. Accesses to memory are routed either via or around the L2 cache depending on senior two bits of the bus address. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 7 \u00a9 2012 Broadcom Corporation. All rights reserved Software accessing RAM directly must use physical addres ses at 0x00000000). Software accessing RAM using AMBA interface structure. In order to keep the system complexity low and data throughput high, the BC M2835 AXI system does not always return read data in-order 2. The GPU has special logic to cope with data arriving out - of-order; however the ARM core does not such Therefore some precautions must using the ARM to access peripherals. Accesses to the same peripheral will always arrive an d return in-order. It is only when switching from one peripheral to another that data can a rrive out-of-order. The simplest way to make sure that data is processed in-order is to place a memory barrier instruction at critical positions in the code. You should place: A memory write barrier before the first write to a peripheral. A memory read barrier after the last read of a periphe ral. It is not required to put a memory barrier instruction after each read or write access. Only at those places in the code where it is possible that a peri pheral read or write may be followed by a read or write of a different peripheral. This is normally at the entry and exit poin ts of the peripheral service code. As interrupts can appear anywhere in the code so you should those. interrupt routine reads from a peripheral the routine should star a memory read barrier. If an interrupt routine writes to a peripheral the s a memory write barrier. 2Normally a processor assumes that if it executes two r ead operations the data will arrive in order. So a rea d from location X followed by a read from location Y shoul d return the data of location X first, followed by the data of location Y. Data arriving out of order can have dis consequences. up the variable s a_status and b_status can be swapped around. It is theoretical possible for writes to go 'wrong' but that is far more difficult to achieve. The AXI syst em makes sure give the expected result. The only time write data can arrive out-of-order is if two different peripherals are connected to the same external equipment. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 8 \u00a9 2012 Broadcom Auxiliaries: UART1 2.1 Overview The Device has three Auxiliary peripherals: One mini U ART and two SPI masters. These three peripheral are grouped together as they share the same area in the peripheral register map and they share a common interrupt. Also 1 Control register SPI 1 Status 1 Data 32 Peek 16 0x7E21 Control register 0 32 0x7E21 50C4 AUX_SPI1_CNTL1_REG SPI 2 Control register 1 8 3 These register names are identical to the defines in 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 9 \u00a9 2012 Broadcom Corporation. All 2 2 Data 32 0x7E21 50D4 AUX_SPI1_PEEK_REG SPI 2 Peek 16 2.1.1 AUX registers There are two Auxiliary registers which control all t hree devices. One is the interrupt status register, the IRQ status register the of an t. pending which m ay be asserted by the three Auxiliary sub blocks. Bit(s) Field Name Description Type Reset 31:3 Reserved, write zero, read as don't care 2 SPI 2 IRQ If set the SPI 2 module has an interrupt pendin g. R 0 1 SPI 1 IRQ If set the SPI1 module has an interrupt pendi ng. R 0 0 Mini UART IRQ If set the mini UART zero, read as don't care 2 SPI2 enable If set the SPI 2 module is enabled. If clear the SPI 2 module disables any SPI 2 module register access R/W 0 1 SPI 1 enable If set the SPI 1 module is enabled. If clear the SPI 1 module disables any SPI access R/W 0 0 Mini UART enable If the mini UART is enabled. The will immediately start receiving data, if the UART1_RX line is low . clear the mini 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 10 \u00a9 2012 Broadcom Corporation. All rights reserved If the enable bits are clear you will have no access to a peripheral. You can not even read or write the registers! GPIO pins should be set up first the before enabling the U ART. The UART core is build to emulate 16550 behaviour. So when it is enabled any data at the inputs will immediately be received . If the UART1_RX line is low (because the GPIO pi ns have not been set-up yet) that will be seen as a start bit and the UART will sta rt receiving 0x00-characters. Valid stops bits are (See al so Implementation details). Hence any bit status is acceptable as stop bit and is only used so the re is clean timing start for the next bit. Looking after a reset: the baudrate will be zero and the system clock will be 250 MHz. So only 2.5 \u00b5seconds suffice to fill the receive FIFO. The result will be that the FIFO is full and overflowing in no time flat. 2.2 Mini UART The mini UART is a secondary low throughput 4 intended to used as a console. It needs to be enabled before it can be used. It is also r ecommended that the correct mode before The mini Uart has the following features: 7 or 8 bit operation. 1 start and 1 stop bit. No parities. Break generation. 8 symbols deep SW level. 16550 like registers. Baudrate derived from system clock. This is a mini UART and it does NOT the 16650 compatible UART However as far as possible the first 8 control and status registers are laid out like a 16550 UART. Al 16550 register bits which are not supported can be written but will be ignore d and read back as 0. All control bits for simple UART receive/transmit operations are a vailable. 4 The UART itself has no throughput limitations in fact it can run up to 32 Mega baud. But doing so requires significant CPU involvement as no DMA support. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 11 \u00a9 2012 will ta ke 2 system clock cycles before they are processed. The module does not check for any framing errors. After rec eiving a start bit and 8 (or 7) data bits the receiver waits for one half bit time and th en starts scanning for the next start bit. The mini UART does not check if the stop bit is high or wait for the stop bit t o appear. As a result of this a UART1_RX input line which is continuously lo w (a break condition or an error in connection or is 250 MHz and the baud register is zer o the baudrate is Mbits/sec or 3.125 Mbytes/sec). lowest baudrate w ith a 250 MHz system clock is 476 Baud. When writing to the data register only the LS 8 bits are t aken. All other bits are ignored. When reading from the data register only the LS 8 bits are valid. All other bits are to write data to and read d ata from the UART FIFOs. If the DLAB bit in the line control register is set this register gives access to the LS 8 bits of the baud rate. (Note: there is easier access to Field Name Type write zero, read as don't care 7:0 LS 8 bits Baudrate read/write, DLAB=1 Access to the LS 8 bits of the 16-bit baudrate register. (Only If bit 7 of the line control register (DLAB bit) is set) R/W 0 7:0 Transmit data write, DLAB=0 Data written is put in the transmit FIFO (Provided it is not full) (Only If bit 7 of the line control register (DLAB bit) is clear) W 0 7:0 Receive data read, DLAB=0 Data read is taken from the receive FIFO (Provided it is not empty) (Only If bit 7 of the line control register (DLAB bit) is clear) R 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 12 \u00a9 the DLAB bit in the line control register is set this register gives access to the MS 8 bits of the baud rate. (Note: there is easier access to Field Name Type write zero, read as don't care 7:0 MS 8 bits Baudrate read/write, DLAB=1 Access to the MS 8 bits of the 16-bit baudrate register. (Only If bit 7 of the line control register (DLAB bit) i s set) R/w 0 7:2 Reserved, write zero, read as don't care Some of these bits have functions in a 16550 compatible UART but are ignored here 1 Enable receive interrupt (DLAB=0) If this bit is set the line is asserted whenev er the receive FIFO holds at least 1 byte. If this bit is clear no receive are generated. R 0 0 Enable interrupt (DLAB=0) If this bit is set the interrupt line is asserted whenev er the transmit FIFO is empty. If this bit is clear no transmit interrupts are generat ed. R 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 13 \u00a9 It also has two FIFO enable status bits and (when w riting) FIFO clear bits. Bit(s) Field Name Description Type Reset 31:8 Reserved, write zero, read as don't care 7:6 FIFO enables Both bits always read as 1 as the FIFOs are always enabled R 11 5:4 - Always read as zero R 00 3 - Always read as zero as the mini UART has no timeout function R 0 2:1 READ: Interrupt ID bits WRITE: FIFO clear bits On read this register shows the interrupt ID bit 00 : No interrupts 01 : Transmit holding register empty : <Not possible> On write: Writing with bit 1 set will clear the receive FIFO Writing with bit 2 set will clear the transmit FIF O R/W 00 0 Interrupt pending This bit is clear whenever interrupt is pending R 1 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 14 \u00a9 gives acces s to the baudrate register Bit(s) Field Name Type Reset 31:8 Reserved, write zero, read as don't care 7 DLAB access If set the first to Mini UART register give access the the Baudrate register. During operation this bit must be cleared. R/W 0 6 Break If set high the UART1_TX line is pulled low continuously. If held for at least 12 bits times that wi ll indicate a break condition. R/W 0 5:1 Reserved, write zero, read as don't care Some of these bits have functions in a 16550 compatible UART but are ignored here 0 0 data size If clear the UART works in 7-bit mode If set the Reset 31:8 Reserved, write zero, read as don't care 7:2 Reserved, write zero, read as don't care Some of these bits have functions in a 16550 compatible UART but are ignored here 0 1 RTS If clear the UART1_RTS line is high If set the UART1_RTS line is low This bit is ignored if the RTS is used for auto-flow control. See the Mini Uart Extra Control register description) R/W 0 0 Reserved, write zero, read as don't care This bit has a function in a 16550 compatible UART but is ignored here 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 15 \u00a9 Field Name Description Type Reset 31:8 Reserved, write zero, read as don't care 7 Reserved, write zero, read as don't care This bit has a function in a 16550 compatible UART but is ignored here 0 6 Transmitter idle This bit is set if the transmit FIFO is empty and the transmitter is idle. (Finished shifting out the last bit). R 1 5 Transmitter empty This bit is set if the transmit FIFO can accept at lea st one byte. R 0 4:2 Reserved, write zero, read as don't care Some of these bits have functions in a 16550 compatible UART but are ignored here 0 1 Receiver Overrun This bit is set if there was a receiver overrun. That is: one or more characters receive FIFO was full. The newly charters have been discarded. This bit is cleared each time this register is read. To do a non-destructive read of this overrun bit use the Mini Uart Extra Status register. R/C 0 0 Data ready This bit is set if the receive FIFO holds at least 1 Name Description Type Reset 31:8 Reserved, write zero, read as don't care 7:6 Reserved, write zero, read as don't care Some of these bits have functions in a 16550 compatible UART but are ignored here 0 5 CTS status This bit is the inverse of the UART1_CTS input Thus : If set the UART1_CTS pin is low If clear the UART1_CTS pin is high R 1 3:0 Reserved, write zero, read as don't care Some of these bits have functions in a 16550 compatible UART but are ignored here 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 16 \u00a9 AUX_MU_SCRATCH is Bit(s) Field Name Description Type Reset 31:8 Reserved, write zero, read as don't care 7:0 Scratch One whole byte extra on top of the 134217728 provided extra useful and nice features not found on a normal 16550 . Bit(s) Field Name Description Type Reset 31:8 write zero, read as don't care 7 CTS assert level This bit allows one to invert the CTS auto flow operation polarity. If set the CTS auto flow assert level is low* If clear the CTS auto flow assert level is high* R/W 0 6 RTS assert level This bit allows one to invert the RTS auto flow operation polarity. If set the RTS auto flow assert level is low* If clear the RTS auto flow assert level is high* R/W 0 5:4 RTS AUTO flow level These two bits specify at what receiver FIFO level the RTS line is de-asserted in auto-flow mode. 00 : De-assert RTS when the receive FIFO has 3 empty spaces left. 01 : De-assert when the has 2 empty spaces left. 10 : De-assert RTS when the receive FIFO has 1 empty space left. 11 : De-assert RTS when the receive transmit Auto CTS If this bit is set the transmitter will stop if the CT S line is de-asserted. If this bit is clear the transmitter will ignore the status of the CTS line R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 17 \u00a9 2012 Broadcom Corporation. 2 Enable receive Auto flow- control using RTS If this bit is set the RTS line will de-assert if the receive FIFO reaches it 'auto flow' level. In fact t he RTS line will behave as an RTR (Ready To Receive) line. If this bit is clear the RTS line is controlled by the AUX_MU_MCR_REG register bit 1. R/W 0 1 Transmitter enable If this bit is set the mini UART transmitter is enable d. If this bit is clear UART transmitter is disabled R/W 1 0 Receiver enable If bit is set the mini UART receiver is enabled. If this bit is receiver is disabled R/W 1 Receiver enable If this bit is set no new symbols will be accepted by the receiver. Any of reception will be finished. Transmitter enable If this bit is set no new symbols will be send the trans mitter. Any symbols in progress of transmission will be finished. Auto flow control Automatic flow control can be enabled independent for the receiver and the transmitter. CTS auto flow control impacts the transmitter only. T he transmitter will not send out new symbols when the CTS line is de-asserted. Any symbols in progress of transmission when the CTS line becomes de-asserted will be finished. RTS auto flow control impacts the receiver only. In f act the name RTS for the control line is incorrect and should be RTR (Ready to Receive). The rec eiver will de-asserted the RTS (RTR) line when its receive FIFO has back a mini UART using full auto flow control the logic is fast enough to allow the RTS auto flow level of '10' (De-assert RTS when t he receive FIFO has 1 empty space left). Auto flow polarity To offer full flexibility the polarity of the CTS and RTS (RTR) lines can be programmed. This should allow the mini UART to interface with any e xisting hardware flow control available. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 18 \u00a9 about the inte rnal status of the mini UART not found on a normal 16550 UART. Bit(s) Field Name Description Type Reset read as don't care 27:24 Transmit FIFO fill level These bits shows how many symbols are stored in the transmit FIFO The value is in the range 0-8 R 0 23:20 Reserved, zero, read as don't care 19:16 Receive FIFO fill level These bits shows how many symbols are stored in the receive FIFO The value is in the range 0-8 R 0 15:10 Reserved, write zero, read as don't care 9 Transmitter done This bit is set if the transmitter is idle and the tra nsmit FIFO is empty. It is a logic AND of bits 2 and 8 R 1 8 Transmit FIFO is empty If this bit is set the transmitter FIFO is empty. Thus it can accept 8 symbols. R 1 7 CTS line This bit shows the status of the UART1_CTS line. R 0 6 RTS status This bit shows the status of the UART1_RTS li ne. R 0 5 Transmit FIFO is full This is the inverse of bit 1 R 0 4 Receiver overrun This bit is set if there was a receiver overrun. That is: one or more characters full. The have been This bit is cleared each time the AUX_MU_LSR_REG register is read. R 0 3 Transmitter is idle If this bit is set the transmitter is idle. If this bit is clear the transmitter is idle. R 1 2 Receiver is idle If this bit is set the receiver is idle. If this bit is clear the receiver is busy. This bit can change unless the receiver is disabled R 1 1 Space available If this bit is set the mini UART transmitter FIFO can accept at least one more symbol. If this bit is clear the mini UART transmitter FIFO is full R 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 19 \u00a9 2012 Broadcom Corporation. All rights reserved 0 Symbol available If this bit is set the mini UART receive FIFO contains at least 1 symbol If this bit is clear the mini UART receiver FIFO is empty R 0 Receiver is idle This bit is only useful if the receiver is disabled. The normal use is to disable the receiver. Then check (or wait) until the bit is set. Now you can be sure that no new symbols will arrive. (e.g. now you can change the baudrate...) Transmitter is idle This bit tells if the transmitter is idle. Note that th e bit will set only for a short time if the transmit FIFO contains data. Normally you want to use bit 9: Transmitter done. RTS status This bit is useful only in receive Auto flow-control mode a s it shows the status of the RTS line. AUX_MU_BAUD Register (0x7E21 5068) SYNOPSIS The 16-bit wide baudr counter. Bit(s) Field Name Description Type Reset baudrate counter register as is accessed using the LABD bit and the first two register, but much easier to access. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 20 \u00a9 2012 Broadcom Corporation. All rights reserved 2.3 Universal SPI Master (2x) The two universal SPI masters are secondary low throughput5 SPI interfaces. Like the UART the devices needs to be enabled before they can be used. E ach SPI master has the following features: Single beat bit length between 1 and 32 bits. Single beat variable bit length between 1 and 24 bits Multi beat infinite bit length. 3 independent chip selects per master. 4 entries 32-bit wide transmit and receive FIFOs. Data out on rising or falling clock edge. Data in on rising or falling clock edge. Clock inversion (Idle high or idle low). Wide clocking range. Programmable data out hold time. Shift in/out MS or LS bit first A major issue with an SPI interface is that there i s no SPI standard in any form. Because the SPI interface has been around for a long time some pseudo- standard rules have appeared mostly when interfacing with memory devices. The universal S PI master has been developed to work even with the most 'non-standard' SPI devices. 2.3.1 SPI implementation details The following diagrams shows a typical SPI access cycl e. In this case we have 8 SPI clocks. 1 Bit time Set-up Operate Hold (optional) Idle Clk Cs_n One bit time before any clock edge changes the CS_n will go l ow. This makes sure that the MOSI signal has a bit-time of set-up against any cha nging clock after the last clock cycle . Note that at the end there is one half- bit time where the clock does not change but which still is part of the operation cycle. There is an option to add a half bit cycle hold time. T his makes sure that any MISO data has at least a full SPI bit time to arrive. (Without this hold time, data clocked out of the SPI device on the last clock edge would have only half a bit tim e to arrive). 5 Again the SPIs themselves have no throughput limitations i n fact they can run with an SPI clock of 125 MHz. But doing so requires significant CPU involvement as they have and no DMA support. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 21 \u00a9 2012 Broadcom Corporation. All rights reserved Last there is a guarantee of at least a full bit time where the spi chip select is high. A longer CS_n high period can be programmed for another 1-7 the system clock is 250 MHz and the speed field is zero t he SPI clock frequency is 125 MHz. The practical SPI clock will be lower as the I/O pads can not transmit or receive signals at The lowest clock th a 250 MHz system clock is 30.5 KHz. The hardware has an option to add hold time to the MOSI signal against the SPI clk. This is again done using the system clock. So a 250 MHz system clock will add hold times in units of 4 ns. Hold times of 0, 1, 4 and 7 system clock cycles can be used. (So at 250MHz an additional hold time of 0, 4, 16 and 28 ns can be achieved). T he hold time is additional to the normal output timing as specified in the data sheet. 2.3.2 Interrupts The SPI block has two interrupts: TX FIFO is empty, SPI is Idle. TX FIFO is empty: This interrupt will be asserted as soon as the last ent ry has been read from the transmit FIFO. At that time the interface will still be busy shiftin g out that data. This also implies that the receive FIFO will not yet contain the last received data. It is possible at that time to fill the TX FIFO again and read the receive FIFO entries which have been received. Note that there is no \"receive FIFO full\" interrupt as the number of en to of SPI is IDLE: This interrupt will be asserted when the transmit FIFO is empty and the SPI block has finished all actions (including the CS-high time) By this ti me the receive FIFO will have all received data as well. 2.3.3 Long bit streams The SPI module works in bursts of maximum 32 bits. Some SPI devices require data which is longer the 32 bits. To do this the user must make use of the two different data TX addresses: Tx data written to one address cause the CS to r emain asserted. Tx data written to the other address cause the CS to be de-asserted at the end of the transmit cycle. So in order to exchange 96 bits you do the following: Write the first two data words to one address, then write the third word to the other address. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 22 \u00a9 2012 SPI interfaces. Bit(s) Field Name Description Type Reset 31:20 Speed Sets the SPI clock speed. pins when active . R/W 111 16 post-input mode If set the SPI input works in post input mode. For details see text further down R/W 0 15 Variable CS If 1 the SPI takes the CS pattern and the data from the TX fifo If 0 the SPI takes the CS pattern from bits 17-19 of this register Set this bit only if also bit 14 (variable width) is set R/W 0 14 Variable width If 1 the SPI takes the shift length and the data from the TX fifo If 0 the SPI takes the shift length from bits 0-5 of this register R/W 0 13:12 DOUT Hold time Controls the extra DOUT hold time in system clock cycles. 00 : No extra hold time 01 : 1 system clock extra hold time 10 : 4 system clocks extra hold time 11 : 7 system clocks extra hold time R/W 0 11 Enable Enables the SPI interface. Whilst disabled the FIFOs can still be written to or read from This bit should be 1 during normal operation. R/W 0 10 In rising If 1 data is clocked in on the rising edge of the SPI clock If 0 data is clocked in on the falling edge of the SPI clock R/W 0 9 Clear If operation. R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 23 \u00a9 2012 Broadcom Corporation. All rights reserved 8 Out rising If 1 data is clocked out on the rising edge of the SPI clock If 0 data is clocked out on the falling edge of the SPI clock R/W 0 7 Invert SPI CLK If 1 the 'idle' clock line state is high. If 0 the 'idle' clock line state is low. R/W 0 6 Shift out MS bit first If 1 the data is shifted out starting with the MS bit. (bit 15 or bit 11) If 0 the data is shifted out starting with the LS bit. (bi t 0) R/W 0 5:0 Shift length Specifies the number of bits to shift This field ignored when 'variable shift' mode immediately change the polarity of the SPI clock output. It is recommended not to do this when also the CS is active a s the connected devices will see this as a clock change. DOUT hold time Because the interface runs of fast silicon the MOSI hold time against the clock will be very short. This can cause considerable problems on SPI slaves . To make it easier for the slave to see the data the hold time of the MOSI out against the SPI clock out is programmable. No hold time MOSI CLK With hold time MOSI CLK Variable width In this mode the shift length is taken from the transmit FIFO. The transmit data bits 28:24 are used as shift length and the data bits 23:0 are the actual tra nsmit data. If the option 'shift MS out first' is selected the first bit shifted out will be bit 23. The receive data will arrive as normal. Variable CS This mode is used together with the variable width mode. In this mode the CS pattern is taken from the transmit FIFO. The transmit data bits 31: 29 are used as CS and the data bits 23:0 are the actual transmit data. This allows the CPU to write to different SPI devices without having to change the CS bits. However the data lengt h is limited to 24 bits. Post-input mode Some rare SPI devices output data on the falling clock edge w hich then has to be picked up on the next falling clock edge. There are two problems wi th this: 1. The very first falling clock edge there is no valid data a rriving. 2. After the last clock edge there is one more 'dangling' bi t to pick up. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 24 \u00a9 2012 Broadcom Corporation. All rights reserved The post-input mode is specifically to deal with this sort of data. If the post-input mode bit is set, the data arriving at the first falling clock edge is ignored. Then the last falling clock edge the CS remain asserted and after a full bit time the last data bit is picked up. The following figure shows this behaviour: Clk Cs_n Get first bit Get last bit In this mode the CS will go high 1 full SPI clock cycle a fter the last clock edge. This guarantees a full SPI clock cycle time for the data to s ettle SPI interfaces . Bit(s) Field Name Description Type Reset 31:18 - Reserved, write zero, read as don't care 10:8 CS high time Additional SPI clock cycles where the CS i s high. R/W 0 7 TX empty IRQ If 1 the interrupt line is high when the transmit FIFO is empty R/W 0 6 Done IRQ If 1 the interrupt line is high when the inte rface is idle R/W 0 5:2 - Reserved, write zero, read as don't care 1 Shift in MS bit first If 1 the data is shifted in starting with the MS bit. (bit 15) If 0 the data is shifted in starting with the LS bit. (bit 0) R/W 0 0 Keep input If 1 the receiver shift register is NOT cleared. Thus new data is concatenated to old data. If 0 the receiver shift register is cleared before eac Keep input Setting the 'Keep input' bit will make that the shift re gister is not cleared between transactions. However the contents of the shift regis ter is still written to the receive FIFO at the end of each transaction. E.g. if you receive two the first entry and 0x8146 in the second entry. This mode may save CPU time concatenating bits (4 bits follow ed by 12 bits). 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 25 \u00a9 2012 Broadcom Corporation. All rights reserved CS high time The SPI CS will always be high for at least 1 SPI clo ck cycle. Some SPI devices need more time to process the data. This field will set a longe r CS-high time. So the actual CS high time is (CS_high_time + 1) (In SPI clock cycles). Interrupts The SPI block has two interrupts: TX FIFO is empty, SPI is Idle. TX FIFO is empty: This interrupt will be asserted as soon as the last ent ry has been read from the transmit FIFO. At that time the interface will still be busy shiftin g out that data. This also implies that the receive FIFO will not yet contain the last received data. It is possible at that time to fill the TX FIFO again and read the receive FIFO entries which have been received. There is a RX FIFO level field which tells exactly how many words are in the receive FIFO. In general at that time the rece ive FIFO should contain the number of Tx items minus one (the last one still being received). Note that there is no \"receive FIFO full\" interrupt or \"receive FIFO overflow\" flag as the number of entries received can never be more then of transmitted. AUX is IDLE: d all activities, including waiting the minimum CS high time. This guarantees that any recei ve data will be available and `transparent' changes can be made to the status of the SPI interfaces. Bit(s) Field Name Description Type Reset 31:24 TX FIFO level The number of data units in the transmit data FIFO R/W 0 23:12 RX FIFO level The number of data units in the receive data FIFO. R/W 0 11:5 - Reserved, write zero, read as don't care 4 TX Full If 1 the transmit FIFO is full If 0 the transmit FIFO can accept at least 1 data unit. R/W 0 3 TX Empty If 1 the transmit FIFO is empty If 0 the transmit FIFO holds at least 1 data unit. R/W 0 2 RX Empty If 1 the receiver FIFO is empty If 0 the receiver FIFO holds at least 1 data unit. the module is busy transferring data. R/W 0 5:0 Bit count The number of bits still to be processed. Starts with counts down. R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 26 \u00a9 2012 Broadcom Corporation. All rights reserved Busy This status bit indicates if the module is busy. It wil l be clear when the TX FIFO is empty and the module has finished all activities, SPI interfaces. Bit(s) Field Name Description Type Reset 31:16 - Reserved, write zero, read as don't care 15:0 Data Reads from this address will show the top entry from the receive FIFO, but the data is not taken from the FIFO. This provides a means of inspecting the data but not removing it from of the SPI inte rfaces These four addresses all write to the same FIFO. Writing to any of these addresses causes the SPI CS _n pins to be de-asserted at the end of the access Bit(s) Field Name Description Type Reset 31:16 - Reserved, write zero, read as don't care 15:0 Data Writes to this address range end up in the transmit FIFO. Data is lost when writing whilst the transmit FIFO is full. Reads from this address will take the top entry from the receive FIFO. Reading whilst the receive FIFO is will return the last data received. R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 27 \u00a9 of the SPI interf aces These four addresses all write to the same FIFO. Writing to these addresses causes the SPI CS_n pins to remain asserted at the end of the access Bit(s) Field Name Description Type Reset 31:16 - Reserved, write zero, read as don't care 15:0 Data Writes to this address range end up in the transmit FIFO. Data is lost when writing whilst the transmit FIFO is full. Reads from this address will take the top entry from the receive FIFO. Reading whilst the receive FIFO is will return the last data received. R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 28 \u00a9 2012 Broadcom Corporation. All rights reserved 3 BSC 3.1 Introduction The Broadcom Serial Controller (BSC) is a master, fast-mode (400Kb/s) BSC controller. The Broadcom Serial Control bus is pro prietary bus compliant with the Philips\u00ae I2C bus/interface version single master operation (supports clock stretching has eight memory-mapped registers. All accesses are assumed to be 32- bit. Note that the BSC2 master is used dedicated with the HDMI interface and should not be accessed by user programs. There are three BSC masters I 2C interface where the address is an offset from one of the 32 S Status 32 0x8 DLEN Data Length 32 0xc A Slave Address Data FIFO 32 0x14 DIV DEL Data Delay 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 29 \u00a9 2012 is used to enable interrupts, c lear the FIFO, define a read or write operation and start a transfer. The READ field specifies the type of transfer. The CLEAR field is used to clear the FIFO. Writing t o this field is a one-shot operation which will always read back as zero. The CLEAR bit can se t at the same time as the start transfer bit, and will result in the FIFO bei ng cleared just prior to the start of transfer. Note that clearing the FIFO during a tran sfer will result in the transfer being aborted. The ST field starts a new BSC transfer. This has a one shot action, and so the bit will always read back as 0 . The INTD field enables interrupts at the end of a t ransfer the DONE condition. The interrupt remains active until the DONE condition is cleared by writing a 1 to the I2CS.DONE field. Writing a 0 to the INTD field disa bles interrupts on DONE. The INTT field enables interrupts whenever the FIFO is or more empty and needs writing (i.e. during a write transfer) - the TXW con dition. The interrupt remains active until the TXW condition is cleared by writing suffici ent data to the FIFO to complete the transfer. Writing a 0 to the INTT field disables in terrupts on TXW. The INTR field enables interrupts whenever the FIFO is or more full and needs reading (i.e. during a read transfer) - the RXR condition. T he interrupt remains active until the RXW condition is cleared by reading sufficient data fro m the RX FIFO. Writing a 0 to the INTR field disables interrupts on RXR. The I2CEN field enables BSC operations. If this bit is 0 then transfers will not be performed. All register accesses are Description Type Reset 31:16 Reserved - Write as 0, read as don't care 15 I2CEN I2C Enable 0 = BSC controller is enabled RW 0x0 14:11 Reserved - Write don't care 10 INTR INTR Interrupt on = 0x0 9 INTT Interrupt on 0 = TXW condition. 1 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 30 \u00a9 2012 Broadcom Corporation. All rights reserved 8 INTD INTD Interrupt on DONE 0 = Don generate interrupts on DONE condition. 1 = Generate interrupt while DONE = 1. RW 0x0 7 ST ST Start Transfer 0 = No action. 1 = Start a new transfer. One shot operation. Read back as 0. RW 0x0 6 Reserved - Write as 0, read as don't care 5:4 CLEAR CLEAR FIFO Clear 00 = No action. x1 = Clear FIFO. One shot operation. 1x = Clear FIFO. One shot operation. If CLEAR and ST are both set in the same operation, the FIFO is cleared before the new frame is started. Read back as 0. Note: 2 bits are used to maintain compatibility to previous version. RW 0x0 3:1 Reserved - Write as 0, read as don't care 0 READ READ Read Transfer 0 = Write Packet Transfer. 1 = Read Packet Transfer. RW 0x0 S Register 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 31 \u00a9 2012 Broadcom Corporation. All rights Synopsis The status to record and interrupt requests. The TA field indicates the activity status of the BSC controller. This read-only field returns a 1 when the controller is in the middle of a transfer and a 0 when idle. The DONE field is set when the transfer completes. T he DONE condition can be used with I2CC.INTD to generate an interrupt on transfer completion. The DONE field is reset by writing a 1 , writing a 0 to the field has no effect. The read-only TXW bit is set during a write transfer and the FIFO is less than full and needs writing. Writing sufficient data (i.e. enough data to either fill the FIFO more than full or complete the transfer) to the FIFO will clea r the field. When the I2CC.INTT control bit is set, the TXW condition can be used to g enerate an interrupt to write more data to the FIFO to complete the current transfer. If the I2C controller runs out of data to send, it will wait for more data to be written i nto the FIFO. The read-only RXR field is set during a read transfe r and the FIFO is or more full and needs reading. Reading sufficient data to bring the depth below will clear the field. When I2CC.INTR control bit is set, the RXR condition can be used to generate an interrupt to read data from the FIFO before it becom es full. In the event that the FIFO does become full, all I2C operations will stall unti l data is removed from the FIFO. The read-only TXD field is set when the FIFO has spa ce for at least one byte of data. TXD is clear when the FIFO is full. The TXD field can be used to check that the FIFO can accept data before any is written. Any writes to a f ull TX FIFO will be ignored. The read-only RXD field is set when the FIFO contains at least one byte of data. RXD is cleared when the FIFO becomes empty. The RXD field can be used to check that the FIFO contains data before reading. Reading from an empty FIFO will return invalid data. The read-only TXE field is set when the FIFO is empt y. No further data will be transmitted until more data is written to the FIFO. The read-only RXF field is set when the FIFO is full . No more clocks will be generated until space is available in the FIFO to receive more data. The ERR field is set when the slave fails to acknowle dge either its address or a data byte written to it. The ERR field is reset by writing a 1 , writing a 0 to the field has no effect. The CLKT field is set when the slave holds the SCL signal high for too long (clock stretching). The CLKT field is reset by writing a 1 , writing a 0 to the field has no effect. Bit(s) Field Name Description Type Reset 31:10 Reserved - Write as 0, read as don't care 9 CLKT CLKT Clock Stretch Timeout 0 = errors detected. Slave has held the SCL signal low (clock stretching) for longer and that specified in the I2CCLKT register Cleared by writing 1 to the field. RW 0x0 8 ERR ERR ACK Error 0 = No errors detected. 1 = Slave has not acknowledged its address. Cleared by writing 1 to the field. RW 0x0 7 RXF RXF - FIFO Full 0 = FIFO is not full. 1 = FIFO is full. If a read i s underway, no further serial data will be received until data is read from FIFO. RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 32 \u00a9 2012 Broadcom Corporation. All rights reserved 6 TXE TXE - FIFO Empty 0 = FIFO is not empty. 1 = FIFO is empty. If a write is underway, no further serial data can be transmitted until data is written to the FIFO. RO 0x1 5 RXD RXD - FIFO contains Data 0 = FIFO is empty. 1 = FIFO contains at least 1 byte. Cleared by reading sufficient data from FIFO. RO 0x0 4 TXD TXD - FIFO can accept Data 0 = FIFO is full. The FIFO cannot accept more data. 1 = FIFO has space for at least 1 byte. RO 0x1 3 RXR RXR - FIFO needs Reading ( full) 0 = FIFO is less than full and a read is underway. 1 = FIFO is or more full and a read is underway. Cleared by reading sufficient data from the FIFO. RO 0x0 2 TXW TXW - FIFO needs Writing ( full) 0 = FIFO is at least full and a write is underway (or sufficient data to send). 1 = FIFO is less then full and a write is underway. Cleared by writing sufficient data to the FIFO. RO 0x0 1 DONE DONE Transfer Done 0 = Transfer not completed. 1 = Transfer complete. Cleared by writing 1 to the field. RW 0x0 0 TA TA Transfer Active 0 = Transfer not active. 1 = Transfer active. RO 0x0 DLEN Register Synopsis The data length register defines of data to transmit or receive in the I2C transfer. Reading the register gives the nu mber of bytes remaining in the current transfer. The DLEN field specifies the number of bytes to be tr ansmitted/received. Reading the DLEN field when a transfer is in progress (TA = 1) returns the number of bytes still to be transmitted or received. Reading the DLEN field w hen the transfer has just completed (DONE = 1) returns zero as there are no mor e bytes to transmit or receive. Finally, reading the DLEN field when TA = 0 and DONE = 0 returns the last value written. The DLEN field can be left over Bit(s) Field Name Description Type Reset 31:16 Reserved Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 33 \u00a9 2012 Broadcom Corporation. Writing DLEN specifies of bytes to be transmitted/received. Reading from DLEN when TA = 1 or DONE = 1, returns the number of bytes still to be transmitted or received. Reading from DLEN when TA = 0 and DONE = 0, returns the last DLEN value written. DLEN can the slave address of the I2 C device. Bit(s) Field Name Description Type Reset 31:7 Reserved - Write as 0, read as ADDR Slave Address. RW The FIFO register is used to access the FIFO. Wr ite cycles to this address place data in the 16-byte FIFO, ready to transmit on the B SC bus. Read cycles access data received from the bus. Data writes to a full FIFO will be ignored and data reads from an empty FIFO will result in invalid data. The FIFO can be cleared using the I 2CC.CLEAR field. The DATA field specifies the data to be transmitted or received. Bit(s) Field Name Description Type Reset 31:8 Reserved - Write as 0, read as don't care 7:0 DATA Writes to the register write to the FIFO. Reads from register reads received from DIV Register 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 34 \u00a9 2012 register is used to speed of the BSC peripheral. The CDIV field specifies the core clock divider used Bit(s) Field Name Description Type Reset 31:16 Reserved - Write is nominally 150 MHz. If CDIV is set to 0, the divisor is 32768. CDIV is always rounded down to an even number. fine control over t he sampling/launch point of the data. The REDL field specifies the number core clocks to wait after the rising edge before sampling the incoming data. The FEDL field specifies the number core clocks to wait after the falling edge before outputting the next data bit. Note: Care must be taken in choosing values for FEDL and REDL as it is possible to cause the BSC master to malfunction by setting of CDIV/2 or greater. to after the falling edge of SCL next bit cycles to wait after the rising edge of SCL before reading the next bit of data. RW 0x30 CLKT Register 06 February 2012 Broadcom Park Milton Road Cambridge CB4 0WW Page 35 \u00a9 2012 Broadcom timeout register provides a timeout on how long the master waits for the slave to stretch the clock before deciding that t he slave has field high finding that the SCL is still low before decidi ng that the slave is not responding and moving the I2C machine forward. When a timeout occurs, the I2CS.CLKT bit is set. Writing 0x0 to TOUT will result in the Clock Stretch Timeout Field Name Description Type Reset 31:16 Reserved - 0, after the rising edge of SCL before deciding that the slave is not responding. RW 0x40 06 February 2012 Broadcom Europe Ltd. 406 Park Milton Road Cambridge CB4 0WW Page 36 \u00a9 2012 Broadcom Corporation. All rights reserved 3.3 10 Bit Addressing 10 Bit addressing is an extension to the standard 7-bit addres sing mode. This can be combined with , 7 bit addressing. Using 10 bits for addressing exploits the reserved combination 1111 0xx fo r the first byte following a START (S) or REPEATED START (Sr) condition. The 10 bit slave address is formed from the first two byte s following a S or Sr condition. The first seven bits of the first byte are the combina tion 11110XX of which the last two bits (XX) are the two most significant bits of the 10-bit address. The eighth bit of the first by te is the R/W bit. If the R/W bit is '0' (write) then the fo llowing byte contains the remaining 8 bits of the 10-bit address. If the R/W bit is '1' then the next byte contains data transmitted from the slave to the master. Writing Figure 3-1 Write to a slave with 10 bit address Figure 3-1 shows a write to a slave with a 10-bit address, t o perform this using the controller one must do the following: Assuming we are in the 'stop' state: (and the FIFO is e mpty) 1. Write the number of data bytes to written (plus one) to t he I2CDLEN register. 2. Write 'XXXXXXXX' to the FIFO where 'XXXXXXXX' are th e least 8 significant bits of the 10-bit slave address. 3. Write other data to be transmitted to the FIFO. 4. Write '11110XX' to Slave Address Register where 'XX' are th e most significant bits of the 10-bit address. Set I2CC.READ = 0 and I2CC.ST = 1 , this will start a write transfer. Reading Stop Start Slave acknowledge Repeat Start Master acknowledge Slave acknowledge 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 37 \u00a9 2012 Broadcom Corporation. All rights reserved Figure 3-2 Read from slave with 10 bit address Figure 3-2 shows how a read from a slave with a 10-bit address is performed. Following is the procedure for performing a read using the controller: 1. Write 1 to the I2CDLEN register. 2. Write 'XXXXXXXX' to the FIFO where 'XXXXXXXX' are th e least 8 significant bits of the 10-bit slave address. 3. Write '11110XX' to the Slave Address Register where 'XX' ar e the two most significant bits of the 10-bit address. Set I2CC.READ = 0 and I2CC.ST = 1 , this will start a write transfer. 4. Poll the I2CS.TA bit, waiting for the transfer has started. 5. Write the number of data bytes to read to the I2CDLEN register. 6. Set I2CC.READ = 1 and I2CC.ST = 1 , this will send the repeat start bit, new slave address and R/W bit (which is '1') initiating the read. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 38 \u00a9 2012 Broadcom Corporation. All rights reserved 4 DMA Controller 4.1 Overview The majority of hardware pipelines and peripherals within the BCM2835 are bus masters, enabling them to efficiently satisfy their own data requir ements. supporting some In addition, the DMA con troller provides a read only prefetch mode to allow data to be brought into the L2 cache in an ticipation of its later use. Beware that the DMA controller is direcly connected t o the peripherals. Thus the DMA controller must be set-up to use the Physical (harware) a ddresses of the peripherals. The BCM2835 DMA channels . Each operates independently from the others and is internally arbitrat ed onto one of the 3 system busses. This means that the amount of bandwidth that a DMA channe l may consume can be controlled by the arbiter settings. Each DMA channel operates by loading a Control Block (CB) data structure from memory into internal registers. The Control Block defines the required DMA operation. Each Control Block can point to a further Control Block to be loaded and executed once the operation described in the current Control Block has completed. In this way a linked list of Control Blocks can be constructed in order to execute a sequence of DMA operations without software intervention. The DMA supports AXI read bursts to ensure efficient exter nal doesn't do write burs ts, although wide writes will be done in 2 beat bursts if possible. Memory-to-Peripheral transfers can be paced by a Data Request (DREQ) signal which is generated by the peripheral. The DREQ signal is level sensitive and controls the DMA by gating its AXI bus requests. A peripheral can also provide a Panic signal alongside DREQ to indicate that there is an imminent danger of FIFO underflow or overflow or simila r critical situation. The Panic is used to select the AXI apriority level which is then pas sed out onto the AXI bus so that it can be used to influence arbitration in the rest of the syste m. The allocation of peripherals to DMA channels is progra mmable. The DMA can deal with byte aligned transfers and will minimise bus traffic by buffering and misaligned accesses. Each DMA channel can be fully disabled via a top level pow er register to save power. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 39 \u00a9 2012 Broadcom Corporation. All rights 4.2 DMA The the DMA 0 is located at the address of 0x7E007000, Channel 1 at 0x7E007100, Channel 2 at 0x7E007200 and so on. Thus adjacent DMA Channels are 0x100. DMA is physically removed from the o ther DMA Channels and so has a different address base of 0x7EE05000. DMA Channel Offsets DMA Channels 0 - 14 Register Set Offsets from DMA0_BASE 0x000 DMA Channel 0 Register Set 0x100 DMA Channel 1 Register Set 0x200 DMA Channel 2 Register Set 0x300 DMA Channel 3 Register Set 0x400 DMA Channel 4 Register Set 0x500 DMA Channel 5 Register Set 0x600 DMA Channel 6 Register Set 0x700 DMA Channel 7 Register Set 0x800 DMA Channel 8 Register Set 0x900 DMA Channel 9 Register Set 0xa00 DMA Channel 10 Register Set 0xb00 DMA Channel 11 Register Set 0xc00 DMA Channel 12 Register Set 0xd00 DMA Channel 13 Register Set 0xe00 DMA Channel 14 Register Set DMA Channel 15 Register Set Offset from DMA15_BASE 0x000 DMA Channel Register Address Map 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 40 \u00a9 2012 Broadcom Corporation. 4.2.1 DMA Channel Address Map Each DMA channel has an identical register map, only the base address of each channel is different. There is a global enable register at the top of the Addr ess map that can disable each DMA for powersaving. N, STRIDE & NEXTCONBK), are automatically loaded from a Control Block data structure held in external memory. 4.2.1.1 Control Block Data Structure Control Blocks (CB) are 8 words (256 bits) in length and mu st start at a 256-bit aligned address. The format of the CB data structure in memory, is shown below. Each 32 bit word of the control block is automatically loa ded into the corresponding 32 bit DMA control block register at the start of a DMA tran sfer. The of these registers also bit locations in the CB data structure in memory. 32 -bit Word Offset Description Associated Read-Only Register 0 Transfer 1 Address DEST_AD 3 Transfer Length TXFR_LEN Mode STRIDE 5 Next Control Block Address NEXTCONBK 6-7 Reserved - set to zero. N/A Table 4-2 - DMA Control Block Definition The DMA is started by writing the address of a CB structure into the CONBLK_AD register and then setting the ACTIVE bit. The DMA will fetch t he CB from the address set in the SCB_ADDR field of this reg and it will load it into the read-only registers described below. It will then begin a DMA transfer according to the in formation in the CB. When it has completed the current DMA transfer (length => 0) the DMA will update the CONBLK_AD register with the contents of the NEXTCON BK register, fetch a new CB from that address, and start the whole procedure once again. The DMA will stop (and clear the ACTIVE bit) when it ha s completed a DMA transfer and the NEXTCONBK register is set to 0x0000_0000 . It will load this value into the CONBLK_AD reg and then stop. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 41 \u00a9 2012 Broadcom Corporation. All rights reserved Most of the control block registers cannot be written to directly as they loaded automatically from memory. They can be read to provide status informatio n, and to indicate the progress of the current DMA transfer. The value loaded into the N EXTCONBK register can be overwritten so that the linked list of Control Block da ta structures can be dynamically altered. However it is only safe to do this when the DMA is pause d. 4.2.1.2 Register Map DMA Name Description Size 0x0 0_CS DMA Channel 0 Control and Status 32 0x4 0_CONBLK_AD DMA Channel 0 Control Block Address 32 0x8 0_TI DMA Channel 0 CB Word 0 (Transfer Information) 32 0xc 0_SOURCE_AD DMA Channel 0 CB Word 1 (Source Address) 32 0x10 0_DEST_AD DMA Channel 0 CB Word 2 (Destination Address) 32 0x14 0_TXFR_LEN DMA Channel 0 CB Word 3 (Transfer Length) 32 0x18 0_STRIDE DMA Channel 0 CB Word 4 (2D Stride) 32 0x1c 0_NEXTCONBK DMA Channel 0 CB Word 5 (Next CB Address) 32 0x20 0_DEBUG DMA Channel 0 Debug 32 0x100 1_CS DMA Channel 1 Control and Status 32 0x104 1_CONBLK_AD DMA Channel 1 Control Block Address 32 0x108 1_TI DMA Channel 1 CB Word 0 (Transfer Information) 32 0x10c 1_SOURCE_AD DMA Channel 1 CB Word 1 (Source Address) 32 0x110 1_DEST_AD DMA Channel 1 CB Word 2 (Destination Address) 32 0x114 1_TXFR_LEN DMA Channel 1 CB Word 3 (Transfer Length) 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 42 \u00a9 2012 Broadcom Corporation. All rights reserved 0x118 1_STRIDE DMA Channel 1 CB Word 4 (2D Stride) 32 0x11c 1_NEXTCONBK DMA Channel 1 CB Word 5 (Next CB Address) 32 0x120 1_DEBUG DMA Channel 1 Debug 32 0x200 2_CS DMA Channel 2 Control and Status 32 0x204 2_CONBLK_AD DMA Channel 2 Control Block Address 32 0x208 2_TI DMA Channel 2 CB Word 0 (Transfer Information) 32 0x20c 2_SOURCE_AD DMA Channel 2 CB Wo rd 1 (Source Address) 32 0x210 2_DEST_AD DMA CB Word 2 (Destination Address) 32 0x214 2_TXFR_LEN DMA Channel 2 CB Word 3 (Transfer Length) 32 0x218 2_STRIDE DMA Channel 2 CB Word 4 (2D Stride) 32 0x21c 2_NEXTCONBK DMA Channel 2 CB Word 5 (Next CB Address) 32 0x220 2_DEBUG DMA Channel 2 Debug 32 0x300 3_CS DMA Channel 3 Control and Status 32 0x304 3_CONBLK_AD DMA Channel 3 Control Block Address 32 0x308 3_TI DMA Channel 3 CB Word 0 (Transfer Information) 32 0x30c 3_SOURCE_AD DMA Channel 3 CB Word 1 (Source Address) 32 0x310 3_DEST_AD DMA Channel 3 CB Word 2 (Destination Address) 32 0x314 3_TXFR_LEN DMA Channel 3 CB Word 3 (Transfer Length) 32 0x318 3_STRIDE DMA Channel 3 CB Word 4 (2D Stride) 32 0x31c 3_NEXTCONBK DMA Channel 3 CB Word 5 (Next CB Address) 32 0x320 3_DEBUG DMA Channel 0 Debug 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 43 \u00a9 2012 Broadcom Corporation. All rights reserved 0x400 4_CS DMA Channel 4 Control and Status 32 0x404 4_CONBLK_AD DMA Channel 4 Control Block Address 32 0x408 4_TI DMA Channel 4 CB Word 0 (Transfer Information) 32 0x40c 4_SOURCE_AD DMA Channel 4 CB Word 1 (Source Address) 32 0x410 4_DEST_AD DMA Channel 4 CB Word 2 (Destination Address) 32 0x414 4_TXFR_LEN DMA Channel 4 CB Word 3 (Transfer Length) 32 0x418 4_STRIDE DMA Channel 4 CB Word 4 (2D Stride) 32 0x41c 4_NEXTCONBK DMA Channel 4 CB Word 5 (Next CB Address) 32 0x420 4_DEBUG DMA Channel 0 Debug 32 0x500 5_CS DMA Channel 5 Control and Status 32 0x504 5_CONBLK_AD DMA Channel 5 Control Block Address 32 0x508 5_TI DMA Channel 5 CB Word 0 (Transfer Information) 32 0x50c 5_SOURCE_AD DMA Channel 5 CB Word 1 (Source Address) 32 0x510 5_DEST_AD DMA Channel 5 CB Word 2 (Destination Address) 32 0x514 5_TXFR_LEN DMA Channel 5 CB Word 3 (Transfer Length) 32 0x518 5_STRIDE DMA Channel 5 CB Word 4 (2D Stride) 32 0x51c 5_NEXTCONBK DMA Channel 5 CB Word 5 (Next CB Address) 32 0x520 5_DEBUG DMA Channel 5 Debug 32 0x600 6_CS DMA Channel 6 Control and Status 32 0x604 6_CONBLK_AD DMA Channel 6 Control Block Address 32 0x608 6_TI DMA Channel 6 CB Word 0 (Transfer Information) 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 44 \u00a9 2012 Broadcom Corporation. All rights reserved 0x60c 6_SOURCE_AD DMA Channel 6 CB Word 1 (Source Address) 32 0x610 6_DEST_AD DMA Channel 6 CB Word 2 (Destination Address) 32 0x614 6_TXFR_LEN DMA Channel 6 CB Word 3 (Transfer Length) 32 0x618 6_STRIDE DMA Channel 6 CB Word 4 (2D Stride) 32 0x61c 6_NEXTCONBK DMA Channel 6 CB Word 5 (Next CB Address) 32 0x620 6_DEBUG DMA Channel 6 Debug 32 0x700 7_CS DMA Channel 7 Control and Status 32 0x704 7_CONBLK_AD DMA Channel 7 Control Block Address 32 0x708 7_TI DMA Channel 7 CB Word 0 (Transfer Information) 32 0x70c 7_SOURCE_AD DMA Channel 7 CB Word 1 (Source Address) 32 0x710 7_DEST_AD DMA Channel 7 CB Word 2 (Destination Address) 32 0x714 7_TXFR_LEN DMA Channel 7 CB Word 3 (Transfer Length) 32 0x71c 7_NEXTCONBK DMA Channel 7 CB Word 5 (Next CB Address) 32 0x720 7_DEBUG DMA Channel 7 Debug 32 0x800 8_CS DMA Channel 8 Control and Status 32 0x804 8_CONBLK_AD DMA Channel 8 Control Block Address 32 0x808 8_TI DMA Channel 8 CB Word 0 (Transfer Information) 32 0x80c 8_SOURCE_AD DMA Channel 8 CB Word 1 (Source Address) 32 0x810 8_DEST_AD DMA Channel 8 CB Word 2 (Destination Address) 32 0x814 8_TXFR_LEN DMA Channel 8 CB Word 3 (Transfer Length) 32 0x81c 8_NEXTCONBK DMA Channel 8 CB Word 5 (Next CB Address) 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 45 \u00a9 2012 Broadcom Corporation. All 8_DEBUG DMA Channel 8 Debug 32 0x900 9_CS DMA Channel 9 Control and Status 32 0x904 9_CONBLK_AD DMA Channel 9 Control Block Address 32 0x908 9_TI DMA Channel 9 CB Word 0 (Transfer Information) 32 0x90c 9_SOURCE_AD DMA Channel 9 CB Word 1 (Source Address) 32 0x910 9_DEST_AD DMA Channel 9 CB Word 2 (Destination Address) 32 0x914 9_TXFR_LEN DMA Channel 9 CB Word 3 (Transfer Length) 32 0x91c 9_NEXTCONBK DMA Channel 9 CB Word 5 (Next CB Address) 32 0x920 9_DEBUG DMA Channel 9 Debug 32 0xa00 10_CS DMA Channel 10 Control and Status 32 0xa04 10_CONBLK_AD DMA Channel 10 Control Block Address 32 0xa08 10_TI DMA Channel 10 CB Word 0 (Transfer Information) 32 0xa0c 10_SOURCE_AD DMA Channel 10 CB Word 1 (Source Address) 32 0xa10 10_DEST_AD DMA Channel 10 CB Word 2 (Destination Address) 32 0xa14 10_TXFR_LEN DMA Channel 10 CB Word 3 (Transfer Length) 32 0xa1c 10_NEXTCONBK DMA Channel 10 CB Word 5 (Next CB Address) 32 0xa20 10_DEBUG DMA Channel 10 Debug 32 0xb00 11_CS DMA Channel 11 Control and Status 32 0xb04 11_CONBLK_AD DMA Channel 11 Control Block Address 32 0xb08 11_TI DMA Channel 11 CB Word 0 (Transfer Information) 32 0xb0c 11_SOURCE_AD DMA Channel 11 CB Word 1 (Source Address) 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 46 \u00a9 2012 Broadcom Corporation. All rights reserved 0xb10 11_DEST_AD DMA 11 CB Word 2 (Destination Address) 32 0xb14 11_TXFR_LEN DMA Channel 11 CB Word 3 (Transfer Length) 32 0xb1c 11_NEXTCONBK DMA Channel 11 CB Word 5 (Next CB Address) 32 0xb20 11_DEBUG DMA Channel 11 Debug 32 0xc00 12_CS DMA Channel 12 Control and Status 32 0xc04 12_CONBLK_AD DMA Channel 12 Control Block Address 32 0xc08 12_TI DMA Channel 12 CB Word 0 (Transfer Information) 32 0xc0c 12_SOURCE_AD DMA Channel 12 CB Word 1 (Source Address) 32 0xc10 12_DEST_AD DMA Channel 12 CB Word 2 (Destination Address) 32 0xc14 12_TXFR_LEN DMA Channel 12 CB Word 3 (Transfer Length) 32 0xc1c 12_NEXTCONBK DMA Channel 12 CB Word 5 (Next CB Address) 32 0xc20 12_DEBUG DMA Channel 12 Debug 32 0xd00 13_CS DMA Channel 13 Control and Statu s 32 0xd04 13_CONBLK_AD DMA Channel 13 Control Block Address 32 0xd08 13_TI DMA Channel 13 CB Word 0 (Transfer Information) 32 0xd0c 13_SOURCE_AD DMA Channel 13 CB Word 1 (Source Address) 32 0xd10 13_DEST_AD DMA Channel 13 CB Word 2 (Destination Address) 32 0xd14 13_TXFR_LEN DMA Channel 13 CB Word 3 (Transfer Length) 32 0xd1c 13_NEXTCONBK DMA Channel 13 CB Word 5 (Next CB Address) 32 0xd20 13_DEBUG DMA Channel 13 Debug 32 0xe00 14_CS DMA Channel 14 Control and Status 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 47 \u00a9 2012 Broadcom Corporation. All rights reserved 0xe04 14_CONBLK_AD DMA Channel 14 Control Block Address 32 0xe08 14_TI DMA Channel 14 CB Word 0 (Transfer Information) 32 0xe0c 14_SOURCE_AD DMA Channel 14 CB Word 1 (Source Address) 32 0xe10 14_DEST_AD DMA Channel 14 CB Word 2 (Destination Address) 32 0xe14 14_TXFR_LEN DMA Channel 14 CB Word 3 (Transfer Length) 32 0xe1c 14_NEXTCONBK DMA Channel 14 CB Word 5 (Next CB Address) 32 0xe20 14_DEBUG DMA Channel 14 Debug 32 each 0xff0 contains the main c ontrol and status bits for this DMA channel. Bit(s) Field Name Description Type Reset 31 RESET DMA Channel Reset Writing a 1 to this bit will reset the DMA. The bit cannot be read, and will self clear. W1SC 0x0 30 ABORT Abort DMA Writing a 1 to this bit will abort the current DMA CB. The DMA will load the next CB and attempt to continue. The bit cannot be read, and clear. W1SC 0x0 29 DISDEBUG Disable debug pause signal When set to 1, the DMA will not stop when the debug pause signal is asserted. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 48 \u00a9 2012 Broadcom Corporation. All rights reserved 28 WAIT_FOR_OUTSTANDING_WRITES Wait for outstanding writes When set to 1, the DMA will keep a tally of the AXI writes going out and the write responses coming in. At the very end of the current DMA transfer it will wait until the last outstanding write response has been received before indicating the transfer is complete. Whilst waiting it will load the next CB address (but will not fetch the CB), clear the active flag (if the next CB address = zero), and it will defer setting the END flag or the INT flag until the last outstanding write response has been received. In this mode, the DMA will pause if it has more than 13 outstanding writes at any one time. RW 0x0 27: 24 Reserved - Write as 0, read as don't care 23:20 PANIC_PRIORITY AXI Panic Priority Level Sets the of panicking AXI bus transactions. This value is used when the panic bit of the selected peripheral channel is 1. Zero is the lowest priority. 0x0 19:16 PRIORITY AXI Priority Level of normal AXI bus transactions. This value is used when the panic bit of the selected peripheral channel is zero. Zero is the lowest priority. RW 0x0 15:9 Reserved - Write as 0, read as don't care 8 ERROR DMA Error Indicates if the DMA has detected an error. The error flags are available in the debug register, and have to be cleared by writing to that register. 1 = DMA channel has an error flag set. 0 = DMA channel is ok. RO 0x0 7 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 49 \u00a9 2012 Broadcom Corporation. All rights reserved 6 WAITING_FOR_OUTSTANDING_WRITES DMA is Waiting for the Last Write to be Received Indicates if the DMA is currently waiting for any outstanding writes to be received, and is not transferring data. 1 = DMA channel is waiting. RO 0x0 5 DREQ_STOPS_DMA DMA Paused by DREQ State Indicates if the DMA is currently paused and not transferring data due to the DREQ being inactive.. 1 = DMA channel is paused. 0 = DMA channel is running. RO 0x0 4 PAUSED DMA Paused State Indicates if the DMA is currently paused and not transferring data. This will occur if: the active bit has been cleared, if the DMA is currently executing wait cycles or if the debug_pause signal has been set by the debug block, or the number of outstanding writes has exceeded the max count. 1 = DMA channel is paused. 0 = DMA channel is running. RO 0x0 3 DREQ DREQ State Indicates the state of the selected DREQ (Data Request) signal, ie. the DREQ selected by the PERMAP field of the transfer info. 1 = Requesting data. This will only be valid once the DMA has started and the PERMAP field has been loaded from the CB. It will remain valid, indicating the selected DREQ signal, until a new CB is loaded. If PERMAP is set to zero (un- paced transfer) then this bit will read back as 1. 0 = No data request. RO 0x0 2 INT Interrupt Status This is set when the transfer for the CB ends and INTEN is set to 1. Once set it must be manually cleared down, even if the next CB has INTEN = 0. Write 1 to clear. W1C 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 50 \u00a9 2012 Broadcom Corporation. All rights reserved 1 END DMA End Flag Set when the transfer described by the current control block is complete. Write 1 to clear. W1C 0x0 0 ACTIVE Activate the DMA This bit enables the DMA. The DMA will start if this bit is set and the CB_ADDR is non zero. The DMA transfer can be paused and resumed by clearing, then setting it again. This bit is automatically cleared at the end of the complete DMA transfer, ie. after a NEXTCONBK = 0x0000_0000 has been Reset 31:0 SCB_ADDR Block Address This tells the DMA where to find a Control Block stored in memory. When the ACTIVE bit is set and th is address is non zero, the DMA will begin its transfe r by loading the contents of the addressed CB into the relevant DMA channel registers. At the end of the transfer this register will be up dated with the ADDR field of the NEXTCONBK control block register. If this field is zero, the DMA will stop. Reading this register will return the address of th e currently active CB (in the linked list of CB s). T he address must be 256 bit aligned, so the bottom 5 bi ts of the address Type Reset 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 51 \u00a9 2012 Broadcom Corporation. All rights reserved 31:27 Reserved - Write as 0, read as don't care 26 NO_WIDE_BURSTS Don t Do wide writes as a 2 beat burst This prevents the DMA from issuing wide writes as 2 beat AXI bursts. This is an inefficient access mode , so the default is to use the bursts. RW 0x0 25:21 WAITS Add Wait Cycles This slows of dummy cycles burnt after DMA read or write operation is completed. A value of 0 means that no wait cycles are to be added. the transfers, and whose panic signals will be output o n the DMA AXI bus. Set to 0 for a continuous un-paced transfer. transfers. Th e DMA will attempt to transfer data as bursts of this number of words. A value of zero will produce a sin gle transfer. Bursts are only produced for specific conditions, see main text. RW 0x0 11 SRC _IGNORE Ignore Reads 1 = Do not perform source reads. In addition, destination writes will zero all the write strobes. This is used for fast cache fill operations. 0 = Perform source reads.. RW 0x0 10 SRC_DREQ Control Source DREQ 1 = The DREQ selected by PER_MAP will gate the source reads. 0 = DREQ has no effect. RW 0x0 9 SRC_WIDTH Source Transfer Width 1 = Use 128-bit source read width. 0 = Use 32-bit source read width. RW 0x0 8 SRC_INC Source Address Increment 1 = increments after read. The address will increment by 4, if S_WIDTH=0 else by 3 2. 0 = Source address does not change. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 52 \u00a9 2012 Broadcom Corporation. All rights reserved 7 DEST_IGNORE Ignore Writes 1 = Do not perform destination writes. 0 = Write data to 6 DEST_DREQ Control Destination will gate destination writes. has no effect. RW 0x0 DEST_WIDTH Destination Transfer Width 1 = Use 128-bit destination write width. 0 = Use 32-bit destination write width. RW 0x0 address will increment by 4, if DEST_WIDTH=0 else by 32. 0 = Destination address does not change. RW 0x0 3 WAIT_RESP Wait for a Write Response When set this makes the DMA wait until it receives the AXI write response for each write. This ensures that multiple writes cannot get stacked in the AXI bus pipeline. 1= Wait for the write response to be received befor e proceeding. 0 = Don t wait; continue as soon as the write data is sent. RW 0x0 2 Reserved - Write as 0, read as don't care 1 TDMODE 2D Mode 1 the to the address after each transfer. 0 = Linear mode interpret the TXFR register an interrupt when the transfer describ ed by the current Control Block completes. 0 = Do not Park Milton Road Cambridge CB4 0WW Page 53 \u00a9 2012 Broadcom Corporation. All rights reserved Synopsis DMA Bit(s) Name 31:0 S_ADDR DMA Source Address Source address for the DMA operation. Updated by the DMA engine as the transfer Destination address for the DMA operation. Updated by the DMA engine as the transfer the amount of d ata to be transferred in bytes. In normal (non 2D) mode this specifies the amount o f bytes to be transferred. In 2D mode it is interpreted as an X and a Y length , and the DMA will perform Y transfers, each of length X bytes strides onto the addr esses after each X leg of the transfer. The length register is updated by the DMA engine as the transfer progresses, so it will indicate the data left to transfer. Bit(s) Field Name Description Type Reset 31:30 Reserved - Write as 0, read as don't care 29:16 YLENGTH When in 2D mode, This is the Y length, indicating how many xlength transfers are performed . When in normal linear mode this becomes the top bit s of the XLENGTH RW 0x0 15:0 XLENGTH 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 54 \u00a9 to apply to the destination address at the end of each row in 2 D mode. RW 0x0 15:0 S_STRIDE Source Stride (2D Mode) Signed (2 complement) byte increment to apply to the source address at the end of each value loaded into this register can be overwrit ten so that the linked list of Control Block data structures can be altered. However it is only safe to do this when the DMA is paused. The address must be 256 bit aligned and so the bottom 5 bits cannot be set and will read back as zero. Bit(s) Field Name Description Type Reset 31:0 ADDR Address of 31:29 Reserved Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 55 \u00a9 2012 Broadcom Corporation. All rights reserved 28 LITE DMA Lite Set if the DMA is a reduced performance LITE engine. RO 0x0 27:25 VERSION DMA Version DMA version number, indicating control bit filed changes. RO 0x2 24:16 DMA_STATE DMA State Machine State Returns the value of the DMA engines state machine for this channel. RO 0x0 15:8 DMA_ID DMA ID Returns the DMA AXI ID of this DMA channel. RO 0x0 7:4 OUTSTANDING_WRITES DMA Outstanding Writes Counter Returns the number of write responses that have not yet been received. This count is reset at the start of each new DMA transfer or with a DMA reset. RO 0x0 3 Reserved - Writ e as 0, read as don't care 2 READ_ERROR Slave Read Response Error Set if the read operation returned an error value o n the read response bus. It can be cleared by writing a 1, RW 0x0 1 FIFO_ERROR Fifo Error Set if the optional read Fifo records an error condition. It can be cleared by writing a 1, RW 0x0 0 READ_LAST_NOT_SET_ERROR Read Last Not Set Error If the AXI read last signal was not set when expected, then this error bit will be set. It can b e cleared by writing a Name Description Type Reset 31:26 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 56 \u00a9 2012 Broadcom Corporation. All rights reserved 25:21 WAITS Add Wait Cycles This slows down of dummy cycles burnt after DMA read or write operation is completed. A value of 0 means that no wait cycles are to be added. the transfers, and whose panic signals will be output o n the DMA AXI bus. Set to 0 for a continuous un-paced transfer. transfers. Th e DMA will attempt to transfer data as bursts of this number of words. A value of zero will produce a sin gle transfer. Bursts are only produced for specific conditions, see main text. RW 0x0 11 RW 0x0 10 SRC_DREQ Control Source with DREQ 1 = The DREQ selected by PER_MAP will gate the source reads. 0 = DREQ has no effect. RW 0x0 9 SRC_WIDTH Source Transfer Width 1 = Use 128-bit source read width. 0 = Use 32-bit source read width. RW 0x0 8 SRC_INC Source Address Increment 1 = increments after read. The address will increment by 4, if S_WIDTH=0 else by 3 2. 0 = Source address does not change. RW 0x0 7 DEST_IGNORE RW 0x0 6 DEST_DREQ will gate destination writes. has no effect. RW 0x0 DEST_WIDTH Destination Transfer Width 1 = Use 128-bit destination write width. 0 = Use 32-bit destination write width. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 57 \u00a9 2012 address will increment by 4, if DEST_WIDTH=0 else by 32. 0 = Destination address does not change. RW 0x0 3 WAIT_RESP Wait for a Write Response When set this makes the DMA wait until it receives the AXI write response for each write. This ensures that multiple writes cannot get stacked in the AXI bus pipeline. 1= Wait for the write response to be received befor e proceeding. 0 = Don t wait; continue as soon as the write data is sent. RW 0x0 2:1 Reserved - Write as 0, read as don't care 0 INTEN Interrupt Enable 1 = Generate an interrupt when the transfer describ ed by the current Control Block completes. 0 = Do not Type Reset 31:16 Reserved - Write as 0, read as don't care 15:0 XLENGTH Transfer Length Length of transfer, in bytes. Updated by the DMA engine as the Reset 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 58 \u00a9 2012 Broadcom Corporation. All rights reserved 31:29 Reserved - Write as 0, read as don't care 28 LITE DMA Lite Set if the DMA is a reduced performance LITE engine. RO 0x1 27:25 VERSION DMA Version DMA version filed changes. RO 0x2 24:16 DMA_STATE DMA State Machine State Returns the value of the DMA engines state machine for this channel. RO 0x0 15:8 DMA_ID DMA ID Returns the DMA AXI ID of this DMA channel. RO 0x0 7:4 OUTSTANDING_WRITES DMA Outstanding Writes Counter Returns the number of write responses that have not yet been received. This count is reset at the start of each new DMA transfer or with a DMA reset. RO 0x0 3 Reserved - Write as 0, read as don't care 2 READ_ERROR Slave Read Response Error Set if the read operation returned an error value o n the read response bus. It can be cleared by writing a 1, RW 0x0 1 FIFO_ERROR Fifo Error Set if the optional read Fifo records an error condition. It can be cleared by writing a 1, RW 0x0 0 READ_LAST_NOT_SET_ERROR Read Last Not Set Error If the AXI read last signal was not set when expected, then this error bit will be set. It can b e cleared by writing a 1. RW 0x0 INT_STATUS Register Synopsis Interrupt status of Description Type Reset 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 59 \u00a9 2012 Broadcom Corporation. All rights reserved 31:16 Reserved - Write as 0, read as don't care 15 INT15 Interrupt status of DMA engine 15 RW 0x0 14 INT14 Interrupt status of DMA engine 14 RW 0x0 13 INT13 Interrupt status of DMA engine 13 RW 0x0 12 INT12 Interrupt status of DMA engine 12 RW 0x0 11 INT11 Interrupt status of DMA engine 11 RW 0x0 10 INT10 Interrupt status of DMA engine 10 RW 0x0 9 INT9 Interrupt status of DMA engine 9 RW 0x0 8 INT8 Interrupt status of DMA engine 8 RW 0x0 7 INT7 Interrupt status of DMA engine 7 RW 0x0 6 INT6 Interrupt status of DMA engine 6 RW 0x0 5 INT5 Interrupt status of DMA engine 5 RW 0x0 4 INT4 Interrupt status of DMA engine 4 RW 0x0 3 INT3 Interrupt status of DMA engine 3 RW 0x0 2 INT2 Interrupt status of DMA engine 2 RW 0x0 1 INT1 Interrupt status of DMA engine 1 RW 0x0 0 INT0 Interrupt status of DMA engine 0 0x0 Synopsis Global enable bits Name Description Type Reset 31:15 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 60 \u00a9 2012 Broadcom Corporation. All engine February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 61 \u00a9 (Data Request) mechanism is used to pace the dat a flow between the DMA and a peripheral. Each peripheral is allocated a permanent DREQ signal. E channel can select which of the DREQ signals should be used to pace the transfer by controlling the DMA reads, DMA writes or both. Note that DREQ 0 is permanently enabled and can be used if no DREQ is required. When a DREQ signal is being used to pace the DMA reads, t he DMA will wait until it has sampled DREQ high before launching a single or burst read ope ration. It will then wait for all the read data to be returned before re-checking the DREQ an d starting the next read. Thus once a peripheral receives the read request it should move its DREQ as soon as possible from the same DREQ asserti on. DREQ's are not required when reading from AXI peripherals. In this case, the DMA will request data from the peripheral and the peripheral will only send the data when it is available. The DMA will not request data that is does n ot have room for, so no pacing of the data flow is required. DREQ's are required when reading from APB peripherals as the AXI-to-APB bridge will not wait for an APB peripheral to be ready and will just pe rfom the APB read regardless. Thus an APB peripheral needs to make sure that it has all of its read data ready before it drives its DREQ high. When writing to peripherals, a DREQ is always required t o pace the data. However, due to the pipelined nature of the AXI bus system, several wri tes may be in flight before the peripheral receives any data and withdraws its DREQ signa the peripheral must ensure that it has sufficient room in its input FIFO to a ccommodate the maximum amount of data that it might receive. If the peripheral is una ble to do this, the DMA WAIT_RESP mechanism can be used to ensure that only one write is in flight at any one time, however this is less efficient transfer mechanism. The as follows: DREQ Peripheral 0 DREQ = 1 This is always on so use this channel if no DREQ is required. 1 DSI 2 PCM TX 3 PCM RX 4 SMI 5 PWM 6 SPI TX 7 SPI RX 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 62 \u00a9 2012 Broadcom Corporation. All rights reserved 8 BSC/SPI Slave TX 9 BSC/SPI Slave RX 10 unused 11 12 UART TX 14 UART RX. DSI Scaler FIFO 0 & SMI * 25 Scaler FIFO 1 & SMI * 26 Scaler FIFO 2 & SMI * 27 SLIMBUS * The SMI element of the Scaler FIFO 0 & SMI DREQs c an be disabled by setting the SMI_DISABLE bit in the DMA_DREQ_CONTROL stem arbiter control block. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 63 \u00a9 2012 Broadcom Corporation. All rights AXI Bursts The DMA supports bursts under specific Up to 16 beat bursts can be accommodated. Peripheral (32 bit wide) read bursts are supported. The DM A will generate the burst if there is sufficient room in its read buffer to accommodate al l the data from the burst. This limits the burst size to a maximum of 8 beats. Read bursts in destination ignore mode (DEST_IGNORE) are s upported as there is no need for the DMA to deal with the data. This allows wide bur sts of up to 16 beats to be used for efficient L2 cache fills. DMA channel 0 and 15 are fitted with an external 128 bit 8 word r ead FIFO. This enables efficient memory to memory transfers to be performed. This FIFO allows the DMA to accommodate a wide read burst up to the size of the FIFO . In practice this will allow a 128 bit wide read burst of 9 as the first word back will be imm ediately read into the DMA engine (or a 32 bit peripheral read burst of 16 - 8 in the input buffer a nd 8 in the fifo). On any DMA channel, if a read burst is selected that is too large, th e AXI read bus will be stalled until the DMA has written out the data. This may lead to ineffic ient system operation, and possibly AXI lock up if it causes a circular dependancy. In general write bursts are not supported. However to be speci fied with a write burst. In this case the DMA will issue a write burst address sequence followed by the appropriate number of zero data, zero strobe write bus cycles, which will ca use the cache to pre-fetch the data. To improve the efficiency of the 128 bit wide bus architecture, and to make use of the DMAs internal 256 bit registers, the DMA will generate 128 bit wi de writes as 2 beat bursts wherever possible, although this behaviour can be disabled. 4.4 Error Handling If the DMA detects a Read Response error it will record the fact in the READ_ERROR flag in the debug register. This will remain set until it is c leared by writing a 1 to it. The DMA will clear its active flag and generate an interrupt. A ny outstanding read data transactions (remainder a This operator to either restart the DMA by clearing the error bit and setting the active bit, or to abort the DMA transfer by clearing the NEXTCONBK register and restarting the DMA with th e ABORT bit set. The DMA will also record any errors from an external r ead FIFO. These will be latched in the FIFO_ERROR bit in the debug register until they are cl eared by writing a '1' to the bit. (note that only DMA0 and 15 have an external read fifo) If the DMA detects that a read occurred without the AXI rlast set as expected then it will set the READ_LAST_NOT_SET_ERROR bit in the debug register. Thi s can be cleared by writing a '1' to it. The error bits are logically OR'd together and presented as a general ERROR bit in the CS register. 4.5 DMA LITE Engines Several of the DMA engines are of the LITE design. Thi s is a reduced specification engine designed to save space. The engine behaves in the same way as a normal DMA engine except for the following differences. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 64 \u00a9 2012 Broadcom Corporation. All rights reserved 1. The internal data structure is 128 bits instead of 256 bits. This means that if you do a 128 bit wide read burst of more than 1 beat, the DMA input r egister will be full and the read bus will be stalled. The normal DMA engine can accept a read burst of 2 without stalling. If you do a narrow 32 bit read burst fro m the peripherals then the lite engine can cope with a burst of 4 as opposed to a burst of 8 for the normal engine. Note that stalling the read bus will potential ly reduce the overall system performance, and may possible cause a system lockup if y ou end up with a conflict where the DMA cannot free the read bus as the read stal l has prevented it writing out its data due to some circular system relationship. 2. The Lite engine does not support TDMODE tting these registers will have no effect. 3. The DMA length register is now 16 bits, limiting the maxim um transferrable length to 65536 bytes. 4. Source ignore (SRC_IGNORE) and destination ignore (DEST_ IGNORE) modes are removed. The Lite engine will have about half the bandwidth of a normal DMA engine, and are intended for low bandwith peripheral servicing. 06 February 2012 Broadcom Ltd. 406 Park Milton Road Cambridge CB4 0WW Page 65 \u00a9 2012 Broadcom Corporation. All rights 5 External Mass Controller o Introduction (EMMC) the following standards: SD Host Controller Standard Specification Version 3.0 Draft 1.0 SDIO card specification version 3.0 SD Memory Card Specification Draft version 3.0 SD Memory Card Security Specification version 1.01 MMC Specification version 3.31,4.2 and 4.4 For convenience in the following text card is used as a p laceholder for SD, embedded MultiMedia and cards. For detailed information about the EMMC internals pleas e refer to the Arasan document SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.pdf make sure to read the following chapter which lists the to Arasan 's the EMMC module shares pins with other function ality it must be selected in the GPIO interface. Please refer to the GPIO section for further details. The interface to the its own clock clk_emmc whic h is provided of this clock should be sele cted between 50 MHz and 100 MHz. Having a separate clock allows high performance access to the card even if the VideoCore runs at a reduced the sampling clock for the response and data from the card be delayed in up to 40 steps with a configurable delay between 200ps to 1100ps per ste p typically. The delay is intended to cancel the internal delay inside the card (up to 14ns) when reading. The delay per step will vary with temperature and supply voltage. The refore it is better to use a bigger delay than necessary as there is no restriction for delay. The EMMC module handles the handshaking process on the co mmand and data lines and all CRC processing automatically. Command execution is commenced by writing the command plus t he appropriate flags to the CMDTM register the CRC checksum, and to the card, receives the response and checks its CRC. Once the command has exec uted or timed-out bit 0 of register INTERRUPT will be set. Please note that the INTERRU PT register is not self clearing, so the software has first to reset it by writing 1 before using it to detect if a command has finished. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 66 \u00a9 2012 Broadcom Corporation. All rights reserved The software is responsible for checking the status bits of the card's response in order to verify successful processing by the card. In order to transfer data from/to the card register DA TA is accessed after configuring the host and sending the according doesn't card it is important to configure it identical to the card setup CONTROL0 E special care should be taken to make sure that the width of the data bus is configured iden tical for host and card. The card is synchronized to the data flow by switching off its clock priately. available Bit 1 of t he INTERRUPT register can used to determine whether a data transfer has finished. Please not e that the INTERRUPT register is not self clearing, so the software has first to reset it by writing 1 before using it to detect if a data transfer has finished. The EMMC module restricts the maximum block size to the size of the internal data FIFO which is 1k bytes. In order to get maximum performance for data transfers it is necessary to use multiple block data transfers. In this case the EMM C module uses two FIFOs in ping- pong mode, i.e. one is used to transfer data to/from the card while the other is simultaneously accessed by DMA via the AXI bus. If the EMMC module is c onfigured for single block transfers only one FIFO is used, so no DMA access is po ssible while data is transferred to/from the card and vice versa resulting in long dead time s. o Registers Contrary to Arasan's documentation the EMMC module r egisters can only be accessed as 32 bit registers, i.e. the two LSBs of the address are al ways zero. The and Transfer Mode Response bits 31 : 0 32 0x14 RESP1 bits 63 : 32 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 67 \u00a9 2012 Broadcom Corporation. All rights 95 : 64 32 0x1c RESP3 Response bits 127 : 96 32 0x20 DATA Data 32 0x24 STATUS Status 32 0x28 CONTROL0 Host Configuration February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 68 \u00a9 2012 Broadcom This pecific command ACMD23 (SET_WR_BLK_ERASE_COUNT). ARG2 must be set before is issued using the not be accessed or modified while any data transfer between card and host is ongoing. It contains the number and size in bytes for data blo cks to be transferred. Please note that the EMMC module restricts the maximum block size to the size of the internal data FIFO which is 1k bytes. BLKCNT is used to tell the host how many blocks of dat a are to be transferred. Once the data transfer has started and the TM_BLKCNT_EN bit in the CMDTM automatically decreases value as the blocks are transferred and stops the transfer once BLKCNT r eaches Field Name Description Type to be transferred RW 15:10 Reserved - Write as 0, read don't care Block register the card specific command ACMD23 which uses ARG2. ARG1 issued using the 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 69 \u00a9 2012 used to also flags informing the EMMC module what card of data transfer to expect. Incorrect flags will result in st range transfers two modes are supported: either transferring a single block of data or several blocks of the same size. The SD card uses tw o different sets of commands to differentiate between them but the host needs to be additionally configured using TM_MULTI_BLOCK. It is important that this bit is se t correct for the command sent to the card, i.e. 1 for CMD18 and CMD25 and 0 for CMD17 and CMD24. Multiple block transfer gives a better performance. The BLKSIZECNT register is used to configure the size and number of blocks to be transferred. If bit TM_BLKCNT_EN of this register i s set the transfer stops automatically after the number of data blocks configured in the BLKSIZECNT register has been transferred. The TM_AUTO_CMD_EN bits can be used to make the host to send automatically a command to the card telling it that the data transfer has finished once the BLKCNT bits in the BLKSIZECNT register are 0. Bit(s) Field Name Description Type Reset 31:30 Reserved - Write as 0, read as don't care 29:24 CMD_INDEX Index of the command to be issued to the card RW 0x0 23:22 CMD_TYPE Type of command to be issued to the card: 00 = normal 01 = suspend (the current data transfer) 10 = resume (the last data transfer) 11 = abort (the current data transfer) RW 0x0 21 CMD_ISDATA Command involves data transfer: 0 = no data transfer command 1 = data transfer command RW 0x0 20 CMD_IXCHK_EN Check that response has same index as command: 0 disabled 1 enabled RW 1 = enabled RW 0x0 18 Reserved - Write as 0, read as don't care 17:16 CMD_RSPNS_TYPE Type of expected response from card: 00 = no response 01 = 136 bits response 10 = 48 bits response 11 = 48 using busy RW 0x0 06 February 2012 Broadcom 406 Science Park Milton Road Cambridge CB4 0WW Page 70 \u00a9 2012 Broadcom Corporation. All rights reserved 15:6 Reserved - Write as 0, read as don't care 5 TM_MULTI_BLOCK Type of data transfer 0 = single block 1 = multiple block RW 0x0 4 TM_DAT_DIR Direction of data transfer: 0 = from host to card 1 = from card to host RW 0x0 3:2 TM_AUTO_CMD_EN Select the command to be send after completion of a data transfer: 00 = no command 01 = command CMD12 10 = command CMD23 11 = reserved RW 0x0 1 TM_BLKCNT_EN Enable the block counter for block transfers: 0 = disabled 1 = enabled RW 0x0 0 Reserved - Write as 0, don't care RESP0 Register Synopsis This register contains the status bits of the SD card s response. In case of commands CMD2 and CMD10 it contains CID[31:0] and CSD[31:0]. Note: this register once the last comman d has completed and no new command was issued. Bit(s) Field Name Description Type Reset 31:0 RESPONSE Register cont ains CSD[63:32]. Note: this register is only valid once the last comman d has completed and no new command was issued. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 71 \u00a9 2012 Broadcom Corporation. All Field Name Description Type Reset 31:0 RESPONSE Register cont ains CSD[95:64]. Note: this register is only valid once the last comman d has completed and no new command was issued. Bit(s) Field Name Description Type Reset 31:0 RESPONSE Register cont ains CSD[127:96]. Note: this register is only valid once the last comman d has completed and no new command was issued. Bit(s) Field Name Des cription Type Reset DATA Register Synopsis This register is used to transfer data to/from the card. Bit 1 of the INTERRUPT register can be used to check i f data is available. For paced DMA transfers the high active signal dma_req can be used. Bit(s) Field Name Description Type Reset DATA the card RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 72 \u00a9 2012 Broadcom involves resynchronisation between different clock domains it changes only after some late ncy and it is easy sample the values too early. Therefore it is not recommended to use this register for polling. Instead use the register handshake mechan ism which impossible to miss a change when polling. Bit(s) Field Name Description Type Reset 31:29 Reserved - as 0, read as don't Value Reserved - Write as 0, read as don't care 9 READ_TRANSFER New data can be read from EMMC: 0 = no 1 = yes RW 0x0 8 WRITE_TRANSFER New data can be written to EMMC: 0 = no 1 = yes RW 0x0 7:3 Reserved - Write as 0, read as don't care 2 DAT_ACTIVE At least one data line is active: 0 = no 1 = yes RW 0x0 1 DAT_INHIBIT Data lines still used by previous data transfer: 0 = no 1 = yes RW 0x0 0 CMD_INHIBIT Command line still used by previous command: 0 = no 1 = yes RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 73 \u00a9 2012 do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the changes listed in the Field Name Description Type Reset 31:23 Reserved - Write as 0, read as don't care 22 ALT_BOOT_EN Enable alternate boot mode access: disabled enabled RW 0x0 21 BOOT_EN Boot mode access: 0 = stop boot mode access 1 = start boot mode access RW 0x0 20 SPI_MODE SPI mode enable: 0 = normal mode 1 = SPI mode RW 0x0 19 GAP_IEN Enable SDIO interrupt at is set): 0 = disabled = enabled 0x0 18 Use DAT2 protocol for supporting this: = enabled = ignore 1 = restart RW 0x0 16 GAP_STOP Stop the current transaction at the next block gap: 0 = ignore 1 = stop RW 0x0 15:6 Reserved - Write as 0, read as don't care 5 HCTL_8BIT Use 8 data lines: 0 = 1 = enabled RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 74 \u00a9 2012 Broadcom Corporation. All rights reserved 4:3 Reserved - Write as 0, read as don't care 2 HCTL_HS_EN Select high speed mode (i.e. DAT and CMD lines change on the rising CLK edge): 0 = disabled 1 = enabled RW 0x0 1 HCTL_DWIDTH Use 4 data lines: 0 = disabled 1 = enabled RW 0x0 0 Reserved - Write as 0, read don't care CONTROL1 do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the previous seems contrary to its name only to indicat e that there was a rising edge on the clk_emmc input but not that the frequency of th is clock is actually stable. Bit(s) Field Name Description Type Reset 31:27 Reserved - Write as 0, read as don't care 26 SRST_DATA Reset the data handling circuit: 0 disabled 1 = enabled RW 0x0 25 SRST_CMD Reset the handling circuit: disabled 1 = enabled RW 0x0 24 SRST_HC Reset the host disabled 1 = enabled RW 0x0 23:20 Reserved - Write 0, don't care 19:16 DATA_TOUNIT Data timeout unit Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 75 \u00a9 divided 1 = programmable RW 0x0 4:3 Reserved - Write as 0, read as don't care 2 CLK_EN SD clock enable: CLK_STABLE SD clock stable: 0 = 1 = 0 CLK_INTLEN Clock enable for internal EMMC in the IRPT_MASK register. For details please refer to do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been to the changes listed in the previous chapter. ERR is a generic flag and is set if any of the enabl ed error flags is set. Bit(s) Field Name Description Type Reset 31:25 Reserved - Write as 0, read as don't care 24 ACMD_ERR Auto command error: 0 = no error 1 = error RW 0x0 23 Reserved - Write as 0, read as don't care 22 DEND_ERR End bit on data line not 1: 0 = no error 1 = error RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 76 \u00a9 2012 Broadcom Corporation. All rights reserved 21 DCRC_ERR Data CRC error: 0 = no error 1 = error RW 0x0 20 DTO_ERR Timeout on data line: 0 = no error 1 = error RW 0x0 19 CBAD_ERR Incorrect command index in response: 0 = no error 1 = error RW 0x0 18 CEND_ERR End bit on command line not 1: 0 = no error 1 = error RW 0x0 17 CCRC_ERR Command CRC error: 0 = no error 1 = error RW 0x0 16 CTO_ERR Timeout on command line: 0 = no error 1 = error RW 0x0 15 ERR An error has occured: 0 = no error 1 = error RO 0x0 14 ENDBOOT Boot operation has terminated: 0 = no 1 = yes RW 0x0 13 BOOTACK Boot acknowledge has been received: 0 = no 1 = yes RW 0x0 12 RETUNE Clock retune request was made: 0 = no 1 = yes RO 0x0 11:9 Reserved - Write as 0, read as don't care 8 CARD Card made interrupt request: 0 = no 1 = yes RO 0x0 7:6 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 77 \u00a9 2012 Broadcom Corporation. All rights 5 READ_RDY DATA register contains data to be read: 0 = no 1 = yes RW 0x0 4 WRITE_RDY Data can be written to DATA register: 0 = no 1 = yes RW 0x0 3 Reserved - Write as 0, read as don't care 2 BLOCK_GAP Data transfer has stopped at block gap: 0 = no 1 = yes RW 0x0 1 DATA_DONE Data transfer has finished: 0 = no 1 = yes RW 0x0 0 CMD_DONE Command has finished: 0 = no 1 = yes RW 0x0 IRPT_MASK Register Synopsis This register the INTERRUPT register. For the to do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the changes listed in the Field Name Description Type Reset 31:25 Reserved - Write as 0, read as don't care 24 ACMD_ERR Set flag if auto command error: 0 = no 1 = yes RW 0x0 23 Reserved - Write as 0, read as don't care 22 DEND_ERR Set flag if end bit on data line not 1: 0 = no 1 = yes RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 78 \u00a9 2012 Broadcom Corporation. All rights reserved 21 DCRC_ERR Set flag if data CRC error: 0 = no 1 = yes RW 0x0 20 DTO_ERR Set flag if timeout on data line: 0 = no 1 = yes RW 0x0 19 CBAD_ERR Set flag if incorrect command index in response: 0 = no 1 = yes RW 0x0 18 CEND_ERR Set flag if end bit on command line not 1: 0 = no 1 = yes RW 0x0 17 CCRC_ERR Set flag if command CRC error: 0 = no 1 = yes RW 0x0 16 CTO_ERR Set flag if timeout on command line: 0 = no 1 = yes RW 0x0 15 Reserved - Write as 0, read as don't care 14 ENDBOOT Set flag if boot operation has terminated: 0 = no 1 = yes RW 0x0 13 BOOTACK Set flag if boot acknowledge has been received: 0 = no 1 = yes RW 0x0 12 RETUNE Set flag if clock retune request was made: 0 = no 1 = yes RW 0x0 11:9 Reserved - Write as 0, read as don't care 8 CARD Set flag if card made interrupt request: 0 = no 1 = yes RW 0x0 7:6 Reserved - Write as 0, read as don't care 5 READ_RDY Set flag if DATA register contains data to be read: 0 = no 1 = yes RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 79 \u00a9 2012 Broadcom Corporation. All rights reserved 4 WRITE_RDY Set flag if data can be written to DATA register: 0 = no 1 = yes RW 0x0 3 Reserved - Write as 0, read as don't care 2 BLOCK_GAP Set flag if data transfer has stopped at block gap: 0 = no 1 = yes RW 0x0 1 DATA_DONE Set flag if data transfer has finished: 0 = no 1 = yes RW 0x0 0 CMD_DONE Set flag if command has finished: 0 = no 1 = yes RW 0x0 IRPT_EN Register Synopsis This register is in to int_to_arm please to do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the changes listed in the Field Name Description Type Reset 31:25 Reserved - Write as 0, read as don't care 24 ACMD_ERR Create interrupt if auto command error: 0 = no 1 = yes RW 0x0 23 Reserved - Write as 0, read as don't care 22 DEND_ERR Create interrupt if end bit on data line not 1: 0 = no 1 = yes RW 0x0 21 DCRC_ERR Create interrupt if data CRC error: 0 = no 1 = yes RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 80 \u00a9 2012 Broadcom DTO_ERR Create interrupt if timeout on data line: 0 = 1 = yes RW 0x0 19 CBAD_ERR Create interrupt if incorrect command index in response: 0 = no 1 = yes RW 0x0 18 CEND_ERR Create interrupt if end bit on command line not 1: 0 = no 1 = yes RW 0x0 17 CCRC_ERR Create interrupt if command CRC error: 0 = no 1 = yes RW 0x0 16 CTO_ERR Create interrupt if timeout on command line: 0 = no 1 = yes RW 0x0 15 Reserved - Write as 0, read as don't care 14 ENDBOOT Create interrupt if boot operation has terminated: 0 = no 1 = yes RW 0x0 13 BOOTACK Create interrupt if boot acknowledge has been received: 0 = no 1 = yes RW 0x0 12 RETUNE Create interrupt if clock retune request was made: no 1 = yes RW 0x0 11:9 Reserved - Write as 0, read as don't care 8 CARD Create interrupt if card made interrupt request: 0 = no 1 = yes RW 0x0 7:6 Reserved - Write as 0, read as care 5 READ_RDY Create interrupt if DATA register contains data to be read: 0 = no 1 = yes RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 81 \u00a9 2012 Broadcom Corporation. All rights 4 WRITE_RDY Create interrupt if data can be written to DATA register: 0 = no 1 = yes RW 0x0 3 Reserved - Write as 0, read as don't care 2 BLOCK_GAP Create interrupt if data transfer has stopped at block gap: 0 = no 1 = yes RW 0x0 1 DATA_DONE Create interrupt if data transfer has finished: 0 = no 1 = yes RW 0x0 0 CMD_DONE Create interrupt if command has finished: 0 = no = yes RW 0x0 CONTROL2 Register Synopsis This register is in to int_to_arm please to do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been to the changes listed in the previous chapter. Bit (s) Field Name Description Type Reset 31:24 Reserved - Write as 0, read as don't 23 TUNED Tuned clock is used for sampling data: 0 = no 1 = yes RW 0x0 22 TUNEON Start tuning the SD clock: 0 not 1 = tuning RW 0x0 21:19 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 82 \u00a9 2012 Broadcom Corporation. All rights UHSMODE Select speed mode of the SD 000 = SDR12 001 = SDR25 010 = SDR50 011 = SDR104 = DDR50 other = reserved RW 0x0 15:8 Reserved - Write as 0, read as don't care 7 NOTC12_ERR Error occurred during auto command CMD12 execution: 0 = no error 1 = error RO 0x0 6:5 Reserved - Write as 0, read as don't care 4 ACBAD_ERR Command index error occurred during auto command execution: 0 = no error 1 = error RO 0x0 3 ACEND_ERR End bit is not 1 during auto command execution: 0 = no error 1 = error RO 0x0 2 ACCRC_ERR Command CRC error occurred during auto command execution: 0 = no error 1 = error RO 0x0 1 ACTO_ERR Timeout occurred during auto command execution: 0 = no error 1 = error RO 0x0 0 ACNOX_ERR Auto command not executed due to an error: 0 = no 1 = yes RO 0x0 FORCE_IRPT Register Synopsis This register is used to fake t events for debugging. For the exact details please refer to the Arasan do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the previous chapter. 06 February 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 83 \u00a9 2012 Broadcom Corporation. ption Type Reset 31:25 Reserved as 0, as don't care 24 ACMD_ERR Create auto command error: 0 = no 1 = yes RW 0x0 23 Reserved - Write as 0, read as don't care 22 DEND_ERR Create end bit on data line not 1: 0 = no 1 = yes RW 0x0 21 DCRC_ERR Create data CRC error: 0 = no 1 = yes RW 0x0 20 DTO_ERR Create timeout on data line: 0 = no 1 = yes RW 0x0 19 CBAD_ERR Create incorrect command index in response: 0 = no 1 = yes RW 0x0 18 CEND_ERR Create end bit on command line not 1: 0 = no 1 = yes RW 0x0 17 CCRC_ERR Create command CRC error: 0 = no 1 = yes RW 0x0 16 CTO_ERR Create timeout on command line: 0 = no 1 = yes RW 0x0 15 Reserved - Write as 0, read as don't care 14 ENDBOOT Create boot operation has terminated: 0 = no 1 = yes RW 0x0 13 BOOTACK Create boot acknowledge has been received: 0 = no 1 = yes RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 84 \u00a9 2012 RETUNE Create clock retune request was made: no 1 = yes RW 0x0 11:9 Reserved - Write as 0, read as don't care 8 CARD Create card made interrupt request: 0 = no 1 = yes RW 0x0 7:6 Reserved - Write as 0, read as don't care 5 READ_RDY Create DATA register contains data to be read: 0 = no 1 = yes RW 0x0 4 WRITE_RDY Create data can be written to DATA register: 0 = no 1 = yes RW 0x0 3 Reserved - Write as 0, read as don't care 2 BLOCK_GAP Create interrupt if data transfer has stopped at block gap: 0 = no 1 = yes RW 0x0 1 DATA_DONE Create data transfer has finished: 0 = no 1 = yes RW 0x0 0 CMD_DONE Create command has finished: 0 = no 1 RW 0x0 BOOT_TIMEOUT Register Synopsis This cycles a timeout for e.MMC cards in boot mode Bit(s) Field Name Type Reset 31:0 clock RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 85 \u00a9 2012 he debug bus. For the exact details please refer to the Arasan do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bits marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the changes SELECT Submodules accessed by debug for paced DMA transfers when reading from the card. If the extension data FIFO con tains less than RD_THRSH 32 filled the data FIFO above threshold. This compensates the DMA latency. When writing data to the card the extension data FIF O feeds into the EMMC module s FIFO and no fine tuning is required Therefore the R D_THRSH value is in Bit(s) Field Name Description Type Reset 31:3 Reserved - Write as 0, read as don't care 2:0 RD_THRSH Read threshold in be for paced be bypassed Field Name Description Type Reset 31:1 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 86 \u00a9 2012 Broadcom Corporation. All rights reserved 0 ENABLE Enable the extension FIFO: 0 samp ling the data and command response from the card. DELAY determines by how much the sampling clock is dela yed per step. Bit(s) Field Name Description Type Reset 31:3 Reserved - Write as 0, read as don't care 2:0 DELAY Sampling clock delay samp ling the returning data and command response from the card. It determines by how m any steps the sampling clock is delayed in SDR mode. Bit(s) Field Name Description Type Reset 31:6 Reserved - Write as 0, read as don't care 5:0 STEPS Number of 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 87 \u00a9 2012 Broadcom Corporation. This samp ling the returning data and command response from the card. It determines by how m any steps the sampling clock is delayed in DDR mode. Bit(s) Field Name Description Type Reset 31:6 Reserved - Write as 0, read as don't care 5:0 STEPS Number of steps controls interrupt s in SPI mode is possible independent of the card select line. For the exact details please refer to the Arasan do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bit marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the changes listed in the Field Name Description Type Reset 31:8 Reserved as 0, read as 7:0 SELECT Interrupt independent of card select line: yes RW 0x0 SLOTISR_VER Register Synopsis This register contains the version and s lot interrupt status. For the exact details please refer to the Arasan do cumentation SD3.0_Host_AHB_eMMC4.4_Usersguide_ver5.9_jan11_10.p df. Bit marked as reserved in this document but not by the Arasan docum entation refer to functionality which has been the changes listed in the 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 88 \u00a9 2012 Broadcom Corporation. All rights reserved 15:8 Reserved - Write as 0, read as don't care 7:0 SLOT_STATUS Logical OR of RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 89 \u00a9 2012 Broadcom Corporation. All rights reserved 6 General Purpose I/O (GPIO) There are 54 general-purpose I/O (GPIO) lines split into t wo banks. All GPIO pins have at least two alternative functions within BCM. The alterna te functions are usually peripheral IO and a single peripheral may appear in each bank to allow flexibility on the choice of IO voltage. Details of alternative functions are given i n section 6.2. Alternative Function Assignments. The block diagram for an individual GPIO pin is given belo w Figure 6-1 GPIO Block Diagram 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 90 \u00a9 2012 Broadcom Corporation. The GPIO peripheral has three dedicated interrupt lines. These lines are triggered by the setting of bits in the event detect status register. Each bank has its' own interrupt line with the third line shared between all bits. The Alternate function table also has the pull state (pull-up/pull-down) which is applied after a power down. 6.1 Register View The GPIO has 41 registers. All accesses are assumed to be Address February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 91 \u00a9 2012 Broadcom Corporation. All e operation of the general -purpose I/O pins. Each of the 54 GPIO pins has at least two al ternative functions as defined in section 16.2. The FSEL{n} field determines the functionalit y of the nth GPIO pin. All unused alternative function lines are tied to ground and w ill output a \"0\" if selected. All pins reset to normal R 0 06 February 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 92 \u00a9 2012 Function 9 000 Pin 9 is an input 001 = GPIO Pin 9 is an output 100 = GPIO Pin 9 takes alternate function 0 101 = GPIO Pin 9 takes alternate function 1 110 = GPIO Pin 9 takes alternate function 2 111 = GPIO Pin 9 takes alternate function 3 011 = GPIO Pin 9 takes alternate function 4 010 = GPIO 000 = GPIO Pin 19 is an input 001 = GPIO Pin 19 is an output 100 = GPIO Pin 19 takes alternate function 0 101 = GPIO Pin 19 takes alternate function 1 110 = GPIO Pin 19 takes alternate function 2 111 = GPIO Pin 19 takes alternate function 3 011 = GPIO Pin 19 takes alternate function 4 010 = GPIO 2012 406 Science Park Milton Road Cambridge CB4 0WW Page 93 \u00a9 2012 Broadcom Corporation. All Field 000 = GPIO Pin 29 is an input 001 = GPIO Pin 29 is an output 100 = GPIO Pin 29 takes alternate function 0 101 = GPIO Pin 29 takes alternate function 1 110 = GPIO Pin 29 takes alternate function 2 111 = GPIO Pin 29 takes alternate function 3 011 = GPIO Pin 29 takes alternate function 4 010 = GPIO 000 = GPIO Pin 39 is an input 001 = GPIO Pin 39 is an output 100 = GPIO Pin 39 takes alternate function 0 101 = GPIO Pin 39 takes alternate function 1 110 = GPIO Pin 39 takes alternate function 2 111 = GPIO Pin 39 takes alternate function 3 011 = GPIO Pin 39 takes alternate function 4 010 = GPIO 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 94 \u00a9 2012 Broadcom 000 = GPIO Pin 49 is an input 001 = GPIO Pin 49 is an output 100 = GPIO Pin 49 takes alternate function 0 101 = GPIO Pin 49 takes alternate function 1 110 = GPIO Pin 49 takes alternate function 2 111 = GPIO Pin 49 takes alternate function 3 011 = GPIO Pin 49 takes alternate function 4 010 = GPIO 000 = GPIO Pin 53 is an input 001 = GPIO Pin 53 is an output 100 = GPIO Pin 53 takes alternate function 0 101 = GPIO Pin 53 takes alternate function 1 110 = GPIO Pin 53 takes alternate function 2 111 = GPIO Pin 53 takes alternate function 3 011 = GPIO Pin 53 takes alternate function 4 010 = GPIO 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 95 \u00a9 2012 Broadcom The SET{n} field defines the respective GPIO pin to set, writing a \"0\" to the field has no effect. If the GPIO pin is being used as in input (by default) then the value in the SET{n} field is ignored. However, if the pin is subsequently defined as an ou tput then the bit will be set according to the last set/clear operation. Separating the set and clear functions removes the need for read-modify-write operations Bit(s) Field Name Description Type Reset 31-0 SETn (n=0..31) 0 = No effect 1 = pin n R/W 0 Table 6-8 - GPIO Output Register Field - R 0 21-0 SETn (n=32..53) 0 No effect = R/W respective GPIO pin to clear, writing a \"0\" to the field has no effect. If the GPIO pin is being used as in input (by default) then the value in the CLR{n} field is ignored. However, if the pin is subsequently defined as an output then the bit will be set according to the last set/clear operation. Sepa rating the set and clear functions removes the need for read-modify-write op Name Type Reset No Reserved R 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 96 \u00a9 2012 Broadcom Corporation. 21-0 CLRn (n=32..53) 0 = No effect pin level registers return the actual value of t he pin. The LEV{n} field gives the value of the respective Reset 31-0 LEVn (n=0..31) 0 = GPIO pin n is low 0 = GPIO pin n is high R/W 0 Table 6-12 - GPIO Level Register R 0 21-0 LEVn (n=32..53) 0 = GPIO pin n is low 0 = GPIO pin n is high R/W 0 are used to record level and edge events on the GPIO pins. The relevant bit in the event detect stat us registers is set whenever: 1) an edge is detected that matches the type of edge prog rammed in the rising/falling edge detect enable registers, or 2) a level is detect ed that matches the type of level programmed in the high/low level detect enable regis ters. The bit is cleared by \"1\" to the relevant bit. The interrupt controller can be programmed to interru pt the processor when any of the status bits are set. The GPIO peripheral has th ree dedicated generate independent interrupt. The third line generates a single interrupt whenever any bit is set. Bit(s) Field Name Description Type Reset 31-0 EDSn (n=0..31) 0 = Event 1 = 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 97 \u00a9 2012 Broadcom Corporation. All rights Bit(s) Field Name 31-22 1 = detect enable registers define the p ins for which a rising edge transition sets a bit in the event detect status re gisters ( GPEDSn ). When the are both the GPRENn and GPFENn registers, any transition (1 to 0 and 0 to 1) will set a bit in the GPEDSn registers. The GPRENn is sampled using the system clock and then it is looking for a \"011\" pattern on the sampled signal. This has the effect Name Description = Rising edge detect disabled on GPIO pin n. 1 = Rising edge on GPIO pin n sets corresponding bit in EDSn. R/W 6-16 Edge Detect r Bit(s) Field Name Description 31-22 - Reserved R 21-0 Rising edge detect disabled on GPIO pin n. 1 = Rising edge on GPIO pin n sets corresponding bit in EDSn. R/W 6-17 r 1 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 98 \u00a9 2012 pins for which a falling edge transition sets a bit in the event re gisters ( GPEDSn ). When the are both the GPRENn and GPFENn registers, any transition (1 to 0 and 0 to 1) will set a bit in the GPEDSn registers. The GPFENn registers use is sampl ed using the system clock and then it is looking for a \"100\" pattern on the sampled signal. This has the effect suppressing glitches. Bit(s) Field Name Description = Falling edge detect disabled GPIO pin n. 1 = Falling edge on GPIO pin n sets corresponding Field Description Type Reset 31-22 - Reserved R 21-0 Falling edge detect disabled on GPIO pin n. 1 = Falling edge on GPIO pin n sets corresponding enable registers define the p ins for which a high level sets a bit in the event detect status register ( GPEDSn ). If the pin is still high when an attempt is made to clear the status bit in GPEDSn then the status bit will remain set. Bit(s) Field Name Description Type Reset 0 = High detect disabled on GPIO pin n 1 = High on GPIO pin n sets corresponding bit in GPEDS - High detect disabled on GPIO pin n 1 = High on GPIO pin n sets corresponding bit in GPEDS 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 99 \u00a9 2012 enable registers define the pi ns for which a low level sets a bit in the event detect status register ( GPEDSn ). If the pin is still low when an attempt is made to clear the status bit in GPEDSn then the status bit will remain set. Bit(s) Field Name Description Type Reset 0 = Low detect disabled on GPIO pin n 1 = Low on GPIO pin n sets corresponding bit in GPEDS - Low detect disabled on GPIO pin n 1 = Low on GPIO pin n sets corresponding bit in GPEDS d the pins for which a asynchronous rising edge transition sets a bit the system clock. As such rising edges of very short duration can Field Description Type Asynchronous rising edge on GPIO p in n. 1 = Asynchronous rising edge on GPIO pin n sets corresponding EDSn. R rising edge detect disabled on GPIO p in n. 1 = Asynchronous rising edge on GPIO pin n sets corresponding bit in EDSn. R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 100 \u00a9 2012 for which a asynchronous falling edge transition sets a the system clock. As such falling edges of very short duration n. 1 Asynchronous falling edge on GPIO pin n sets n. 1 Asynchronous falling edge on GPIO pin n sets internal pull-up/down control line to ALL the GPIO pins. This register mus t be used in conjunction with the 2 GPPUDCLKn registers. Note that it is not possible to read back the current Pull-up/down settings and so it is the users' responsibility to 'remember' which pull-up/do wns are active. The reason for this is that GPIO pull-ups are maintained even in power-dow n mode when the core is off, when all register contents is lost. The Alternate function table also has the pull state which is applied after a power down. Bit(s) Field Name Description Type Reset 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 101 \u00a9 2012 Broadcom Corporation. PUD = Off - disable pull-up/down 01 = Enable Pull Down control 10 = Pull Up respective GPIO pins. These registers must be us ed the to effect GPIO fol of events is required: 1. Write to GPPUD to set the required control signal (i.e. Pull-up or Pull-Down or neither to remove the current Pull-up/down) Wait 150 cycles - this provides the required set-u p time for the control signal 3. Write to GPPUDCLK0/1 to clock the control signal in to the GPIO pads you wish to modify - NOTE only the pads which receive a clock will be modified, all others will retain their previous state. 4. Wait 150 cycles - this provides the required hold time for the control signal 5. Write to GPPUD to remove the control signal 6. Write to GPPUDCLK0/1 to remove the clock Bit(s) Field Name = No Effect (n) R 0 21-0 Effect = (n) 406 Science Park Milton Road Cambridge CB4 0WW Page 102 \u00a9 2012 Broadcom Corporation. All rights 6.2 Alternative Every GPIO pin to 6 alternate function are available but not every pin has that many alternate functions. The table below Park Milton Road Cambridge CB4 0WW Page 103 \u00a9 2012 should not be used. These may have unexpected results as some of these have special functions used in test mode. e.g. they may drive the output with high frequency signals. Special function legend: Name Function See section SDA0 BSC 6 master 0 data line BSC SCL0 BSC master 0 clock line BSC SDA1 BSC master 1 data line BSC SCL1 BSC master 1 clock line BSC PCM Audio PCM_FS PCM Frame Sync PCM Audio PCM_DIN PCM Data in PCM Audio PCM_DOUT PCM data out PCM Audio SAx Secondary mem Address Secondary Secondary Memory Interface BSCSL SDA / MOSI BSC slave Data, SPI salve MOSI BSC ISP slave BSCSL SCL / SCLK BSC slave Clock, SPI slave clock BSC ISP slave BSCSL - / MISO BSC <not used>,SPI MISO BSC ISP slave BSCSL - / CE_N BSC <not used>, SPI CSn BSC ISP slave 6 The Broadcom Serial Control bus is a proprietary bus co mpliant with the Philips \u00ae I2C bus/interface 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 104 \u00a9 2012 Broadcom February 2012 Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 105 \u00a9 2012 Broadcom Corporation. All General General Purpose clocks can be pins. They f requency. In jitter a fastest rs which push this divider jitter out of the audio band. MASH noise-shaping is incorporated to push the fractional divider jitter out of the audio band if required. The MASH can be programmed for 1, is and the user must ensure that the source / ( + 1 ) 2 3 source / ( - 1 ) source / ( 1024 ) source / ( + 2 ) 3 5 source / ( - 3 ) source / ( of the MASH filter. Note that the spread is greater for lower freq freq (MHz) ave (MHz) max freq 650 18.32 0 35.480 492 18.57 18.32 20.00 ok 400 18.32 3 21.834 21 854 16.00 18.32 22.22 ok 200 18.32 0 10.917 10 939 20.00 20.00 20.00 ok 200 18.32 1 10.917 10 939 18.18 18.32 20.00 ASH Filtering It is beyond the scope of this specification to describe the operation of a MASH filter or to determine under what conditions f iltering are beneficial. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 106 \u00a9 2012 Broadcom Frequency The maximum operating frequency of the General Purpose clo cks is ~125MHz at 1.2V but this will be reduced if the GPIO pins are heavily loaded or have a capacitive load. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 107 \u00a9 2012 Broadcom 0 10-9 MASH avoid lock-ups and glitches do not change this control while BUSY=1 and do not change this control at the same time as asserting ENAB. R/W 0 8 FLIP Invert the This is intended for use in test/debug only. Switch ing this control will generate an edge on the clock generator output. To avoid glitches do BUSY Clock generator and setups mus t not be changed while this flag is set. R 0 6 - Unused R 0 5 KILL Kill the clock generator 0 = no action 1 = stop and reset the clock generator This is intended for test/debug only. Using this or stop without glitches. The output clock will not stop immediatel y because cycle be allowed to complete to avoid glitches. The BUSY flag will go low when the final cycle is completed. R/W 0 3-0 SRC Clock source 0 = GND 1 = oscillator 2 = testdebug0 3 = testdebug1 4 = PLLA per 5 = PLLC per 6 = PLLD per 7 = HDMI auxiliary 8-15 = GND To avoid lock-ups and glitches do not change this control while BUSY=1 and do not change this control at the same time as asserting ENAB. R/W 0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 108 \u00a9 2012 divisor determined by To avoid lock-u ps and glitches do not change control while BUSY= 1. R/W 0 11-0 DIVF Fractional part of divisor To avoid lock-ups and glitches do not change this 406 Park Milton Road Cambridge CB4 0WW Page 109 \u00a9 2012 Broadcom Corporation. All rights reserved 7 Interrupts 7.1 Introduction The ARM has two types of interrupt sources: 1. Interrupts coming from the GPU peripherals. 2. Interrupts coming from local ARM control peripheral s. The ARM processor gets three types of interrupts: 1. Interrupts from ARM specific peripherals. 2. Interrupts from The ARM specific interrupts are: timer. Two Address/access error interrupt The Mailbox and Doorbell are not for gene ral usage. For each interrupt source (ARM or GPU) there is an interrupt enable bit (read/write) and an interrupt pending bit (Read Only). All interrupts generated b y the arm control block are level sensitive interrupts. Thus all interrupts remain asserted unt il source cleared. Default the interrupts from doorbell 0,1 and mailbo x 0 go to the ARM this means that these resources should be written by the GPU and read by the ARM. The opposite holds for doorbells 2, 3 and mailbox 1. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 110 \u00a9 2012 Broadcom Corporation. 7.2 Interrupt interrupt vector module still adequate processing the pend. 1 A few selected GPU IRQs See text There are three interrupt pending . To speed up the interrupt processing it also has a number of selected GPU interrupts which are deemed most likely to be required in ARM drivers. Further there are two special GPU pending bits whic h tell if any of the two other pending registers has bits set, one bit if a GPU interrupt 0-31 is pe nding, a second bit if a GPU interrupt 32-63 is pending. The 'selected GPU interrupts' pending registers are NOT taken into account for these two status bits. So the two pending 0,1 statu s bits tell you that 'there are more interrupt whic h you have not seen yet'. GPU pending registers. There are two GPU pending registers with one bit pe r GPU interrupt source. 7.3 Fast Interrupt (FIQ). The ARM nterrupt sources selected to connected to input. There also normal normal and a FIQ interrupt will be fired at the same time. Not a good idea! 7.4 Interrupt priority. There is no priority for any interrupt. If one inte rrupt is much more important then all others it can be routed to the FIQ. Any remaining interrupts pending 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 111 \u00a9 2012 Broadcom Corporation. All rights reserved registers. It is up to the ARM software to device a strategy. e.g. First start looking for specific pe nding bits or process them all shifting one bit at a time . As interrupt may arrive whilst this process is ongo ing the usual care for any 'race-condition critical ' code must be taken. The following ARM assembly code has been proven + 31) and \\tmp, \\irqstat, and 9 bics \\irqstat, \\irqstat, #0x300 @ clear bit PEND0 PEND0 pending 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 112 \u00a9 2012 Broadcom Corporation. All rights reserved .endm 7.5 Registers table which lists all interrupts which can come from the peripherals which can be handled by the ARM. 7 This is the offset which needs to be added to the base address to get the full hardware address. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 113 \u00a9 2012 Broadcom peripherals interrupts table. # IRQ 0 -15 # IRQ 16 -31 # IRQ 32 -47 # IRQ 48 -63 0 16 32 48 smi 1 17 33 49 gpio_int[0] 2 18 34 50 gpio_int[1] 3 19 35 51 gpio_int[2] 4 20 36 52 gpio_int[3] 5 21 37 53 i2c_int 6 22 38 54 spi_int 7 23 39 55 pcm_int 8 24 40 56 9 25 41 57 uart_int 10 26 42 58 11 27 43 i2c_spi_slv_int 59 12 28 44 60 13 29 Aux int 45 pwa0 61 14 30 46 pwa1 62 15 31 47 63 The table above has many empty entries. These shoul d not be enabled as they will interfere with the GPU operation. ARM peripherals interrupts table. 0 ARM Timer 1 ARM Mailbox 2 ARM Doorbell 0 3 ARM Doorbell 1 4 GPU0 halted (Or GPU1 halted if bit 10 of control r egister 1 is set) 5 GPU1 halted 6 Illegal access type 1 7 Illegal access type 0 Basic pending register. The basic pending register shows which interrupt ar e pending. To speed up interrupts processing, a number of 'normal' interrupt status bits have been added register. This makes the 'IRQ 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 114 \u00a9 2012 IRQ 57 18 R GPU IRQ 56 17 R GPU IRQ 55 16 R GPU IRQ 54 15 R GPU IRQ 53 14 R GPU IRQ 19 13 R GPU IRQ 18 12 R GPU IRQ 10 11 R GPU IRQ 9 10 R GPU IRQ 7 9 R One or more bits set in pending register 2 8 R One or more bits set in pending register 1 7 R Illegal access type 0 IRQ pending 6 R Illegal if bit 10 of control register 1 is set) 3 R ARM Doorbell 1 IRQ pending 2 R ARM Doorbell 0 IRQ pending 1 Mailbox Timer IRQ pending GPU IRQ x (10,11..20) These bits are direct interrupts from the GPU. They have been selected as interrupts which are most likely to be useful to the ARM. The GPU interrupt s elected are 7, 9, 10, 18, 19, 53,54,55,56,57,62. Fo r details see the GPU interrupts table . Bits set in pending registers (8,9) These bits indicates if there are bits set in the p ending 1/2 registers. The pending 1/2 registers hol d ALL interrupts 0..63 from the GPU side. Some of the se 64 interrupts are also connected to the basic pending register. Any bit set in pending register 1 /2 is NOT connected to the basic pending register causes bit 8 or 9 to set. Status bits 8 an d 9 should be seen as \"There are some interrupts pending which you don't know about. They are ding register 1 /2.\" Illegal access type-0 IRQ (7) This bit indicate that the address/access error lin e from the ARM processor has generated an interrupt. That signal is asserted when either an a ddress bit 31 or 30 was high or when an access was 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 115 \u00a9 2012 Broadcom Corporation. All rights reserved seen on the ARM Peripheral bus. The status of that signal can be read from Error/HALT status register bit 2. Illegal access type-1 IRQ (6) This bit indicates that an address/access error is seen in the ARM control has generated an interrupt. That can either be an address bit 29..26 was high o r when a burst access was seen on the GPU Peripheral bus. The status of that signal can be re ad from Error/HALT status register bits 0 and 1. GPU-1 halted IRQ (5) This bit indicate that the GPU-1 halted status bit has generated an interrupt. The status of that sign al can be read from Error/HALT status register bits 4. GPU-0 (or any GPU) halted IRQ (4) This bit indicate that the GPU-0 halted status bit has generated an interrupt. The status of that sign al can be read from Error/HALT status register bits 3. In order to allow a fast interrupt (FIQ) routine to cope with GPU 0 OR GPU-1 there is a bit in control register 1 which, if set will also route a GPU-1 ha lted status on this bit. peripheral IRQs (0,1,2,3) These bits indicate if an interrupt is pending for one of the control side. Some of these interrupts are also connected to the basic pending register. Any interr upt status bit in here which is NOT connected to the basic pending will also cause bit 8 of the basi c pending register to be set. That is all bits exce pt 7, 9, 10, 18, 19. GPU side. Some of these interrupts are also connected to the basic pending register. Any interr upt status bit in here which is NOT connected to the basic pending will also cause bit 9 of the basi c pending register to be set. That is all can generate a FIQ to the ARM. Only a single interrupt can be selected. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 116 \u00a9 bit to 1 to enable FIQ generat ion. If set to 6:0 64 ARM Timer 65 ARM Mailbox interrupt ARM Doorbell 71 Illegal access type -0 interrupt 72 table above) Writing a to a bit will set the corresponding IRQ enable bit. All other IRQ enable bits are unaffected. Only bits which are enabled can be seen in the interrupt pending registers. There is no provision here to see if there are interrupts which are pending but not enabled. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 117 \u00a9 2012 above ) Writing to a bit will set the corresponding IRQ enable bit. All other IRQ enable bits are unaffected. Only bits which are enabled can be seen in the interrupt pending registers. There is no provision here to see if there are interrupts which are type -0 IRQ 6 R/Wbs Set to enable Access error type -1 IRQ 5 R/Wbs Set to enable GPU 1 Halted to to to Doorbell IRQ R/Wbs Set to enable 0 R/Wbs Set to enable ARM Timer IRQ Writing a 1 to a bit will set the corresponding IRQ enable bit. All other IRQ enable bits are unaffected. Again only bits which are enabled can b e seen in the basic pending register. There is no provision here to see if there are interrupts which are ) bit will clear the corresponding I RQ enable unaffected. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 118 \u00a9 2012 table abov e) Writing a 1 to a bit will clear the corresponding I RQ enable bit. error type -0 IRQ 6 R/Wbc Set to disable Access error type -1 IRQ 5 R/Wbc Set to disable GPU 1 Halted to to to Doorbell IRQ R/Wbc Set to disable 0 R/Wbc Set to disable ARM Timer IRQ Writing a 1 to a bit will clear the corresponding I RQ enable unaffected. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 119 \u00a9 2012 Broadcom Corporation. All rights reserved 8 PCM / I2S Audio The PCM audio interface is an APB peripheral providin g input and output of telephony serial audio It supports many classi c PCM formats including I2S. The PCM audio interface has 4 interface signals; PCM_CLK - bit clock. PCM_FS - frame sync signal. PCM_DIN - serial data input. PCM_DOUT - serial data output. PCM is a serial format with a single bit data_in and si ngle bit data_out. Data is always serialised MS-bit first. The frame sync signal (PCM_FS) is used to delimit the ser ial data into individual frames. The length of the frame and the size and position of the fr ame sync are fully programmable. Frames can contain 1 or 2 audio/data channels in each dir ection. Each channel can be between 8 and 32 bits wide and can be positioned anywhere wit hin the frame as long as the two channels don't overlap. The channel format and receive directions. PCM_CLK PCM_FS CH1POS CH1WID CH2WID CH2POS FSLEN 2 CH1POS CH1WID CH2WID CH2POS Figure 8-1 PCM_CLK can be asynchronous to the bus clock a nd can be logically inverted if required. The signals can be individually selected, allowing the interface to act as a master or slave device. The input interface is also capable of supporting up to 2 PDM microphones, as an alternative to the classic PCM input format, in conjunction with a P CM output. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 120 \u00a9 2012 Broadcom Corporation. All rights reserved 8.1 Block Diagram Figure 8-2 PCM Audio Interface Block Diagram The PCM audio interface contains separate transmit an d receive FIFOs. Note that if the frame contains two data channels, they must share the same F IFO and so the channel data will be interleaved. The block can be driven using simple polling, an interrupt based method or typical PCM_CLK and input signals are sampled on its falling edge. The frame sync is considered as a data signal and sampled in the same way. The front end of the PCM audio interface is run off th e PCM_CLK and the PCM signals are timed against this clock. the polarity of the PCM_CLK can be physically in which case the edges are reversed. In clock master mode (CLKM=0), the PCM_CLK is an a is driven the clock input. mode (CLKM=1), clock source. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 121 \u00a9 2012 Broadcom Corporation. All rights reserved In frame sync master mode (FSM=0), the PCM_FS is inter nally generated and is treated as a data output that changes on the positive edge of the cloc k. The length and polarity of the frame sync is fully programmable and it can be used as a s tandard frame sync signal, or as an L-R signal for I2S. In frame sync slave mode (FSM=1), the PCM_FS is treated as a data input and is sampled on the negative edge of PCM_CLK. The first clock of a fra me is taken as the first clock period where PCM_FS is sampled as a 1 following a period or periods where it was previously a 0. The PCM audio interface locks onto the incoming frame sync and uses this to indicate where the data channels are positioned. The precise timing at t he start of frame is shown in Figure 8-3. Note that in frame sync slave mode there are two synchro nising methods. The legacy method is used when the length = 0. In this case the inte rnal frame logic has to detect the incoming PCM_FS signal and reset the internal frame coun ter at the start of every frame. The logic relies on the PCM_FS to indicate the length of the frame and so can cope with adjacent frames of different lengths. However, this cr eates a short timing path corrupt the one specific frame/channel sett ing. The preferred method to set length to the length. Here the incoming PCM_FS is used to resynchronise the internal frame count er and this eliminates the short timing path. 8.3 Operation The PCM interface runs asynchronously at the PCM_CLK rat e and and receive data across to the internal APB c lock domain. The control registers are NOT synchronised and should be programmed before the device is enabled and should NOT be changed whilst the interface is running. Only the EN, RXON and TXON bits of the PCMCS register are synchronised across the PCM - APB clock domain and are allowed to be changed whils t the interface is running. The EN bit is a global power-saving enable. The TXON and RX ON bits enable transmit receive, and the interface is running whenever either TXON or RXON is enabled. In operation, the PCM format is programmed by setting the appropriate frame length, frame sync, channel position values, and signal polarity controls . The transmit FIFO should be preloaded with data and the interface can then be enabled and started, and will run continuously until stopped. transmit FIFO become s empty the receive FIFO becomes full, the RXERR or TXERR error flags will be set, but the interface will just continue. If the RX FIFO overflows, new samples are discarded and if the TX FIFO underflows, zeros are transmitted. Normally channel data is read or written into the appropri ate FIFO as a single word. If the channel is less than 32 bits, the data is right justified and should be padded with zeros. If the RXSEX bit is set then the received data is sign extended up to the full 32 bits. When a frame is programmed to have two data channels, then each channel is written/read as a separate word in the FIFO, producing an interleaved data stream. Wh en initialising the interface, the first word read out of the TX FIFO will be used for the first channel, and the data from the first channel on the first frame to be received will b e the first word written into the RX FIFO. If a FIFO error occurs in a two channel frame, then c hannel synchronisation may be lost which may result in a left right audio channel swap. RX SYNC and TXSYNC status bits are 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 122 \u00a9 2012 Broadcom Corporation. All rights reserved provided to help determine if channel slip has occurred. They i ndicate if the number of words in the FIFO is a multiple of a full frame (taking in to account where we are in the current frame being transferred). This assumes that an integer n umber of frames data has been sent/read from the FIFOs. If a frame is programmed to have two data channels and the packed mode bits are set (FRXP FTXP) then the FIFOs are configured so that each word co ntains the data for both channels (2x 16 bit samples). In this mode each word written to the TX FIFO contains 2 16 bit samples, and the Least Significant sample is transmit ted first. Each word read from the RX FIFO will contain the data received from 2 channels, the f irst channel received will be in the Least Significant half of the word. If the channels si ze is less than 16 bits, the TX data will be truncated and RX data will be padded to 16 bits with zeros. Note that data is always serialised MS-bit first. This i s well-established behaviour in both PCM and I2S. If the PDM input mode is enabled then channel 1 is sampled on the negative edge of PCM_CLK whilst channel 2 is sampled on Figure 8-3 Timing at Start of Frame Note that the precise timing of FS (when it is an input) i s not clearly defined and it may change state before or after the positive edge of the clock. Here the first clock of the frame is defined as the clock period where the PCM_FS is sampled (n egative edge) as a 1 where it was previously sampled as a 0. 8.4 Software Operation 8.4.1 Operating in Polled mode Set the EN bit to enable the PCM block. Set all operatio nal values to define the frame and channel settings. Assert RXCLR and/or TXCLR wait ensure the FIFOs are reset. The SYNC bit can be used to determine w hen 2 clocks have passed. Set RXTHR/TXTHR to determine the FIFO thresholds. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 123 \u00a9 2012 Broadcom words is started. Set TXON data is transferred. 8.4.2 Operating in Interrupt mode a) Set the EN bit to enable the PCM block. Set all operatio nal values to define the frame and channel settings. Assert RXCLR and/or TXCLR wait fo to ensure the FIFOs are reset. The SYNC bit can be used to determ ine when 2 clocks have passed. Set RXTHR/TXTHR to determine the is started. Set TXON and/or operation. d) When an interrupt occurs, check RXR. If this is set then one more sample words are available in PCMFIFO. If TXW is set then one or mo re sample words can be sent to PCMFIFO. 8.4.3 DMA a) Set the EN bit to enable the PCM block. Set all operatio nal values to define the frame and channel settings. Assert RXCLR and/or TXCLR wait fo to ensure the FIFOs are reset. The SYNC bit can be used to determ ine when 2 clocks have passed. b) Set DMAEN to enable DMA DREQ and set RXREQ/TXREQ to ermine FIFO for the DREQs. If required, set TXPANIC and RXPANIC to determine the level at which the DMA should increase it s AXI priority, c) In the DMA set the correct DREQ channels , one for RX and one for TX. Start the DMA which should fill the TX FIFO. d) Set TXON and/or RXON to begin operation. 8.5 Error Handling. In all software operational modes, the possibility of FIFO over or under run exists. Should this happen when using 2 channels per frame, there is a risk of losing sync with the channel data stored in the FIFO. If this happens and is not detected a nd corrected, then caused by a FIFO over or under-run and this will set the appropriate latching error bit in the control/status register. Writing a '1' back to this error bit will clear the latched flag. In a system using a polled operation, the error bit s can be checked manually. For an interrupt or DMA based system, setting the INTE bit will cause t he PCM interface to generate an interrupt when an error is detected. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 124 \u00a9 2012 Broadcom Corporation. All rights reserved If a FIFO error occurs during operation in which 2 data channels are being used then the synchronisation of the data may be lost. This can b e recovered by either of these two methods: (RXCLR and TXCLR =1). Note that it may take up to 2 PCM clocks for t he FIFOs to be physically cleared after initiating a clear. Then preload the FIFO and restart transmission. This of course loses the data in the FIF O and further interrupts the data flow to the external device. b) the TXSYNC and RXSYNC flags. These flags in dicate if the amount of data in the FIFO is a whole number of frames, automatically taking i nto account where we are in the current frame being transmitted or received. Thus, providi ng an even number of samples was read or written to the FIFOs, then if the flags are set then this indicates that a single word needs to be written or read to adjust the data. Normal ex change of data can then proceed (where the first word in a data pair is for channel 1). Th is method should cause less disruption to the 8.6 Input Mode Operation The PDM input mode is capable of interfacing with two digita l half-cycle PDM implements CIC a decimati on factor. The clock input of the microphones is shared with the PCM output codec and be As result may be necessary to add a number of padding bits into the PCM output and configure the output codec to allow for this. When using the PDM input mode the bit width and the rate of t he data received will depend on the decimation factor used. Once the data has been r ead from the peripheral a further decimation and filtering stage will be required and can mplemented The software filter should 16 bits unsigned 4 48kHz 1 (N=32) 3.072 20 bits unsigned 2 48kHz Table 8-1 PDM Input Mode Configuration 8.7 GRAY Code Input Mode Operation GRAY mode is used for an incoming data stream only. GRAY mo de is selected by setting the enable bit (EN) in the PCM_GRAY register. In this mode data is received on the PCM_DIN (data) and the PCM_FS (strobe) pins. The data is expected to be in data/strobe format. In this m ode data is detected when either the data or the strobe change state. As each bit is receiv ed it is written into the RX buffer and when 32 bits are received they are written out to the RX FIFO as a 32 bit word. In order for this mode to work the user must program a PCM clock rate whi ch is 4 times faster then the rate. Also the 06 February 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 125 \u00a9 2012 Broadcom Corporation. All rights The normal RXREQ and RXTHR FIFO levels will apply as for normal PCM received data. If a message is received that is not a multiple of 32 bit s, any data in the RX Buffer can be flushed out by setting the flush bit (FLUSH). Once set, t his bit will read back as zero until the flush operation has completed. This may take several cycl es as the APB clock may be many times faster than the PCM clock. Once the flush has occurred, the bits are packed up to 32 bits with zeros and written out to the RXFIFO. The fl ushed field (FLUSHED) will indicate how many of bits of this word are valid. Note that to get an accurate indication of the number of bits currently in the rx shift register (RXLEVEL) APB PCM_CL K. Figure 8-4 Gray mode input format 8.8 PCM Register Map There is only PCM module in the BCM2835. The PCM base address for is Register Name CS_A PCM Control and Status 32 0x4 FIFO_A PCM FIFO Data 32 0x8 MODE_A Level 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 126 \u00a9 2012 & Clear GRAY Mode Control 32 CS_A Register Synopsis This register contains the main control and status bi ts for the PCM. The bottom 3 bits of this register can be written to whilst the PCM is running. The remaining bits cannot. Bit(s) Field Name Description Type Reset 31:26 Reserved - Write as 0, read as don't care 25 STBY RAM Standby This bit is used to control the PCM Rams standby mode. By default this bit is 0 causing RAMs to start initially in standby mode. Rams should be released from standby prior to any transmit/receive operation. Allow for at least 4 PCM clock cycles to take effect. This may or may not be implemented, depending upon the RAM libraries being used. RW 0x0 24 SYNC PCM Clock sync This bit provides a software synchronisation mechanism to allow the software to detect when 2 PCM clocks have occurred. It takes 2 PCM clocks before the value written to this bit will be echoed back in read value. RW 0x0 23 RXSEX RX Sign extension. 1 Sign extend the RX data. When set, the MSB of the received data channel (as set by the CHxWID parameter) is repeated in all the higher data bits up to the full 32 bit data width. RW 0x0 22 RXF RX FIFO is Full 0 = RX FIFO can accept more data. 1 = RX FIFO is full and will overflow if more data is received. RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 127 \u00a9 2012 Broadcom Corporation. All rights reserved 21 TXE TX FIFO is Empty 0 = TX FIFO is not empty. 1 = TX FIFO is empty and underflow will take place if no more data is written. RO 0x1 20 RXD Indicates that the RX FIFO contains data 0 = RX FIFO is empty. 1 = RX FIFO contains at least 1 sample. RO 0x0 19 TXD Indicates that the TX FIFO can accept data 0 = TX FIFO is full and so cannot accept more data. 1 = TX FIFO has space for at least 1 sample. RO 0x1 18 RXR Indicates that the = FIFO is less than RXTHR full. 1 = RX FIFO is RXTHR or more full. This is cleared by reading sufficient data from the RX FIFO. RO 0x0 17 TXW Indicates that the TX FIFO needs Writing 0 = TX FIFO is at least TXTHR full. 1 = TX FIFO is less then TXTHR full. This is cleared by writing sufficient data to the TX FIFO. RO 0x1 16 RXERR RX FIFO Error 0 = FIFO has had no errors. 1 = FIFO has had an under or overflow error. This flag is cleared by writing a 1. RW 0x0 15 TXERR TX FIFO Error 0 = FIFO has had no errors. 1 = FIFO has had an under or overflow error. This flag is cleared by writing a 1. RW 0x0 14 RXSYNC RX FIFO Sync 0 = FIFO is out of sync. The amount of data left in the FIFO is not a multiple of that required for a frame. This takes into account if we are halfway through the frame. 1 = FIFO is in sync. RO 0x0 13 TXSYNC TX FIFO Sync 0 = FIFO is out of sync. The amount of data left in the FIFO is not a multiple of that required for a frame. This takes into account if we are halfway through the frame. 1 = FIFO is in sync. RO 0x0 12:10 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 128 \u00a9 2012 Broadcom Corporation. All rights reserved 9 DMAEN DMA Enable 0 = Don t generate DMA requests. 1 = Generates a TX DMA DREQ requests whenever the TX FIFO level is lower than TXREQ or generates a RX DMA threshold at which point the RXR flag is set 00 = set when we have a single sample in the RX FIFO 01 = set when the RX FIFO is at least full 10 = set when the RX FIFO is at least 11 = set when the RX FIFO is full RW 0x0 6:5 TXTHR Sets the TX FIFO threshold at which point the TXW flag is set 00 = set when the TX FIFO is empty 01 = set when the TX FIFO is less than full 10 = set when the TX FIFO is less than full 11 = set when the TX FIFO is full but for one sample RW 0x0 4 clear RX FIFO. This bit is self clearing and is always read as clear Note that it will take 2 PCM clocks for the FIFO to be physically cleared. WO 0x0 3 TXCLR Clear the TX FIFO Assert to clear TX FIFO. This bit is self clearing and is always read as clear. Note that it will take 2 PCM clocks for the FIFO to be physically cleared. WO 0x0 2 TXON Enable transmission 0 = Stop transmission. This will stop immediately if possible or else at the end of the next frame. The TX FIFO can still be written to to preload data. 1 = Start transmission. This will start transmittin g at the start of the next frame. Once enabled, the first data read from the TX FIFO will be placed in the first channel of the frame, thus ensuring proper channel synchronisation. The frame counter will be started whenever TXON or RXON are set. This bit can be written whilst the interface is running. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 129 \u00a9 2012 Broadcom Corporation. RXON Enable reception. 0 = Disable reception. This will stop on the next available frame end. RX FIFO data can still be read. 1 = Enable reception. This will be start receiving at the start of the next frame. The first channel to be received will be the first word written to the RX FIFO. This bit can be written whilst the interface is running. RW 0x0 0 EN Enable the PCM Audio Interface 0 = The PCM interface is disabled and most logic is gated off to save power. 1 = The PCM Interface is enabled. This bit can be written whilst the interface is running. RW 0x0 FIFO_A Register Synopsis This is the FIFO port of the PCM. Data written here is transmitted, and received data is read from here. Bit(s) Field Name Description Type Reset 31:0 Reserved - Write as 0, Register Synopsis This register defines It is used to configure the frame size and format and whether the PCM is in master or slave modes for its frame sync or clock. This register cannot be changed whilst the PCM i running. Bit(s) Field Name Description Type Reset 31:29 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 130 \u00a9 2012 Broadcom Corporation. All 28 CLK_DIS PCM = clock. PCM clock can be disabled, and then the clock source switched, and then the clock re- enabled. 0 = Enable the PCM clock. RW 0x0 27 PDMN PDM Decimation Factor (N) 0 = Decimation factor 16. 1 = Decimation factor 32. Sets the decimation factor of the CIC decimation filter. RW 0x0 26 PDME PDM Input Mode Enable = Disable PDM PDM input filter. Enable CIC filter on input pin for PDM inputs. In order to receive data RXON must also be set. RW 0x0 25 FRXP Receive Frame Packed Mode 0 = The data from each channel is written into the RX FIFO. 1 = The data from both RX channels is merged (1st channel is in the LS half) and then written to the RX FIFO as a single 2x16 bit packed mode word. First received channel in the frame goes into the LS half word. If the received data is larger than 16 bits, the upper bits are truncated. The maximum channel size is 16 bits. RW 0x0 24 FTXP Transmit Frame Packed Mode 0 = Each TX FIFO word is written into a single channel. 1 = Each TX FIFO word is split into 2 16 bit words and used to fill both data channels in the same frame. The maximum channel size is 16 bits. The LS half of the word is used in the first channel of the frame. RW 0x0 23 CLKM PCM Clock Mode 0 = Master mode. The PCM CLK is an output and drives at the MCLK rate. 1 = Slave mode. The PCM CLK is an input. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 131 \u00a9 2012 Broadcom this logically inverts the PCM_CLK signal. 0 = Outputs change on rising edge of clock, inputs are sampled on falling edge. 1 = Outputs change on falling edge of clock, inputs are sampled on rising edge. RW 0x0 21 FSM Frame Sync Mode 0 = Master mode. The PCM_FS is an output and we generate the frame sync. 1 = Slave mode. The PCM_FS is an input and we lock onto the incoming frame sync signal. RW 0x0 20 FSI Frame Sync Invert This logically inverts the frame sync signal. 0 = In master mode, FS is normally low and goes high to indicate frame sync. In slave mode, the frame starts with the clock where FS is a 1 after being a 0. 1 = In master mode, FS is normally high and goes low to indicate frame sync. In slave mode, the frame starts with the clock where FS is a 0 after being a 1. RW 0x0 19:10 FLEN Frame Length Sets the frame length to (FLEN+1) clocks. Used only when FSM == 0. 1 = frame length of 2 clocks. 2 = frame length of 3 clocks. etc RW 0x0 9:0 FSLEN Frame Length Sets the frame sync length to (FSLEN) clocks. This is only used when FSM will remain permanently active if FSLEN >= FLEN. 0 = frame sync pulse is off. 1 = frame sync pulse is 1 clock wide. etc RW 0x0 RXC_A Register Synopsis Sets the Channel configurations for Receiving. This s ets the position and width of the 2 receive channels within the frame. The two channels can not overlap, however they channel 1 can come after channel zero, although the firs t data will always be from the first channel in the frame. Channels can also straddl e the frame begin end boundary as that is set by the frame sync position. This regist er cannot be changed whilst the PCM is running. Field Name Description Type Reset 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 132 \u00a9 2012 Broadcom Corporation. All rights reserved 31 CH1WEX Channel 1 Width Extension Bit This is the MSB of the channel 1 width (CH1WID). It allows widths greater than 24 bits to be programmed and is added here to keep backwards compatibility with older versions of the PCM RW 0x0 30 CH1EN Channel 1 Enable 0 = Channel 1 disabled and no data is received from channel 1 and written to the RX FIFO. 1 = Channel 1 enabled. RW 0x0 29:20 CH1POS Channel 1 Position This sets the bit clock at which the first bit (MS bit) of channel 1 data occurs in the frame. 0 indicates the first clock of frame. RW 0x0 19:16 CH1WID Channel 1 Width This sets the width of channel 1 in bit clocks. This field has been extended with the CH1WEX bit giving a total width of (CH1WEX* 16) + CH1WID + 8. The Maximum supported width is 32 bits. 0 = 8 bits wide 1 = 9 bits wide RW 0x0 15 CH2WEX Channel 2 Width Extension Bit This is the MSB of the channel 2 width (CH2WID). It allows widths greater than 24 bits to be programmed and is added here to keep backwards compatibility with older versions of the PCM RW 0x0 14 CH2EN Channel 2 Enable 0 = Channel 2 disabled and no data is received from channel 2 and written to the RX FIFO. 1 = Channel 2 enabled. RW 0x0 13:4 CH2POS Channel 2 Position This sets the bit clock at which the first bit (MS bit) of channel 2 data occurs in the frame. 0 indicates the first clock of frame. RW 0x0 3:0 CH2WID Channel 2 Width This sets the width of channel 2 in bit clocks. This field has been extended with the CH2WEX bit giving a total width of (CH2WEX* 16) + CH2WID + 8. The Maximum supported width is 32 bits. 0 = 8 bits wide 1 = 9 bits wide RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 133 \u00a9 2012 Broadcom Corporation. the Channel configurations for Transmitting. Th is sets the position and width of the 2 transmit channels within the frame. The two cha nnels cannot overlap, however they channel 1 can come after channel zero, although the first data will always be used in the first channel in the frame. Channels can also straddle the frame begin end boundary as that is set by the frame sync position. Thi s register cannot be changed whilst the PCM is running. Bit(s) Field Name Description Type Reset 31 CH1WEX Channel 1 Width Extension Bit This is the MSB of the channel 1 width (CH1WID). It allows widths greater than 24 bits to be programmed and is added here to keep backwards compatibility with older versions of the PCM RW 0x0 30 CH1EN Channel 1 Enable 0 = Channel 1 disabled and no data is taken from the TX FIFO and transmitted on channel 1. 1 = Channel 1 enabled. RW 0x0 29:20 CH1POS Channel 1 Position This sets the bit clock at which the first bit (MS bit) of channel 1 data occurs in the frame. 0 indicates the first clock of frame. RW 0x0 19:16 CH1WID Channel 1 Width This sets the width of channel 1 in bit clocks. This field has been extended with the CH1WEX bit giving a total width of (CH1WEX* 16) + CH1WID + 8. The Maximum supported width is 32 bits. 0 = 8 bits wide 1 = 9 bits wide RW 0x0 15 CH2WEX Channel 2 Width Extension Bit This is the MSB of the channel 2 width (CH2WID). It allows widths greater than 24 bits to be programmed and is added here to keep backwards compatibility with older versions of the PCM RW 0x0 14 CH2EN Channel 2 Enable 0 = Channel 2 disabled and no data is taken from the TX FIFO and transmitted on channel 2. 1 = Channel 2 enabled. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 134 \u00a9 2012 Broadcom Corporation. All rights reserved 13:4 CH2POS Channel 2 Position This sets the bit clock at which the first bit (MS bit) of channel 2 data occurs in the frame. 0 indicates the first clock of frame. RW 0x0 3:0 CH2WID Channel 2 Width This sets the width of channel 2 in bit clocks. This field has been extended with the CH2WEX bit giving a total width of (CH2WEX* 16) + CH2WID + 8. The Maximum supported width is 32 bits. 0 = 8 bits wide 1 = 9 bits wide RW 0x0 DREQ_A Register Synopsis Set the DMA DREQ and Panic thresholds. The PCM drive s 2 DMA controls back to the DMA, one for the TX channel and one for the RX channe l. DMA DREQ is used to request the DMA to perform another transfer, and DM A Panic is used to tell the DMA to use its panic level of priority when requesting t hins on the AXI bus. This register cannot be changed whilst the PCM is running. Bit(s) Field Name Description Type Reset 31 Reserved - Write as 0, read as don't care 30:24 TX_PANIC TX Panic Level This sets the TX FIFO Panic level. When the level is below this the PCM will assert its TX DMA Panic signal. RW 0x10 23 Reserved - Write as 0, read as don't care 22:16 RX_PANIC RX Panic Level This sets the RX FIFO Panic level. When the level is above this the PCM will assert its RX DMA Panic signal. RW 0x30 15 Reserved - Write as 0, read as don't care 14:8 TX TX Request Level This sets the TX FIFO DREQ level. When the level is below this the PCM will assert its DMA DREQ signal to request more data is written to the TX FIFO. RW 0x30 7 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 135 \u00a9 2012 Broadcom Corporation. All rights 6:0 RX RX Request Level This sets the RX FIFO DREQ level. When the level is above this the PCM will assert its DMA DREQ signal to request that some more data is read out of the RX FIFO. RW 0x20 cannot be changed whilst the PCM running. Bit(s) Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't RXERR RX Error Interrupt Setting this bit when RX FIFO error occurs. RW 0x0 2 TXERR TX Error Interrupt Setting this bit enables interrupts from PCM block when TX FIFO error 0x0 1 enables interrupts PCM block when RX FIFO level is greater than or equal to the specified RXTHR Setting this bit enables interrupts from PCM block TX FIFO level is the and clear the PCM inte rrupt status. Writing a 1 to the asserted bit clears the bit. Writing a 0 has no effe ct. Bit(s) Field Name Description Type Reset 31:4 Reserved Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 136 \u00a9 2012 Broadcom Corporation. All 3 RXERR RX indicates an interrupt occurred on RX FIFO Error. Writing 1 to this bit clears it. Writing 0 has no effect. RW 0x0 2 TXERR TX Error Interrupt Status / Clear This bit indicates an interrupt occurred on TX FIFO Error. Writing 1 to this bit clears it. Writing 0 has no effect. RW 0x0 1 RXR RX Read bit indicates an interrupt occurred on RX Read. Writing 1 to this bit clears it. Writing 0 has no effect. RW 0x0 0 TXW TX Write Interrupt Status / Clear This bit indicates an interrupt occurred on TX Write. Writing 1 to this bit clears it. Writing 0 has no effect. RW 0x0 GRAY Register Synopsis This register is used to control the gray mode gener ation. This is used to put the PCM into a special data/strobe mode. This mode is under 'best effort ' contract. Bit(s) Field Name Description Type Reset 31:22 Reserved - Write as 0, read as don't care 21:16 RXFIFOLEVEL The Current level of the RXFIFO This indicates how many words are currently in the RXFIFO. RO 0x0 15:10 FLUSHED The Number of bits that were flushed into the RXFIFO This indicates how many bits were valid when the flush operation was performed. The valid bits are from bit 0 upwards. Non-valid bits are set to zero. RO 0x0 9:4 RXLEVEL The Current fill level of the RX Buffer This indicates how many GRAY coded bits have been received. When 32 bits are received, they are written out into the RXFIFO. RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 137 \u00a9 2012 Broadcom Corporation. All rights reserved 3 Reserved - Write as 0, read as don't care 2 FLUSH Flush the RX Buffer into the RX FIFO This forces the RX Buffer to do an early write. This is necessary if we have reached the end of the message and we have bits left in the RX Buffer. Flushing will write these bits as a single 32 bit word, starting at bit zero. Empty bits will be packed with zeros. The number of bits written will be recorded in the FLUSHED Field. This bit is written as a 1 to initiate a flush. It will read back as a zero until the flush operation has completed (as the PCM Clock may be very slow). RW 0x0 1 CLR Clear the GRAY Mode Logic This Bit will reset all the GRAY mode logic, and flush the RX buffer. It is not self clearing. RW 0x0 0 EN Enable GRAY Mode Setting this bit will put the PCM into GRAY mode. In gray mode the data is received on the data in and the frame sync pins. The data is expected to be in data/strobe format. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 138 \u00a9 2012 Broadcom Corporation. All either serialised of a 32-bit PWM outputs have variable input and output resolutions. Serialise mode configured to load data to and/or read data fro m a FIFO storage block, which can store up to eight 32-bit words. Both modes clocked by clk_pwm which is nominally 100MHz, but can be by clock manager. 9.2 Block Diagram 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 139 \u00a9 2012 Broadcom 9.3 PWM Implementation A value as a ratio of N/M can be transm itted along a serial channel with pulse width modulation in which the value is represented by the duty cycle of the output signal. To send value periodic sequence M cycles, output should be 1 for N cycles and The desired sequence should 1's and as even as possible so that during any arbitrary period of time duty cycle achieves closes t approximation of the value. the following table where 4/8 is modulated (N= 4, M = 8). Bad 0 0 0 0 1 1 1 1 0 0 0 0 Fair 0 0 1 1 0 0 1 1 0 0 1 1 Good 0 1 0 1 0 1 0 1 0 1 0 1 Sequence which gives the 'good' approximation from the table following algorithm: where context is a register which stores the result of the addition/subtractions. 9.4 Modes of Operation PWM controller consists of two pwm or MSEN =0 and MSEN=1. When MSEN=0, which is the default mode, data to be sent is interpreted as the value the algorithm. Pulses are sent within this range so tha t the resulting duty cycle is N/M. Channel sends it s output continuously as long as data register is use d, or buffer is used and it is not empty. 1. Set context = 0 2. context = context + N 3. if (context >= M) = - M send 1 else 06 February 2012 Broadcom Europe Ltd. 406 Science P ark Milton Road Cambridge CB4 0WW Page 140 \u00a9 2012 Broadcom Corporation. All rights reserved When MSEN=1, PWM block does not use the algorithm e xplained above, instead it sends serial data with the M/S ratio as in the picture below. M is th e data to be sent, and S is the range. This mode may be preferred if high frequency modulation is no t required or has negative effects. Channel sends its output continuously as long as data regis ter is used, or buffer is used and it is not empty. Serial bit transmission when M/S Mode enabled a serialiser. In this mode data written in buffer or the data register is sent serially. 9.5 Quick Reference PWM DMA is 5. GPIOs are assigned to PWM GPIO 12 Alt 0 - GPIO 13 - Alt Fun 0 GPIO 18 Alt Fun 5 - GPIO 19 - Alt Fun 5 GPIO 40 Alt Fun 0 - GPIO 41 - Alt Fun 0 GPIO 45 - Alt Fun 0 GPIO 52 Alt Fun 1 - GPIO 53 - Alt Fun 1 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 141 \u00a9 2012 Broadcom Corporation. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 142 \u00a9 2012 Broadcom this bit to 1 enables the channel and transmitter state machine. Al l registers and FIFO is writable without setting this bit. MODEi bit is used to determine mode of operation. S etting this bit to 0 enables PWM mode. In this mode data stored in either PWM_DATi o r FIFO is transmitted by pulse width modulation within the range defined by i. When this mode, in which data stored in either PWM_DATi or FIF O is transmitted serially the range defined by PWM_RNGi. to enable/disable repeating of the la st data available in the FIFO just before it empties. When this bit is 1 and FIFO is u sed, the last available data in the FIFO is repeatedly sent. This may be useful in PWM m ode to avoid duty cycle gaps. If the FIFO is not used this bit does not have any effe ct. Default operation is do-not- repeat. SBITi defines the state of the output when no trans mission takes place. It also defines the zero polarity for the zero padding in serialiser m ode. This bit is padded between two consecutive transfers as well as tail data when is larger than bit depth of data being transferred. this bit is zero by default. POLAi is used to configure the polarity of the outpu t bit. When set to high the final output is inverted. Default operation is no inversi on. USEFi bit is used to enable/disable FIFO transfer. When this bit is high data stored in the FIFO is used for transmission. When it is low, data written to PWM_DATi is transferred. This bit is 0 as default. CLRF is used to clear the FIFO. Writing a 1 to this bit clears the FIFO. Writing 0 has no effect. This is a single shot operation and reading the bit always returns 0. MSENi is used to determine whether to use PWM algor ithm or simple M/S ratio transmission. When this bit is high M/S transmissio n is used. This bit is zero as default. When MODEi is 1, this configuration bit has no effec t. Bit(s) Field Name Description Type Reset 31:16 Reserved - Write as 0, read as don't 15 MSEN2 Channel 2 M/S Enable RW 0x0 14 Reserved - Write as 0, read as don't care 13 USEF2 Channel 1 Use Fifo 0: Data register is transmitted 1: Fifo is used for transmission RW SBIT2 Silence Bit Defines the state of the output when no transmission takes place RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 143 \u00a9 2012 Broadcom Corporation. All rights reserved 10 RPTL2 Channel 1 Repeat Last Data 0: Transmission interrupts when FIFO is empty 1: Last data in FIFO is transmitted repetedly until FIFO is not empty RW Mode 1: Channel 1: Clears Has no effect This is a single shot operation. This bit always reads 0 RO 0x0 5 USEF1 Channel 1 Use Fifo 0: Data register is transmitted 1: Fifo is used for transmission RW SBIT1 Silence Bit Defines the state of the output when no transmission takes place RW 0x0 2 RPTL1 Channel 1 Repeat Last Data 0: Transmission interrupts when FIFO is empty 1: Last data in FIFO is transmitted repetedly until FIFO is not empty RW Mode 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 144 \u00a9 2012 Broadcom STA Register Synopsis FULL1 bit indicates the full status of the FIFO. If this bit is high FIFO is full. EMPT1 bit indicates the empty status of the FIFO. If this bit is high FIFO is empty. WERR1 bit sets to high when a write when full error occurs. Software must clear this bit by writing 1. Writing 0 to this bit has no effe ct. RERR1 bit sets to high when a read when empty error occurs. Software must clear this bit by writing 1. Writing 0 to this bit has no effe ct. GAPOi. bit indicates that there has been a gap betwe en transmission of two consecutive data from FIFO. This may happen when FIFO gets empty after state machine has sent a word and waits for the next. If co ntrol bit RPTLi is set to high this event will not occur. Software must clear this bit by writing 1. Writing 0 to this bit has no effect. BERR sets to high when an error has occurred while wr iting to registers via APB. This may happen if the bus tries to write successively to s ame set of registers faster than the synchroniser block can cope with. Multiple m ay occur and contaminate the data during synchronisation. Software should clear this bit by writing 1. Writing 0 to this bit has no effect. STAi bit indicates the current state of the channel wh ich is useful for debugging purposes. 0 1 means channel is Name Description Type Reset 31:13 Reserved - Write as 0, read as don't care 12 STA4 Channel 4 State RW 0x0 11 STA3 Channel 3 State RW 0x0 10 STA2 Channel 2 State RW 0x0 9 STA1 Channel 1 State RW 0x0 8 BERR Bus Error Flag RW 0x0 7 GAPO4 Channel 4 Gap Occurred Flag 6 3 5 2 4 1 Gap Occurred Flag RW 0x0 3 RERR1 Fifo Read Error Flag RW 0x0 2 WERR1 Fifo Write Error Flag RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 145 \u00a9 2012 Broadcom Corporation. EMPT1 Fifo Flag Synopsis ENAB bit is used to start DMA. PANIC bits are used to determine the threshold leve l for PANIC signal going active. Default value is 7. DREQ bits are used to determine the threshold level for DREQ signal going active. Default value is 7. Bit(s) Field Name Description Type Reset Write 0, read as don't care 15:8 PANIC DMA Threshold for co channel. In PWM mode evenly distributed pulses are sent within a period of length defined by this register. In serial mode serialised data is transmitted within t he same period. If the value in PWM_RNGi is less than 32, only the bi ts are resulting in a truncation. If it is larger than 32 excess zero bits ar e padded at the end of data. Default value for this register is 32. Note: Channels 3 and 4 are not corresponding Channel Range Ltd. 406 Park Milton Road Cambridge CB4 0WW Page 146 \u00a9 2012 DAT1 Register Synopsis This register stores the 32 bit data to be sent by t he PWM Controller when USEFi is 0. In PWM mode data is sent by pulse width modulation: of the number of pulses which is sent within the period defined by PWM_RNGi. In serialiser mode data stored in this register is ser ialised and transmitted. Note: Channels 3 and 4 are not and corresponding Channel Data Registers Field Description RW is channels . Data written to this address is stored in channel FIFO and if USEFi is enabled for t he channel i it is used as data to be sent. This register is write only, and reading th is register will always return bus default return value, pwm0 . When more than one channel is enabled for FIFO usage , the data written into the FIFO is shared between these channels in turn. For example if the word series A B C D E F G H I .. is written to FIFO and two channels are acti ve and configured to use FIFO then channel 1 will transmit words A C E G I .. and channe l 2 will transmit words B D F H .. . Note that requesting data from the FIFO locked- step manner and therefore requires tight coupling of state machines of the chann els. If any of the channel range (period) value is different than the others this wi ll cause the channels with small range values to wait sharing the configured use the same range value. Also note that RPTLi are not meaningful when the FI FO is shared between channels as there is no defined channel to own the last data in the FIFO. Therefore sharing channels must have their RPTLi set to zero. If the set of channels to share the FIFO has been mo dified after a configuration change, FIFO should be cleared before writing new dat a. Bit(s) Field Name Description Type Reset 2012 Broadcom 406 Science Park Milton Road Cambridge CB4 0WW Page 147 \u00a9 2012 Broadcom Corporation. All rights Synopsis This register is used to define the range co channel. In PWM mode evenly distributed pulses are sent within a period of length defined by this register. In serial mode serialised data is transmitted within t he same period. If the value in PWM_RNGi is less than 32, only the bi ts are resulting in a truncation. If it is larger than 32 excess zero bits ar e padded at the end of data. Default value for this register is 32. Note: Channels 3 and 4 are not corresponding Channel Range stores the data to be sent by t he PWM Controller when USEFi is 1. In PWM mode data is sent by pulse width modulation: of the number of pulses which is sent within the period defined by PWM_RNGi. In serialiser mode data stored in this register is ser ialised and transmitted. Note: Channels 3 and 4 are not and corresponding Channel Data Registers Field Description Data RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 148 \u00a9 2012 Broadcom Corporation. All rights reserved 10 SPI 10.1 Introduction This Serial interface peripheral supports the following fe atures: Implements a 3 wire serial protocol, variously called S erial Peripheral Interface (SPI) or Synchronous Serial Protocol (SSP). Implements a 2 wire version of SPI that uses a single wire as a bidirectional data wire instead of one for each direction as in standard SPI. Implements a LoSSI Master (Low Speed Serial Interface ) Provides support for polled, interrupt or DMA operation. 10.2 SPI Master Mode 10.2.1 Standard mode In Standard SPI master mode the peripheral implements t he standard 3 wire Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 149 \u00a9 2012 In SPI master mode the same SPI standard is implemented except that a single wire is used for the data (MIMO) instead of the two as in standard mode (MISO and MOSI). Bidirectional mode is used in a similar way to standar d mode, the only difference is that before attempting to read data from the slave, you must set the read enable (SPI_REN) bit in the SPI control and status register (SPI_CS). This will turn the bus around, and when you write to the SPI_FIFO register (with junk) a read tran saction will take place on the bus, and the read data will appear in the FIFO. Figure 10-4 Bidirectional SPI Master Typical Usage 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 150 \u00a9 2012 Broadcom Corporation. All allows us to issue commands to p eripherals and to transfer data to and from them. LoSSI commands and parameters are 8 bits long , but an extra bit is used to indicate whether the byte is a command or data. This extra bit is se t high for a parameter and low for a command. The resulting 9-bit value is serialized to the output. When reading from a LoSSI peripheral the standard allows us to read bytes of data, as well as 24 and 32 bit words. Commands and parameters are issued to a LoSSI perip heral by writing the 9-bit value of the command or data into the SPI_FIFO register as you w ould for SPI mode. Reads are automated in that if the serial interface peripheral detects a read c ommand being issued, it will issue the command and complete the read transaction, putting the received data into the FIFO. 10.3.2 Parameter write 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 151 \u00a9 2012 Broadcom Corporation. All rights reserved 10.3.3 Byte read be achieved by using the command 0x04. 10.3.5 32bit read command A 32bit using the command 0x09. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 152 \u00a9 2012 Broadcom Corporation. All rights 10.4 Block Diagram Figure 10-6 Serial interface Block Diagram 10.5 SPI Register Map The BCM2835 devices has only one SPI interface of this type. It is referred to in all the documentation as SPI0. It has two additional mini SPI i nterfaces (SPI1 and SPI2). The specifiation of those can be found under 2.3 Universal SPI Master (2x) . The base address of this Offset Register Name Description Size 0x0 CS SPI Master Control and Status 32 0x4 FIFO SPI Master TX and RX FIFOs February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 153 \u00a9 2012 Broadcom Corporation. All mode TOH CS Register Synopsis This register contains the main control and status bi ts for the SPI. Bit(s) Field Name Description Type Reset 31:26 Reserved - Write as 0, read as don't care 25 LEN_LONG Enable Long data word in Lossi mode if DMA_LEN is set 0= writing to the FIFO will write a single byte 1= wrirng to the FIFO will write a 32 bit word RW 0x0 24 DMA_LEN Enable DMA mode in Lossi Chip Select 2 Chip select is active low. 1= Chip select is active high. RW 0x0 22 CSPOL1 Chip Select 1 Polarity 0= Chip select is active low. 1= Chip select is active high. RW 0x0 21 CSPOL0 Chip Select 0 Polarity 0= Chip select is active low. 1= select active high. RW 0x0 20 RXF RXF - RX FIFO Full 0 = RXFIFO is not full. 1 = RX FIFO is full. No further serial data will be sent/ received until data is read from FIFO. RO 0x0 19 RXR RXR RX FIFO needs Reading ( full) 0 = RX FIFO is less than full (or not active TA = 0). 1 = RX FIFO is or more full. Cleared by reading sufficient data from the RX FIFO or setting TA to 0. RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 154 \u00a9 2012 Broadcom Corporation. All rights reserved 18 TXD TXD TX FIFO can accept Data 0 = TX FIFO is full and so cannot accept more data. 1 = TX FIFO has space for at least 1 byte. RO 0x1 17 RXD RXD RX FIFO contains Data 0 empty. 1 = RX FIFO contains at least 1 byte. RO 0x0 16 DONE Done transfer Done 0 = Transfer is in progress (or not active TA = 0). 1 = Transfer is complete. Cleared by writing more data to the TX FIFO or setting TA to 0. RO 0x0 15 TE_EN Unused RW 0x0 14 LMONO Unused RW 0x0 LEN LoSSI enable The serial interface is configured as a LoSSI master. 0 = The serial interface will behave as an SPI master. 1 = The serial interface will behave as a LoSSI master. RW 0x0 12 REN REN Read Enable read enable if you are using bidirectional mode. If this bit is set, the SPI peripheral will be able to send data to this device. 0 = We intend to write to the SPI peripheral. 1 = We intend to read from t automatically deassert chip select at the end of a DMA transfer chip select is manually controlled by software. 1 = Automatically deassert chip select at the end of a DMA transfer (as determined by SPIDLEN) RW 0x0 10 INTR FIFO 1 = RW 0x0 9 INTD Interrupt on Done 0 = Don t generate interrupt on transfer complete. 1 = Generate interrupt when DONE = 1. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 155 \u00a9 2012 Broadcom Corporation. All rights reserved 8 DMAEN DMAEN DMA Enable 0 = No DMA requests will be issued. 1 = Enable DMA operation. Peripheral the SPIDLEN has been reached. RW 0x0 7 TA Transfer Active 0 = Transfer not active./CS lines are all high (assuming CSPOL = 0). RXR and DONE are 0. Writes to SPIFIFO write data into bits -0 of SPICS allowing DMA data blocks to set mode before sending data. 1 = Transfer active. /CS lines are set according to CS bits and CSPOL. Writes to SPIFIFO write to TX FIFO.TA is by a dma_frame_end pulse from RW 6 CSPOL Chip Select Polarity 0 = Chip select lines are active low 1 = Chip select lines are active high RW 0x0 5:4 CLEAR CLEAR FIFO Clear 00 = No action. x1 = Clear TX FIFO. One shot operation. 1x = Clear RX FIFO. One shot operation. If CLEAR and TA are both set in the same operation, the FIFOs are cleared before the new frame is started. Read back as 0. RW 0x0 3 CPOL Clock Polarity 0 = Rest state of clock = low. 1 = Rest state of clock = high. RW 0x0 2 CPHA Clock Phase 0 = First SCLK transition at middle of data bit. 1 = First SCLK transition at beginning of data bit. RW 0x0 1:0 CS Chip Select 00 = Chip select 0 01 = Chip select 1 10 = Chip select 2 11 = Reserved RW 0x0 FIFO Register Synopsis This register allows TX data to be written to the T X FIFO and RX data to be read from the RX FIFO. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 156 \u00a9 2012 Broadcom Corporation. All rights reserved Bit(s) Field Name Description Type Reset 31:0 DATA DMA Mode (DMAEN set) If TA is clear, the first 32-bit write to this regi ster will control SPIDLEN and (DMAEN clear, TA set) Writes to the register write bytes to TX FIFO. Reads from register read bytes from the Bit(s) Field Name Description Type Reset 31:16 Reserved - Write CDIV CDIV is set to 0, the divisor is 65536. The divisor must be a power of 2. Odd numbers rounded down. The maximum SPI clock rate is of length set. Bit(s) Field Name Description Type Reset 31:16 Reserved - Write as 0, read as don't care 15:0 LEN Data Length The number of bytes to transfer. This field is only valid for DMA mode (DMAEN set) and controls how many bytes to transmit (and therefore receive). RW 0x0 06 February 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 157 \u00a9 2012 Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3:0 TOH This sets the Output Hold delay in APB clocks. register generation of the DREQ an d Panic signals to an external DMA engine The DREQ signals are generated when the FIFOs reach The ct the external DMA raise the priority of its AXI requests. Bit(s) Field Name Type Reset 31:24 RPANIC DMA Read Panic Threshold. Generate the Panic signal to the RX DMA engine whenever the RX FIFO level is greater than this to the RX DMA engine whenever the RX FIFO level is greater than this amount, (RX DREQ is also generated if DMA Write Panic Threshold. Generate the Panic signal to the TX DMA engine whenever the TX FIFO level is less than or equal to Threshold. Generate a DREQ signal to the TX DMA engine whenever the TX FIFO level is less than or 2012 Broadcom Ltd. 406 Park Milton Road Cambridge CB4 0WW Page 158 \u00a9 2012 Broadcom Corporation. All Set CS, CPOL, required and set TA = 1. b) Poll TXD writing bytes to SPI_FIFO, RXD reading bytes until all data written. c) Poll DONE until it goes to 1. d) Set TA = 0. 10.6.2 Interrupt e) Set INTR and INTD. These can be left set over multip le operations. f) Set CS, CPOL, CPHA as required and set TA = 1. This wil l immediately trigger a first interrupt with DONE == 1. g) On interrupt: h) If DONE is set and data to write (this means it is th e first interrupt), write up to 16 bytes to SPI_FIFO. If DONE is set and no more data, set TA = 0. Read trailing data from SPI_FIFO until RXD is 0. i) If RXR is set read 12 bytes data from SPI_FIFO and if mor e data to write, write up to 12 bytes to SPIFIFO. 10.6.3 DMA Note: In order to function correctly, each DMA channel must be set to perform 32-bit transfers when communicating with the SPI. Either the Source or the Destination Transfer Width field in the DMA TI register must be set to 0 (i.e . 32-bit words) depending upon whether the channel is reading or writing to the SPI. Two DMA channels are required, one to read from and one to write to the SPI. j) Enable DMA DREQ's by setting the DMAEN bit and ADCS if r equired. k) Program two DMA control blocks, one for each DMA contr oller. l) DMA channel 1 control block should have its PER_MAP set to x and should be set to write 'transfer length' + 1 words to SPI_FIFO. The data s hould comprise: i) A word with the transfer length in bytes in the top si xteen bits, and the control register settings [7:0] in the bottom eight bits (i.e. TA CS, CPOL, CPHA as required.) of data to send. m) DMA channel 2 control block should have its PER_MAP set to y and should be set to read 'transfer length' words from SPI_FIFO. n) Point each DMA channel at its CB and set its ACTIVE bit to 1. o) On receipt of an interrupt from DMA channel 2, the trans fer is complete. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 159 \u00a9 2012 Broadcom Corporation. All rights reserved 10.6.4 Notes 1. The SPI Master knows nothing of the peripherals it is con nected to. It always both sends and receives bytes for every byte of the transacti on. 2. SCLK is only generated during byte serial transfer. It paus es in the rest state if the next byte to send is not ready or RXF is set. 3. Setup and Hold times related to the automatic asser tion and de-assertion of the CS lines when operating in DMA mode (DMAEN and ADCS set) are as follows: The CS line will be asserted at least 3 core clock cycles before the msb of the first byte of the transfer. The CS line will be de-asserted no earlier than 1 c ore clock cycle after the trailing edge of the final clock these control assertion and de-assertion of the CS lines. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 160 \u00a9 2012 Broadcom Corporation. All rights reserved 11 SPI/BSC SLAVE 11.1 Introduction The BSC interface can be used as either a Broadcom Ser ial Controller (BSC) or a Serial Peripheral Interface (SPI) controller. The BSC bus is a proprietary bus compliant with the Philips\u00ae I2C bus/interface version 2.1 January 2000. Both BSC a nd SPI controllers work in the slave mode. The BSC slave controller has speciall y built in the Host Control and Software Registers for a Chip booting. The BCS controller supports fast-mode (400Kb/s) and it is compliant to the I 2C bus specification version 2.1 January 2000 with the restric tions: I2C stretching is 7-bit addressing only There is one BSC/SPI slave. The registers base addresses is 0x7E21_4000. 11.2 SPI 3 wire serial protocol variously called Serial Peripheral Interface (SPI) or Synchronous Serial Protocol (SSP). BSC and SPI controllers do not have DMA connected, Register RSR The operation status register and error register is used to configure the I2C or SPI 0x10 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 161 \u00a9 2012 Broadcom Corporation. All 0x30 used to transfer/receiv e data characters and provide a Status and Flag information. Status and Flag inform ation is also available via 31:27 RXFLEVEL RXFLEVEL RX FIFO Level Returns the current level of the RX FIFO use RO 0x0 26:22 TXFLEVEL TXFLEVEL TX FIFO Level Returns the current level of the TX FIFO use RO 0x0 21 RXBUSY RXBUSY Receive Busy 0 Receive operation inactive operation RO 0x0 20 TXFE TXFE TX FIFO Empty 0 TX FIFO is not empty 1 When TX FIFO is empty RO 0x1 19 RXFF RXFE RX FIFO Full 0 FX FIFO is not full 1 When FX FIFO is full RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 162 \u00a9 2012 Broadcom Corporation. All rights reserved 18 TXFF TXFF TX FIFO Full 0 TX FIFO is not full 1 When TX FIFO is full RO 0x0 17 RXFE RXFE RX FIFO Empty 0 FX FIFO is in operation RO 0x0 15:10 Reserved - Write as 0, read as don't care 9 UE TXUE TX Underrun Error 0 - No error case detected 1 Set when TX FIFO is empty and I2C master attempt to read a data character from I2C slave. Cleared by writing 0 to I2C SPI . RO 0x0 8 OE RXOE RX Overrun Error 0 No error case detected 1 Set when RX FIFO is full and a new data character is received. Cleared by writing 0 to I2C SPI Status register . RO 0x0 7:0 DATA DATA data characters Data written to this location is pushed into the TX FIFO. Data read from this location is fetched from the RX FIFO. RW 0x0 and Bit(s) Field Name Description Type Reset 31:6 Reserved - Write as 0, read as don't care 5 RXDMABREQ Unsupported, write zero, read as don't care RO 0x0 4 RXDMAPREQ Unsupported, write zero, read as don't care RO 0x0 3 TXDMABREQ Unsupported, write zero, read as don't care RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 163 \u00a9 2012 Broadcom Corporation. All rights reserved 2 TXDMAPREQ Unsupported, write zero, read as don't care RO 0x0 1 UE TXUE TX Underrun Error 0 - No error case detected 1 Set when TX FIFO is empty and I2C master attempt to read a data character from I2C slave. Cleared by writing 0 to it. RW 0x0 0 OE RXOE RX Overrun Error 0 No error case detected 1 Set when RX FIFO is full and a new data character is received. Cleared by writing 0 to it. RW The dress value. NOTE: It is of no use in SPI mode. Bit(s) Field Name Description Type Reset 31:7 Reserved - Write 0, bit from the I2C SPI Control Register bit SLVADDR[0] chooses the following: 0 selects normal i.e. accessing RX and TX FIFOs. 1 - selects access to I2C SPI SW Status Register or Host Control register to configure the I2C or SPI operation. Bit(s) Field Name Description Type Reset 31:14 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 164 \u00a9 2012 Broadcom Corporation. 13 INV_TXF INV-RX Inverse TX status flags 0 = default status flags When this bit is 0, bit 6 (TXFE - TX FIFO Empty) will reset to a 1 1 = inverted status flags When this bit is set, bit 6 (TXFE - TX FIFO Full) will reset to a 0 * Note: INV_TX bit changes the default values of 6 bit as it is specified for I2C SPI GPU Host Status Register . RW 0x0 12 HOSTCTRLEN HOSTCTRLEN Enable Control for Host 0 = Host Control disabled 1 = Host Control enabled Note: HOSTCTRLEN allows Host to request GPUSTAT or HCTRL register. The same behaviour is achieved from the GPU using ENSTAT and ENCTRL. RW 0x0 11 TESTFIFO TESTFIFO FIFO disabled flags 0 = default status flags When this bit is 0, bit 6 (RXFF - RX FIFO Full) will reset to a 0 1 = inverted status flags When this bit is 0, bit 6 (RXFF - RX FIFO Empty) will reset to a 1 * NOTE: INV_RX bit changes the default values of 7 bit as it is specified for I2C SPI GPU Host enabled RW 0x0 TXE TXE Transmit Enable mode disabled enabled RW 0x0 7 BRK BRK Break current operation 0 = No effect. 1 = Stop operation and clear the FIFOs. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 165 \u00a9 2012 Broadcom = When enabled the control register is received as a first data character on the I2C bus. NOTE: The same behaviour is achieved from the Host side by using bit SLVADDR[6] of the slave address. RO 0x0 5 = When enabled the status register is transferred as a first data character on the I2C bus. Status register is transferred to the host. NOTE: The same behaviour is achieved from the Host side by using bit SLVADDR[6] of slave address. RW 0x0 4 Polarity 3 CPHA CPHA Clock Phase = SPI Related 0x0 2 I2C SPI Mode 0 = Disabled I2C mode 1 = Enabled I2C mode RW 0x0 1 SPI SPI Mode 0 = Disabled SPI mode 1 = Enabled SPI mode RW 0x0 0 EN EN Enable Device 1 = Enable I2C SPI Slave. 0 = Disable I2C SPI 0x0 FR Register Synopsis The flag register indicates the current status of the operation. Bit(s) Field Name Description Type Reset 31:16 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 166 \u00a9 15:11 RXFLEVEL RXFLEVEL RX FIFO Level Returns the current the RX FIFO use RW 0x0 10:6 TXFLEVEL TXFLEVEL TX FIFO Level Returns the current level of the TX FIFO use RW 0x0 5 RXBUSY RXBUSY Receive Busy RW 0x0 4 TXFE TXFE TX FIFO Empty 0 TX FIFO is not empty 1 When TX FIFO is empty RW 0x1 3 RXFF RXFE RX FIFO Full 0 FX FIFO is not full 1 When FX FIFO is full RW 0x0 2 TXFF TXFF TX FIFO Full 0 TX FIFO is not full 1 When TX FIFO is full RW 0x0 1 RXFE RXFE RX FIFO Empty 0 FX Register Synopsis The flag register indicates the current status of the operation. Bit(s) Field Name Description Type Reset 31:12 Reserved - Write as 0, read as don't care 11:9 RXIFPSEL Unsupported, write zero, read as don't care RO 0x0 8:6 TXIFPSEL Unsupported, write zero, read as don't care RO 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 167 \u00a9 000 RX FIFO gets 1/8 full 001 RX FIFO gets 1/4 full 010 RX FIFO gets 1/2 full 011 RX FIFO gets 3/4 full 100 RX FIFO gets 7/8 full 101 111 not used RW 0x0 2:0 TXIFLSEL TXIFLSEL TX Interrupt FIFO Level Select Interrupt is triggered when : 000 TX FIFO gets 1/8 full 001 TX FIFO gets 1/4 full 010 TX FIFO gets 1/2 full 011 TX FIFO gets 3/4 full 100 TX FIFO gets 7/8 full 101 111 not used RW 0x0 IMSC Register Synopsis read this re gister returns the current value of the mask on the relevant interrupt. On a write of 1 to the particular bit, it sets the corresponding mask of that interrupt. A write of 0 cl ears the corresponding mask. Bit(s) Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3 OEIM Overrun error interrupt mask. A read returns the current mask for the interrupt. On a write of 1, the mask of the OEINTR interrupt is set. A write of 0 clears the mask. RW 0x0 2 BEIM Break error interrupt mask. A read returns the current mask for the BEINTR interrupt. On a write of 1, the mask of the interrupt is set. A writ e of 0 clears the mask. RW 0x0 1 TXIM Transmit interrupt mask. A read returns the current mask for the TXINTR interrupt. On a write of 1, the mask of the interrupt is set. A writ e of 0 clears the mask. RW 0x0 0 RXIM Receive interrupt mask. A read returns the current mask for the RXINTR interrupt. On a write of 1, the mask of the interrupt is set. A writ e of 0 clears the mask. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 168 \u00a9 2012 Broadcom Corporation. All RIS Register Synopsis The Raw Interrupt Status Register returns the curren t raw status value, prior to masking, of the interrupt. Bit(s) Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3 OERIS Overrun error interrupt status. Returns the raw interrupt state of the OEINTR interrupt. RW 0x0 2 BERIS Break error interrupt status. the raw interrupt state the BEINTR interrupt. RW 0x0 1 TXRIS Transmit interrupt interrupt. RW 0x0 0 RXRIS Receive interrupt Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3 OEMIS Overrun error masked interrupt RW 0x0 error masked masked RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 169 \u00a9 2012 31:4 Reserved - Write as 0, read The not supported in this v ersion. Bit(s) Field Name Description Type Reset 31:3 Reserved - Write as 0, read as don't care 2 DMAONERR Unsupported, write zero, read as don't care RW 0x0 1 TXDMAE Unsupported, write zero, read as don't care RW 0x0 0 RXDMAE Unsupported, write don't Register Synopsis The Test Data enables data to be written i nto the receive FIFO and read out from the transmit FIFO for test purposes. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 170 \u00a9 2012 Broadcom Corporation. All Bit(s) Field Name Description Type Reset 31:8 Reserved - Write as 0, read as don't care 7:0 DATA Test data is written into the receive FIFO and read out of the transmit FIFO. RW 0x0 GPUSTAT Register Synopsis Register be via I2C bus to a Host. NOTE: GPU SW Status Register is combined with the st atus bit coming from within I2C SPI Slave device. Hence, the I2C SPI GPU Host Sta tus Register as it is seen by a Host is depicted on Table 1 14. Bit(s) Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3:0 DATA GPUSTAT GPU to is received from the host side via I2C bus. When ENCTRL - enable control register bit is set, the host control register is received as the first data character after the I2C address. Bit(s) Field Name Description Type Reset 31:8 Reserved - Write as 0, read as don't 7:0 DATA HCTRL Host Control Park Milton Road Cambridge CB4 0WW Page 171 \u00a9 2012 Broadcom Corporation. All Bit(s) Field Name Description Type Reset 31:26 Reserved - Write as 0, 31:24 Reserved - Write as 0, read RW 0x400000 REFERENCE \u00a9 2012 Broadcom Corporation. All rights reserved Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW 12 System Timer The System Timer peripheral provides four 32-bit timer channe ls and a single 64-bit free running counter. Each channel has an output compare compared against the significant bits of the free running counter values. When t he two values match, the system timer peripheral generates a signal to indicate a match for the appropriate channel. The match signal is then fed into the interrupt controller. The timer tick. The free running counter is driven by the timer clock and stopped whenever the processor is stopped in debug mode. The Physical (hardware) base address for the system tim ers is 0x7E003000. 12.1 System Timer Registers ST CLO System 32 0x8 System 32 Register Timer Control This record clear timer cha nnel matches. The system s are routed to the interrupt controller where they c an interrupt. The M0-3 fields contain the free-running counter ma tch status. Write a one to the relevant bit to clea r the match detect status bit and the corresponding inter rupt request line. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 173 \u00a9 2012 Broadcom Corporation. All Bit(s) Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3 M3 System Timer Match 3 0 = No Timer 3 match since last cleared. 1 = Timer 3 match detected. RW 0x0 2 M2 System Timer Match 2 0 = No Timer 2 match since last cleared. 1 = Timer 2 match detected. RW 0x0 1 M1 System Timer Match 1 0 = No Timer 1 match since last cleared. 1 = Timer 1 match detected. RW 0x0 0 M0 System Timer Match 0 0 = No Timer 0 match since last cleared. 1 = Timer 0 detected. RW 0x0 CLO lower registe r is a read-only register that returns the current value of the lower 32-bits of the free running counter. Bit(s) Field Name Description Type Reset 31:0 CNT Lower 32 -bits of the free a returns the current value of the higher 32-bits of the free running counter. Bit(s) Field Name Description Type Reset 31:0 CNT RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 174 \u00a9 2012 Broadcom each of the four timer channels. Whenever the lower 32-bits of the free-running coun ter matches one of the compare values bit in is set. Each timer peripheral (minirun has a set o f four compare registers. Bit(s) Field Name Description Type Reset 31:0 match channel n. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 175 \u00a9 2012 Broadcom Corporation. All rights reserved 13 UART The BCM2835 device has two UARTS. On mini UART and and PL011 U ART. This section describes the PL011 UART. For of 2.2 PL011 UART is characters received from ed PL011 UART has some optional functionality whic h can be or left out. The following functionality is not supported : Association (IrDA) Serial InfraRed (SIR) protocol Encoder/Decoder (ENDEC) Memory bits (start, stop and parity). These are added prior to transmission and removed on reception. False start bit detection. Line break generation and detection. Support of the modem control functions CTS and RTS. Howe ver DCD, DSR, DTR, and RI are not supported. Programmable hardware flow control. Fully-programmable serial interface characteristics: data can be 5, 6, 7, or 8 bits even, odd, stick, or no-parity bit generation and detection 1 or 2 stop bit generation baud rate generation, dc up to UARTCLK/16 The UART clock source and associated dividers are controll by the Clock Manager. For the in-depth UART overview, please, FIFO trigger levels are 1/8, 1/4, 1/2, 3/4, and 7/8 Transmit FIFO trigger levels are 1/8, 1/4, 1/2, 3/4, and 7/8 The internal register map address space, 06 February 2012 406 Park Milton Road Cambridge CB4 0WW Page 176 \u00a9 2012 Broadcom Corporation. All rights reserved The deltas of the modem status signals are not e. The following 16C650 UART features are not supported: 1.5 stop bits (1 or 2 stop bits only are supported) Independent receive clock. 13.2 Primary UART implementation. The following table shows the UART signals map on the General Purpose I/O (GPIO). For the insight on how to program of individual interrupts. UARTINTR, this is an OR function change in the nUARTCTS modem status \u2014 UARTDSRINTR, because of a change in the nUARTDSR mode m status. UARTEINTR, that can be caused by an error in the rec eption: 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 177 \u00a9 2012 Broadcom Corporation. All rights UARTOEINTR, because of an overrun error \u2014 UARTBEINTR, of a break in the reception \u2014 UARTPEINTR, because of a parity error in the received character \u2014 UARTFEINTR, because of a framing error in the receive d character. One can enable or disable the individual interrupts by chang ing the mask bits in the Interrupt Mask Set/Clear Register, UART_IMSC. Setting UARTRXINTR: The transmit interrupt changes state when of f ollowing events occurs: If the FIFOs are enabled and the transmit FIFO is equ al to or lower than the programmed trigger level then the transmit interrupt is asserted HIGH. The transmit interrupt is cleared by writing data to the transmit FIFO until it becomes greater than the trigger level, or by clearing the interrupt. If the FIFOs are disabled (have a depth of one locatio n) and there is no data present in the transmitters single location, the transmit inte rrupt is asserted HIGH. It is cleared by performing a single write to the transmit FIFO, or by cl earing the interrupt. UARTRTINTR: The receive interrupt changes state when of fo llowing events occurs: If the FIFOs are enabled and the receive FIFO reaches the programmed level. When this is asserted HIGH. The receive interrupt cleared by reading data from the receive FIFO until it be comes less than the trigger level, or by clearing the interrupt. If the FIFOs are disabled (have a depth of one locati on) the receive interrupt is cleared by performing a single read of the receive FIFO, or by cl earing the interrupt. 13.4 Register The PL011 USRT is Flag register 32 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 178 \u00a9 2012 Broadcom Corporation. All 32 DR Register 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 179 \u00a9 2012 Broadcom Corporation. All The UART_DR Register is the data register. For t o be transmitted: if the FIFOs are enabled, data written to this locati on is pushed onto the transmit FIFO. if the FIFOs are not enabled, data is stored in the t ransmitter holding register (the bottom word of the transmit FIFO). The write operation initiates transmission from the UAR T. The data is prefixed with a start bit, appended with the appropriate pari ty bit (if parity is enabled), and a stop bit. The resultant word is then transmitted . For received words: if the FIFOs are enabled, the data byte and the 4-bit status (break, frame, parity, and overrun) is pushed onto the 12-bit wide re ceive FIFO if the FIFOs are not enabled, the data byte and status are stored in the receiving holding register (the bottom word of the rece ive FIFO). Bit(s) Field Name Description Type Reset 31:12 Reserved - Write as 0, read as don't care 11 OE Overrun error. This bit is set to 1 if data is received and the receive FIFO is already full. This is cleared to 0 once there is an empty space in the FIFO and a new character can be written to it. RW 0x0 10 BE Break error. This bit is set to 1 if a break condition was detected, indicating that the received data input was held LOW for longer than a full-word transmission time (defined as start, data, parity and stop bits). In FIFO mode, this error is associated with the character at the top of the FIFO. When a break occurs, only one 0 character is loaded into the FIFO. The next character is only enabled after the receive data input goes to a 1 (marking state), and the next valid start bit is received. RW 0x0 9 PE Parity error. When set to 1, it indicates that the parity of the received data character does not match the parity that the EPS and SPS bits in the Line Control Register, UART_LCRH select. In FIFO mode, this error is associated with the character at the top of the FIFO. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 180 \u00a9 2012 Broadcom Corporation. All rights reserved 8 FE Framing error. When set to 1, it indicates that the received character did not have a valid stop bit (a valid stop bit is 1). In FIFO mode, this error is associated with the character at the top of the FIFO. RW 0x0 7:0 DATA Receive (read) data character. Transmit register. If the status is read from this register, then the status information for break, framing and parity corresponds to the data char acter read from the Data Register, UART_DR. The status information for ov an overrun condition occurs. NOTE: The received data character must be read first from the Data Register, UA RT_DR on before reading the error status associated with that data chara cter from this register. Bit(s) Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3 OE Overrun error. This bit is set to 1 if data is received and the receive FIFO is already full. This is cleared to 0 once there is an empty space in the FIFO and a new character can be written to it. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 181 \u00a9 2012 Broadcom Corporation. All rights reserved 2 BE Break error. This bit is set to 1 if a break condition was detected, indicating that the received data input was held LOW for longer than a full-word transmission time (defined as start, data, parity and stop bits). In FIFO mode, this error is associated with the character at the top of the FIFO. When a break occurs, only one 0 character is loaded into the FIFO. The next character is only enabled after the receive data input goes to a 1 (marking state), and the next valid start bit is received. RW 0x0 1 PE Parity error. When set to 1, it indicates that the parity of the received data character does not match the parity that the EPS and SPS bits in the Line Control Register, UART_LCRH select. In FIFO mode, this error is associated with the character at the top of the FIFO. RW 0x0 0 FE Framing error. When set to 1, it indicates that the received character did not have a valid stop bit (a valid stop bit is 1). In FIFO mode, this error is associated with the character at the top of the FIFO. RW 0x0 FR Register Synopsis The UART_FR Register is Name Description Type Reset 31:9 Reserved - Write as 0, read as don't care 8 RI Unsupported, write zero, read as don't care RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 182 \u00a9 2012 Broadcom Corporation. 7 TXFE Transmit FIFO empty. The meaning of this bit depends on the state of the FEN bit in the Line Control Register, UARTLCR_ LCRH. If the FIFO is disabled, this bit is set when the transmit holding register is empty. If the FIFO is enabled, the TXFE bit is set when the transmit FIFO is empty. This bit does not indicate if there is data in the transmit shift register. RW 0x1 6 RXFF Receive FIFO full. The meaning of this bit depends on the state of the FEN bit in the UARTLCR_ LCRH Register. If the FIFO is disabled, this bit is set when the receive holding register is full. If the FIFO is enabled, the RXFF bit is set when the receive FIFO is full. RW 0x0 5 TXFF Transmit FIFO full. The meaning of this bit depends on the state of the FEN bit in the UARTLCR_ LCRH Register. If the FIFO is disabled, this bit is set when the transmit holding register is full. If the FIFO is enabled, the TXFF bit is set when the transmit FIFO is full. RW 0x0 4 RXFE Receive FIFO empty. The meaning of this bit depends on the state of the FEN bit in the UARTLCR_H Register. If the FIFO is disabled, this bit is set when the receive holding register is empty. If the FIFO is enabled, the RXFE bit is set when the receive FIFO is empty. RW 0x0 3 BUSY UART busy. If this bit is set to 1, the UART is busy transmitting data. This bit remains set until the complete byte, including all the stop bits, has been sent from the shift register. This bit is set as soon as the transmit FIFO becomes non-empty, regardless of whether or not. 0x0 2 DCD Unsupported, write zero, read as don't care RW 0x0 1 DSR Unsupported, write zero, don't care RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 183 \u00a9 2012 Broadcom Corporation. All rights reserved 0 CTS Clear to send. This bit is clear to send, nUARTCTS, modem status input. That is, the bit is when nUARTCTS is LOW. RW 0x0 ILPR Register Synopsis This is writing to it has n ot effect and reading returns 0. Bit(s) Field Name Description Type Reset 31:0 ILPR Reserved - Register Synopsis The UART_IBRD the ba ud rate divisor value. Bit(s) Field Name Description Type Reset 31:16 Reserved - Write as 0, b aud rate divisor value. not up dated until transmission or reception of the current character is compl ete. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 184 \u00a9 2012 Broadcom Corporation. All Bit(s) Field Name Description Type Reset 31:6 Reserved - Write as 0, read as and changed: when the UART is enabled when completing a transmission or a reception when it ha s been programmed to become ) Field Name Description Type 31:8 Reserved - Write as 0, read as don't care 7 SPS Stick parity select. 0 = stick parity is disabled 1 = either: if the EPS bit is 0 then the parity bit is transmitted and checked as a 1 if the EPS bit is 1 then the parity bit is transmitted and checked as a 0. See Table 25 9. RO 0x0 6:5 WLEN Word length. These bits indicate the number of data bits transmitted or received in a frame as follows: b11 = 8 bits b10 = 7 bits b01 = 6 bits b00 = 5 bits. RW 0x0 4 FEN Enable FIFOs: 0 = FIFOs are disabled (character mode) that the FIFOs become 1-byte-deep holding registers 1 = transmit and enabled (FIFO mode). RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 185 \u00a9 2012 Broadcom Corporation. All rights reserved 3 STP2 Two stop bits select. If this bit is set to 1, two stop bits are transmitted at the end of the frame. The receive logic does not check for two stop bits being received. RW 0x0 2 EPS Even parity select. Controls the of parity the UART uses and generates or checks for an odd number of 1s in the data and parity bits. 1 = even parity. The UART generates or checks for an even number of 1s in the data and parity bits. This bit has no effect when the PEN bit disables parity checking and generation. See Table 25 9. RW 1 PEN Parity enable: 0 = parity is disabled and no parity bit added to the data frame 1 = parity checking and generation is enabled. See Table 25 9. RW 0x0 0 BRK Send break. If this bit is set to 1, a low-level is continually output on the TXD output, after completing of character. RW 0x0 CR Register Synopsis The UART_CR Register is the control register. NOTE: To enable transmission, the TXE bit and UARTEN bit must be set to 1. Similarly, to enable reception, the RXE bit and UART EN bit, must be set to 1. NOTE: Program the control registers as follows: 1. Disable the UART. 2. Wait for the end of transmission or reception of the current character. 3. Flush the transmit FIFO by setting the FEN bit to 0 in the Line Control Register, UART_LCRH. 4. Reprogram 06 February 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 186 \u00a9 2012 Broadcom Corporation. All Bit(s) Field Name Description Type Reset 31:16 Reserved - Write as 0, read as don't care 15 CTSEN CTS hardware flow control enable. If this bit is set to 1, CTS hardware flow control is enabled. Data is only transmitted when the nUARTCTS signal is asserted. RW 0x0 14 RTSEN RTS hardware flow control enable. If this bit is set to 1, RTS hardware flow control is enabled. Data is only requested when there is space in the receive FIFO for it to be received. RW 0x0 13 OUT2 Unsupported, write zero, read as don't care RO 0x0 12 OUT1 Unsupported, write zero, read as don't care RO 0x0 11 RTS Request to send. This bit is the complement of the UART request to send, nUARTRTS, modem status output. That is, when the bit is programmed to a 1 then nUARTRTS is LOW. RW 0x0 10 DTR Unsupported, write zero, read as don't care RO 0x0 9 RXE Receive enable. If this bit is set to 1, the receive section of the UART is signals. disabled in the middle of reception, it completes the current character before stopping. RW 0x1 8 TXE Transmit enable. If this bit is set to 1, the transmit section of the UART is enabled. Data UART signals. When the UART is disabled in the middle of transmission, it completes the current character before stopping. RW 0x1 7 LBE Loopback enable. If this bit is set to 1, the UARTTXD path is fed through to the UARTRXD path. In UART mode, when this bit is set, the modem outputs are also fed through to the modem inputs. This bit is cleared to 0 on disable loopback. RW 0x0 06 February 2012 Broadcom Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 187 \u00a9 2012 Broadcom Corporation. All rights reserved 6:3 Reserved - Write as 0, read as don't care 2 SIRLP Unsupported, write zero, read as don't care RO 0x0 1 SIREN Unsupported, write zero, read as don't care RO 0x0 0 UARTEN UART enable: 0 = UART is disabled. If the UART is disabled in the middle of transmission or reception, it completes the current character before stopping. 1 se lect register. You can use this register to define the FIFO level that trigge rs the assertion of the combined interrupt are rough a level rather than being based on the level. That is, the interrupts are generated when the fill level progresses through the trigger level. The bits are reset so that the trigger level is when th e FIFOs are at the half- way mark. Bit(s) Field Name Description Type Reset 31:12 Reserved - as 0, read as don't care 11:9 RXIFPSEL Unsupported, write zero, read as don't care RO 0x0 8:6 TXIFPSEL Unsupported, write zero, don't 5:3 RXIFLSEL Receive interrupt FIFO level select. The receive interrupt are as follows: b000 = Receive FIFO becomes full b001 = Receive FIFO becomes 1/4 full b010 = Receive FIFO becomes 1/2 full b011 = Receive FIFO becomes 3/4 full b100 = Receive FIFO becomes 7/8 full b101-b111 = reserved. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 188 \u00a9 2012 Broadcom Corporation. 2:0 TXIFLSEL Transmit interrupt FIFO level select. The transmit interrupt are as follows: b000 = Transmit FIFO becomes full b001 = Transmit FIFO becomes 1/4 full b010 = Transmit FIFO becomes 1/2 full b011 = Transmit FIFO becomes 3/4 full b100 = Transmit FIFO becomes full is read/write register. On a read this register returns th e current value of the mask on the relevant interrupt. On a write of 1 to th e particular bit, it sets the corresponding mask of that interrupt. A write of 0 clea rs the corresponding mask. Bit(s) Field Name Description Type Reset 31:11 Reserved - Write as 0, read as don't care 10 OEIM Overrun error interrupt mask. A read returns the current mask for the interrupt. On a write of 1, the mask of the UARTOEINTR interrupt is set. A write of 0 clears the mask. RW 0x0 9 BEIM Break error interrupt mask. A read returns the current mask for the UARTBEINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 8 PEIM Parity error interrupt mask. A read returns the current mask for the UARTPEINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 7 FEIM Framing error interrupt mask. A read returns the current mask for the UARTFEINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 189 \u00a9 2012 6 RTIM Receive timeout interrupt mask. A read returns the current mask for the UARTRTINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 5 TXIM Transmit interrupt mask. A read returns the current mask for the UARTTXINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 4 RXIM Receive interrupt mask. A read returns the current mask for the UARTRXINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 3 DSRMIM Unsupported, write zero, read as don't care RO 0x0 2 DCDMIM Unsupported, write zero, read as don't care RO 0x0 1 CTSMIM nUARTCTS modem interrupt mask. A read returns the current mask for the UARTCTSINTR interrupt. On a write of 1, the mask of the interrupt is set. A write of 0 clears the mask. RW 0x0 0 RIMIM Unsupported, write zero, read as don't care RO 0x0 RIS Register Synopsis The UART_RIS Register is the raw interrupt er. It is a read-only register. This register returns the current raw status value, prior to masking, of the corresponding interrupt. NOTE: All the bits, except for the modem status interru pt bits (bits 3 to 0), are cleared to 0 when reset. The modem status interrupt bit s are undefined Bit(s) Field Name Description Type Reset 31:11 Reserved - Write as 0, read as don't care 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 190 \u00a9 2012 Broadcom Corporation. All rights reserved 10 OERIS Overrun error interrupt status. Returns the raw state of the UARTOEINTR interrupt. RW 0x0 9 BERIS Break error interrupt status. the raw interrupt state of the UARTBEINTR interrupt. RW 0x0 8 PERIS Parity error interrupt raw interrupt UARTPEINTR interrupt. RW 0x0 7 FERIS Framing error interrupt raw interrupt RW 0x0 timeout interrupt. RW 0x0 5 TXRIS Transmit interrupt interrupt. RW 0x0 4 RXRIS Receive interrupt UARTRXINTR interrupt. RW 0x0 3 DSRRMIS Unsupported, write don't care RW 0x0 2 DCDRMIS Unsupported, write zero, RW 0x0 CTSRMIS nUARTCTS modem interrupt UARTCTSINTR interrupt. RW 0x0 0 RIRMIS Unsupported, write RW 0x0 MIS Register 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 191 \u00a9 2012 Broadcom Corporation. masked This value of the correspo nding interrupt. NOTE: All the bits, except for the modem status interru pt bits (bits 3 to 0), are cleared to 0 when reset. The modem status interrupt bit s are undefined Bit(s) Field Name Description Type Reset 31:11 Reserved - Write as 0, read as don't care 10 OEMIS Overrun error masked interrupt RW 0x0 error masked masked interrupt. RW 0x0 Unsupported, write don't care RW 0x0 2 DCDMMIS Unsupported, write zero, interrupt. RW 0x0 care RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 192 \u00a9 2012 Type Reset 31:11 Reserved - Write as 0, read interrupt. RW 0x0 Unsupported, write don't care RW 0x0 2 DCDMIC Unsupported, write zero, interrupt. RW 0x0 care RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 193 \u00a9 2012 Broadcom Corporation. Register Synopsis This is the disabled DMA Control Register, writing to i t has not effect and reading returns 0. Bit(s) Field Name Description Type Reset 31:3 Reserved - Write as 0, read as don't care 2 DMAONERR Unsupported, write zero, read as don't care RW 0x0 1 TXDMAE Unsupported, write zero, read as don't care RW 0x0 0 RXDMAE Unsupported, write don't care RW 0x0 Synopsis This is the Field Name Description Type Reset 31:2 Reserved - Write as 0, read as don't care 1 ITCR1 Test FIFO enable. When this bit it 1, a write to the Test Data Register, UART_DR writes data into the receive FIFO, and reads the UART_DR register reads data out of the transmit FIFO. When this bit is 0, data cannot be read directly from the transmit FIFO or written directly to the receive FIFO (normal operation). RW 0x0 0 ITCR0 Integration test enable. When this bit is 1, the UART is placed in integration test mode, otherwise it is in normal operation. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 194 \u00a9 2012 Broadcom Corporation. All rights is the Test Field Name Description Type Reset 31:4 Reserved - Write as 0, read as don't care 3 ITIP3 Reads return the primary input. RW 0x0 2:1 Reserved - Write as 0, read as don't care 0 ITIP0 Reads return Field Name Description Type Reset 31:12 Reserved - Write as 0, ITOP11 Intra-chip output. return the value of UARTMSINTR at the return the value of UARTRXINTR at the return the value of UARTTXINTR at test multiplexor. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 195 \u00a9 2012 return the value of UARTRTINTR at the return the value of UARTEINTR at the return the value of UARTINTR at the test multiplexor. RW 0x0 5:4 Reserved - Write as ITIP3 Primary output. nUARTRTS. RW 0x0 2:1 Reserved - Write as 0, care 0 ITIP0 Primary output. UART_TDR is It enables data to be written into the receive FIFO and read out from the transmit FIFO for t est purposes. This test function is enabled by the ITCR1bit in the Test Contro l Register, UART_ITCR. Bit(s) Field Name Description Type Reset 31:11 Reserved Write as 0, read as don't care 10:0 TDR10_0 When the ITCR1 bit is set to 1, data is written into the receive FIFO and read out of the transmit FIFO. RW 0x0 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 196 \u00a9 2012 Broadcom Corporation. All rights 14 Timer (ARM side) 14.1 Introduction The ARM Timer is based on a ARM AP804, but it has a number of differences with the standard SP804: There is only one timer. It only runs in continuous mode. It has a extra clock pre-divider register. It has a extra stop-in-debug-mode control bit. It also has a 32-bit free running counter. The clock from the ARM timer is derived from the sy stem clock. This clock can change dynamically e.g. if the system goes into reduced power or in lo w power mode. Thus the clock speed adapts to the overal system performance capabilities. For acc urate timing it is recommended to use the system timers. Registers: (Read in real 804!) 0x420 running (Not real 804!) Timer Load register The timer load register sets the time for the timer to count down. This value is loaded into the timer value register after the load register has or if the timer-value register has counted down to 0. 8 This is the offset which needs to be added to the base address to get the full hardware address. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 197 \u00a9 2012 is counted down when the counter is counted each timer the timer load register and the interrupt pending b it is set. The timer count down speed is set by the timer pre-divide o f 8 bits but in the BCM implementation there are more control bits for the extra features. Control b its 0-7 are identical to the SP804 bits, albeit som e functionality of the SP804 is not implemented. All new control bits start from bit 8 upwards. Differences between a real 804 and is bits do not 804! v alue is 0x3E 0 : running counter Disabled 1 : Free running counter Enabled This bit does not exists in a standard 804 timer! 8 R/W 0 : Timers keeps running if ARM is in debug halted mode 1 : Timers halted if ARM is in debug halted mode This bit does not exists in a standard 804 timer! 7 R/W 0 : Not used , The timer is always in free running mode. If this bit is set it enables periodic mode in a st andard 804. That mode is not supported in the BC2835M. 5 R/W / 1 (No pre-scale) 01 : pre-scale is clock / 16 10 : pre-scale is clock / 256 11 : pre-scale is clock / 1 (Undefined in 804) 1 R/W 0 : 16 -bit The timer is always in wrapping mode. If this bit is set it enables one-shot mode in real 804. That mode is not supported in the BCM2835. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 198 \u00a9 the interrupt-pending bit is cleared. When reading this register it returns 0x544D5241 wh ich is a read-only register. It sh ows the of the interrupt : The interrupt pending bits is clear 1 : The interrupt pending bit is set. The interrupt pending bits is set each time the val ue register is counted down to zero. The interrupt pending bit can not by itself generates only be It shows the status of the interrupt signal. It is si mply a logical AND of the interrupt pending Interrupt line not asserted. 1 :Interrupt line is asserted, (the interrupt pendi ng the enable bit set.) Timer Reload register: This register a copy of the timer load register. The difference is that a write to this register do es not trigger an immediate reload of the timer value register. Instead the the value the SP80 4. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 199 \u00a9 2012 Broadcom Corporation. All rights reserved The pre-divider register is 10 bits wide and can be written or read from. This register has been added as the SP804 expects a 1MHz clock which we do not h ave. Instead the pre-divider takes the APB clock and divides is 0x7D so gives a divide by 126. Free running counter counter is not present in the SP80 4. The free running counter is a 32 bits wide read onl y register. The register is enabled by setting bit 9 of the Timer control register. The free running cou nter is incremented immediately after it is enabled. The timer can not be reset but when enable d, will always increment and roll-over. The free running counter is also running from the APB clock and has its own clock pre-divider controlled by bits 16-23 of the timer control register. This register will be halted too if bit 8 of the co ntrol register is set and the ARM is in Debug Halt mode. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 200 \u00a9 2012 Broadcom Corporation. All rights reserved 15 USB The USB core used in the Videocore is build from Sy nopsys IP. Details about the block can be found in DWC_otg_databook.pdf (Which are specified before the block is build and thus can not be changed using software. The above mentioned document has a list these under the Parameters\". The Feature/Parameter OTG (Device of Operation Non -LPM -capable core HSIC core Architecture 2: Internal DMA Point -to -Point Only 0: No High -Speed PHY Interfaces 1: USB 1.1 selection: FS_USB/IC_U SB 0 : FS_USB interface Data Width of 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 201 \u00a9 Mode Number of Device Mode IN Endpoints including Control Endpo int 0 8 Number of Device Mode Control Endpoints in Addition to Endpoint 0 0 Number of Host Mode Channels 8 Is Periodic OUT Channel Support Needed in Host Mode 1: Yes Total Data FIFO RAM 4096 Enable Data FIFO Non -periodic Tx Data FIFO Depth Mode Periodic Request Queue Depth 8 Device Mode IN Token Sequence Learning Queue Depth 8 Width of Transfer Size Counters 19 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 202 \u00a9 2012 Broadcom from PHY from PHY from PHY Enable Filter on \"session_end\" Signal from PHY 1: Yes Direction of Endpoints Mode is {IN and OUT} for all endpoin ts Largest Device Mode Periodic Tx Data FIFO n Depth 768 for all endpoints (Except 0) Largest Device Mode IN Endpoint Tx FIFOn Depth (n = 0 to the documentation of Synopsys a number of extra registers have been added. These control the Analogue USB Phy and t he connections of the USB block into the Video core bus structure. Also the USB_GAHBCFG register has an alternative function for the bits [4:1]. Base Address of the USB block - 0x7E98_0000 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 203 \u00a9 2012 read MDIO R 0 30-24 - Unused 23 bb_mdo Direct write (bitbash) MDO output 0 22 0 20 freerun 1= MDC is continous active 0 = MDC only active during data transfer 0 input shift register. Updates falling edge mdio_data 32-bit sequence to send over bu W 0 31-0 mdio_data 32-bit sequence received from MDIO b us R 0 Table 15-2 USB MDIO data A Preamble is not auto-generated so any MDIO access mus t be preceded by a write to this register of 0xFFFFFFFF. Furthermore, a bug in the USB PH Y requires an extra clock edge so a write of 0x00000000 must follow the actual access. 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 204 \u00a9 2012 - Unused - 0 19-16 AXI priority level R/W 0 15:10 - Unused - 0 9 vbus_irq 1=one or more bits of [6:4] have changed since last read. This bit is cleared when the register is read. RC 0 8 vbus_irq_en 1=Enable IRQ on VBUS status change W 0 7 afe_non_driving 1=USB PHY AFE pull ups/pull downs are off 0=Normal USB AFE operation (Has no effect if MDIO mode is enabled in the phy) R/W 0 6 utmisrp_dischrgv bus Drive VBUS R 0 5 s Charge VBUS R 0 4 utmiotg_drvvbus utmiotg_avalid A 2 utmiotg_bvalid USB MDIO data The RW bits this register are fed into the USB2.0 cont roller and the RO bits are coming out of it. In the real device, it will be up to the softwa re to communicate this information between the USB2.0 controller and external VBUS device (some of these have I2C control, others will have to interface (HBstLen)\" have used 1 = all outstanding AXI writes to complete before signalling (internally) that DMA is done. 0 = don't wait. [3] Not used [2:1] Sets the maximum AXI burst length, but the bits are inverted, 00 = maximum AXI burst length of 4, 01 = maximum AXI burst length of 3, 10 = maximum AXI burst length of 2 11 = maximum AXI burst length of 1 06 February 2012 Broadcom Europe Ltd. 406 Science Park Milton Road Cambridge CB4 0WW Page 205 \u00a9 2012 Broadcom Corporation. with a digital interface for applications such as low - cost compassing and magnetometry . The includes 1 \u00b0 to 2\u00b0 compass heading accuracy. The I2C serial bu s allows for y interface . The HMC5883L is a 3.0x3.0x0.9mm surface mount Applications for the HMC5883L include Mobile Phones, Netbooks, Consumer Electronic s, Auto Navigation Navigation at sensitivity is designed to measure both the direction and the magnitude of Earth' s magnetic fields, from milli-gauss to 8 gauss. Honeywell's Magnetic Sensors are among the most sensitive and in industry. FEATURES Mount Package Small Size for Highly Integrated Products. Just Add a Micro - Controller Interface, P lus Two External SMT Capacitors Designed for High Volume, Cost Sensitive OEM Designs Easy to Assemble & Compatible with High Speed SMT Assembly 12-Bit ADC Coupled with Low Noise AMR Sensors Achieves 2 milli-gauss Field Resolution in \u00b1 8 Gauss Fields Enables 1 \u00b0 to 2\u00b0 Degree Compass Heading Accuracy Built-In Self Test Enables Low -Cost Functionality after Assembly in Production Low Voltage Operations ( 2.16 to 3.6 V) and Low Power Consumption ( 100 A) Compatible for Battery Powered Applications Built-In Strap Drive Circuit s Set/Reset and Offset Degaussing, Self Test, and Offset Compensation I2C Digital Interface Popular Two -Wire Serial Data Interface for Consu mer Electronics Lead Free Construction RoHS Compliance Wide Field Oe) Can Be Used in Strong Magnetic Field Environments with a 1\u00b0 to 2\u00b0 Degree Heading Accuracy Software and Algorithm Support Available Soft Iron, and = 2.5V (Single Supply) - - 2 100 - - A A Performance Field Range Full scale (FS) -8 Resolution Measur ement Period From receiving command 6 ms Turn-on Time Ready for I2C commands Analog Circuit Ready for of Schmitt trigger (VDDIO=1.8V) Rise (VDDIO=1.8V) Axes Z Axis \u00b11.16 \u00b11.08 gauss X & Y & Z Axes (GN=5) Positive Bias X & Y -575 575 -243 Output -0.3 %/\u00b0C General ESD Voltage Human Body Model (all pins) Charged Device Model (all pins) 2000 750 Volts Operating Temperature Ambient -30 85 \u00b0C Storage Temperature 125 \u00b0C Peak Temperature Package Size Length and Width 2.85 3.00 3.15 mm Package Height 0.8 0.9 1.0 mm Package Weight 18 mg Absolute Maximum Ratings (* Tested at 25 \u00b0C except Not to be Connected 4 S1 Tie to VDD IO 5 NC Not to be Connected 6 NC Not to be Connected 7 NC Not to be C1 Supply Ground 12 SETC S/R Capacitor (C2) Connection 13 VDD IO IO Power Supply (1.71V to VDD) 14 NC Not to be Ready , Interrupt Low for 250 \u00b5sec when data is placed in the data output registers . 16 SDA magnetic generates positive output reading HMC5 8 83 L an d P a d P a ttern (A ll d im e nsio ns a re in mm) LAYOUT CONSIDERATIONS components that may contain ferrous (nickel, etc.) away from the sensor on both sides of the PCB , it is also recommend ed that there is no conducting copper under/near the sensor in any of the PCB layers. See recommended layout below. Notice that the one trace under the sensor in the dual supply mode is not expected to carry active current since it is for pin 4 pull -up to VDDIO. Power and ground plan es are removed under the sensor to minimize possible source of magnetic noise. For best results, use non -ferrous materials for all exposed copper coding. 6 www.honeywell.com PCB Pad HMC5883L and the external capacitors (C1 and C2) to handle the 1 ampere peak current pulses with low voltage drop on the traces. Stencil Design and Solder Paste coverage is recommended for the electrical contact pads. Reflow Assembly This device is classified as MSL 3 with 260 C peak reflow A baking process (125C, if device is not kept continuously in a dry (< 10% RH) environment before assembly. No special reflow profile is required for HMC5883L test can be used to verify after small ceramic (0402), so be Typical Noise Floor (Field Resolution) 00.511.522.53 0 1 2 of the DRDY Interrupt pin The Honeywell HMC5883L magnetoresistive sensor circuit a trio of sensors and application specific support circuits to measure magnetic fields. With power supply applied, the sensor converts any incid ent magnetic field in the sensitive axis directions to a differential voltage output. The magnetoresistive and patterned as a resistive strip element. In the presence of a magnetic field, a change in the bridge resistive elements causes a corresponding change in voltage across the bridge outputs. These resistive elements are aligned together to have a common sensitive axis (indicated by arrows in the pinout diagram ) that will provide positive voltage change with magnetic fields increasing in the sensitive direction. Because the output is only proportion al to the magnetic field component along its axis , additional sensor bridges are orthogonal directions to Self Test To check the HMC5883L for proper operation, a self test feature in incorporated in which the sensor is internally excited with a nominal magnetic field (in either positive or negative bias configuration) . This fi then measured and reported. This function is enabled and the polarity is set by bits MS[n] in the configuration register A. An internal current source generate s DC current (about 10 mA) from the VDD supply. This DC current is applied to the offset strap s of the magneto - resistive sensor, which creates an artificial magnetic field bias on the sensor. The difference of this measurement and the measurement of the ambient field will be put in the data output register for each of the three axes. verify the sensor's full functionality after the assembly without additional test setu p. The self test results can also be measurement\", the ASIC: 1. Sends a \"Set\" p ulse 2. Takes one m easurement (M1) 3. Sends the (~10 mA) offset current to generate the (~1.1 Gauss) offset field and takes another measurement (M2) 4. Puts the difference of the two measurements s output egister: - M1] (i.e. o utput = offset field only) See SELF TEST OPERATION section later in this datasheet for additional details . Power Management This device has two different domains of power supply. The first one is VDD that is the power supply for internal operations and the second one is VDDIO that is dedicated to IO interface. It is possible to work with VDDIO equal to VDD ; lower than VDD allowing HMC5883L to be compatible with other devices on board. I2C Interface Control of this device is carried out via the I2C bus. This device will be connected to this bus as a slave device under the control of a master device, such as the processor. This device As I2C compatible device, this device has a 7 -bit serial address and supports I2C protocols. This device support standard and fast modes, 100kHz and 400kHz , respectively, but does not support the high speed mode (Hs). External pull-up resistors are required to support these standard and fast speed modes. Activities required by the master (register read and write) have over internal activities, such as the measurement. The purpose of this priority is to not keep the master waiting and the I2C bus engaged for longer than internal digital logic functions and timing Set/Reset strap of the sensor. This strap is largely a resistive load. There is no need for an external Set/Reset circuit. The controllin g of the Set/Reset done automatically by the ASIC for each One half of the difference from the measurements taken after a set pulse and after a reset pulse will be put in the data output register for each of the three axes. By internal remove the past magnetic sensor, if any. For each \"m easurement\", the ASIC: 1. Sends easurement (Mset) 3. Sends a \"Reset\" p ulse Mreset] 2 Charge Current Limit The current that reservoir capacitor (C 1) can draw when charging is limited for both single supply and dual supply configuration s. This prevents drawing down the supply voltage (VDD). MODES OF OPERATION This device has several operating modes whose primary purpose is power management and ontrolled by the Mode Register . data output registers. can be -read from the data output registers if necessary; however, if the master does not ensure that the data register is accessed before the completion of the next measurement, the data output registers are updated with the new measurement. To co nserve current between measurements, the device is placed in a state similar to idle mode, but the Mode Register is not changed to Idle Mode. That is, MD[n] bits are unchanged. Settings in the Configuration measurement mode. The I2C bus is enabled for use by other devices on the network in while continuous -measurement mode. Single -Measurement Mode This is the default power -up mode. During single -measurement mode, the device makes a single measurement and places the measured data in data output registers. After the measurement is complete and output data registers are updated, the device is placed in idle mode, and the Mode Register is changed to idle mode by setting registers in values while in single -measurement mode. The I2C bus is enabled for use by other devices on the network while in single -measurement mode. Idle Mode During this mode the device is accessible through the I2C bus, but major sources of power consumption are disabled, such as, but not limited to, the ADC, the amplifier, and the sensor bias current. All registers maintain values while in idl e mode. The I2C bus is enabled for use by other devices on the network while in idle mode. HMC5883L www.honeywell.com 11 REGISTERS This de vice is controlled and configured via a number of on -chip registers, are in this section. In the following descriptions, set implies a logic 1, All address 8 bits. Address Location Read Read Data Output Y Read 09 Status Register Read 10 Identification Register A Read 11 Identification Re Register section describes the process of reading from and writing to this device. The devices uses an address pointer to indicate which register location is be from or written to. These pointer locations are sent from the master to this slave device and succeed the 7 -bit address (0x1E) plus 1 and 0x3C for write . To minimize the communication between the master and this device, the pointer updated automatically without master incremented by 1 automatically after the successfully. The pointer value be read to read an invalid address location 0's, and write to an or undefined bit within a ignored by this device. random to data that are in the configuration register. CRA7 denotes the first bit of the The number in parenthesis indicates the default value reserved for future fun ction . Set to 0 when configuring CRA. CRA MA1 to MA0 Select 8) per measurement output . 00 = 1 (Default) ; 01 = 2; 10 = 4; 11 = 8 CRA4 to CRA2 DO2 to DO0 Data Output Rate Bits. These bits set the rate at which dat a is written to all three define the measurement flow of the device, specifically whether or not s maximum Hz can be achieved by Output Rate (Hz) 0 0 0 0.75 0 0 1 1.5 0 1 0 3 0 1 1 7.5 1 0 0 15 (Default) 1 0 1 30 1 1 0 75 1 1 1 Reserved Table 5: Data normal measurement configuration the device follows normal measurement flow. The positive and negative pins of the resistive load are left floating and high impedance. 0 1 bias configuration X, Y, and Z axes configuration, a positive current is forced across the resistive load for all three axes. 1 0 Negative bias configuration for X , Y and Z axes . In this configuration, a negative current is forced across the resistive load for all three bit locations, the conf iguration register. CRB7 denotes the first The number in parenthesis indicates the default value Table Bits. gain for the device. The gain configuration is common for all channels. CRB4 to CRB0 0 These bits settings. Use the \"Gain\" column to convert counts to Gauss . The \" Digital Resolution\" column is the theoretical v alue in term of milli -Gauss per count (LSb) which is the inverse of the values in the \" Gain \" column The effective resolution of the usable signal also depends o n the noise floor of the system, i.e. Effective Resolution = Max ( Digital hen total of the data output registers (saturation) . Note that the very first measurement after a gain change maintains the same gain previous setting. new gain setting is -0x07FF (-2048 -2047 ) 0 (default) 0.92 0xF800 -0x07FF (-2048 -2047 ) 0 1 1.22 0xF800 -0x07FF (-2048 -2047 ) 0 0xF800 -0x07FF (-2048 -2047 ) 0xF800 -0x07FF (-2048 -2047 ) 0xF800 -0x07FF (-2048 -2047 ) 0xF800 -0x07FF (-2048 -2047 ) is an 8 -bit register from which data can be read or to which data can be written. This register is used to select the ugh MR7 indicate bit locations, with MR denoting bits that are in the mode register. MR7 denotes the first bit of the data stream. The number in parenthesis indicates the default value to MR2 this enable MR1 to Mode Select Bits. These bits select the operation mode of this Table 11: Mode s and places the result in the data register. RDY goes high when ne w data is placed in all three registers. After a power -on or a write to the mode or configuration register, the first measurement set is available from all three data output registers after a period of 2/f DO and subsequent measurements are available at a frequency of f DO, where f DO is the frequency of data output. 0 1 Single -Measurement Mode (Default) . When single -measurement mode is selected, device performs a single measurement, se ts RDY high and returned to idle mode . Mode register returns to idle mode bit values. The measurement remains in the data output register and RDY remains high until the data output register is read or another measurement is performed. 1 0 Idle Mode. Device is placed in idle mode. 1 1 Idle Mode. Device is placed in idle mode. Table 12: Operating Modes HMC5883L www.honeywell.com 15 Data Output A and B The data output X registers are two 8 -bit registers, data A These registers store the measurement result from channel X. Data output X regist er A contains the MSB from data The stored DXRA and DXRB denoting the that are the data output X registers. DXRA7 and DXRB7 denote the first the stream. The number in parenthesis indicates the default value of that bit . In the event the ADC reading overflows or underflows for the given channel, or if there is a math overflow during DXRB5 DXRB4 DXRB3 DXRB2 DXRB1 (0) (0) Table 13: Data Output X Registers A and B Data Output Y Registers A and B The data output Y registers are two 8 -bit registers, data A These registers store the measurement result from Y. Data output register A the MSB from The stored DYRA and DYRB denoting the that are the data output Y registers. DYRA7 and DYRB7 denote the first the stream. The number in parenthesis indicates the default value of that bit. In the event the ADC reading overflows or underflows for th e given channel, or is math during DYRB5 DYRB4 DYRB3 DYRB2 DYRB1 (0) (0) (0) Table 14: Data Output Y Registers A and B Data Output Z Registers A and B The data output Z registers are two 8 -bit registers, data outpu register A and B. These registers store the measurement result from Z. Data output register A the MSB from the The v alue stored in DZRA and DZRB denoting the that are the data output Z registers. DZRA7 and DZRB7 denote the first the stream. The number in parenthesis indicates the default value of that bit. In the event the ADC reading overflows or underflows for the given channel, or if a overflow DZRB5 DZRB4 DZRB3 DZRB2 DZRB1 (0) (0) Table 15: Data Output Z Registers A and B Data Output Register Operation When one or more of the output registers are read, new data cannot be placed in any of the output data registers until all cannot be is placed in all the output registers. Status Register The status is -only register. This register through SR7 indicate bit locations, with SR denoting the bits that are in the status register. SR7 denotes the first SR4 SR3 SR2 SR1 LOCK (0) RDY(0) Table 16: Status Register Location Name Description bits are reserved . SR1 LOCK Data output register lock. This bit is set when : 1.some but not all for of the six data output registers have been read , 2. Mode register has been read. When this b it is set, the six data output registers are locked and any new data will not be placed in these register until one of these conditions are met: 1.all six bytes have been read, 2. the mode register is changed, 3. the measurement configuration (CRA) is chan ged, 4. power is reset. SR0 RDY Ready Bit. Set when data is written to all six data registers. Cleared when device initiates a write to the data output registers and after one or more of the data output registers are written to. When RDY bit is clear i t shall remain cleared for a 250 s. DRDY pin can be used as an alternative to the status register for monitoring the device for IRA7 indicate bit locations, with IRA denoting the that are in the identification register A. IRA7 denotes the first bit of the stream. The number in parenthesis indicates the default value of that bit. The identification value for t his device is stored in this register. This is a 18: Identification Register the through IRB7 indicate bit locations, with IRB denoting the that are in the identification register A. IRB7 denotes the first bit IRC7 indicate bit locations, with IRC denoting the that are in the identification register A. IRC7 denotes the first bit -wire I2C bus syst em as a slave device. The HMC5883L uses a simple protocol with the interface protocol defined by the I2C bus specification, and by this document . The data rate is at the standard - mode 100k bps or 400kbps rates as defined in the I2C Bus Specification s. The bus bit format is an 8 -bit Data/Address send and a 1 -bit acknowledge bit. The format of the data bytes (payload) shall be case sensitive ASCII charact ers or binary data to the HMC5883L slave, and binary data returned. Negative binary values will be in two's fo The default (factory) HMC5883L 8-bit slave address is 0x3C for write operations, or 0x3D for read operations. The HMC5883L Serial Clock (SCL) and Serial Data (SDA) lines require resistive pull -ups (Rp) between the master device (usually microprocessor) and the HMC5883L . Pull -up resistance 2.2K ohms ar e recommended with a nominal VDD IO voltage . Other resistor values may be used as defined in t he I2C Bus Specifications that can be tied to VDD IO. The SCL and SDA lines in this bus specification may be connected to multiple devices. The bus can be a single master to multiple slaves, or it can be a multiple master configuration. All data transfers are initiated by the master device , which is responsible for generating the clock signal, and the data transfers are 8 bit long. All devices are addressed by I2C's unique 7 -bit address. After each device generates a 9th clock pul se, and releases the SDA line. The receiving device (addressed slave) will pull the SDA line low to acknowledge (ACK) the successful transfer or leave the SDA IRC5 IRC4 IRC3 IRC2 IRC1 1 1 HMC5883L 18 www.honeywell.com Per the I2C spec, all transitions in the SDA line must occu r when SCL is low. This requirement leads to two unique conditions on the bus associated with the SDA transitions when SCL is high. Master device pulling the SDA line low while the SCL line is high indicates the Start (S) condition, and the Stop (P) condi tion is when the SDA line is pulled high while the SCL line is high. The I2C protocol also allows for the Restart condition in which the master device issues a second start condition without issuing a stop. All bus transactions begin with the master devic e issuing the start sequence followed by the slave address byte. The address byte contains the slave address; the upper 7 bits (bits7 -1), and the Least Significant bit (LSb). The LSb of the address byte designates if the operation is a read (LSb=1) or a write (LSb=0). At the 9th clock pulse, the receiving slave device will issue the ACK (or NACK). Following these bus events, the master will send data bytes for a write operation, or the slave will clock out data with a read operation. All bus transaction s are terminated with the master issuing a stop sequence. I2C bus control can be implemented with either hardware logic or in software. Typical hardware designs will release the SDA and SCL lines as appropriate to allow the slave device to manipulate thes e lines. In a software implementation, care must be taken to perform these tasks in OPERATIONAL EXAMPLES The HMC5883L has a fairly quick stabilization time from no voltage to stable and ready for data retrieval. The nominal 56 milli-seconds with t he factory default single measurement mode means that the six bytes of magnetic data registers (DXRA, D XRB, D ZRA, D ZRB, D YRA, and D YRB) are filled with a valid first measurement. To change the measurement mode to continuous measurement mode, 0x3C the 00 into the second register or mode register to switch from single to continuous measurement mode setting. With the data rate at the factory default of 1 5Hz updates, a 67 milli-second typica l 83L data registers for measurements. The HMC5883L will automatically re -point back to register 3 for the next 0x3D query . All six data registers must be read properly before new data can be placed in any of these data registers. Below is an \"continuous 15 or send 0x3C 0x02 (Continuous -measurement mode) 4. monit or status register or DRDY hardware interrupt pin 5. Loop Send 0x3D (Read all 6 bytes. I f gain is changed then this data set is respectively. Send 0x3C 0x03 (point to first data register 03) Wait about 67 ms (if 15 Hz rate) or monitor status register or DRDY hardware interrupt for \"single 0x3C 0x02 0x01 (Single -measurement mode) Wait 6 ms register or DRDY hardware interrupt pin Send 0x3D 6 bytes . If gain then this data set Z, Y, respectivel y. HMC5883L www.honeywell.com 19 SELF TEST OPERATION To check the HMC5883L for proper operation, a self test feature in incorporated in which the sensor offset straps are excited to create a nominal field strength (bias field) to measured. implement of are changed from 00 to 01 (positive b ias) or 10 (negetive b ias). Then, b y placing the mode register into single or continuous -measurement mode, two data acquisition cycles will be made on each magnetic vector. The first acquisition will be a set pulse followed shortly by measurement data of the external second acquisition will have the offset strap excited (about 10 mA) in the positive bias mode for X , Y, and Z axes to create about a 1.1 gauss self test field plus the external field. The first acquisition values will be subtracted from the second acquisition, and the net measurement will be placed into the data output registers. Since self test adds ~1.1 Gauss additional field a reduced For example, i is set to 0xA0 (Gain= 5), values around + 452 LSb (1.16 Ga * 390 LSb/Ga) will be placed in the X an d Y data output registers and around +421 (1.08 Ga * 390 LSb/Ga) will be placed in Z data output register . To leave the self test mode, change MS1 and MS0 bit of the configuration register A back to 00 (Normal Measurement Mode). Acceptable limits of the table. Below is an example process using send 0x00 (Continuous -measurement mode) 4. Wait or monitor status register or DRDY hardware interrupt pin 5. Loop 6 bytes . If then this data set respectively. Send 0x3C 0x03 (point to first data register 03) Wait about 67 ms (if 15 Hz rate) or monitor st atus End_loop 6. Check limits - If all 3 axes (X, Y, and Z) are within reasonable limits (243 to 575 for 3 axes pass positive CRA (00) - send 0x3C 0x00 0x70 (Exit self test mode next data set) Else At least one axis did not pass positive self test Write CRA (00) - send 0x3C 0x00 0x70 (Exit self test mode and this procedure) End If Below is an example of how to test on the gain : 1. If Gain = 6, self test limits are : Low Limit = 243 * 330/390 = 206 High Limit = 575 * 330/390 = 487 2. If Gain = 7, self test limits are : Low Limit = 243 * 230/390 = 143 High Limit = 575 * 230/390 = HMC5883L 20 www.honeywell.com SCALE FACTOR TEMPERATURE temperature A compensation factor can be found b y comparing the self test outputs with the ones obtained at a known temperature. For example, if the self test output is 400 at room temperature and 300 at the current temperature th en a compensation factor of (400/300) should be applied to all current magnetic readings. is required using self 1. If self test measurement at a temperature \" when the last magnetic calibration was done\": X_STP = 400 Y_STP = 410 Z_STP = 420 2. If self test m easurement at a different t mperature: X_STP = 300 (Lower than before) Y_STP = 310 (Lower than before) Z_STP = (Lower n ew measurements: X = X * X_TempComp Y = Y * Y_TempComp Z = Z * Z_TempComp Now all 3 axes are temperature compensated, i.e. MORE For more information on Honeywell's Magnetic Sensors visit us online at www. magneticsensors .com or contact us at 1-800-323-8295 (763 application c ircuits herein constitute typical usage and interface of Honeywell product. does not warranty or assume liability o f customer - from this description or depiction. to make changes to improve design. Honeywell does not assume any liability arising out of the application or use of any product or circuit described herein; neither does it convey any license under its patent rights nor the rights of others. U.S. 4,533,872, 55 MN 55441 Tel: 800 www. .com Form +85 \u00b0C (max) \u00b13.0\u00b0C from 55 \u00b0C to +125 the allowing up toeight devices one bus. The TMP101 of fers SMBus alert function with up to three devices per bus. The TMP100 and TMP101 are ideal for extended temperature measurement in a variety of communication, computer, consumer, environmental, industrial, and instrumentation applications. The TMP100 and TMP101 are specified for operation over a temperature range of +125 \u00b0C. Register important notice concerning availability, standard warranty, and use in critical of T exasInstruments semiconductor products and disclaimers thereto appears at the end sheet. is a trademark of NXP Semiconductors. maximum conditions for extended periods may degrade device reliability. These are stress ratings only, and functional operation of the device at these or any other conditions beyond those specified is not supported. can be damaged by ESD. Texas Instruments recommends that all integrated circuits be handled with appropriate precautions. Failure to observe proper handling and installation procedures can cause damage. ESD damage can range from subtle performance degradation to complete device failure. Precision integrated circuits may be more susceptible to damage because very small parametric changes could cause the device not to meet its published specifications. ORDERING INFORMATION (1) ordering information, see the Package Option Addendum at the end of this document, or see the TI web site at www.ti.com. PIN CONFIGURATION Top View SOT23 Top View 6.0 V VIL 0.5 0.3(V+) V Input Current, I IN 0V VIN 6V 1 \u00b5A Output Logic Levels: VOL SDA IOL = 3mA 0 0.15 0.4 V VOL ALERT IOL = 4mA 0 0.15 0.4 V Resolution Selectable 9 to 12 Bits Conversion Time 9-Bit 40 75 ms 10-Bit 80 150 ms 11-Bit 160 300 ms 12-Bit 320 Current IQ Serial Inactive 45 75 \u00b5A Serial Bus Active, SCL Frequency = 70 Current ISD Bus Active, SCL Frequency = 20 2 002 04 06 08 01 0 0 1 2 0 1 4 0IQ(\u00b5A) SerialBusInactiveV+=5 V V +=2 0.1SHUTDOWNCURRENTvs TEMPERATURE Temperature( /C0095C)60 40 20 0 20 40 60 80 100 120 140ISD(\u00b5A) 400 350 300 250CONVERSION TIME vsTEMPERATURE Temperature( /C0095C)60 40 2 002 04 06 08 0 1 0 0 1 2 0 1 4 0Conversion Temperature( /C0095C)60 40 20 0 20 120 140TemperatureError( /C0095C) 3 TypicalUnits NOTE: 12bit resolution. 180 160 140 and over range TMP100 and TMP101 require no operation pull-up on SCL, SDA, and ALERT, although a capacitor Typical of the TMP100 The die flag of the lead frame is connected to pin 2. The sensing device of the TMP100 and TMP101 is the chip itself. Thermal paths run through the package leads as well as the plastic package. The lower the or TMP101 is directly connected to the metal lead and the best choice for thermal input.To be the data registers should respond to a read or write command. Table 1 identifies the bits of the Pointer Register 2 12-bit that stores the output of the most recent conversion. Two bytes must be read to obtain data and are described in Table 3 and Table 4. The first 5. Following power-up will 0 \u00b0C until the first conversion is complete. Table 3. Byte 1 of Temperature 100 0110 0100 0101 0000 75 0100 1011 0000 4B0 50 0011 0010 0000 320 25 0001 1001 0000 190 0.25 0000 0000 0100 004 0.0 0000 0000 0000 000 0.25 1111 1111 1100 FFC 25 1110 0111 0000 E70 55 1100 1001 0000 C90 128 1000 0000 0000 800 The user can obtain 9, 10, 11, or 12 bits of resolution by addressing the Register with 8-bit to store bits that control the operational modes of the temperature sensor. Read/write operations are performed MSB first. The format of the Configuration Register for TMP100 and TMP101 is valueof the Configuration Register is all bits equal to 0. The OS/ALERT bit will read as 1 after power-up/reset. TMP100 and TMP101 allows the user to save maximum power by shutting down all device circuitry other than the serial interface, which reduces current consumption 1 is enabled whenthe SD bit is 1. The device will shutdown once the current conversion is completed. For SD 0, the maintain continuous conversion. THERMOSTAT MODE (TM) The indicates to thedevice operate in Comparator Mode (TM = 0)or Interrupt Mode (TM = 1). For more information on comparator and interrupt modes, see the HIGH and LOW Limit Registers section. POLARITY (POL) The Polarity Bit allows the user to adjust the polarity of the ALERT pin output. If POL = 0, the ALERT pin will be active LOW, as shown in Figure 4. For POL = 1 the ALERT pin will be active HIGH, and the state of the ALERT pin is inverted. the number of fault may programmed Queue. The Fault Queue is provided to prevent a false alert due to environmental noise. The Fault Queue requires consecutive fault measurements in totrigger the alert If the temperature falls belowT the number of measured faults that may F1 F0 CONSECUTIVE FAULTS 0 0 1 0 1 2 1 0 4 1 1 6 CONVERTER RESOLUTION (R1/R0) The Converter TMP101 RESOLUTIONCONVERSION TIME (typical) 00 9 Bits (0.5 \u00b0C) 40ms 01 10 Bits (0.25 \u00b0C) 80ms 1011 Bits (0.125 \u00b0C) 160ms 1112 Measurement Mode. When the device is inShutdown Mode, writing a 1 to the OS/ALERT bit will start a single temperature conversion. The device will return to the shutdown state at the completion of the singleconversion. This is useful to reduce power consumption in the TMP100 and TMP101 when continuous monitoring of is not required. Reading the OS/ALERT bit will provide information about the Comparator Mode status. The state of the POL bit willinvert the polarity of data returned from the OS/ALERT bit. For POL = 0, the OS/ALERT will read as 1 until the temperature equals or consecutive faults, causing the OS/ALERT bit to read as 0. The OS/ALERT bit will continue to read as 0 until the temperature falls below T LOW for the programmed number of consecutive faults when it will again read as 1.The status of the TM bit does not affect the status of the OS/ALERT bit. HIGH AND LOW LIMIT REGISTERS In Comparator Mode (TM = 0), the ALERT pin of theTMP101 becomes active when the temperature equals or exceeds the value in a consecutive number of faults according to fault pin remain active until the temperature falls the indicated value for the same number of faults.In Interrupt Mode (TM = 1) the ALERT Pin becomes active when the temperature equals or exceeds T HIGH for a consecutive number of fault conditions. The ALERT pinremains active until a read operation of any register occurs or the device successfully responds to the SMBus Response Address. The ALERT pin will also be cleared if the device is placed in Shutdown Mode. Once the ALERTpin is cleared, it will only become active again by the temperature falling below T LOW. When the temperature falls below T LOW, the ALERT pin will become active and remain active until cleared by a read operation of anyregister a successful response to the SMBus Alert Response Once pin is cleared, the above cycle will repeat with the ALERT pin becomingactive when the temperature equals or exceeds T HIGH. The ALERT pin can also be cleared by resetting the device with the General Call Reset command. This will also clear the state of the internal registers in the device returning thedevice to Comparator Mode (TM = 0). Both operational modes are represented in Figure 4. Table 9 and Table 10 describe the format for the T HIGH and TLOW registers. Power-up Reset values for T HIGH and TLOW are: THIGH = 80 \u00b0C and T LOW = 75 \u00b0C. The format of the data for T HIGH and TLOW is the same as for the Temperature Register. Table 9. Bytes 1 and 2 of Register BYTE D7D6D5D4D3D2D1D0 1H11H10H9H8H7H6H5H4 BYTE D7D6D5D4D3D2D1D0 2H3H2H1H00000 Table 10. Bytes and T LOW Register BYTE D7D6D5D4D3D2D1D0 1L11L10L9L8L7L6L5L4 BYTE D7D6D5D4D3D2D1D0 2L3L2L1L00000 All 12 bits the Temperature, T HIGH, and TLOW registers are used in the comparisons for the ALERT function for allconverter resolutions. The three LSBs in T HIGH and TLOW can affect the ALERT output even if the converter is configured 9-bit resolution. SERIAL INTERFACE The TMP100 TMP101 operate only slave deviceson the I 2C bus and SMBus. Connections to the bus are made via the open-drain I/O lines SDA and SCL. TheTMP100 and TMP101 support the transmission protocolfor fast (up to 400kHz) and high-speed (up to 3.4MHz) modes. All data TMP100 and TMP101, the master must first address slave devices via a slave address byte. The slave address byte consists of seven address bits, and adirection bit indicating the of read The TMP100 features two address pins to allow up to eight devices to be addressed on a single I 2C interface. Table 11 describes the pin logic levels used to properly connect up to eight devices. Float indicates the pin is left unconnected. The state of pins ADD0 and ADD1 is sampled on the first I2C bus communication and should be set prior to any activity on the interface. Table 11. Address Pins and Slave Addresses for the address pin and an ALERT pin, allowing up to three devices to be connected per bus. Pin logic levels are described in Table 12. The address pins of the TMP100 and TMP101 are read after reset or inresponse to an I 2C address acquire request. Following reading, the state of the address pins is latched to minimize power dissipation associated with detection. Table OVERVIEW The device that initiates the transfer is called a master, and the devices controlled by the master are slaves. The bus must be controlled by a master device that generates the serial clock (SCL), controls the bus access, and generates the START and STOP conditions. To address a specific device, a START condition is initiated, indicated by pulling the data-line (SDA) from a HIGH to LOW logic level while SCL is HIGH. All slaves on the bus shift in the slave address byte, with the last bitindicating whether a read or write operation is intended. ninth clock pulse, the slave by generating an Acknowledgeand pulling SDA LOW.Data transfer clock pulses followed by an Acknowledge Bit. During data transfer SDA must remain stable while SCL is HIGH, asany change in SDA while SCL is HIGH will be interpreted as a control signal. Once all data have been transferred, the master generates a STOP condition indicated by pulling SDA from LOW to HIGH, while SCL is HIGH. WRITING/READING TO THE TMP100 AND TMP101 Accessing particular register on the TMP101 by appropriate Register. The value for the Register is the first byte transferred after the I2C slave address byte with the R/W bit LOW. Every write operation to the TMP100 and TMP101 requires a value for the Pointer Register. (Refer to Figure 6.) When reading from the TMP100 and TMP101, the last value stored in the Pointer Register by a write operation is used to determine which register is read by a read operation. To change the register pointer for a readoperation, a new value must be written to the PointerRegister. This is accomplished by issuing an I 2C slave address byte with the R/W bit LOW, followed by the Pointer Register Byte. No additional data are required. The mastercan then generate a START condition and send the I 2C slave address byte with the R/W bit HIGH to initiate the read command. See Figure 7 for details of this sequence. If repeated reads from the Pointer Register value until it is changed by the next write operation. SLAVE MODE OPERATIONS The TMP100 and TMP101 can operate as slave receiversor slave transmitters. Slave Receiver Mode: The first byte transmitted by the master is the slaveaddress, with the R/W bit LOW. The TMP100 or TMP101 then acknowledges reception of a valid address. The next transmitted the master then acknowledges reception of byte. The next byte or bytes are written to the register addressed by reception of data byte. The master may terminate data transfer bygenerating a START or STOP condition. Slave Transmitter Mode: The first byte is transmitted by the master and is the slaveaddress, with the R/W bit HIGH. The slave acknowledges reception of a valid slave address. The next byte is transmitted by the slave and is the most significant byte of the register data byte. The next byte transmitted by the slave is the least significant byte. The master acknowledges reception of the data byte. Themaster may terminate data transfer by generating aNot-Acknowledge on reception of any data byte, or generating a START or STOP condition. SMBus operating in Interrupt Mode (TM = 1), the ALERT pin of the TMP101 may be connected as anSMBus Alert signal. When a master senses that an ALERT condition is present on the ALERT line, the master sends an SMBus Alert command (00011001) on the bus. If theALERT pin of the TMP101 is active, the TMP101 willacknowledge the SMBus Alert command and respond by returning its slave address on the SDA line. The eighth bit (LSB) of the slave address byte will indicate if thetemperature exceeding T HIGH or falling below T LOW caused the ALERT condition. For POL = 0, this bit will be LOW if the temperature is greater than or equal to T HIGH. This bit will be HIGH if the temperature is less than T LOW. The polarity of this bit will be inverted if POL = 1. Refer toFigure 8 for details of this sequence. If multiple devices on the bus respond to the SMBus Alert command, arbitration during the slave address portion of the SMBus alert command will determine which device will clear its ALERT status. If the TMP101 wins the arbitration, its ALERT pin will become inactive at the completion of theSMBus Alert command. If the TMP101 loses the arbitration, its ALERT pin will remain active. The TMP100 will also respond to the SMBus ALERT command if its TM bit is set to 1. Since it does not have an ALERT pin, the master needs to periodically poll thedevice by issuing an SMBus Alert If has generated an ALERT, it will acknowledge the SMBus Alert command and return its slave address in the next byte.GENERAL CALL The TMP100 and TMP101 respond to the I2C General Call address (0000000) if the eighth bit is 0. The device will acknowledge the General Call address and respond tocommands in the second byte. If the second byte is00000100, the TMP100 and TMP101 will latch the status of their address pins, but will not reset. If the second byte is 00000110, the TMP100 and TMP101 will latch that reset the device to default settings when the device is powered on. This circuit activates when thepower supply is TMP101 are powered down by removing supply voltage from the device, but the supply voltage to be less recommended a General Call reset command on the I 2C interface bus to ensure that the TMP100 and TMP101 are completely reset. HIGH-SPEED MODE In bus to operate at frequencies above 400kHz, the master device must issue an Hs-mode master code (00001XXX) as the first byte after a START condition to switch the bus to high-speed operation. The TMP100and TMP101 will not acknowledge this byte as required by the I 2C specification, but will switch their input filters on SDA and SCL and their SDA to operate allowing transfers at up to 3.4MHz. After theHs-mode master code has been issued, the master will transmit an I 2C slave address to initiate a data transfer operation. The bus will continue to operate in Hs-modeuntil a STOP condition occurs on the bus. Upon receiving the STOP condition, the TMP100 and TMP101 will Figure 5 to Figure 8 describe the various Bus Bus Idle: Both SDA and SCL lines remain HIGH. Start Data Transfer: A change in the state of the SDA line, from HIGH to LOW, while the SCL line is HIGH, defines a START condition. Each data transfer is initiated with a START condition. Stop Data Transfer: A change in the state of the SDA line from LOW to HIGH while the SCL line is HIGH defines aSTOP condition. Each data transfer terminated START or STOP condition.Data Transfer: The number of data bytes transferred between a START and a STOP condition is not limited and is determined by the master device. The receiveracknowledges the transfer of data. Acknowledge: Each receiving device, when addressed, is obliged Acknowledge bit. A device thatacknowledges must down SDA line during the Acknowledge clock pulse in such a way that the SDA line is stable LOW during the HIGH period of the Acknowledgeclock pulse. Setup and hold times must be taken intoaccount. On a master receive, the termination of the data transfer can be signaled by the master generating a Not-Acknowledge on the last byte that has beentransmitted by the slave. Table Frequency f(SCLK) 0.4 3.4 MHz Bus Free TIme Between STOP and START Conditions t(BUF) 600 160 ns Hold time after repeated START condition. After this period, the first clock is generated.t(HDSTA) 600 160 ns Repeated START Condition Setup t(SUSTA) 600 160 ns STOP Condition Setup Time t(SUSTO) 600 160 ns Data HOLD Time t(HDDAT) 0 0 ns Data Setup Time t(SUDAT) 100 10 ns SCLK Clock LOW Period t(LOW) 1300 160 ns SCLK Clock HIGH Period t(HIGH) 600 60 ns Clock/Data Fall Time tF 300 160 ns Clock/Data Rise Time A2 0 0 0 0 19 19 19SDASCL 001 A 2 A 1 A 0 R / W 000000 P 1 P 0 ... ... ...... SDA (Continued)SCL W A 1 A to 125 T101 (1) The marketing status values are defined as follows: ACTIVE: Product device recommended for new designs. LIFEBUY: TI has announced that the device will be discontinued, and a lifetime-buy period is in effect. NRND: Not recommended for new designs. Device is in production to support existing customers, but TI does not recommend using this part in a new design. PREVIEW: Device has been announced but is not in production. Samples may or may not be available. OBSOLETE: TI has discontinued the production of the device. (2) Eco Plan - The planned eco-friendly classification: Pb-Free please check http://www.ti.com/productcontent for details. TBD: or \"Pb-Free\" the current RoHS requirements for all 6 substances, at high temperatures, package, or 2) lead-based die adhesive used between the Pb-Free defines the JEDEC industry and peak solder temperature. (4) Multiple Top-Side parentheses and separated by a \"~\" will appear on a device. If a line is indented then it is a continuation of the previous line and the two combined represent the entire Top-Side Marking for that device. Important Disclaimer: The information provided on this page represents TI's knowledge and belief as of the date that it is provided. TI bases its knowledge and belief on information provided by third parties, and makes no representation or warranty to the of such information. Efforts are underway to better integrate information from third parties. TI has and take reasonable steps to provide accurate information but may not have conducted destructive testing or chemical analysis on incoming materials and chemicals. TI and TI suppliers consider certain information to be proprietary, and thus CAS numbers and other limited information may not be available for release. In no event shall TI's of such purchase price of the TI part(s) at issue in this document sold by TI to Customer on an annual basis. OTHER QUALIFIED VERSIONS ApplicationsTAPE 1*All dimensions are nominal Device Package Type Package Drawing Pins SPQ Length (mm) Digital Barometer The MPL115A2 sensor with a digital I2C output targeting low cost applications. A miniature 5 by 3 by 1.2 mm LGA package is ideally suited for the space constrained requirem ents of portable electronic devices. Low current consumptions of 5 A during Active mode and 1 A during Shutdown (Sleep) mode are essential when focusing on low-power The wide operating temperature conditions. conditioning IC to provide accurate pressure measurement s from 50 to 115 kPa. An integrated ADC converts pressure and temperature sensor readings to digitized outputs via a I2C port. Factory calibration data is stored internally in an ROM. Utilizing the raw information together programmed calibration coefficients for host micro use. Factory Interface (operates up to 400 kHz) 7 b i t I2C address = 0x60 and Application (portable and desktop) Altimeters Weather Stations Hard Disk-Drives (HDD) Industrial Equipment Health Monitoring Air Control Systems ORDERING INFORMATION Device Name Package Options Case No.# of Ports Pressure Type Digital Interface None Single Dual Gauge Differential Absolute MPL115A2 MPL115A2T2 Tape & Reel (5000) 2015 I2CMPL115A2 50 to 115 kPa Top ViewMPL115A2 5.0 mm by 3.0 mm by 1.2 mm Pin Connections1 NCSDAVDD CAP SHDNGND RSTSCL 2 3 48 7 6 5 Sensors 2 Freescale Semiconductor, Inc.MPL115A21 Block Diagram and Pin Descriptions Figure 1. Block Diagram and Pin Connections Table 1. CAP F connected to ground. 3 GND Ground 4 SHDNShutdown: Connect to GND to disable the device. When in shutdown, the part draws no more than 1 A supply current and all communications pins (RST , SCL, SDA) are high impedance. Connect to VDD for normal operation. 5 RST Reset: Connect to ground to disable I2C communications. 6 NC NC: No connection Use 4.7k pullup resistors for I2C F Microcontroller4.7 k 4.7 kSensors Freescale Semiconductor, Inc. 3MPL115A22 Mechanical and Elect rical Specifications 2.1 Maximum Ratings Voltage (with respect to GN D unless otherwise noted) VDD..................................................................................................................... = otherwise noted. Typical +25\u00b0C. Ref Parameters Symbol Min Typ Max Units 2 Supply Current IDDShutdown (SHDN = GND) \u2014 \u2014 1 A Standby \u2014 3.5 10 A Average - at one measurement per second \u2014 5 6 A Pressure Sensor 3 Range 50 \u2014 115 kPa 4 Resolution \u20140 . \u2014k Typical circuit 0.1 \u2014 kPa/V 100 mV p-p 217 Hz square wave plus 100 mV pseudo random noise with 10 MHz bandwidth0.1 \u2014 kPa 7 Conversion Time (Start Pressure and Temperature Conversion )tc Time between start convert command and data available in the Pressure and Temperature registers\u20141 . 6 3 m s 8 Wakeup Time tw Time between leaving Shutdown mode (SHDN goes high) and communicating with the device to issue a command or read data.\u20143 5 m s Stages: Voltage VIL \u2014\u2014 0 . 3 VDDV 11 High Level Input Voltage VIH 0.7VDD\u2014\u2014 V I2C Outputs: SDA 12 Data Setup Time tSUSetup from command receipt to ready 0000000. Slave address has been set to 0x60 or 00000.Sensors 4 Freescale Semiconductor, Inc.MPL115A23 Overview of Functions/Operation Figure 2. Sequence Flow Chart The MPL115A interfaces to a host (or syst em) microcontroller in the user's application. All communications are via I2C. A typical usage sequence is as follows: Initial Power-up All circuit elements are active. I 2C port pins are high impedance and associated registers are cleared. The device mode.Reading typically accesses the and reads the coefficien t data. The main circuits within the slave device are disable d during read activity. The coefficients are usually stored in the host microcontoller local memory but can be re-read at any tim e. It is not necessary to read the values stored in the host microc ontroller multiple times because the coefficients within a devi ce are constant and do not change. However, note that the coefficient s will be different from device to device, and cannot be used for another part.Data ConversionThis is the first step that is performed each time a new pressure reading is required which is initiated by the host sending th e CONVERT command. The main system circuits are activated (w ake) in response to the command and after the conversion completes, the result is placed The conversion completes within the maximum conversion time, tc (see Row 7, in the Operating Characteristics Table). The device then enters the conversion has been given time to complete, the host microcontroller reads the from the ADC which compensated for changes in temperature and pressure sensor linearity. This is done using the coefficient data from the MPL115A and the raw sampled pressure and temperature in a compensa equation Note this is an absolute pressure measurement with a vacuum as a reference.From this step the host controller may either wait and then retu rn to the Data Conversion step to obtain the next pressure read ing or it may go to the Shutdown step.Reading coefficient data Data conversionInitial powerup Compensated Semiconductor, Inc. 5MPL115A2Shutdown For longer periods of inactivity the user may assert the SHDN input by driving this pin low to reduce system power consumption. This removes power from all internal circuits, including any re gisters. In the shutdown and Temperature be is exited by taking the SHDN pin high. Wait for the maximum wakeup time, tw (see Row 8, in the Operating Characteristics Table), after which another pressure reading can be taken by transitioning to the data Conversion step. For values with less than 16 bits, the lower LSBs are zero. For ex ample, c12 is 14 bits and is stored into 2 bytes as follows: c12 s for Pressure and Temperature ADC values. Table 2. Device Memory Map Address \u2014 0x11 Pressure and Temperature Conversion \u2014 *These registers are set to 0x00. previously utilized 16 16 14 10 10 Sign Bits 1 1 1 1 0 0 Integer Bits 12 2 1 0 10 10 Fractional Bits 3 13 14 13 0 0 dec pt zero pad 0 0 0 9 0 0Sensors 6 Freescale Semiconductor, Inc.MPL115A2Example Binary Format Definitions: a0 Signed, 0, Fractional Bits = 13, dec pt zero pad = 9 : Coeff c12 = S 0 Tadc is temperatur e a0 (TCS) will produce a value of 0 with an inpu t pressure of 50 kPa and will produce a full-scale value of 1023 with an input pres sure Eqn. 2 a succession of Mult iply Accumulates (MACs) operations of the form P =c o m p115 50 - 1023---------------------- 50+ a b xy + XSensors can be evaluated ( Equation 1 ) as a sequence of 3 MACs: Please refer to Freescale application note AN3785 for more detailed notes on implementation. 3.4 I2C Device Read/Write Operations All device read/write operations are memory mapped. Device acti ons e.g. \"Start Conversions\" ar e controlled by writing to the appropriate memory address location. F o r I2C the Address (from Table 2) has a toggle bit, where the least significant bit is '1' for read operations or '0' for writ e operations. The Device Address is 0xC0 for a Write and the Device Address is 0xC1 for a Read . The most significant bit in the Command tables below is not us ed and is don't care (X). In examples given it's set to '0'. Refer to Sensor I2C Setup and FAQ Application Note AN4481 for more information on I2C communication between the sensor and host controller. X = Don't care 1 = The command byte needs to be paired with a 0x00 as part of the I2C exchange to complete the passing of Start Conversions.Table 3. I2C Write Commands Command Binary HEX(1) Devices Address by the part in response to each command are as follows: X = don't care These are MPL115A2 I2C read coefficients, execute Pressure a nd Temperature conversions, and to read Pressure and Temperature data. The sequence of the commands for the interaction is given as an example to operate the data, an of calculating Compensated Pressure reading is given floating n. I2C Commands bit Address + read bit \"To = 0xC1 Command to Write \"Convert Pressure and Temperature\" = 0x12Command to Read \"Pressure ADC High byte\" = 0x00 Command to Read \"Pressure ADC Low byte\" = 0x01 Command to Read \"Temperature ADC High byte\" = 0x02Command to Read \"Temperature ADC Low byte\" = 0x03 Command to Read \"Coefficient data byte Command Description input. D Pressure and Temperature registers with the result. Shut down main circuits and Table 5. I2C Read Command Description Command HEX(1) Device Address + Read bit 1100 0001 Semiconductor, 9MPL115A2Figure SAC solder alloy (i.e., Sn-Ag-Cu) with a melting point of about 217\u00b0C. It is to Time to 90s on board type, thermal of the board/ an inert reflow environment (with O 2 level about 5 to 15 ppm). NOTE: The stress level and signal offset of the device also depend s on the board type, board core material, board thickness and metal finishing of the board. Please refer to Freescale application note AN3150, Soldering Re commendations for Pressure Sensor Devices a1 c12x2 = -2.37585 + -1.97532 a1x1 a1 Padc -1.97532 410 -809.8812y1 = Semiconductor, Inc. 11MPL115A25 Handling Recommendations It is recommended to handle the MPL115A pressure sensor with a vacuum pick and place tool. Sharp objects utilized to move the MPL115A pressure sensor increase the possibility of damage via a foreign object/tool into the small exposed port. The sensor die is sensitive to light exposure. Direct light expos ure through the port hole can lead to varied accuracy of press ure to the port during normal operation.Please note that the Pin 1 designator is on the bottom of the package. Do not use the port as a orientation reference in produc tion. 6 Soldering/Landing Pad Information The LGA package is compliant with the RoHS standard. It is re commended to use a no-clean solder paste to reduce cleaning exposure to high pressure and chemical agents that can da mage or reduce life span of the Pressure sensing element. Figure 6. MPL115A2 Recommended Tape Reel Specifications Figure 7. LGA (3 by 5) Embossed Carrier Dimensions Figure 8. Device Orientation in Measured from sprocket hole centerline of sprocket to centerline of pocket. (IV) Other material available. Dimensions are in millimeters.Ao 3.35 \u00b1 8.00 0.10 W 12.00 Pin AreaSensors 13 Semiconductor, Inc.MPL115A2PACKAGE DIMENSIONS CASE 2015-02 ISSUE A LGA PACKAGESensors 14 Freescale Semiconductor, Inc.MPL115A2Related Documentation The MPL115A2 device features and operations are described in a variety of reference manuals, user guides, and application notes. To find the most-current versions of these documents: 1. Go to the Freescale homepage at: http://www.freescale.com/ 2. In the Keyword search box at the top of the page, enter the device number MPL115A2. 3. In the Refine Your Result pane on the left, click on the Documentation link.Sensors Freescale Semiconductor, Inc. 15MPL115A2Table Function s/Operation: executed once, Table 2: added (bits) column in I2C Device Read/Write Operations \u0081 Rev. in this document is provided solely to enable system and software implementers to use Freescale Semiconduc tor products. There are no express or implied copyright granted hereunder to circuits or integrated circuits based on the information in this document. Freescale Semiconductor reserves the right to make changes without further notice to any products herein. Freescale no representation or guarantee the suitability of its products for any particular purpose, nor does Freescale Semiconductor assume any liability ar ising out of the application or use of any product or circuit, and specifically discl aims any and damages. \"Typical\" parameters in Freescale Semiconductor data s heets and/or specifications can and do vary in different applications and actual performance may vary over time. All operating parameters, including technical experts. Freescale Se miconductor does not convey any license under its patent rights nor the rights of others. Freescale Semiconductor products are not designed, intended, or authorized for use as components in systems intended for surgical implant into the body, or other applications intended to support or sustain life, or for any other application in which the fa ilure of the Freescale Semiconductor product could create a situation where personal injury or death may occur. Should Buyer or or unauthorized application, Buyer shall injury or death associated with unintended or unauthorized use, even if such claim alleges Freescale Semiconductor was negligent regarding the design or manufacture of the part. Freescale and the Freescale logo are trademarks of Freescale Semiconductor, Inc., Reg. U.S. Pat. & Tm. Off. All other product or service names are the property of their respective owners. \u00a9 contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO SPECIFIC DISCLAIMERS, SET FORTH AT www.vishay.com/doc?91000Fully Integrated Proximity and Ambient Sensor with Infrared Emitter, I2C Interface, and Interrupt Function DESCRIPTION The VCNL4010 is a fully integrated proximity and ambient light sensor. Fully integrated me ans that the infrared emitter is included in the package. It has 16 bit resolution. It includes a signal processing IC and features standard I 2C communication interface. It features an interrupt function. APPLICATIONS Proximity sensor for mobile devices (e.g. smart phones, touch phones, PDA, GPS) for touch screen locking, power saving, etc. Integrated ambient light f unction for display/keypad contrast control and dimming of mobile devices Proximity/optical switch for consumer, computing and industrial devices and displays Dimming control for consumer, computing and industrial displaysFEATURES Package type: surface mount Dimensions (L x W x H in mm): 3.95 x 3.95 x 0.75 Integrated infrared emitter, ambient proximity and Interrupt function Supply voltage range V DD: to 3.6 V Supply voltage range IR anode: 2.5 V to 5 V Communication via I 2C interface I2C Bus H-level range: 1.7 V to 5 V Floor life: 168 h, MSL 3, acc. J-STD-020 Low stand by current consumption: 1.5 A Material categorization: Programmable LED drive current from 10 mA to 200 mA in 10 mA steps Excellent ambient light su ppression by modulating the infrared signal Proximity distance up to 200 mm Built-in ambient light photo-pin-diode with close-to- human-eye sensitivity range from klx 100 Hz rejection Note through I2C interface nc IR anode 1 IR 3 SDA (lx)OUTPUT CODE VCNL4010 1 to 200 2.5 to 3.6 1.7 to 5 10 to 200 0.25 to 16 383 0.25 16 bit, I2CVCNL4010 www.vishay.comVishay Semiconductors Rev. contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE The VCNL4 010 sensor by Software site: INFORMATION CODE PACKAGING (1)REMARKS VCNL4010-GS08Tape and pcs3.95 7000 (2)- MOQ: 1 pc \u00b0C, unless otherwise specified) PARAMETER TEST CONDITION SYMBOL MIN. MAX. UNITSupply voltage V DD - 0.3 5.5 V Operation temperature range T amb - 25 + 85 \u00b0C Storage temperature range T stg - 40 + 85 \u00b0C Total power dissipation T amb 25 \u00b0C P tot 50 mW Junction temperature T j 100 \u00b0C BASIC CHARACTERISTICS unless SYMBOL MIN. TYP. MAX. UNITSupply voltage V DD 2.5 3.6 V Supply voltage IR anode 2.5 5 VI 2C Bus H-level range 1.7 5 V INT H-level range 1.7 5 VINT low voltage 3 mA sink current 0.4 VCurrent consumptionStandby current, no (averaged)2 second, 250 measurements per second, IRED current 20 mA520 A 2 measurements per second, IRED current 200 mA35 A 250 measurements per second, IRED current 200 mA4.0 mA Current consumption ambient light mode2 measurements per second averaging = 12.5 A 8 measurements per second averaging = 110 A 2 measurements per second averaging = 64160 A 8 measurements per second averaging = 64640 A Ambient light resoluti on Digital resolution (LSB count ) 0.25 lx contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO SPECIFIC DISCLAIMERS, SET FORTH AT www.vishay.com/doc?91000CIRCUIT BLOCK DIAGRAM Note nc must not be electrically connected Pads 8 to 11 are only considered as BASIC CHARACTERISTICS (Tamb = 25 \u00b0C, unless otherwise specified) Fig. 1 - Idle Current vs. Ambient Temperature Fig. 2 - Idle Current vs. V DD Fig. 3 - Proximity Value vs. Distance Fig. 4 - Forward Current vs. Temperature22299-1GND 12 11 nc IR anode 1 IR cathode Kodak gray card (18 % reflectivity) VCNL4010 IRED 30 mm x 30 mm Proxi-PD22300-1 2.4 1.01.21.41.81.62.02.2 110 - 50 - 30 10 50 90 - 10 30 70IDD - Supply Current Idle Mode (A) Tamb - Ambient Temperature (\u00b0C) 22301VDD = 3.6 V VDD = 3.5 V VDD = 3.3 V VDD = 3.1 VVDD = 2.5 V VDD = 2.7 V VDD = 2.9 V 2.4 1.01.21.41.61.82.02.2 3.8 2.4 2.6 2.8 3.0 3.2 3.4 3.6IDD - Supply Current Idle Mode (A) VDD - Supply Voltage (V) 22302100 \u00b0C 80 \u00b0C 55 \u00b0C 25 \u00b0C - 10 \u00b0C - 40 \u00b0C100 000 1100100010 000 10 0.1 1 10 100Proximity Value (ct s) Distance to Reflecting Card gray cardMod. fre quency = 390 kHzLED current 200 mA LED current 100 mA LED current 20 mA 250 050100150200 140 - 60- 20 20 60 100IIRED - Forward contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO SPECIFIC SET FORTH AT www.vishay.com/doc?91000 Fig. 5 - Relative Intensity vs. 6 - Sensitivity vs. Angular Displacement (Proximity Sensor) Fig. 9 - Ambient Ligh t Value Illuminance Fig. 10 Inten Signal (ct s) EV - Illuminance (lx)0.1 1 10 100 1000 10 000 00.20.40.60.81.0 1100 400500 600 700 800 contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO SPECIFIC SET FORTH AT www.vishay.com/doc?91000 Fig. 11 - Relative Radiant Sens itivity vs. Angular Displacement (Ambient Light Sensor) APPLICATION INFORMATION VCNL4010 is a cost effective solution of proximity and ambient light sensor with I2C bus interface. The st andard serial digital interface is easy to access \"Proximity Signal\" and \"Light Intens flexible programma ble interrupt pin is available. 1. Application Circuit Fig. 12 - Application Circuit (x) = Pin Number Note The interrupt pin is an open drain output . The needed pull-up resistor may be 100 k . Proposed value for R3 and R4, e.g. 2.2 k 4.7 k , depend also on the I 2C bus speed. For detailed description about set-up and use of the interrupt as well as more application related information V to 3.6 V2.5 5.0 VR2 contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO AT with VCNL4010. The built in I2C interface is compatible with all I2C modes (standard, fast and high speed). I2C H-level range = 1.7 V to 5 V. Please refer to the I2C specification from NXP for details. Fig. 13 - Send Byte /Receive Byte Protocol Device AddressThe VCNL4010 has a accessing The predefined 7 bit I bus set to 011 = 13h. The least significant bit (LSB) defines re ad or write mode. Accordingly the bus address is set to 0010 0 11x 26h 27h t or proximity measurements. This register contains 2 for data ready indi cation. Note With setting bit 3 and bit 4 at the same write command, a simultaneously measurement of ambient light and proximity mode s are disabled if selftime d_en bit is set. For the selftimed_en mode changes in reading rates (reg #4 and reg #2) can be made only when b0 (selftimed_en bit) = 0. For the als_od mode changes to the reg #4 can be made only when b4 (als_od bit) = 0; this is to the clock domains. effect this means that it is only reason able to change rates while no selftimed conversion is ongoing.S Slave addre VCNL4010 A Regi ster addre ss A Wr P S Slave addre ss P A A Data byteSend byte Write command to VCNL4010 S = start condition P = stop condition A = acknowledgeHost action sponseS A Regi A Wr P byte A 22313-1 TABLE 1 - COMMAND REGISTER #0 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t = 1 als_data_rdyRead only bit. Value = 1 when ambient light measurement data is available in the result registers. This bit will be reset when one of the corresponding result registers (reg #5, reg #6) is Value = 1 when proximity measurement data is available in the result registers. This bit will be reset when one of the corresponding result registers (reg #7, a single measurement for ambient light. If averaging is enabled, starts of averaged . Result is available at the end in the registers #5(HB) and proximity.Result is available at the end of reading contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO and any new value written in this register will not be mode 83h. This register is se the LED current value for proximity measurement. The value is adjustable in steps of 10 mA from 0 mA to 200 mA. This register also contains information about the used device 2 - PRODUCT ID REVISION REGISTER #1 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Product ID Revision ID Description Product ID Read only bits. Value = 2 Revision ID Read on ly bits. 1 TABLE - PROXIMITY #2 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 n/aRate of Proximity Measurement (no. of measurements per second) Description Proximity rateR/W bits. 000 - 1.95 measurements/s (DEFAULT) 001 - measurements/s 010 - - 62.5 - 125 measurements/s 111 - 250 measurements/s TABLE 4 - IR LED CURRENT REGISTER #3 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Fuse prog ID IR LED current value Description Fuse revision used for initial setup/calibration of the device. IR LED current valueR/W bits. IR LED current = Value (dec.) x 10 mA. Valid Range = 0 to 20d. e.g. 0 = 0 mA , 1 = 10 mA, ...., 20 = 200 mA (2 = 20 mA = DEFAULT) LED Current is limited to 200 mA for values higher as 20d. contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO = any new value written in this register will not be mode fo r ambient light measurement readings. The result is a 16 bit value. The high byte is stor ed in register #5 and the low byte in register #6.TABLE 5 - AMBIENT LIGHT PARAMETER REGISTER #4 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t can for performing faster ambient ligh t measurements. Plea se refer to the application information chapter 3.3 for details about this function. Ambient light me asurement rateR/W bits. Ambient li ght measurement rate 000 - 1 samples/s 001 - 2 samples/s = DEFAULT 010 - 3 samples/s 011 - 4 samples/s 100 - 5 samples/s 101 - 6 samples/s 110 - 8 samples/s 111 - 10 samples/s Auto offset compensationR/W bit. compensation.Enable DEFAULT; Disable = 0In order compensate a technology, package or te mperature related drift of the ambient light values there is a built in automatic offset one cycle. the of all conversions.Number of conversions = 2 decimal_value e.g. 0 = 1 conv., 1 = 2 conv, 2 = 4 conv., ....7 = 128 conv. DEFAULT = 32 conv. (bit 2 to bit 0: 101) TABLE 6 - AMBIENT LIGHT RESULT REGISTER #5 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description Read only bits. High byte (15:8) of ambient light measurement result TABLE 7 - AMBIENT LIGHT RESULT REGISTER #6 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description Read only bits. Low byte (7:0) of ambient light measurement resultVCNL4010 www.vishay.comVishay contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT The result is a 16 bit value. The high byte is stor ed in register #7 the i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description Read only bits. High byte (15:8) of t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description Read only bits. Low byte (7:0) of proximity measurement result TABLE i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Int count exceed n/aINT_PROX_ ready_ENINT_ALS_ ready_ENINT_THRES_ENINT_THRES_ SEL Description Int count number of consecutive above/below = - 2 count010 - 4 count011 - 8 count100 -16 count101 - 32 count110 - R/W Enables in terrupt generation when is INT_THRES_SELR/W If contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT Th e value is a 16 bit word. The high byte is stored in register #10 and the low threshold value. The value is a 16 bit word. The high byte is stored in register #12 and the either proximity or ALS function and indicates if high or low going threshold exceeded. Note Once an interrupt is generated the corresponding status bit goes to 1 and stays there unless it is cleared by writing a 1 in t he corresponding bit. The int pad will be pulled down wh ile at least one of the status bit is 1.TABLE 11 - LOW THRESHOLD REGISTER #10 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description R/W bits. High byte (15:8) of low threshold value TABLE - LOW #11 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description R/W bits. Low byte (7:0) of low threshold value TABLE - HIGH #12 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description R/W bits. High byte (15:8) of high threshold value TABLE - HIGH #13 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 Description R/W bits. Low byte (7:0) of high threshold value TABLE - INTERRUPT #14 B i t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE performance will be provided by Vishay. With first samples this is evaluated to: Delay Time = 0 ; Dead Time = 1 and Prox Fr equency = 0 . With that register#15 programmed with 1 (= value). IR Level RegisterRegister not APPLICATION HINTS EXAMPLES the receiver has th e lowest current consumption of about 1.5 A. In this mode only the I 2C interface is active. This is always valid, when there are no measurement demands for proximity and ambient light ex ecuted. Also the current sink for the IR-LED is inactive, so there is no need for changing register #3 (IR LED current). 3.2 Data Read In order to get a certain register value, the register has to be addressed without data like shown in the following scheme. Aft er this register addressing, the data fr om the addressed register is writte n after a subsequent read command. Fig. 14 - Send Byte /Receive Byte Protocol The stop condition between these write and read sequences is no t mandatory. It works also with a repeated start condition. Note For reading out 2 (or more) subsequent registers like the result registers, it is address each of the registe rs separately. the internal register counter is increased auto matically and t 7B i t 6B i t 5B i t 4B i t 3B i t 2B i t 1B i t 0 bits. Setting a delay time between IR LED signal and IR input signal evaluation. This function is for compensation of delays from IR LED and IR phot o diode. Also in respect to Proximity frequencyR/W bits. Setting the proximit IR test signal frequency The proximity measurement is using a square IR signal as measurement Four different are bits. Setting a dead time in evaluation of IR signal at the slopes of the IR signal. ( DEFAULT = be used carefully. S Slave addre ss RdReceive byte Read data from VCNL4010 AR e g i ster addre ss A Wr P S Slave addre ss P A A Data byte S = start condition P = stop condition A = acknowledgeHost action VCNL4010 contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT Conversion Mode is a detail description of the function \"continuous conversion\" (bit 7 of register #4)Standard mode (bit 7 of reg #4 = 0): In standard mode the ambient light measurem ent is done during a fixed time frame of 100 ms. The single measurement itself takes actually only appr. in mode using averaging as examples for illustration (p ossible values up to 128). Fig. 15 - Ambient Light Measurement with Averaging = 2; Final Measurement Result = Average of these 2 Measurements Fig. 16 - Ambient Light Meas urement with Averaging = 8; Final Measurement Result = Average of these 8 Measurements Note Independent of setting of averaging the result is available only after 100 ms. Continuous conversion mode 7 of register #4 = 1): In continuous conversion mode after each other. See following examples in figure 17 and 18 Fig. 17 - Light Measurement with Averaging = 2; using Continuous Conversion = sStart 100 m s 22316 460 sStart s 22317460 sStart 4.2 m contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT po sition 12.4 + 2 18.4 max.\u00d8 21 \u00b1 0.8 100mm min. with cover tape specification saccording to DINtechnical drawing sNot indicated tolerance s \u00b1 = 1800 pc s. GS 18 \u00d8 330 \u00b1 2 = 7000 pc s. \u00d8 13 \u00b1 0.2 X 2:1XVCNL4010 www.vishay.comVishay Semiconductors contact: sensorstechsupport@vishay.com CHANGE WITHOUT NOTICE. THE PRODUCTS DESCRIBED HEREIN AND THIS DOCUMENT ARE SUBJECT TO SPECIFIC and storage. Each bag contains a desiccant. FLOOR LIFE Floor life (time between soldering and removing from MBB) must not exceed the on MBB label: Floor life: 168 h Conditions: T amb < 30 \u00b0C, RH < 60 % Moisture sensitivity level 3, according to J-STD-020 DRYING before J-STD-020 or taped on reel dry us ing recommended conditions 192 h at 40 \u00b0C (+ 5 \u00b0C), RH < 5 %.050100150200250300 0 50 100 150 200 250 300Time (s)Temperature (\u00b0C)240 \u00b0C245 \u00b0Cmax. 260 \u00b0C max. 120 s max. 100 s217 \u00b0C max. 30 s max. ramp up 3 \u00b0C/s PRODUCT, PRODUCT SPECIFICATIONS AND DATA ARE SUBJECT TO CHANGE WITHOUT NOTICE RELIABILITY, and employee s, and all persons acting on it s or their behalf (collectivel y, \"Vishay\"), disclaim any inaccuracies or incompleteness contained in any datasheet or regarding y of the products for any particular purpose or the continuing production of any product. To the maximum extent permitted by applicable law, Vi shay disclaims (i) any and all liability arising out of the application or use of any product, (ii) any and all liability, including without limitation specia l, consequential or incidental i the suitability of products certain type s of applications are based on Vishay's knowledge typical the suitability of products a particular application. It is the customer's responsib ility to validate that a particu lar product with the properties descri bed in the product specification is suitable fo r use in a particular application. Parameters provided in datasheets and/or specification s may vary in different applications an d performance may vary over time. All operating parameters, the as expressly indicate d in writing, products are not designed for use in medical, life-saving, or life-sustaining applications or for any other application in which the failure of the Vi shay product could result in personal injury indicated for use in such applications do so at their own risk. Pleas e contact authorized Vishay license, express implied, by estoppel or otherwise, to any intellectual prope rty rights is granted by this document or by any conduct of Vishay. names and fulfill the definitions 2011/65/EU of The Euro pean Parliament and of the Council of June 8, 2011 on the restriction of the use of certain hazardous substances in electrical and electronic equipment (EEE) - recast, unless otherwis e specified as non-compliant. Please note that documentation may still make reference to RoHS Directive 2002/95/ EC. We confirm identified Ha logen-Free follow Halogen-Free requirements as per JEDEC JS709A stan dards. Please note that some Vishay documentation may still make reference to the IEC 61249-2-21 definition. We co nfirm that all the products identified as being compliant to IEC 61249-2-21 http://www.humiditycn.com ---------------------------- ------------- T h o m a s L i u ( S a l e s M a n a g e r ) Email: thomasliu198518@yahoo.com.cn , sales@humiditycn.com sensor RHT03 1. Feature & Application: * H i g h p r e c i s i o n * C a p a c i t i v e t y p e *Full range temperature compensated *Relative humidity and temperature measurement * C a l i b r a t e d d i g i t a l s i g n a l *Outstanding long-term stability *Extra components is connected with 8-bit single-chip computer. Every sensor of this model is temperature compensate d and calibrated in accurate calibration chamber and the calibration-coefficient is saved in type of programme in OTP memory, when the sensor is detecting, it will cite coefficient from memory. Small size & low consumption & long transmission distance(100m) enable RHT03 occasions. Single-row packaged Specification: Model RHT03 e p e a t a b i l i t y h u m i d i t y + - 1 % R H ; t e m p e r a t u r e + - 0 . 2 C e l s i u s Your specialist in innovating humidity http://www.humiditycn.com ---------------------------- ------------- T h o m a s L i u ( S a l e s M a n a g e r ) Operating (1) Power and Pins Power's voltage should be 3.3-6V DC. When power is supp lied to sensor, don't send any instruction to the sensor within one second to pass unstable status. One capacito r valued 100nF can be added between VDD and for wave filtering. (2) Communication and Ltd. , it 's different from Maxim/Dallas 1-wire bus, so it's with Dallas of MaxDetect 1-wire bus: Data is comprised of integral and decimal part, the following is the formula for data. DATA=8 bit integral RH data+8 bit decimal RH data+8 bit integral T data+8 bit decimal T data+8 http://www.humiditycn.com ---------------------------- ------------- T h o m a s L i u ( S a l e s M a n a g e r ) Email: thomasliu198518@yahoo.com.cn , sales@humiditycn.com - 3 - is right, check-sum should be: Check sum=8 bit integral RH data+8 bit decimal RH data+8 bit integral T data+8 bit decimal T data Example: MCU has received 40 bits data from RHT03 as 0000 0010 1000 1100 0000 0001 0101 1111 1110 1110 1 6 b i t s R H d a t a 1 6 b i t s T d a t a c h e c k s u m Check sum=0000 it m eans the temperature is below degree Celsius. Example: 1000 0000 0110 0101 , T= minus 10.1 1 6 b i t s T d a t a When MCU send start signal, RHT03 relative temperature to MCU. Without start signal from MCU, RHT03 will not give response signal to MCU. One start signal for one response data from RHT03 that reflect the relative humidity and temperature. RHT03 will change to status when data collecting finished if it don't receive start signal below overall communication process, the interval of whole must beyond specialist in innovating http://www.humiditycn.com ---------------------------- ------------- T h o m a s L i u ( S a l e s M a n a g e r ) Email: thomasliu198518@yahoo.com.cn response signal to MCU Data-bus's free status is high voltage level. When communication between MCU and RHT03 begins, MCU will pull low data-bus and this process must beyond le ast 1~10ms to ensure RHT03 could detect MCU's signal, RHT03's RHT03 detect the start will the 80us as response RHT03 http://www.humiditycn.com ---------------------------- ------------- T h o m a s L i u ( S a l e s M a n a g e r ) Email: thomasliu198518@yahoo.com.cn , sales@humiditycn.com - 5 - RHT03 is always high-voltage-level, it means RHT03 is not working properly, please check the electrical connection status. 7. Electrical Characteristics: Items Condition Min Typical Max Unit Power supply DC 3.3 5 6 V Measuring 1 1.5 mA Current supply Stand-by 40 Null 50 uA Collecting period Second 2 Second 8. Attentions of application: (1) and storage the in this specification. The sensor can recover after working in abnormal will accelerate sensors' aging. (2) Attentions to chemical materials Vapor interfere RHT03's sensitive-elements and debase RHT03's happens sensor <10%RH for hours; Step After one, keep the RHT03 sensor at condition of Temperat ure 20~30Celsius, http://www.humiditycn.com ---------------------------- ------------- T h o m a s L i u ( S a l e s M a n a g e r ) Email: technology to ensure accurate measurement of RH. But it's still be mu ch better to keep the sensor at same temperature when sensing. RHT03 should be mounted at the place as far as pos sible from parts that may cause change to temperature. (5) Attentions to light Long time exposure to strong light and ultraviolet may debase RHT03's performance. (6) Attentions dew condition. * Don't use this product in safety or emergency stop devices or any other occasion that failure of "}